<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Local Explorer</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap');
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: '#0b1220',
            steel: '#1f2937',
            deck: '#111827',
            ivory: '#f8f7f2',
            amber: '#f59e0b',
            seafoam: '#10b981'
          },
          fontFamily: {
            display: ['Poppins', 'sans-serif'],
            body: ['Raleway', 'sans-serif']
          },
          boxShadow: {
            glow: '0 10px 40px rgba(16, 185, 129, 0.25)'
          },
          backgroundImage: {
            'compass-ring': 'conic-gradient(from 180deg, rgba(16,185,129,0.35), rgba(245,158,11,0.45), rgba(11,18,32,0.9))'
          }
        }
      }
    };
  </script>
  <style>
    body {
      font-family: 'Raleway', sans-serif;
      background: radial-gradient(circle at top, rgba(16, 185, 129, 0.2), rgba(11, 18, 32, 1));
      min-height: 100vh;
      color: #f8f7f2;
    }
    .glass {
      background: rgba(17, 24, 39, 0.6);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(248, 247, 242, 0.06);
    }
    .card-lift {
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      box-shadow: 0 10px 30px rgba(11, 18, 32, 0.3);
    }
    .card-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 36px rgba(11, 18, 32, 0.45);
    }
    .no-pointer {
      pointer-events: none !important;
    }
    .focus-trap:focus {
      outline: 2px solid #f59e0b;
      outline-offset: 4px;
    }
    .scroll-shadow::before {
      content: '';
      position: sticky;
      top: 0;
      height: 12px;
      width: 100%;
      pointer-events: none;
      background: linear-gradient(to bottom, rgba(11, 18, 32, 0.85), transparent);
      z-index: 5;
      display: block;
    }
  </style>
</head>
<body class="h-full overflow-x-hidden">
  <div id="app" class="relative mx-auto max-w-md min-h-screen px-4 pb-24 pt-6">
    <header class="flex items-center justify-between">
      <h1 class="font-display text-3xl font-bold tracking-tight">Local Explorer</h1>
      <button id="refreshLocationBtn" class="glass card-lift rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber hover:text-seafoam focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber" aria-label="Refresh location">Refresh</button>
    </header>
    <p id="locationStatus" class="mt-2 text-sm text-ivory/80">Locating you‚Ä¶</p>

    <section id="localFactCard" class="glass card-lift mt-4 rounded-2xl p-4 shadow-xl transition-transform" aria-live="polite">
      <div class="flex items-center justify-between">
        <h2 class="font-display text-lg font-semibold text-amber">Local Fact</h2>
        <span id="localFactSource" class="text-xs text-ivory/60">Wikipedia</span>
      </div>
      <p id="localFactText" class="mt-2 text-sm leading-relaxed text-ivory/90">Discovering nearby stories‚Ä¶</p>
    </section>

    <section class="mt-4 space-y-3">
      <div class="glass rounded-2xl p-4 shadow-xl">
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold uppercase tracking-wide text-ivory/70">Manual Location</span>
          <button id="toggleManualLocation" class="text-sm font-semibold text-seafoam hover:text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber">Enter</button>
        </div>
        <form id="manualLocationForm" class="mt-3 hidden" aria-hidden="true">
          <label class="sr-only" for="manualLocationInput">Enter a city or zip code</label>
          <input id="manualLocationInput" name="manualLocation" type="text" placeholder="City or ZIP" class="w-full rounded-xl border border-ivory/10 bg-steel/70 px-3 py-2 text-ivory placeholder:text-ivory/40 focus:border-amber focus:outline-none" autocomplete="off" />
          <button type="submit" class="mt-3 w-full rounded-xl bg-amber px-3 py-2 font-semibold text-deck transition hover:bg-amber/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Update</button>
        </form>
      </div>

      <div class="glass rounded-2xl p-4 shadow-xl">
        <div class="flex items-center justify-between">
          <h2 class="font-display text-lg font-semibold text-amber">Pick Your Vibe</h2>
          <button id="moodToggle" class="rounded-full border border-amber/60 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber transition hover:border-seafoam hover:text-seafoam focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" aria-pressed="false">Adventurous</button>
        </div>
        <p class="mt-2 text-xs text-ivory/70">Focus group tip: switch between adventurous or chill results depending on your mood.</p>
      </div>

      <div class="glass rounded-2xl p-4 shadow-xl">
        <div class="flex items-center justify-between">
          <h2 class="font-display text-lg font-semibold text-amber">Today's Essentials</h2>
          <div id="quickWeather" class="text-sm text-ivory/80">Checking local weather‚Ä¶</div>
        </div>
        <p class="mt-2 text-xs text-ivory/60">Travelers asked for a heads-up on conditions before heading out.</p>
      </div>
    </section>

    <section class="mt-6">
      <div class="flex items-center justify-between">
        <h2 class="font-display text-xl font-semibold text-amber">Main Filters</h2>
        <button id="recentSearchesBtn" class="text-xs font-semibold uppercase tracking-widest text-seafoam hover:text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber">Recent</button>
      </div>
      <div class="mt-4 grid grid-cols-2 gap-3" role="list">
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="foodie">
          <span class="text-2xl">üçΩÔ∏è</span>
          <div>
            <p class="font-display text-lg font-semibold">Foodie Finds</p>
            <p class="text-xs text-ivory/60">Taste trail</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="sights">
          <span class="text-2xl">üèõÔ∏è</span>
          <div>
            <p class="font-display text-lg font-semibold">Iconic Sights</p>
            <p class="text-xs text-ivory/60">Culture dive</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="night">
          <span class="text-2xl">üåô</span>
          <div>
            <p class="font-display text-lg font-semibold">Night Out</p>
            <p class="text-xs text-ivory/60">Late vibes</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="gems">
          <span class="text-2xl">üíé</span>
          <div>
            <p class="font-display text-lg font-semibold">Hidden Gems</p>
            <p class="text-xs text-ivory/60">Under the radar</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="outdoors">
          <span class="text-2xl">üèûÔ∏è</span>
          <div>
            <p class="font-display text-lg font-semibold">Outdoors</p>
            <p class="text-xs text-ivory/60">Fresh air</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="pets">
          <span class="text-2xl">üêæ</span>
          <div>
            <p class="font-display text-lg font-semibold">Pet Friendly</p>
            <p class="text-xs text-ivory/60">Bring pals</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="utilities">
          <span class="text-2xl">üõü</span>
          <div>
            <p class="font-display text-lg font-semibold">Utilities & Help</p>
            <p class="text-xs text-ivory/60">Peace of mind</p>
          </div>
        </button>
        <button class="category-btn glass card-lift flex h-28 flex-col justify-between rounded-2xl p-4 text-left shadow-xl transition" data-category="donate">
          <span class="text-2xl">ü§ù</span>
          <div>
            <p class="font-display text-lg font-semibold">Donate</p>
            <p class="text-xs text-ivory/60">Give back</p>
          </div>
        </button>
      </div>
      <button id="surpriseMeBtn" class="card-lift mt-4 w-full rounded-2xl bg-seafoam px-4 py-3 text-lg font-semibold text-deck shadow-xl transition hover:bg-seafoam/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam">Surprise Me</button>
    </section>

    <button id="darkModeBtn" class="fixed bottom-6 left-4 glass card-lift flex h-14 w-14 items-center justify-center rounded-full text-2xl shadow-xl" aria-label="Open dark discoveries">üëª</button>
    <button id="myListBtn" class="fixed bottom-6 right-4 glass card-lift rounded-full px-5 py-3 text-sm font-semibold uppercase tracking-widest text-ivory shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber">My List</button>

    <section id="submenuPanel" class="invisible fixed inset-0 z-20 flex items-end justify-center bg-deck/80 backdrop-blur-xl opacity-0 transition-opacity" aria-hidden="true">
      <div class="glass w-full max-w-md rounded-t-3xl p-6 shadow-2xl">
        <div class="flex items-center justify-between">
          <h2 id="submenuTitle" class="font-display text-2xl font-semibold text-amber">Filters</h2>
          <button id="submenuClose" class="rounded-full border border-amber/40 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Back</button>
        </div>
        <p id="submenuSubtitle" class="mt-1 text-xs text-ivory/70">Select a focus</p>
        <div id="submenuOptions" class="mt-4 grid grid-cols-1 gap-3"></div>
        <button id="submenuBackMain" class="mt-6 text-sm font-semibold text-seafoam hover:text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber">Back to Main Filters</button>
      </div>
    </section>

    <section id="resultsOverlay" class="invisible fixed inset-0 z-30 flex flex-col bg-deck/90 backdrop-blur-xl opacity-0 transition-opacity" aria-hidden="true" aria-labelledby="resultsHeader">
      <header class="glass flex items-center justify-between px-5 pb-3 pt-6 shadow-xl">
        <div>
          <p class="text-xs uppercase tracking-[0.35em] text-ivory/50">Results</p>
          <h2 id="resultsHeader" class="font-display text-2xl font-semibold text-amber">0 Spots</h2>
        </div>
        <div class="flex items-center gap-2">
          <button id="resultsBackBtn" class="rounded-full border border-amber/40 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Back</button>
          <button id="mapAllBtn" class="rounded-full border border-seafoam/50 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-seafoam focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam">Map All</button>
        </div>
      </header>
      <div class="scroll-shadow flex-1 overflow-y-auto px-5 pb-28 pt-4" id="resultsList" role="list"></div>
    </section>

    <section id="detailSheet" class="invisible fixed inset-x-0 bottom-0 z-40 mx-auto max-w-md translate-y-full rounded-t-3xl bg-deck/95 p-6 text-ivory shadow-2xl transition-transform" aria-hidden="true" aria-labelledby="detailTitle" role="dialog">
      <div class="h-1 w-20 rounded-full bg-ivory/30 mx-auto mb-4"></div>
      <div id="detailPhoto" class="h-48 w-full overflow-hidden rounded-2xl bg-steel/80"></div>
      <div class="mt-4 flex items-start justify-between">
        <div>
          <h2 id="detailTitle" class="font-display text-2xl font-semibold text-amber"></h2>
          <div id="detailMeta" class="mt-1 flex flex-wrap items-center gap-2 text-sm text-ivory/80"></div>
        </div>
        <button id="savePlaceBtn" class="rounded-full border border-amber/60 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" aria-pressed="false">‚òÜ Save</button>
      </div>
      <div id="detailChips" class="mt-4 flex flex-wrap gap-2"></div>
      <div id="detailContact" class="mt-4 space-y-2 text-sm text-ivory/90"></div>
      <div id="detailButtons" class="mt-4 grid grid-cols-2 gap-3">
        <button data-action="map" class="detail-action rounded-xl bg-seafoam px-3 py-2 text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam">Map View</button>
        <button data-action="website" class="detail-action rounded-xl bg-amber px-3 py-2 text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Website</button>
        <button data-action="share" class="detail-action rounded-xl bg-steel/80 px-3 py-2 text-sm font-semibold text-ivory shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Share</button>
        <button data-action="compass" class="detail-action rounded-xl bg-deck px-3 py-2 text-sm font-semibold text-amber shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Compass</button>
      </div>
      <div id="detailReviews" class="mt-6 space-y-4"></div>
      <div class="mt-6 flex items-center justify-between">
        <button id="detailPrev" class="rounded-full border border-amber/40 px-4 py-2 text-sm font-semibold text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Back</button>
        <button id="detailNext" class="rounded-full border border-seafoam/40 px-4 py-2 text-sm font-semibold text-seafoam focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam">Next</button>
      </div>
    </section>

    <section id="compassModal" class="invisible fixed inset-0 z-50 flex items-center justify-center bg-deck/90 backdrop-blur-xl opacity-0 transition-opacity" role="dialog" aria-modal="true" aria-labelledby="compassTitle" aria-hidden="true">
      <div class="glass relative w-full max-w-sm rounded-3xl p-6 shadow-2xl focus:outline-none" tabindex="-1">
        <button id="compassClose" class="absolute right-4 top-4 rounded-full border border-amber/40 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Close</button>
        <h2 id="compassTitle" class="font-display text-2xl font-semibold text-amber">Compass Guide</h2>
        <p class="mt-1 text-xs text-ivory/70">Focus group loved voice-guided steps & custom voices.</p>
        <div class="mt-4 flex flex-col items-center gap-4">
          <div class="relative flex h-52 w-52 items-center justify-center rounded-full bg-compass-ring">
            <div class="absolute inset-4 rounded-full bg-steel/80 shadow-glow"></div>
            <div id="compassArrow" class="absolute h-32 w-2 origin-bottom rounded-full bg-amber shadow-glow transition-transform"></div>
            <div class="absolute h-6 w-6 rounded-full bg-seafoam shadow-glow"></div>
          </div>
          <div class="text-center">
            <p id="compassDistance" class="text-xl font-semibold text-ivory">--</p>
            <p id="compassInstruction" class="text-sm text-ivory/70">Waiting for location‚Ä¶</p>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
          <button id="guideMeBtn" class="rounded-xl bg-amber px-3 py-2 font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" aria-pressed="false">Guide Me ‚ñ∂Ô∏é</button>
          <button id="compassMapBtn" class="rounded-xl bg-seafoam px-3 py-2 font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam">Open Map</button>
        </div>
        <div class="mt-4 space-y-3 text-sm">
          <label class="flex flex-col gap-1">
            <span class="text-xs uppercase tracking-[0.25em] text-ivory/60">Voice</span>
            <select id="voicePicker" class="rounded-xl border border-ivory/10 bg-steel/80 px-3 py-2 text-ivory focus:border-amber focus:outline-none"></select>
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-xs uppercase tracking-[0.25em] text-ivory/60">Voice Rate</span>
            <input type="range" id="voiceRate" min="0.7" max="1.4" step="0.05" class="accent-amber" />
          </label>
        </div>
        <p class="mt-4 text-xs text-ivory/60">Press ESC or Close to exit. Sensors stop automatically.</p>
      </div>
    </section>

    <section id="donateModal" class="invisible fixed inset-0 z-40 flex items-center justify-center bg-deck/90 backdrop-blur-xl opacity-0 transition-opacity" role="dialog" aria-modal="true" aria-labelledby="donateTitle" aria-hidden="true">
      <div class="glass w-full max-w-sm rounded-3xl p-6 shadow-2xl focus:outline-none" tabindex="-1">
        <button id="donateClose" class="absolute right-4 top-4 rounded-full border border-amber/40 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Close</button>
        <h2 id="donateTitle" class="font-display text-2xl font-semibold text-amber">Support Local Causes</h2>
        <p class="mt-2 text-sm text-ivory/80">Choose a quick amount or open Venmo to give in seconds.</p>
        <div class="mt-4 grid grid-cols-3 gap-3">
          <button class="donate-quick rounded-xl bg-amber px-3 py-2 text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" data-amount="3">$3</button>
          <button class="donate-quick rounded-xl bg-amber px-3 py-2 text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" data-amount="5">$5</button>
          <button class="donate-quick rounded-xl bg-amber px-3 py-2 text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" data-amount="10">$10</button>
        </div>
        <a id="venmoDeepLink" class="mt-4 block rounded-xl bg-seafoam px-4 py-3 text-center text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam" href="venmo://pay?txn=pay&recipients=__VENMO_HANDLE__&amount=5&note=Local%20Explorer" rel="noopener">Open Venmo</a>
        <a id="venmoWebLink" class="mt-3 block text-center text-sm font-semibold text-amber underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" href="https://venmo.com/__VENMO_HANDLE__" rel="noopener" target="_blank">Use Venmo Website</a>
      </div>
    </section>

    <section id="myListPanel" class="invisible fixed inset-0 z-40 flex items-end justify-center bg-deck/90 backdrop-blur-xl opacity-0 transition-opacity" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="myListTitle">
      <div class="glass w-full max-w-md rounded-t-3xl p-6 shadow-2xl focus:outline-none" tabindex="-1">
        <div class="flex items-center justify-between">
          <h2 id="myListTitle" class="font-display text-2xl font-semibold text-amber">My Saved Places</h2>
          <button id="myListClose" class="rounded-full border border-amber/40 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Close</button>
        </div>
        <div class="mt-2 flex items-center justify-between text-xs text-ivory/70">
          <span>Curated from focus group feedback.</span>
          <button id="clearAllData" class="text-amber underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber">Clear All Data</button>
        </div>
        <div id="savedList" class="scroll-shadow mt-4 max-h-72 overflow-y-auto space-y-4"></div>
        <section class="mt-6">
          <h3 class="font-display text-lg font-semibold text-seafoam">Focus Group Wins</h3>
          <ul id="focusGroupList" class="mt-2 list-disc space-y-2 pl-5 text-sm text-ivory/80"></ul>
        </section>
        <section class="mt-6">
          <h3 class="font-display text-lg font-semibold text-seafoam">Recent Searches</h3>
          <ul id="recentSearches" class="mt-2 list-disc space-y-2 pl-5 text-sm text-ivory/80"></ul>
        </section>
      </div>
    </section>
  </div>

  <div id="map" class="hidden"></div>
  <div id="streetViewLayer" class="hidden no-pointer"></div>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=__GOOGLE_MAPS_API_KEY__&libraries=places,geometry"></script>
  <script>
    const appState = {
      map: null,
      placesService: null,
      directionsService: null,
      directionsRenderer: null,
      currentLocation: null,
      manualLocation: null,
      localFacts: [],
      factIndex: 0,
      factTimer: null,
      currentCategory: null,
      currentFilter: null,
      currentResults: [],
      detailIndex: 0,
      savedPlaces: [],
      recentSearches: [],
      voiceSettings: { voiceURI: null, rate: 1 },
      speechSynthesis: window.speechSynthesis,
      guideActive: false,
      compassWatchId: null,
      orientationHandler: null,
      currentRoute: null,
      currentStepIndex: 0,
      mood: 'adventurous',
      focusGroupInsights: [
        { suggestion: 'Add a quick weather glance on the home screen.', reasoning: 'Travelers wanted to plan outfits and travel mode.', applied: 'Weather block with live data via Open-Meteo.' },
        { suggestion: 'Include a mood toggle to switch between adventurous and chill picks.', reasoning: 'Couples and students wanted flexible energy levels.', applied: 'Mood button influencing search query emphasis.' },
        { suggestion: 'Keep recent searches handy for quick replays.', reasoning: 'Frequent explorers revisit favorite filters.', applied: 'Recent searches list stored in localStorage.' },
        { suggestion: 'Surface saved spots in one tap.', reasoning: 'Retirees wanted easier recall.', applied: 'My List drawer with shareable actions.' },
        { suggestion: 'Offer clear data reset controls.', reasoning: 'Privacy-minded vets requested easy clearing.', applied: 'Clear All Data button wiping local storage.' },
        { suggestion: 'Expand donate options with preset buttons.', reasoning: 'Community advocates preferred one-tap amounts.', applied: 'Quick donate amounts triggering Venmo deeplinks.' },
        { suggestion: 'Allow custom navigation voices and speed.', reasoning: 'Accessibility testers had unique preferences.', applied: 'Compass voice picker + rate slider stored persistently.' },
        { suggestion: 'Show itinerary-ready action buttons.', reasoning: 'Students wanted Map and Share instantly.', applied: 'Detail sheet action buttons for Map, Website, Share, Compass.' },
        { suggestion: 'Provide offline-ready reassurance.', reasoning: 'Travelers worried about no signal.', applied: 'Service worker + offline messaging when fetch fails.' },
        { suggestion: 'Display focus group wins transparently.', reasoning: 'Users loved knowing improvements came from feedback.', applied: 'Focus group wins list inside My List panel.' }
      ]
    };

    const CATEGORY_CONFIG = {
      foodie: {
        title: 'Foodie Finds',
        vibe: 'Tasty adventures tailored for your appetite.',
        subfilters: [
          { label: 'üçï Surprise Me', keyword: 'best restaurants', types: ['restaurant', 'meal_takeaway'], adventurous: true },
          { label: 'Italian', keyword: 'italian restaurant', types: ['restaurant'] },
          { label: 'Mexican', keyword: 'mexican restaurant', types: ['restaurant'] },
          { label: 'Japanese', keyword: 'japanese restaurant', types: ['restaurant'] },
          { label: 'Chinese', keyword: 'chinese restaurant', types: ['restaurant'] },
          { label: 'Indian', keyword: 'indian restaurant', types: ['restaurant'] },
          { label: 'Pizza', keyword: 'pizza', types: ['restaurant'] },
          { label: 'Cafes', keyword: 'cafe', types: ['cafe', 'bakery'] },
          { label: 'Desserts', keyword: 'dessert', types: ['bakery', 'cafe', 'restaurant'] }
        ],
        allowedTypes: ['restaurant', 'cafe', 'bakery']
      },
      sights: {
        title: 'Iconic Sights',
        vibe: 'Art, history, and cultural landmarks.',
        subfilters: [
          { label: 'Museums', keyword: 'museum', types: ['museum'] },
          { label: 'Art Galleries', keyword: 'art gallery', types: ['art_gallery'] },
          { label: 'Tourist Attractions', keyword: 'tourist attraction', types: ['tourist_attraction'] }
        ],
        allowedTypes: ['museum', 'art_gallery', 'tourist_attraction']
      },
      night: {
        title: 'Night Out',
        vibe: 'Evening energy and neon-lit fun.',
        subfilters: [
          { label: 'Bars', keyword: 'bar', types: ['bar'] },
          { label: 'Night Clubs', keyword: 'night club', types: ['night_club'] }
        ],
        allowedTypes: ['bar', 'night_club']
      },
      gems: {
        title: 'Hidden Gems',
        vibe: 'Unexpected indie discoveries.',
        subfilters: [
          { label: 'Quirky Shops', keyword: 'quirky shop', types: ['tourist_attraction', 'store'] },
          { label: 'Indie Coffee', keyword: 'indie coffee', types: ['cafe'] },
          { label: 'Local Art', keyword: 'local art', types: ['art_gallery', 'tourist_attraction'] },
          { label: 'Quiet Spots', keyword: 'quiet place', types: ['library', 'park'] }
        ],
        allowedTypes: ['tourist_attraction', 'art_gallery', 'library', 'park', 'cafe']
      },
      outdoors: {
        title: 'Outdoors',
        vibe: 'Nature escapes and scenic air.',
        subfilters: [
          { label: 'Hikes', keyword: 'hiking trail', types: ['park', 'natural_feature'] },
          { label: 'Beaches', keyword: 'beach', types: ['natural_feature', 'park'] },
          { label: 'Waterfalls', keyword: 'waterfall', types: ['natural_feature'] },
          { label: 'Scenic Overlooks', keyword: 'scenic overlook', types: ['tourist_attraction', 'natural_feature'] },
          { label: 'Lakes', keyword: 'lake', types: ['natural_feature'] },
          { label: 'Playgrounds', keyword: 'playground', types: ['park'] }
        ],
        allowedTypes: ['park', 'campground', 'tourist_attraction', 'natural_feature']
      },
      pets: {
        title: 'Pet Friendly',
        vibe: 'Places that welcome furry explorers.',
        subfilters: [
          { label: 'Dog Park', keyword: 'dog park', types: ['park'] },
          { label: 'Pet Store', keyword: 'pet store', types: ['pet_store'] },
          { label: 'Veterinarian', keyword: 'veterinarian', types: ['veterinary_care'] }
        ],
        allowedTypes: ['park', 'pet_store', 'veterinary_care']
      },
      utilities: {
        title: 'Utilities & Help',
        vibe: 'Reliable helpers when you need them.',
        subfilters: [
          { label: 'Hospital', keyword: 'hospital', types: ['hospital'] },
          { label: 'Pharmacy', keyword: 'pharmacy', types: ['pharmacy'] },
          { label: 'Police', keyword: 'police', types: ['police'] },
          { label: 'Gas Station', keyword: 'gas station', types: ['gas_station'] },
          { label: 'Car Rental', keyword: 'car rental', types: ['car_rental'] },
          { label: 'ATM', keyword: 'atm', types: ['atm'] }
        ],
        allowedTypes: ['hospital', 'pharmacy', 'police', 'gas_station', 'car_rental', 'atm']
      },
      donate: {
        title: 'Donate',
        vibe: 'Support local nonprofits and drives.',
        subfilters: [],
        allowedTypes: []
      },
      dark: {
        title: 'Dark Discoveries',
        vibe: 'Spine-tingling locales for curious souls.',
        subfilters: [
          { label: 'Cemeteries', keyword: 'cemetery', types: ['cemetery'] },
          { label: 'Haunted Tours', keyword: 'haunted tour', types: ['tourist_attraction'] },
          { label: 'Haunted Sites', keyword: 'haunted site', types: ['tourist_attraction', 'museum'] },
          { label: 'Crime Museums', keyword: 'crime museum', types: ['museum'] }
        ],
        allowedTypes: ['cemetery', 'tourist_attraction', 'museum']
      }
    };

    const RETAIL_BLOCK_LIST = ['store', 'lodging', 'hotel'];
    const DARK_KEYWORDS = ['haunted', 'ghost', 'crypt', 'crime', 'noir', 'spirit', 'phantom'];

    const elements = {
      locationStatus: document.getElementById('locationStatus'),
      localFactCard: document.getElementById('localFactCard'),
      localFactText: document.getElementById('localFactText'),
      toggleManualLocation: document.getElementById('toggleManualLocation'),
      manualLocationForm: document.getElementById('manualLocationForm'),
      manualLocationInput: document.getElementById('manualLocationInput'),
      refreshLocationBtn: document.getElementById('refreshLocationBtn'),
      categoryButtons: document.querySelectorAll('.category-btn'),
      submenuPanel: document.getElementById('submenuPanel'),
      submenuTitle: document.getElementById('submenuTitle'),
      submenuSubtitle: document.getElementById('submenuSubtitle'),
      submenuOptions: document.getElementById('submenuOptions'),
      submenuClose: document.getElementById('submenuClose'),
      submenuBackMain: document.getElementById('submenuBackMain'),
      resultsOverlay: document.getElementById('resultsOverlay'),
      resultsHeader: document.getElementById('resultsHeader'),
      resultsList: document.getElementById('resultsList'),
      resultsBackBtn: document.getElementById('resultsBackBtn'),
      mapAllBtn: document.getElementById('mapAllBtn'),
      detailSheet: document.getElementById('detailSheet'),
      detailPhoto: document.getElementById('detailPhoto'),
      detailTitle: document.getElementById('detailTitle'),
      detailMeta: document.getElementById('detailMeta'),
      detailChips: document.getElementById('detailChips'),
      detailContact: document.getElementById('detailContact'),
      detailButtons: document.getElementById('detailButtons'),
      detailReviews: document.getElementById('detailReviews'),
      detailPrev: document.getElementById('detailPrev'),
      detailNext: document.getElementById('detailNext'),
      savePlaceBtn: document.getElementById('savePlaceBtn'),
      compassModal: document.getElementById('compassModal'),
      compassArrow: document.getElementById('compassArrow'),
      compassDistance: document.getElementById('compassDistance'),
      compassInstruction: document.getElementById('compassInstruction'),
      guideMeBtn: document.getElementById('guideMeBtn'),
      compassClose: document.getElementById('compassClose'),
      compassMapBtn: document.getElementById('compassMapBtn'),
      donateModal: document.getElementById('donateModal'),
      donateClose: document.getElementById('donateClose'),
      donateQuickButtons: document.querySelectorAll('.donate-quick'),
      venmoDeepLink: document.getElementById('venmoDeepLink'),
      venmoWebLink: document.getElementById('venmoWebLink'),
      darkModeBtn: document.getElementById('darkModeBtn'),
      surpriseMeBtn: document.getElementById('surpriseMeBtn'),
      myListBtn: document.getElementById('myListBtn'),
      myListPanel: document.getElementById('myListPanel'),
      myListClose: document.getElementById('myListClose'),
      savedList: document.getElementById('savedList'),
      clearAllData: document.getElementById('clearAllData'),
      focusGroupList: document.getElementById('focusGroupList'),
      recentSearches: document.getElementById('recentSearches'),
      recentSearchesBtn: document.getElementById('recentSearchesBtn'),
      localFactSource: document.getElementById('localFactSource'),
      mapEl: document.getElementById('map'),
      streetViewLayer: document.getElementById('streetViewLayer'),
      guideVoicePicker: document.getElementById('voicePicker'),
      guideVoiceRate: document.getElementById('voiceRate'),
      compassModalCard: document.querySelector('#compassModal > div'),
      donateModalCard: document.querySelector('#donateModal > div'),
      myListCard: document.querySelector('#myListPanel > div'),
      submenuCard: document.querySelector('#submenuPanel > div'),
      resultsOverlayEl: document.getElementById('resultsOverlay'),
      moodToggle: document.getElementById('moodToggle'),
      quickWeather: document.getElementById('quickWeather')
    };

    function metersToImperial(meters) {
      const feet = meters * 3.28084;
      if (feet < 528) {
        return `${Math.round(feet)} ft`;
      }
      const miles = feet / 5280;
      return `${miles.toFixed(1)} mi`;
    }

    function renderStars(rating) {
      if (!rating) return '<span class="text-xs text-ivory/50">No rating</span>';
      const fullStars = Math.floor(rating);
      const halfStar = rating - fullStars >= 0.5;
      let stars = '';
      for (let i = 0; i < fullStars; i += 1) stars += '‚òÖ';
      if (halfStar) stars += '¬Ω';
      return `<span class="text-amber">${stars}</span> <span class="text-xs text-ivory/60">${rating.toFixed(1)}</span>`;
    }

    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || div.innerText || '';
    }

    function showFacts() {
      elements.localFactCard.classList.remove('hidden');
      elements.localFactCard.setAttribute('aria-hidden', 'false');
    }

    function hideFacts() {
      elements.localFactCard.classList.add('hidden');
      elements.localFactCard.setAttribute('aria-hidden', 'true');
    }
    function togglePanel(panel, show) {
      if (show) {
        panel.classList.remove('invisible');
        requestAnimationFrame(() => {
          panel.classList.remove('opacity-0');
        });
      } else {
        panel.classList.add('opacity-0');
        panel.addEventListener(
          'transitionend',
          () => panel.classList.add('invisible'),
          { once: true }
        );
      }
    }

    function trapFocus(container) {
      const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      const focusable = Array.from(container.querySelectorAll(focusableSelectors)).filter((el) => !el.hasAttribute('disabled'));
      if (!focusable.length) return () => {};
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      function handleKey(event) {
        if (event.key === 'Tab') {
          if (event.shiftKey && document.activeElement === first) {
            event.preventDefault();
            last.focus();
          } else if (!event.shiftKey && document.activeElement === last) {
            event.preventDefault();
            first.focus();
          }
        } else if (event.key === 'Escape') {
          container.dispatchEvent(new CustomEvent('request-close'));
        }
      }
      container.addEventListener('keydown', handleKey);
      first.focus();
      return () => container.removeEventListener('keydown', handleKey);
    }

    function saveToLocalStorage() {
      localStorage.setItem('localExplorerSaved', JSON.stringify(appState.savedPlaces));
      localStorage.setItem('localExplorerRecent', JSON.stringify(appState.recentSearches));
      localStorage.setItem('localExplorerVoice', JSON.stringify(appState.voiceSettings));
    }

    function loadFromLocalStorage() {
      try {
        const saved = JSON.parse(localStorage.getItem('localExplorerSaved'));
        const recent = JSON.parse(localStorage.getItem('localExplorerRecent'));
        const voice = JSON.parse(localStorage.getItem('localExplorerVoice'));
        if (Array.isArray(saved)) appState.savedPlaces = saved;
        if (Array.isArray(recent)) appState.recentSearches = recent;
        if (voice && typeof voice === 'object') appState.voiceSettings = { ...appState.voiceSettings, ...voice };
      } catch (error) {
        console.error('Storage parse error', error);
      }
      renderSavedPlaces();
      renderRecentSearches();
    }

    function renderFocusGroupList() {
      elements.focusGroupList.innerHTML = '';
      appState.focusGroupInsights.forEach((insight) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${insight.suggestion}</strong> ‚Äî ${insight.reasoning} <span class="text-ivory/60">(Applied: ${insight.applied})</span>`;
        elements.focusGroupList.appendChild(li);
      });
    }

    function renderSavedPlaces() {
      elements.savedList.innerHTML = '';
      if (!appState.savedPlaces.length) {
        elements.savedList.innerHTML = '<p class="text-sm text-ivory/60">No saved places yet. Star a spot to pin it here.</p>';
        return;
      }
      appState.savedPlaces.forEach((place) => {
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 shadow-xl';
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <p class="font-display text-lg font-semibold text-amber">${place.name}</p>
              <p class="text-xs text-ivory/60">${place.vicinity || place.formatted_address || 'Address unavailable'}</p>
            </div>
            <button class="rounded-full border border-amber/40 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-amber remove-saved" data-id="${place.place_id}">Remove</button>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <a class="rounded-xl bg-seafoam px-3 py-2 text-center font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam" href="https://www.google.com/maps/search/?api=1&query_place_id=${place.place_id}" target="_blank" rel="noopener">Open in Maps</a>
            <button class="rounded-xl bg-amber px-3 py-2 font-semibold text-deck shadow-xl share-saved" data-id="${place.place_id}">Share</button>
          </div>
        `;
        elements.savedList.appendChild(div);
      });
    }

    function renderRecentSearches() {
      elements.recentSearches.innerHTML = '';
      if (!appState.recentSearches.length) {
        elements.recentSearches.innerHTML = '<li class="text-xs text-ivory/60">No recent searches yet.</li>';
        return;
      }
      appState.recentSearches.slice(-6).reverse().forEach((item) => {
        const li = document.createElement('li');
        li.innerHTML = `<button class="text-left text-sm text-ivory hover:text-amber recent-search" data-category="${item.category}" data-filter="${item.filterKey}">${item.label}</button>`;
        elements.recentSearches.appendChild(li);
      });
    }

    function updateSaveButtonState(placeId) {
      const saved = appState.savedPlaces.some((p) => p.place_id === placeId);
      elements.savePlaceBtn.setAttribute('aria-pressed', saved.toString());
      elements.savePlaceBtn.textContent = saved ? '‚òÖ Saved' : '‚òÜ Save';
    }

    function addRecentSearch(category, filterKey, label) {
      appState.recentSearches.push({ category, filterKey, label, timestamp: Date.now() });
      if (appState.recentSearches.length > 20) appState.recentSearches.shift();
      renderRecentSearches();
      saveToLocalStorage();
    }

    async function fetchLocalFacts(lat, lng) {
      try {
        const radius = 10000;
        const url = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}%7C${lng}&gsradius=${radius}&gslimit=12&format=json&origin=*`;
        const response = await fetch(url);
        const data = await response.json();
        const pageIds = data.query.geosearch.map((item) => item.pageid).join('|');
        const extractUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=true&explaintext=true&pageids=${pageIds}&format=json&origin=*`;
        const extractResponse = await fetch(extractUrl);
        const extractData = await extractResponse.json();
        const extracts = Object.values(extractData.query.pages)
          .map((page) => ({ title: page.title, extract: page.extract }))
          .filter((item) => item.extract && item.extract.length > 40)
          .slice(0, 12);
        appState.localFacts = extracts;
        if (extracts.length) {
          elements.localFactSource.textContent = 'Wikipedia';
          showFact();
        } else {
          elements.localFactText.textContent = 'No local facts found. Explore and create your own!';
        }
      } catch (error) {
        console.error('Facts fetch error', error);
        elements.localFactSource.textContent = 'Offline mode';
        elements.localFactText.textContent = 'Unable to load facts right now. They‚Äôll return when you‚Äôre back online.';
      }
    }

    function showFact() {
      if (!appState.localFacts.length) return;
      const fact = appState.localFacts[appState.factIndex % appState.localFacts.length];
      elements.localFactText.innerHTML = `<strong>${fact.title}:</strong> ${fact.extract}`;
      appState.factIndex += 1;
      clearTimeout(appState.factTimer);
      appState.factTimer = setTimeout(showFact, 7000);
    }

    function initializeMap() {
      if (appState.map) return;
      appState.map = new google.maps.Map(elements.mapEl, {
        center: { lat: 0, lng: 0 },
        zoom: 13,
        disableDefaultUI: true
      });
      appState.placesService = new google.maps.places.PlacesService(appState.map);
      appState.directionsService = new google.maps.DirectionsService();
      appState.directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
      appState.directionsRenderer.setMap(appState.map);
    }

    function setLocationStatus(text) {
      elements.locationStatus.textContent = text;
    }

    function updateManualLocationVisibility(show) {
      elements.manualLocationForm.classList.toggle('hidden', !show);
      elements.manualLocationForm.setAttribute('aria-hidden', (!show).toString());
    }

    function handleToggleManualLocation() {
      const isHidden = elements.manualLocationForm.classList.contains('hidden');
      updateManualLocationVisibility(isHidden);
      if (isHidden) {
        elements.manualLocationInput.focus();
      }
    }
    async function geolocateUser(useFallback = false) {
      if (useFallback) {
        appState.currentLocation = { lat: 51.5074, lng: -0.1278 };
        setLocationStatus('Defaulting to London, UK. Enter a location for precise results.');
        fetchLocalFacts(appState.currentLocation.lat, appState.currentLocation.lng);
        fetchWeather();
        return;
      }
      if (!navigator.geolocation) {
        setLocationStatus('Geolocation unavailable. Enter a location manually.');
        updateManualLocationVisibility(true);
        geolocateUser(true);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          appState.currentLocation = { lat: latitude, lng: longitude };
          setLocationStatus('Great news! We‚Äôve locked onto your spot.');
          reverseGeocode(latitude, longitude);
          fetchLocalFacts(latitude, longitude);
          fetchWeather();
        },
        (error) => {
          console.warn('Geolocation denied', error);
          setLocationStatus('Location access denied. Enter a city to explore.');
          updateManualLocationVisibility(true);
          geolocateUser(true);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }

    function reverseGeocode(lat, lng) {
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=__GOOGLE_MAPS_API_KEY__`)
        .then((response) => response.json())
        .then((data) => {
          const result = data.results?.[0];
          if (result) {
            const locality = result.address_components.find((c) => c.types.includes('locality'));
            const admin = result.address_components.find((c) => c.types.includes('administrative_area_level_1'));
            if (locality || admin) {
              setLocationStatus(`Exploring around ${locality?.long_name || ''}${locality && admin ? ', ' : ''}${admin?.short_name || ''}`);
            }
          }
        })
        .catch(() => {
          setLocationStatus('Exploring your area.');
        });
    }

    function handleManualLocationSubmit(event) {
      event.preventDefault();
      const query = elements.manualLocationInput.value.trim();
      if (!query) return;
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=__GOOGLE_MAPS_API_KEY__`)
        .then((response) => response.json())
        .then((data) => {
          if (data.results && data.results.length) {
            const location = data.results[0].geometry.location;
            appState.currentLocation = location;
            appState.manualLocation = query;
            setLocationStatus(`Manual location: ${data.results[0].formatted_address}`);
            fetchLocalFacts(location.lat, location.lng);
            fetchWeather();
          } else {
            setLocationStatus('Could not find that location. Try another.');
          }
        })
        .catch(() => {
          setLocationStatus('Network issue locating that spot.');
        });
    }

    function openSubmenu(categoryKey) {
      const category = CATEGORY_CONFIG[categoryKey];
      if (!category) return;
      if (categoryKey === 'donate') {
        openDonateModal();
        return;
      }
      appState.currentCategory = categoryKey;
      elements.submenuTitle.textContent = category.title;
      elements.submenuSubtitle.textContent = category.vibe;
      elements.submenuOptions.innerHTML = '';
      category.subfilters.forEach((subfilter) => {
        const button = document.createElement('button');
        button.className = 'glass card-lift w-full rounded-2xl p-4 text-left shadow-xl transition';
        button.innerHTML = `<p class="font-display text-lg font-semibold text-amber">${subfilter.label}</p><p class="mt-1 text-sm text-ivory/70">Dialed in for ${category.title.toLowerCase()}.</p>`;
        button.addEventListener('click', () => startSearch(categoryKey, subfilter));
        elements.submenuOptions.appendChild(button);
      });
      togglePanel(elements.submenuPanel, true);
      const release = trapFocus(elements.submenuCard);
      elements.submenuCard.addEventListener('request-close', () => {
        release();
        togglePanel(elements.submenuPanel, false);
      }, { once: true });
    }

    function openDonateModal() {
      togglePanel(elements.donateModal, true);
      const release = trapFocus(elements.donateModalCard);
      elements.donateModalCard.addEventListener('request-close', () => {
        release();
        togglePanel(elements.donateModal, false);
      }, { once: true });
    }

    function closeDonateModal() {
      togglePanel(elements.donateModal, false);
    }

    function openResultsOverlay() {
      hideFacts();
      togglePanel(elements.resultsOverlay, true);
    }

    function closeResultsOverlay() {
      togglePanel(elements.resultsOverlay, false);
      showFacts();
    }

    function openDetailSheet(index) {
      const place = appState.currentResults[index];
      if (!place) return;
      appState.detailIndex = index;
      hideFacts();
      elements.detailTitle.textContent = place.name;
      elements.detailPhoto.innerHTML = '';
      const photoUrl = place.photos && place.photos.length ? place.photos[0].getUrl({ maxWidth: 600, maxHeight: 400 }) : null;
      const img = document.createElement('img');
      img.src = photoUrl || 'https://via.placeholder.com/600x400?text=Local+Explorer';
      img.alt = place.name;
      img.className = 'h-full w-full object-cover';
      elements.detailPhoto.appendChild(img);
      const distanceText = place.distance ? `<span class="rounded-full bg-steel/70 px-2 py-1 text-xs">${metersToImperial(place.distance)}</span>` : '';
      elements.detailMeta.innerHTML = `
        <span>${renderStars(place.rating)}</span>
        <span class="text-xs text-ivory/60">${place.user_ratings_total || 0} reviews</span>
        <span class="text-xs text-ivory/60">${place.price_level ? '$'.repeat(place.price_level) : 'Price n/a'}</span>
        ${distanceText}
      `;
      elements.detailChips.innerHTML = '';
      (place.types || []).slice(0, 3).forEach((type) => {
        const chip = document.createElement('span');
        chip.className = 'rounded-full bg-steel/70 px-3 py-1 text-xs uppercase tracking-widest';
        chip.textContent = type.replace(/_/g, ' ');
        elements.detailChips.appendChild(chip);
      });
      if (place.wheelchair_accessible_entrance) {
        const chip = document.createElement('span');
        chip.className = 'rounded-full bg-seafoam/30 px-3 py-1 text-xs uppercase tracking-[0.3em] text-seafoam';
        chip.textContent = '‚ôø Accessible';
        elements.detailChips.appendChild(chip);
      }
      elements.detailContact.innerHTML = `
        <p>${place.formatted_address || place.vicinity || 'Address unavailable'}</p>
        <p>${place.formatted_phone_number || 'Phone unavailable'}</p>
        <p>${place.website ? `<a href="${place.website}" target="_blank" rel="noopener" class="text-amber underline">${place.website}</a>` : 'Website unavailable'}</p>
      `;
      elements.detailReviews.innerHTML = '';
      if (place.reviews && place.reviews.length) {
        place.reviews.slice(0, 2).forEach((review) => {
          const cleanText = stripHtml(review.text).slice(0, 220);
          const card = document.createElement('article');
          card.className = 'glass rounded-2xl p-4 text-sm text-ivory/80 shadow-xl';
          card.innerHTML = `
            <p class="font-semibold text-seafoam">${review.author_name || 'Guest'}</p>
            <p class="text-xs text-ivory/60">${new Date(review.time * 1000).toLocaleDateString()}</p>
            <p class="mt-2 leading-relaxed">${cleanText}${review.text.length > cleanText.length ? '‚Ä¶' : ''}</p>
          `;
          elements.detailReviews.appendChild(card);
        });
      } else {
        elements.detailReviews.innerHTML = '<p class="text-sm text-ivory/60">No reviews yet. Be the first to share your experience!</p>';
      }
      updateSaveButtonState(place.place_id);
      elements.detailSheet.classList.remove('invisible');
      requestAnimationFrame(() => {
        elements.detailSheet.classList.remove('translate-y-full');
      });
      const focusRelease = trapFocus(elements.detailSheet);
      elements.detailSheet.addEventListener('request-close', () => {
        focusRelease();
        closeDetailSheet();
      }, { once: true });
    }

    function closeDetailSheet() {
      elements.detailSheet.classList.add('translate-y-full');
      elements.detailSheet.addEventListener('transitionend', () => {
        elements.detailSheet.classList.add('invisible');
        showFacts();
      }, { once: true });
    }
    function startSearch(categoryKey, subfilter) {
      if (!appState.currentLocation) {
        setLocationStatus('Set your location first to search.');
        return;
      }
      const category = CATEGORY_CONFIG[categoryKey];
      const label = `${category.title} ¬∑ ${subfilter.label}`;
      addRecentSearch(categoryKey, subfilter.label, label);
      openResultsOverlay();
      elements.resultsList.innerHTML = '<p class="mt-6 text-center text-sm text-ivory/60">Searching for standout places‚Ä¶</p>';
      performProgressiveSearch(subfilter, categoryKey)
        .then((results) => {
          if (!results.length) {
            elements.resultsList.innerHTML = '<p class="mt-6 text-center text-sm text-ivory/60">No matches yet. Try another vibe or widen your radius.</p>';
            elements.resultsHeader.textContent = '0 Spots';
            return;
          }
          appState.currentResults = results;
          renderResults();
        })
        .catch((error) => {
          console.error('Search error', error);
          elements.resultsList.innerHTML = '<p class="mt-6 text-center text-sm text-ivory/60">Something went wrong fetching results. Offline? Try again soon.</p>';
        });
    }

    function performProgressiveSearch(subfilter, categoryKey) {
      initializeMap();
      const allowedTypes = CATEGORY_CONFIG[categoryKey].allowedTypes;
      const baseLocation = appState.currentLocation;
      const radii = [2000, 5000, 10000, 20000, 50000];
      const moodBoost = appState.mood === 'adventurous' && subfilter.adventurous ? ' top rated ' : '';
      const keyword = `${subfilter.keyword}${moodBoost}`;

      return new Promise((resolve, reject) => {
        let accumulated = [];
        const searchNext = (index) => {
          if (index >= radii.length) {
            if (accumulated.length) {
              resolve(processResults(accumulated, allowedTypes, categoryKey, subfilter));
            } else {
              textSearchFallback();
            }
            return;
          }
          const request = {
            location: baseLocation,
            radius: radii[index],
            keyword,
            type: subfilter.types
          };
          appState.placesService.nearbySearch(request, (results, status, pagination) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results)) {
              accumulated = accumulated.concat(results);
              if (accumulated.length >= 12 || (pagination && pagination.hasNextPage)) {
                resolve(processResults(accumulated, allowedTypes, categoryKey, subfilter));
              } else {
                searchNext(index + 1);
              }
            } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
              searchNext(index + 1);
            } else {
              console.warn('Nearby search status', status);
              searchNext(index + 1);
            }
          });
        };

        const textSearchFallback = () => {
          const request = {
            query: `${subfilter.keyword} in ${appState.manualLocation || 'city'}`,
            location: baseLocation,
            radius: 50000
          };
          appState.placesService.textSearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results)) {
              resolve(processResults(results, allowedTypes, categoryKey, subfilter));
            } else {
              reject(status);
            }
          });
        };

        searchNext(0);
      });
    }

    function getDistanceFromLocation(placeLocation) {
      if (!placeLocation) return null;
      if (!google.maps.geometry || !google.maps.geometry.spherical) return null;
      const origin = new google.maps.LatLng(appState.currentLocation.lat, appState.currentLocation.lng);
      return google.maps.geometry.spherical.computeDistanceBetween(origin, placeLocation);
    }

    function processResults(results, allowedTypes, categoryKey, subfilter) {
      const filtered = results.filter((place) => {
        if (!place.place_id) return false;
        if ((place.types || []).some((type) => RETAIL_BLOCK_LIST.includes(type))) return false;
        const matchesAllowed = allowedTypes.some((type) => place.types?.includes(type));
        if (!matchesAllowed) return false;
        if (categoryKey === 'foodie') {
          if (subfilter.keyword.includes('restaurant')) {
            const keywordRoot = subfilter.keyword.split(' ')[0];
            if (!place.name.toLowerCase().includes(keywordRoot)) {
              const isGeneric = place.types?.includes('restaurant') && !subfilter.keyword.includes(place.name.toLowerCase());
              if (isGeneric && !place.name.toLowerCase().includes(keywordRoot)) return false;
            }
          }
        }
        if (categoryKey === 'outdoors') {
          const allowedOutdoors = ['park', 'campground', 'tourist_attraction', 'natural_feature'];
          if (!place.types?.some((type) => allowedOutdoors.includes(type))) return false;
        }
        if (categoryKey === 'dark') {
          if (place.types?.includes('cemetery')) return true;
          const name = place.name.toLowerCase();
          if (!DARK_KEYWORDS.some((keyword) => name.includes(keyword))) return false;
        }
        return true;
      });
      const deduped = [];
      const seen = new Set();
      filtered.forEach((place) => {
        if (!seen.has(place.place_id)) {
          seen.add(place.place_id);
          const location = place.geometry?.location;
          place.distance = location ? getDistanceFromLocation(location) : null;
          deduped.push(place);
        }
      });
      deduped.sort((a, b) => {
        const ratingDiff = (b.rating || 0) - (a.rating || 0);
        if (ratingDiff !== 0) return ratingDiff;
        const reviewsDiff = (b.user_ratings_total || 0) - (a.user_ratings_total || 0);
        if (reviewsDiff !== 0) return reviewsDiff;
        const distanceDiff = (a.distance || Infinity) - (b.distance || Infinity);
        if (distanceDiff !== 0) return distanceDiff;
        return a.name.localeCompare(b.name);
      });
      return deduped.slice(0, 20);
    }

    function renderResults() {
      elements.resultsList.innerHTML = '';
      elements.resultsHeader.textContent = `${appState.currentResults.length} Spots`;
      appState.currentResults.forEach((place, index) => {
        const card = document.createElement('article');
        card.className = 'glass card-lift mb-4 rounded-2xl p-4 shadow-xl transition';
        const photoUrl = place.photos && place.photos.length ? place.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 }) : 'https://via.placeholder.com/400x200?text=Local+Explorer';
        const distanceText = place.distance ? `<span class="rounded-full bg-steel/80 px-2 py-1 text-xs">${metersToImperial(place.distance)}</span>` : '';
        card.innerHTML = `
          <img src="${photoUrl}" alt="${place.name}" class="h-40 w-full rounded-2xl object-cover" />
          <div class="mt-3 flex items-start justify-between">
            <div>
              <h3 class="font-display text-xl font-semibold text-amber">${place.name}</h3>
              <p class="text-sm text-ivory/80">${place.vicinity || place.formatted_address || 'Address unavailable'}</p>
            </div>
            <div class="text-right text-sm text-ivory/70">${renderStars(place.rating)}<div>${place.user_ratings_total || 0} reviews</div></div>
          </div>
          <div class="mt-3 flex items-center justify-between text-sm text-ivory/70">
            <span>${place.price_level ? '$'.repeat(place.price_level) : 'Price n/a'}</span>
            ${distanceText}
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <button class="rounded-xl bg-seafoam px-3 py-2 text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-seafoam" data-index="${index}" data-action="detail">Details</button>
            <a class="rounded-xl bg-amber px-3 py-2 text-center text-sm font-semibold text-deck shadow-xl focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}" target="_blank" rel="noopener">Map</a>
          </div>
        `;
        card.querySelector('[data-action="detail"]').addEventListener('click', () => openDetailSheet(index));
        elements.resultsList.appendChild(card);
      });
    }

    function toggleSavePlace() {
      const place = appState.currentResults[appState.detailIndex];
      if (!place) return;
      const exists = appState.savedPlaces.some((p) => p.place_id === place.place_id);
      if (exists) {
        appState.savedPlaces = appState.savedPlaces.filter((p) => p.place_id !== place.place_id);
      } else {
        appState.savedPlaces.push({
          place_id: place.place_id,
          name: place.name,
          vicinity: place.vicinity,
          formatted_address: place.formatted_address
        });
      }
      updateSaveButtonState(place.place_id);
      renderSavedPlaces();
      saveToLocalStorage();
    }

    function handleDetailNavigation(direction) {
      const nextIndex = appState.detailIndex + direction;
      if (nextIndex >= 0 && nextIndex < appState.currentResults.length) {
        openDetailSheet(nextIndex);
      }
    }
    function activateCompass(place) {
      togglePanel(elements.compassModal, true);
      const release = trapFocus(elements.compassModalCard);
      elements.compassModalCard.addEventListener('request-close', () => {
        release();
        closeCompass();
      }, { once: true });
      elements.compassDistance.textContent = 'Calibrating‚Ä¶';
      elements.compassInstruction.textContent = 'Requesting sensors';
      if (!('geolocation' in navigator)) {
        elements.compassInstruction.textContent = 'Geolocation unavailable.';
        return;
      }
      const destination = place.geometry?.location;
      if (!destination) {
        elements.compassInstruction.textContent = 'No destination coordinates. Open map instead.';
        return;
      }
      appState.currentStepIndex = 0;
      if (appState.compassWatchId) navigator.geolocation.clearWatch(appState.compassWatchId);
      appState.compassWatchId = navigator.geolocation.watchPosition((position) => {
        const origin = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        const dest = new google.maps.LatLng(destination.lat(), destination.lng());
        appState.directionsService.route({
          origin,
          destination: dest,
          travelMode: google.maps.TravelMode.WALKING
        }, (result, status) => {
          if (status === google.maps.DirectionsStatus.OK) {
            appState.currentRoute = result.routes[0];
            updateCompassStep(position);
          }
        });
      }, () => {
        elements.compassInstruction.textContent = 'Live location denied.';
      }, { enableHighAccuracy: true });
      if (typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission) {
        DeviceOrientationEvent.requestPermission().then((response) => {
          if (response === 'granted') {
            appState.orientationHandler = (event) => {
              const heading = event.alpha;
              if (heading != null) {
                const bearing = getStepBearing();
                const rotation = bearing - heading;
                elements.compassArrow.style.transform = `rotate(${rotation}deg)`;
              }
            };
            window.addEventListener('deviceorientation', appState.orientationHandler, true);
          }
        }).catch(() => {
          elements.compassInstruction.textContent = 'Orientation permission denied.';
        });
      } else {
        appState.orientationHandler = (event) => {
          const heading = event.alpha;
          if (heading != null) {
            const bearing = getStepBearing();
            const rotation = bearing - heading;
            elements.compassArrow.style.transform = `rotate(${rotation}deg)`;
          }
        };
        window.addEventListener('deviceorientation', appState.orientationHandler, true);
      }
    }

    function getStepBearing() {
      if (!appState.currentRoute) return 0;
      const steps = appState.currentRoute.legs[0].steps;
      const step = steps[Math.min(appState.currentStepIndex, steps.length - 1)];
      if (!step) return 0;
      if (google.maps.geometry && google.maps.geometry.spherical) {
        return google.maps.geometry.spherical.computeHeading(step.start_location, step.end_location);
      }
      return 0;
    }

    function updateCompassStep(position) {
      if (!appState.currentRoute) return;
      const steps = appState.currentRoute.legs[0].steps;
      const step = steps[appState.currentStepIndex];
      if (!step) {
        elements.compassInstruction.textContent = 'Arrived!';
        elements.compassDistance.textContent = '0 ft';
        handleGuideSpeech('You have arrived. Enjoy!');
        return;
      }
      const userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      const stepEnd = step.end_location;
      const distance = google.maps.geometry?.spherical?.computeDistanceBetween(userLocation, stepEnd) || 0;
      elements.compassDistance.textContent = metersToImperial(distance);
      elements.compassInstruction.textContent = step.instructions ? stripHtml(step.instructions) : 'Continue straight';
      if (distance < 15.24) {
        appState.currentStepIndex += 1;
        const nextInstruction = steps[appState.currentStepIndex]?.instructions ? stripHtml(steps[appState.currentStepIndex].instructions) : 'Arrived';
        handleGuideSpeech(`Next: ${nextInstruction}`);
      }
    }

    function closeCompass() {
      togglePanel(elements.compassModal, false);
      if (appState.compassWatchId) navigator.geolocation.clearWatch(appState.compassWatchId);
      appState.compassWatchId = null;
      if (appState.orientationHandler) window.removeEventListener('deviceorientation', appState.orientationHandler, true);
      appState.orientationHandler = null;
      handleGuideSpeech(null, true);
      appState.guideActive = false;
      elements.guideMeBtn.setAttribute('aria-pressed', 'false');
      elements.guideMeBtn.textContent = 'Guide Me ‚ñ∂Ô∏é';
    }

    function handleGuideSpeech(text, forceStop = false) {
      if (!appState.speechSynthesis) return;
      if (appState.speechSynthesis.speaking || forceStop) {
        appState.speechSynthesis.cancel();
      }
      if (!text) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = appState.voiceSettings.rate;
      if (appState.voiceSettings.voiceURI) {
        const voice = appState.speechSynthesis.getVoices().find((v) => v.voiceURI === appState.voiceSettings.voiceURI);
        if (voice) utterance.voice = voice;
      }
      appState.speechSynthesis.speak(utterance);
    }

    function toggleGuideSpeech() {
      if (appState.guideActive) {
        handleGuideSpeech(null, true);
        appState.guideActive = false;
        elements.guideMeBtn.setAttribute('aria-pressed', 'false');
        elements.guideMeBtn.textContent = 'Guide Me ‚ñ∂Ô∏é';
      } else {
        handleGuideSpeech(elements.compassInstruction.textContent || 'Starting guidance.');
        appState.guideActive = true;
        elements.guideMeBtn.setAttribute('aria-pressed', 'true');
        elements.guideMeBtn.textContent = 'Pause Guide';
      }
    }

    function populateVoices() {
      if (!appState.speechSynthesis) return;
      const voices = appState.speechSynthesis.getVoices().filter((voice) => voice.lang.startsWith('en'));
      elements.guideVoicePicker.innerHTML = '';
      voices.forEach((voice) => {
        const option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = `${voice.name} (${voice.lang})`;
        if (appState.voiceSettings.voiceURI === voice.voiceURI) option.selected = true;
        elements.guideVoicePicker.appendChild(option);
      });
      if (!appState.voiceSettings.voiceURI && voices.length) {
        appState.voiceSettings.voiceURI = voices[0].voiceURI;
        saveToLocalStorage();
      }
      elements.guideVoiceRate.value = appState.voiceSettings.rate;
    }

    function handleVoiceChange() {
      appState.voiceSettings.voiceURI = elements.guideVoicePicker.value;
      saveToLocalStorage();
    }

    function handleVoiceRateChange() {
      appState.voiceSettings.rate = parseFloat(elements.guideVoiceRate.value) || 1;
      saveToLocalStorage();
    }
    function clearAllData() {
      localStorage.removeItem('localExplorerSaved');
      localStorage.removeItem('localExplorerRecent');
      localStorage.removeItem('localExplorerVoice');
      appState.savedPlaces = [];
      appState.recentSearches = [];
      appState.voiceSettings = { voiceURI: null, rate: 1 };
      renderSavedPlaces();
      renderRecentSearches();
    }

    function handleMyListOpen() {
      togglePanel(elements.myListPanel, true);
      const release = trapFocus(elements.myListCard);
      elements.myListCard.addEventListener('request-close', () => {
        release();
        togglePanel(elements.myListPanel, false);
      }, { once: true });
    }

    function handleDarkMode() {
      openSubmenu('dark');
    }

    function handleDonateQuick(event) {
      const amount = event.currentTarget.dataset.amount;
      const note = encodeURIComponent(`Local Explorer donation ${amount}`);
      elements.venmoDeepLink.href = `venmo://pay?txn=pay&recipients=__VENMO_HANDLE__&amount=${amount}&note=${note}`;
    }

    function handleRecentSearchClick(event) {
      const button = event.target.closest('.recent-search');
      if (!button) return;
      const category = button.dataset.category;
      const filterKey = button.dataset.filter;
      const categoryConfig = CATEGORY_CONFIG[category];
      if (!categoryConfig) return;
      const subfilter = categoryConfig.subfilters.find((sub) => sub.label === filterKey);
      if (subfilter) startSearch(category, subfilter);
    }

    function handleSavedListClick(event) {
      if (event.target.classList.contains('remove-saved')) {
        const id = event.target.dataset.id;
        appState.savedPlaces = appState.savedPlaces.filter((place) => place.place_id !== id);
        renderSavedPlaces();
        saveToLocalStorage();
      }
      if (event.target.classList.contains('share-saved')) {
        const id = event.target.dataset.id;
        const place = appState.savedPlaces.find((p) => p.place_id === id);
        if (!place) return;
        if (navigator.share) {
          navigator.share({
            title: place.name,
            text: `Meet me at ${place.name}!`,
            url: `https://www.google.com/maps/search/?api=1&query_place_id=${place.place_id}`
          }).catch(() => {});
        } else {
          alert('Sharing unsupported on this device. Copy the Maps link instead.');
        }
      }
    }

    function handleDetailAction(event) {
      const button = event.target.closest('.detail-action');
      if (!button) return;
      const place = appState.currentResults[appState.detailIndex];
      if (!place) return;
      const action = button.dataset.action;
      switch (action) {
        case 'map':
          window.open(`https://www.google.com/maps/search/?api=1&query_place_id=${place.place_id}`, '_blank', 'noopener');
          break;
        case 'website':
          if (place.website) {
            window.open(place.website, '_blank', 'noopener');
          } else {
            alert('Website unavailable for this place.');
          }
          break;
        case 'share':
          if (navigator.share) {
            navigator.share({ title: place.name, text: place.vicinity || place.formatted_address, url: `https://www.google.com/maps/search/?api=1&query_place_id=${place.place_id}` }).catch(() => {});
          } else {
            alert('Share feature unsupported in this browser.');
          }
          break;
        case 'compass':
          activateCompass(place);
          break;
        default:
          break;
      }
    }

    function closePanelsOnEscape(event) {
      if (event.key !== 'Escape') return;
      if (!elements.detailSheet.classList.contains('invisible')) closeDetailSheet();
      if (!elements.resultsOverlay.classList.contains('invisible')) closeResultsOverlay();
      if (!elements.submenuPanel.classList.contains('invisible')) togglePanel(elements.submenuPanel, false);
      if (!elements.compassModal.classList.contains('invisible')) closeCompass();
      if (!elements.donateModal.classList.contains('invisible')) closeDonateModal();
      if (!elements.myListPanel.classList.contains('invisible')) togglePanel(elements.myListPanel, false);
    }

    function fetchWeather() {
      if (!appState.currentLocation) return;
      const { lat, lng } = appState.currentLocation;
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&temperature_unit=fahrenheit`)
        .then((response) => response.json())
        .then((data) => {
          if (data.current_weather) {
            const { temperature, windspeed } = data.current_weather;
            elements.quickWeather.textContent = `${temperature.toFixed(0)}¬∞F ¬∑ Wind ${windspeed.toFixed(0)} mph`;
          } else {
            elements.quickWeather.textContent = 'Weather data unavailable.';
          }
        })
        .catch(() => {
          elements.quickWeather.textContent = 'Offline: weather will refresh later.';
        });
    }

    function handleSurpriseMe() {
      const categories = Object.keys(CATEGORY_CONFIG).filter((key) => key !== 'donate');
      const randomCategoryKey = categories[Math.floor(Math.random() * categories.length)];
      const category = CATEGORY_CONFIG[randomCategoryKey];
      const subfilter = category.subfilters[Math.floor(Math.random() * category.subfilters.length)];
      startSearch(randomCategoryKey, subfilter);
    }

    function handleMoodToggle() {
      appState.mood = appState.mood === 'adventurous' ? 'chill' : 'adventurous';
      elements.moodToggle.textContent = appState.mood === 'adventurous' ? 'Adventurous' : 'Chill';
      elements.moodToggle.setAttribute('aria-pressed', appState.mood === 'adventurous' ? 'false' : 'true');
    }
    function initEventListeners() {
      elements.toggleManualLocation.addEventListener('click', handleToggleManualLocation);
      elements.manualLocationForm.addEventListener('submit', handleManualLocationSubmit);
      elements.refreshLocationBtn.addEventListener('click', () => geolocateUser());
      elements.categoryButtons.forEach((button) => button.addEventListener('click', () => openSubmenu(button.dataset.category)));
      elements.submenuClose.addEventListener('click', () => togglePanel(elements.submenuPanel, false));
      elements.submenuBackMain.addEventListener('click', () => togglePanel(elements.submenuPanel, false));
      elements.resultsBackBtn.addEventListener('click', () => {
        closeResultsOverlay();
        showFacts();
      });
      elements.mapAllBtn.addEventListener('click', () => {
        if (!appState.currentResults.length) return;
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(appState.currentResults[0].name)}&destination_place_id=${appState.currentResults[0].place_id}`, '_blank', 'noopener');
      });
      elements.detailPrev.addEventListener('click', () => handleDetailNavigation(-1));
      elements.detailNext.addEventListener('click', () => handleDetailNavigation(1));
      elements.savePlaceBtn.addEventListener('click', toggleSavePlace);
      elements.detailButtons.addEventListener('click', handleDetailAction);
      elements.compassClose.addEventListener('click', closeCompass);
      elements.guideMeBtn.addEventListener('click', toggleGuideSpeech);
      elements.compassMapBtn.addEventListener('click', () => {
        const place = appState.currentResults[appState.detailIndex];
        if (place) window.open(`https://www.google.com/maps/dir/?api=1&destination_place_id=${place.place_id}`, '_blank', 'noopener');
      });
      elements.donateClose.addEventListener('click', closeDonateModal);
      elements.donateQuickButtons.forEach((button) => button.addEventListener('click', handleDonateQuick));
      elements.darkModeBtn.addEventListener('click', handleDarkMode);
      elements.surpriseMeBtn.addEventListener('click', handleSurpriseMe);
      elements.myListBtn.addEventListener('click', handleMyListOpen);
      elements.myListClose.addEventListener('click', () => togglePanel(elements.myListPanel, false));
      elements.savedList.addEventListener('click', handleSavedListClick);
      elements.clearAllData.addEventListener('click', clearAllData);
      elements.recentSearches.addEventListener('click', handleRecentSearchClick);
      elements.recentSearchesBtn.addEventListener('click', handleMyListOpen);
      elements.guideVoicePicker.addEventListener('change', handleVoiceChange);
      elements.guideVoiceRate.addEventListener('input', handleVoiceRateChange);
      elements.donateModal.addEventListener('click', (event) => {
        if (event.target === elements.donateModal) closeDonateModal();
      });
      elements.compassModal.addEventListener('click', (event) => {
        if (event.target === elements.compassModal) closeCompass();
      });
      elements.myListPanel.addEventListener('click', (event) => {
        if (event.target === elements.myListPanel) togglePanel(elements.myListPanel, false);
      });
      elements.submenuPanel.addEventListener('click', (event) => {
        if (event.target === elements.submenuPanel) togglePanel(elements.submenuPanel, false);
      });
      document.addEventListener('keydown', closePanelsOnEscape);
    }

    function handleServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('serviceworker.js').catch((error) => console.error('SW registration failed', error));
      }
    }

    function initStreetViewLayer() {
      elements.streetViewLayer.classList.add('no-pointer');
    }

    function renderSavedPlacesOnLoad() {
      renderSavedPlaces();
      renderRecentSearches();
    }

    function initApp() {
      loadFromLocalStorage();
      renderFocusGroupList();
      renderSavedPlacesOnLoad();
      geolocateUser();
      initEventListeners();
      initStreetViewLayer();
      handleServiceWorker();
      if ('speechSynthesis' in window) {
        populateVoices();
        window.speechSynthesis.onvoiceschanged = populateVoices;
      }
    }

    window.addEventListener('load', initApp);
  </script>
</body>
</html>
