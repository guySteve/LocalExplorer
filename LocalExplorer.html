<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Local Explorer</title>
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  Â  Â  <meta name="theme-color" content="#f8f7f2">
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
Â  Â  <script src="key.js"></script>
Â  <style>
Â  Â  :root {
Â  Â  Â  /* Modern rugged naval explorer palette */
Â  Â  Â  --background: #f5f5f2; /* offâ€‘white */
Â  Â  Â  --card: #061f3e;Â  Â  Â  /* deep navy blue reminiscent of naval uniforms */
Â  Â  Â  --primary: #e95420;Â  Â /* bright orange accent for callâ€‘toâ€‘actions */
Â  Â  Â  --secondary: #0a324a; /* dark teal for secondary highlights */
Â  Â  Â  --text-dark: #061f3e;
Â  Â  Â  --text-light: #ffffff;
Â  Â  Â  --accent: #b38a5e;Â  Â  /* ropeâ€‘tan accent colour */
Â  Â  Â  --radius: 12px;
Â  Â  }
Â  Â  * {
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'Raleway', sans-serif;
Â  Â  Â  background-color: var(--background);
Â  Â  Â  color: var(--text-dark);
Â  Â  Â  overflow-x: hidden;
Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  overscroll-behavior: contain; /* Prevent scroll bounce on mobile */
Â  Â  }
Â  Â  h1, h2, h3 {
Â  Â  Â  font-family: 'Poppins', sans-serif;
Â  Â  Â  margin: 0;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  color: var(--card);
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 1rem 0;
Â  Â  Â  letter-spacing: 0.05rem;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  font-weight: 700;
Â  Â  Â  border-bottom: 3px solid var(--accent);
Â  Â  }
Â  Â  #locationDisplay {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  color: var(--card);
Â  Â  Â  font-weight: 500;
Â  Â  Â  letter-spacing: 0.02rem;
Â  Â  }
Â  Â  #manualInputContainer {
Â  Â  Â  display: none;
Â  Â  Â  margin: 0.5rem auto;
Â  Â  Â  max-width: 90%;
Â  Â  }
Â  Â  #manualInputContainer input {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.6rem;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  border: 1px solid var(--accent);
Â  Â  Â  font-size: 1rem;
Â  Â  Â  background-color: var(--background);
Â  Â  Â  color: var(--card);
Â  Â  Â  outline: none;
Â  Â  }
Â  Â  #factWidget {
Â  Â  Â  background-color: var(--secondary);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  margin: 0.5rem auto;
Â  Â  Â  padding: 0.75rem 1rem;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  max-width: 90%;
Â  Â  Â  min-height: 80px;
Â  Â  Â  border: 2px dashed var(--accent);
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  }

Â  Â  /* Single fact bubble styling */
Â  Â  #factBubble {
Â  Â  Â  background-color: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  padding: 0.7rem 1rem;
Â  Â  Â  border-radius: 1rem;
Â  Â  Â  border: 2px solid var(--accent);
Â  Â  Â  /* Expand to full width within its container for better readability */
Â  Â  Â  max-width: 100%;
Â  Â  Â  min-height: 80px;
Â  Â  Â  margin: auto;
Â  Â  Â  text-align: center;
Â  Â  Â  line-height: 1.4;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
Â  Â  Â  transition: transform 0.4s ease, opacity 0.4s ease;
Â  Â  }
Â  Â  /* Out animation for bubble */
Â  Â  #factBubble.out {
Â  Â  Â  transform: translateY(20px);
Â  Â  Â  opacity: 0;
Â  Â  }
Â  Â  .filters {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  max-width: 90%;
Â  Â  Â  margin: 1rem auto;
Â  Â  }
Â  Â  .filter-btn {
Â  Â  Â  background-color: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: 1px solid var(--accent);
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.1s ease, background-color 0.2s ease;
Â  Â  }
Â  Â  .filter-btn:active {
Â  Â  Â  transform: scale(0.96);
Â  Â  Â  background-color: var(--secondary);
Â  Â  }

Â  Â  /* Special styling for the support button to evoke a steel anchor */
Â  Â  .support-btn {
Â  Â  Â  background: linear-gradient(145deg, #48586b, #7b8b9e);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: 1px solid #a4b0bc;
Â  Â  Â  box-shadow: inset 1px 1px 2px rgba(255,255,255,0.3), inset -2px -2px 3px rgba(0,0,0,0.4);
Â  Â  }
Â  Â  #primaryActions {
Â  Â  Â  max-width: 90%;
Â  Â  Â  margin: 1rem auto;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 0.5rem;
Â  Â  }
Â  Â  #myListBtn, #surpriseBtn {
Â  Â  Â  border: none;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  font-size: 1rem;
Â  Â  Â  padding: 0.8rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 0.5rem;
Â  Â  }
Â  Â  #myListBtn {
Â  Â  Â  background-color: var(--secondary);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: 1px solid var(--accent);
Â  Â  }
Â  Â  #surpriseBtn {
Â  Â  Â  background-color: var(--primary);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  font-weight: 600;
Â  Â  Â  border: 1px solid var(--primary);
Â  Â  }
Â  Â  #myPlanBtn {
Â  Â  Â  background-color: var(--secondary);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: 1px solid var(--accent);
Â  Â  }
Â  Â  #donateBtn {
Â  Â  Â  /* Steel effect for rugged naval style */
Â  Â  Â  background: linear-gradient(145deg, #48586b, #7b8b9e);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: 1px solid #a4b0bc;
Â  Â  Â  box-shadow: inset 1px 1px 2px rgba(255,255,255,0.3), inset -2px -2px 3px rgba(0,0,0,0.4);
Â  Â  }
Â  Â  #ghostBtn {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 1rem;
Â  Â  Â  left: 1rem;
Â  Â  Â  background: transparent;
Â  Â  Â  border: none;
Â  Â  Â  font-size: 2.2rem;
Â  Â  Â  opacity: 0.4;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: opacity 0.2s, transform 0.3s;
Â  Â  Â  z-index: 30;
Â  Â  }
Â  Â  #ghostBtn:hover {
Â  Â  Â  opacity: 1;
Â  Â  Â  transform: rotate(5deg);
Â  Â  }
Â  Â  /* Modal overlay */
Â  Â  .modal {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: rgba(0,0,0,0.6);
Â  Â  Â  display: none;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  z-index: 20;
Â  Â  }
Â  Â  .modal.active {
Â  Â  Â  display: flex;
Â  Â  Â  /* Blur underlying content for focus */
Â  Â  Â  backdrop-filter: blur(2px);
Â  Â  }

Â  Â  /* When a modal is open, prevent scrolling on body */
Â  Â  body.modal-open {
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  background-color: var(--background);
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  max-height: 80vh;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  width: 92%;
Â  Â  Â  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
Â  Â  Â  padding: 1rem;
Â  Â  Â  position: relative;
Â  Â  Â  border: 2px solid var(--accent);
Â  Â  Â  transform: scale(0.95) translateY(20px);
Â  Â  Â  transition: transform 0.3s ease;
Â  Â  }

Â  Â  /* Animate modal content expansion */
Â  Â  .modal.active .modal-content {
Â  Â  Â  transform: scale(1) translateY(0);
Â  Â  }
Â  Â  .modal-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  }
Â  Â  .close-btn {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: var(--card);
Â  Â  Â  padding: 0.2rem;
Â  Â  }
Â  Â  .subMenuList button,
Â  Â  .results-list button {
Â  Â  Â  width: 100%;
Â  Â  Â  background: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: none;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.2s;
Â  Â  }

Â  Â  /* Special button for surprise actions */
Â  Â  .special-btn {
Â  Â  Â  background: var(--primary);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .subMenuList button:hover,
Â  Â  .results-list button:hover {
Â  Â  Â  background: #1e293b;
Â  Â  }
Â  Â  .results-item {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.75rem;
Â  Â  }
Â  Â  .results-item img {
Â  Â  Â  width: 60px;
Â  Â  Â  height: 60px;
Â  Â  Â  object-fit: cover;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .results-info {
Â  Â  Â  flex-grow: 1;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .results-info h4 {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'Poppins', sans-serif;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  color: var(--text-light);
Â  Â  Â  letter-spacing: 0.03rem;
Â  Â  }
Â  Â  .results-info .rating {
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  color: #fbbf24;
Â  Â  }
Â  Â  /* Details sheet */
Â  Â  #detailsSheet {
Â  Â  Â  position: fixed;
Â  Â  Â  left: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 70vh;
Â  Â  Â  background-color: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border-radius: 20px 20px 0 0;
Â  Â  Â  transform: translateY(100%);
Â  Â  Â  transition: transform 0.35s ease;
Â  Â  Â  z-index: 25;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  /* Details sheet close button */
Â  Â  .sheet-close {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0.3rem;
Â  Â  Â  right: 0.5rem;
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  color: var(--text-light);
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  #detailsSheet.active {
Â  Â  Â  transform: translateY(0);
Â  Â  }
Â  Â  #detailsMap {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 40%;
Â  Â  Â  background: #000;
Â  Â  }
Â  Â  #detailsContent {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 60%;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 1rem;
Â  Â  Â  background: rgba(17,24,39,0.95);
Â  Â  Â  backdrop-filter: blur(4px);
Â  Â  }
Â  Â  #detailsContent h3 {
Â  Â  Â  margin-top: 0;
Â  Â  Â  font-size: 1.4rem;
Â  Â  }
Â  Â  #detailsContent .stars {
Â  Â  Â  color: #fbbf24;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  margin-right: 0.5rem;
Â  Â  }
Â  Â  #detailsContent .price {
Â  Â  Â  color: #fbbf24;
Â  Â  Â  font-size: 1.1rem;
Â  Â  }
Â  Â  #detailsActions {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  margin-top: 0.75rem;
Â  Â  }
Â  Â  #detailsActions button {
Â  Â  Â  flex: 1;
Â  Â  Â  min-width: 100px;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  padding: 0.5rem;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 0.3rem;
Â  Â  }
Â  Â  #saveBtn {
Â  Â  Â  background: #4b5563;
Â  Â  Â  color: var(--text-light);
Â  Â  }
Â  Â  #openMapsBtn, #websiteBtn {
Â  Â  Â  background: #334155;
Â  Â  Â  color: var(--text-light);
Â  Â  }
Â  Â  #shareBtn {
Â  Â  Â  background: var(--primary);
Â  Â  Â  color: var(--text-light);
Â  Â  }
Â  Â  #compassBtn {
Â  Â  Â  background: #0f172a;
Â  Â  Â  color: var(--text-light);
Â  Â  }
Â  Â  /* Accordion */
Â  Â  .accordion {
Â  Â  Â  background: #1e293b;
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border: none;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  width: 100%;
Â  Â  Â  text-align: left;
Â  SÂ  Â  outline: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .accordion-content {
Â  Â  Â  background: #1e293b;
Â  Â  Â  max-height: 0;
Â  Â  Â  overflow: hidden;
Â  Â  Â  transition: max-height 0.3s ease;
Â  Â  Â  border-radius: 0 0 var(--radius) var(--radius);
Â  Â  Â  padding: 0 0.5rem;
Â  Â  }
Â  Â  .accordion.active + .accordion-content {
Â  Â  Â  max-height: 300px;
Â  Â  Â  padding: 0.5rem;
Â  Â  }
Â  Â  /* My List modal */
Â  Â  #myListModal .results-list button {
Â  Â  Â  background: var(--card);
Â  Â  }
Â  Â  #myListModal .empty-state {
Â  Â  Â  text-align: center;
Â  Â  Â  color: var(--card);
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  margin: 1rem 0;
Â  Â  }

Â  Â  /* Improve styling for list and plan items */
Â  Â  #myListModal .results-list button,
Â  Â  #planModal .results-list button {
Â  Â  Â  background-color: var(--secondary);
Â  Â  Â  border: 1px solid var(--accent);
Â  Â  Â  margin-bottom: 0.4rem;
Â  Â  Â  padding: 0.7rem;
Â  Â  }
Â  Â  #myListModal .results-list button:hover,
Â  Â  #planModal .results-list button:hover {
Â  Â  Â  background-color: #1e293b;
Â  Â  }
Â  Â  /* Compass & navigation overlay */
Â  Â  #compassOverlay {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 0.5rem;
Â  Â  Â  right: 0.5rem;
Â  Â  Â  transform: translateY(100%);
Â  Â  Â  width: 300px;
Â  Â  Â  max-width: 90%;
Â  Â  Â  background: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
Â  Â  Â  z-index: 40;
Â  Â  Â  transition: transform 0.4s ease;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #compassOverlay.active {
Â  Â  Â  transform: translateY(0);
Â  Â  }
Â  Â  #compassTop {
Â  Â  Â  padding: 1rem;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  #compassArrow {
Â  Â  Â  width: 0;
Â  Â  Â  height: 0;
Â  Â  Â  border-top: 45px solid var(--primary);
Â  Â  Â  border-left: 12px solid transparent;
Â  Â  Â  border-right: 12px solid transparent;
Â  Â  Â  transform-origin: center bottom;
Â  Â  Â  position: absolute;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translate(-50%, -50%) rotate(0deg);
Â  Â  }
Â  Â  /* Radar scanning container */
Â  Â  #radar {
Â  Â  Â  position: relative;
Â  Â  Â  width: 140px;
Â  Â  Â  height: 140px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: radial-gradient(circle at center, rgba(233,84,32,0.4) 0%, transparent 70%);
Â  Â  Â  border: 2px solid var(--primary);
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #miniMap {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  overflow: hidden;
Â  Â  Â  z-index: 0;
Â  Â  }
Â  Â  #radar::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 50%;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  transform-origin: left center;
Â  Â  Â  background: linear-gradient(to right, transparent, var(--primary) 5%, transparent 15%);
Â  Â  Â  animation: radarSweep 6s linear infinite;
Â  Â  }
Â  Â  @keyframes radarSweep {
Â  Â  Â  from { transform: rotate(0deg); }
Â  Â  Â  to { transform: rotate(360deg); }
Â  Â  }
Â  Â  #compassControls {
Â  Â  Â  padding: 0.5rem 1rem 1rem 1rem;
Read-only
Â  Â  Â  border-top: 1px solid var(--secondary);
Â  Â  Â  background-color: var(--secondary);
Â  Â  }
Â  Â  #voiceSelect {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.4rem;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  border: 1px solid var(--accent);
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  background-color: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  }
Â  Â  #navigationButtons {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  }
Â  Â  #navigationButtons button {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 0.4rem;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  border: 1px solid var(--accent);
Â  SÂ  Â  background-color: var(--card);
Â  Â  Â  color: var(--text-light);
Â  Â  Â  cursor: pointer;
Read-only
Â  Â  }
Â  Â  #navigationButtons button:disabled {
Â  Â  Â  opacity: 0.5;
Â  Â  Â  cursor: not-allowed;
Â  Â  }
Â  Â  #directionsList {
Â  Â  Â  max-height: 150px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  line-height: 1.3;
Â  Â  }

Â  Â  #radarControls label {
Â  Â  Â  color: var(--text-light);
Â  Â  }
Â  Â  /* Hide map container used for Places Service */
Â  Â  #hiddenMap {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
read-only
Â  Â  Â  width: 1px;
Â  Â  Â  height: 1px;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  /* Responsive adjustments */
Â  Â  @media (min-width: 768px) {
Â  Â  Â  h1 { font-size: 2rem; }
Â  Â  Â  #detailsSheet {
Â  Â  Â  Â  height: 60vh;
Â  Â  Â  }
Â  Â  Â  #detailsMap { height: 45%; }
SÂ  Â  #detailsContent { height: 55%; }
Â  Â  }
Â  </style>
</head>
<body>
Â  <h1>Local Explorer</h1>
Â  <div id="locationDisplay">Determining your locationâ€¦</div>
Â  <div id="manualInputContainer">
Â  Â  <input type="text" id="manualInput" placeholder="Enter a location">
Â  </div>
Â  <div id="factWidget">
Â  Â  <div id="factBubble">Fetching local factsâ€¦</div>
Â  </div>
Â  <div class="filters" id="filterGrid">
Â  Â  Â  </div>
Â  <div id="primaryActions">
Â  Â  <button id="myListBtn">ğŸ“‹ My List</button>
Â  Â  <button id="myPlanBtn">ğŸ—ºï¸ My Plan</button>
Â  Â  <button id="surpriseBtn">ğŸ¤· Surprise Me!</button>
Â  </div>
Â  <button id="ghostBtn">ğŸ‘»</button>

Â  Â  <div id="hiddenMap"></div>

Â  Â  <div id="subMenuModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3 id="subMenuTitle">Categories</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeSubMenu">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="subMenuList" id="subMenuList"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="resultsModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3 id="resultsTitle">Results</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeResults">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="results-list" id="resultsList"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="myListModal" class="modal">
Â  SÂ  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3>My List</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeMyList">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="results-list" id="myListContent"></div>
Â  Â  Â  <div class="empty-state" id="myListEmpty" style="display:none;">Your saved places will appear here.</div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="planModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3>My Plan</h3>
Â  Â  Â  Â  <button class="close-btn" id="closePlan">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="planSummary" style="margin-bottom:0.5rem; font-size:0.85rem; color:var(--card);"></div>
Â  Â  Â  <div class="results-list" id="planContent"></div>
Â  Â  Â  <div class="empty-state" id="planEmpty" style="display:none;">Your plan is empty. Add places to your plan from the details view.</div>
Â  Â  Â  <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
Â  Â  Â  Â  <button id="sharePlanBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--primary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Share Plan</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="donateModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3>Support Local Explorer</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeDonate">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <p style="color: var(--card); font-size: 0.9rem; margin-bottom: 1rem;">
Â  Â  Â  Â  If you enjoy using Local Explorer, consider supporting development. Donations help keep this sailorâ€™s app afloat!
Â  Â  Â  </p>
Â  Â  Â  <p style="color: var(--card); font-size: 0.9rem; margin-bottom: 1rem; text-align:center;">
Â  Â  Â  Â  Venmo: <strong>@Stephen-Mohamed-1</strong>
Â  Â  Â  </p>
Â  Â  Â  <div style="display:flex; gap:0.5rem;">
Â  Â  Â  Â  <button id="openVenmoBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--primary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Open Venmo</button>
Â  Â  Â  Â  <button id="copyVenmoBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--secondary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Copy Handle</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="detailsSheet">
Â  Â  <div id="detailsMap"></div>
Â  Â  <div id="detailsContent">
Â  Â  Â  <button id="closeDetailsBtn" class="sheet-close">Ã—</button>
Â  Â  Â  <h3 id="detailsName"></h3>
Â  Â  Â  <div id="detailsRating"></div>
Â  Â  Â  <div id="detailsPhone"></div>
Â  Â  Â  <div id="detailsAddress"></div>
Â  Â  Â  <div id="detailsPrice"></div>
Â  Â  Â  <div id="detailsActions">
Â  Â  Â  Â  <button id="saveBtn">â˜† Save</button>
SÂ  Â  Â  <button id="openMapsBtn">ğŸ“ Open in Maps</button>
Â  Â  Â  Â  <button id="websiteBtn">ğŸ”— Website</button>
Â  Â  Â  Â  <button id="shareBtn">ğŸ”— Share</button>
Â  Â  Â  Â  <button id="compassBtn">ğŸ§­ Compass</button>
Â  Â  Â  Â  <button id="addToPlanBtn">ğŸ—ºï¸ Add to Plan</button>
Â  Â  Â  Â  <button id="toggleStreetBtn">ğŸ–¼ï¸ Street View</button>
Â  Â  Â  </div>
Â  Â  Â  <button class="accordion" id="reviewsAccordion">Reviews</button>
Â  Â  Â  <div class="accordion-content" id="reviewsContent"></div>
Â  Â  Â  <button class="accordion" id="hoursAccordion">Weekly Hours</button>
Â  Â  Â  <div class="accordion-content" id="hoursContent"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="compassOverlay">
Â  Â  <div id="compassTop">
Â  Â  Â  <div id="radar">
Â  Â  Â  Â  <div id="miniMap"></div>
Â  Â  Â  Â  <div id="compassArrow"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="compassControls">
Â  Â  Â  <select id="voiceSelect"></select>
Â  Â  Â  <div id="navigationButtons">
Â  Â  Â  Â  <button id="startNavigationBtn">Start</button>
SÂ  Â  Â  <button id="stopNavigationBtn" disabled>Stop</button>
Â  Â  Â  Â  <button id="closeCompassBtn">Close</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="directionsList"></div>
Â  Â  Â  <div id="radarControls">
Â  S Â  Â  <label style="display:block; margin-top:0.5rem; font-size:0.8rem;">Zoom
Â  Â  Â  Â  Â  <input type="range" id="radarZoom" min="12" max="20" value="15" style="width:100%;">
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label style="display:block; margin-top:0.5rem; font-size:0.8rem;">Brightness
Â  Â  Â  Â  Â  <input type="range" id="radarBrightness" min="30" max="100" value="50" style="width:100%;">
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <script>
Â  Â  // Create the script tag for Google Maps after reading the API key from keys.js
Â  Â  (function() {
Â  Â  Â  // Use the key defined in keys.js, or fall back to the userâ€‘provided key if the
Â  Â  Â  // external file fails to load. This ensures the Maps API always receives a key.
Â  Â  Â  const fallbackKey = 'AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY';
Â  Â  Â  const mapsKey = window.MAPS_API_KEY || fallbackKey;
Â  Â  Â  const mapsScript = document.createElement('script');
Â  Â  Â  mapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${mapsKey}&libraries=places,geometry&callback=initMap`;
Â  Â  Â  mapsScript.async = true;
Â  Â  Â  mapsScript.defer = true;
Â  Â  Â  document.head.appendChild(mapsScript);
Â  Â  })();
Â  Â  // Utility functions
Â  Â  function $(id) { return document.getElementById(id); }

Â  Â  // Show/hide the ghost Easter egg depending on whether the user is on the main page
Â  Â  function hideGhost() {
Â  Â  Â  const ghost = $("ghostBtn");
Â  Â  Â  if (ghost) ghost.style.display = 'none';
Â  Â  }
Â  Â  function showGhost() {
Â  Â  Â  const ghost = $("ghostBtn");
Â  Â  Â  if (ghost) ghost.style.display = 'block';
Read-only
Â  Â  }

Â  Â  // Store state
Â  Â  let currentPosition = null;
Â  Â  let currentAddress = '';
Â  Â  let map, placesService, geocoder, streetViewPanorama;
Â  Â  let currentResults = [];
Â  Â  let factInterval;
Â  Â  let currentPlaceDetails;
Â  Â  let compassWatching = false;
Â  Â  let compassWatchId;
Â  Â  let miniMap;
// Track the visibility of Street View for the details view. By default the
// panorama is hidden and a static photo is shown instead.
let streetViewVisible = false;

Â  Â  // Categories definition
Â  Â  const categories = {
Â  Â  Â  "Foodie Finds": [
Â  Â  Â  Â  { name: "Italian", keyword: "italian restaurant", type: "restaurant" },
Â  Â  Â  Â  { name: "Pizza", keyword: "pizza", type: "restaurant" },
Â  Â  Â  Â  { name: "Cafes", keyword: "cafe", type: "cafe" },
Â  Â  Â  Â  { name: "Bakeries", keyword: "bakery", type: "bakery" },
Â  Â  Â  Â  { name: "Sushi", keyword: "sushi", type: "restaurant" }
Â  Â  Â  ],
Â  Â  Â  "Iconic Sights": [
Â  Â  Â  Â  { name: "Tourist Attractions", type: "tourist_attraction" },
Â  Â  Â  Â  { name: "Museums", type: "museum" },
Â  Â  Â  Â  { name: "Art Galleries", type: "art_gallery" },
Â  Â  Â  Â  { name: "Parks", type: "park" },
Â  Â  Â  Â  { name: "Landmarks", keyword: "landmark", type: "point_of_interest" }
Read-only
Â  Â  Â  ],
Â  Â  Â  "Night Out": [
Â  Â  Â  Â  { name: "Bars", type: "bar" },
Â  Â  Â  Â  { name: "Night Clubs", type: "night_club" },
Â  Â  Â  Â  { name: "Movie Theaters", type: "movie_theater" },
Â  Â  Â  Â  { name: "Bowling Alleys", type: "bowling_alley" },
Â  Â  Â  Â  { name: "Concert Venues", keyword: "concert", type: "point_of_interest" }
Â  Â  Â  ],
Â  Â  Â  "Hidden Gems": [
Â  Â  Â  Â  { name: "Libraries", type: "library" },
Â  Â  Â  Â  { name: "Book Stores", type: "book_store" },
Â  Â  Â  Â  { name: "Gardens", keyword: "garden", type: "park" },
Â  Â  Â  Â  { name: "Historical Sites", keyword: "historical site", type: "point_of_interest" },
Â  Â  Â  Â  { name: "Local Favorites", keyword: "local favorite", type: "point_of_interest" }
Â  Â  Â  ],
Â  Â  Â  "Pet Friendly": [
Â  Â  Â  Â  { name: "Dog Parks", keyword: "dog park", type: "park" },
Â  Â  Â  Â  { name: "Pet Stores", type: "pet_store" },
Â  Â  Â  Â  { name: "Veterinary Care", type: "veterinary_care" },
Â  Â  Â  Â  { name: "Pet Friendly Cafes", keyword: "pet friendly cafe", type: "cafe" },
Â  Â  Â  Â  { name: "Pet Friendly Hotels", keyword: "pet friendly hotel", type: "lodging" }
Â  Â  Â  ],
Â  Â  Â  "Utilities & Help": [
Â  Â  Â  Â  { name: "Hospitals", type: "hospital", ignoreRating: true },
Â  Â  Â  Â  { name: "Pharmacies", type: "pharmacy", ignoreRating: true },
Â  Â  Â  Â  { name: "Police", type: "police", ignoreRating: true },
Â  Â  Â  Â  { name: "Gas Stations", type: "gas_station", ignoreRating: true },
Â  Â  Â  Â  { name: "ATMs", type: "atm", ignoreRating: true }
Â  Â  Â  ],
Â  Â  Â  "Dark Side": [
Â  Â  Â  Â  { name: "Cemeteries", type: "cemetery", ignoreRating: true },
Â  Â  Â  Â  { name: "Funeral Homes", type: "funeral_home", ignoreRating: true },
Â  Â  Â  Â  { name: "Psychic", keyword: "psychic", type: "point_of_interest", ignoreRating: true },
Â  Â  Â  Â  { name: "Bars", type: "bar", ignoreRating: true },
Â  Â  Â  Â  { name: "Haunted Places", keyword: "haunted", type: "point_of_interest", ignoreRating: true }
Â  Â  Â  ]
Â  Â  Â  ,
Â  Â  Â  "Outdoor": [
Â  Â  Â  Â  { name: "Parks", type: "park" },
Â  Â  Â  Â  { name: "Trails", keyword: "hiking trail", type: "park" },
Â  Â  Â  Â  { name: "Nature Reserves", keyword: "nature reserve", type: "park" },
Â  Â  Â  Â  { name: "Beaches", keyword: "beach", type: "park" },
Â  Â  Â  Â  { name: "Campgrounds", keyword: "campground", type: "campground" }
SÂ  Â  ],
Â  Â  Â  "Local Events": [
Â  Â  Â  Â  { name: "All Events", value: "all" },
Â  Â  Â  Â  { name: "Music", value: "music" },
Â  Â  Â  Â  { name: "Sports", value: "sports" },
Â  Â  Â  Â  { name: "Comedy", value: "comedy" },
Â  Â  Â  Â  { name: "Festivals", value: "festival" }
Â  Â  Â  ]
Â  Â  };

Â  Â  // Initialize the app after Google script loads
Â  Â  function initApp() {
Â  Â  Â  map = new google.maps.Map($("hiddenMap"), { center: { lat: 0, lng: 0 }, zoom: 15 });
Â  Â  Â  placesService = new google.maps.places.PlacesService(map);
Â  Â  Â  geocoder = new google.maps.Geocoder();
Â  Â  Â  // Attempt geolocation
Â  Â  Â  if (navigator.geolocation) {
        // *** MODIFIED THIS CALL ***
Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  onLocationSuccess, 
Â  Â  Â  Â  Â  onLocationError,
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  enableHighAccuracy: false, // Use faster Wi-Fi/Cellular
Â  Â  Â  Â  Â  Â  timeout: 15000, Â  Â  Â  Â  Â // Give it 15 seconds
Â  Â  Â  Â  Â  Â  maximumAge: 60000 Â  Â  Â  Â  // Allow a location up to 1 min old
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  );
        // *** END OF MODIFICATION ***
Â  Â  Â  } else {
Â  Â  Â  Â  showManualInput();
Â  Â  Â  }
Â  Â  Â  populateFilterButtons();

Â  Â  Â  // If a plan is encoded in the URL (as ?plan=...), decode it and load
Â  Â  Â  // it into localStorage, then open the plan modal. The data is
Â  Â  Â  // expected to be a base64-encoded, URI-encoded JSON string
Â  Â  Â  // containing an object with an `items` array.
Â  Â  Â  try {
Â  Â  Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  Â  Â  if (params.has('plan')) {
Â  Â  Â  Â  Â  const encoded = params.get('plan');
Â  Â  Â  Â  Â  const decoded = decodeURIComponent(atob(encoded));
Â  Â  Â  Â  Â  const data = JSON.parse(decoded);
Â  Â  Â  Â  Â  if (data && Array.isArray(data.items)) {
Â  Â  Â  Â  Â  Â  localStorage.setItem('myPlan', JSON.stringify(data.items));
Â  Â  Â  Â  Â  Â  localStorage.removeItem('visitedPlan');
Â  Â  Â  Â  Â  Â  // Open the plan modal after a brief delay to allow the UI to initialise
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  loadPlan();
Â  Â  Â  Â  Â  Â  Â  $("planModal").classList.add('active');
Read-only
Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  Â  Â  Â  Â  hideGhost();
Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('Failed to decode shared plan', e);
Â  Â  Â  }
Â  Â  }

Â  Â  function onLocationSuccess(position) {
Â  Â  Â  currentPosition = {
Â  Â  Â  Â  lat: position.coords.latitude,
Â  Â  Â  Â  lng: position.coords.longitude
Â  Â  Â  };
Â  Â  Â  // Reverse geocode to get address
Â  Â  Â  reverseGeocode(currentPosition);
Â  Â  Â  // Fetch local facts
Â  Â  Â  fetchLocalFacts(currentPosition);
Â  Â  }

Â  Â  function onLocationError(err) {
Â  Â  Â  console.warn('Geolocation failed', err);
Â  Â  Â  $("locationDisplay").textContent = "Enter a location to begin";
Â  Â  Â  showManualInput();
Â  Â  }

Â  Â  function showManualInput() {
Â  Â  Â  $("manualInputContainer").style.display = 'block';
Â  Â  Â  const input = $("manualInput");
Â  Â  Â  input.addEventListener('keypress', function(e) {
Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  const addr = input.value.trim();
Â  Â  Â  Â  Â  if (addr) {
Â  Â  Â  Â  Â  Â  geocodeAddress(addr);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function geocodeAddress(address) {
Â  Â  Â  geocoder.geocode({ address: address }, (results, status) => {
Â  Â  Â  Â  if (status === 'OK' && results[0]) {
Â  Â  Â  Â  Â  currentPosition = {
Â  Â  Â  Â  Â  Â  lat: results[0].geometry.location.lat(),
Â  Â  Â  Â  Â  Â  lng: results[0].geometry.location.lng()
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  currentAddress = results[0].formatted_address;
Â  Â  Â  Â  Â  // Display city/state with small coordinates beneath
Â  Â  Â  Â  Â  let city = '', state = '';
Â  Â  Â  Â  Â  if (results[0].address_components) {
Â  Â  Â  Â  Â  Â  results[0].address_components.forEach(comp => {
Â  Â  Â  Â  Â  Â  Â  if (comp.types.includes('locality')) city = comp.long_name;
Â  Â  Â  Â  Â  Â  Â  if (comp.types.includes('administrative_area_level_1')) state = comp.short_name || comp.long_name;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  let locStr = city && state ? `${city}, ${state}` : city || state || currentAddress;
Â  Â  Â  Â  Â  $("locationDisplay").innerHTML = locStr + '<br><span style="font-size:0.75rem; opacity:0.8;">' + currentPosition.lat.toFixed(4) + ', ' + currentPosition.lng.toFixed(4) + '</span>';
Â  Â  Â  Â  Â  fetchLocalFacts(currentPosition);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('Location not found. Please try again.');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function reverseGeocode(pos) {
Â  Â  Â  geocoder.geocode({ location: pos }, (results, status) => {
Â  Â  Â  Â  if (status === 'OK' && results[0]) {
Â  Â  Â  Â  Â  currentAddress = results[0].formatted_address;
Â  Â  Â  Â  Â  // Extract city and state for a concise display
Â  Â  Â  Â  Â  let city = '', state = '';
Â  Â  Â  Â  Â  if (results[0].address_components) {
Â  Â  Â  Â  Â  Â  results[0].address_components.forEach(comp => {
Â  Â  Â  Â  Â  Â  Â  if (comp.types.includes('locality')) city = comp.long_name;
Â  Â  Â  Â  Â  Â  Â  if (comp.types.includes('administrative_area_level_1')) state = comp.short_name || comp.long_name;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  let locStr = city && state ? `${city}, ${state}` : city || state || currentAddress;
Â  Â  Â  Â  Â  $("locationDisplay").innerHTML = locStr + '<br><span style="font-size:0.75rem; opacity:0.8;">' + pos.lat.toFixed(4) + ', ' + pos.lng.toFixed(4) + '</span>';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Fallback: display coordinates if reverse geocoding fails
Â  Â  Â  Â  Â  $("locationDisplay").innerHTML = '<span style="font-size:0.85rem;">' + pos.lat.toFixed(4) + ', ' + pos.lng.toFixed(4) + '</span>';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function populateFilterButtons() {
Â  Â  Â  const grid = $("filterGrid");
Â  Â  Â  grid.innerHTML = '';
Â  Â  Â  Object.keys(categories).forEach(cat => {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.className = 'filter-btn';
Â  Â  Â  Â  btn.innerHTML = `${getIconForCategory(cat)} ${cat}`;
Â  Â  Â  Â  btn.addEventListener('click', () => openSubMenu(cat));
Â  Â  Â  Â  grid.appendChild(btn);
Â  Â  Â  });

Â  Â  Â  // Append donation button near the end of the filter grid
Â  Â  Â  const supportBtn = document.createElement('button');
Â  Â  Â  supportBtn.className = 'filter-btn support-btn';
Â  Â  Â  // Clarify that this button is for donations, not technical support
Â  Â  Â  supportBtn.innerHTML = 'âš“ Donate';
Â  Â  Â  supportBtn.addEventListener('click', () => {
Â  Â  Â  Â  $("donateModal").classList.add('active');
Â  Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  Â  hideGhost();
Â  Â  Â  });
Â  Â  Â  grid.appendChild(supportBtn);
Â  Â  }

Â  Â  function getIconForCategory(cat) {
Â  Â  Â  switch (cat) {
Â  Â  Â  Â  case 'Foodie Finds': return 'ğŸ½ï¸';
Â  Â  Â  Â  case 'Iconic Sights': return 'ğŸ›ï¸';
Â  Â  Â  Â  case 'Night Out': return 'ğŸŒ™';
Â  Â  Â  Â  case 'Hidden Gems': return 'ğŸ’';
Â  Â  Â  Â  case 'Pet Friendly': return 'ğŸ¾';
Â  Â  Â  Â  case 'Utilities & Help': return 'ğŸ› ï¸';
Â  Â  Â  Â  case 'Dark Side': return 'ğŸ‘»';
Â  Â  Â  Â  case 'Outdoor': return 'ğŸŒ²';
Â  Â  Â  Â  case 'Local Events': return 'ğŸŸï¸';
Â  Â  Â  Â  default: return '';
Â  Â  Â  }
Â  Â  }

Â  Â  // Sub menu handling
Â  Â  function openSubMenu(categoryName) {
Â  Â  Â  // Hide ghost when navigating away from home screen
Â  Â  Â  hideGhost();
Â  Â  Â  $("subMenuTitle").textContent = categoryName;
Â  Â  Â  const list = $("subMenuList");
Â  Â  Â  list.innerHTML = '';
Â  Â  Â  const items = categories[categoryName];
Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.textContent = item.name;
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  closeSubMenu();
Â  Â  Â  Â  Â  performSearch(categoryName, item);
Â  Â  Â  Â  });
Â  Â  Â  Â  list.appendChild(btn);
Â  Â  Â  });
Â  Â  Â  // Foodie Finds special: add Surprise Me button
Â  Â  Â  if (categoryName === 'Foodie Finds') {
Â  Â  Â  Â  const surpriseBtn = document.createElement('button');
Â  Â  Â  Â  surpriseBtn.className = 'special-btn';
Â  Â  Â  Â  surpriseBtn.textContent = 'ğŸ¤¤ Surprise Me!';
Â  Â  Â  Â  surpriseBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  // Randomly pick a subcategory for Foodie Finds
Â  Â  Â  Â  Â  const options = categories['Foodie Finds'];
Â  Â  Â  Â  Â  const randomItem = options[Math.floor(Math.random() * options.length)];
Â  Â  Â  Â  Â  closeSubMenu();
Â  Â  Â  Â  Â  performSearch('Foodie Finds', randomItem);
Â  Â  Â  Â  });
Â  Â  Â  Â  list.appendChild(surpriseBtn);
Â  Â  Â  }
Â  Â  Â  $("subMenuModal").classList.add('active');
Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  }

Â  Â  function closeSubMenu() {
Â  Â  Â  $("subMenuModal").classList.remove('active');
Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  showGhost();
Â  Â  }
Â  Â  $("closeSubMenu").addEventListener('click', closeSubMenu);

Â  Â  // Results handling
Â  Â  function performSearch(category, item) {
Â  Â  Â  if (!currentPosition) {
Â  Â  Â  Â  alert('Please provide a location first.');
Â  Â  Â  Â  return;
Â  Â  S }
Â  Â  Â  // Handle Local Events separately
Â  Â  Â  if (category === 'Local Events') {
Â  Â  Â  Â  searchLocalEvents(item);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const request = {
Â  Â  Â  Â  location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
Â  Â  Â  Â  radius: 7000,
Â  Â  Â  Â  type: item.type || undefined,
Â  Â  Â  Â  keyword: item.keyword || undefined,
Â  Â  Â  Â  rankBy: google.maps.places.RankBy.PROMINENCE
Â  Â  Â  };
Â  Â  Â  // Use nearbySearch for relevant results
Â  Â  Â  placesService.nearbySearch(request, (results, status) => {
Â  Â  Â  Â  if (status === google.maps.places.PlacesServiceStatus.OK) {
Â  Â  Â  Â  Â  // Filter by rating if needed
Â  Â  Â  Â  Â  let filtered = results;
Â  Â  Â  Â  Â  if (!item.ignoreRating) {
Â  Â  Â  Â  Â  Â  filtered = results.filter(p => p.rating && p.rating >= 4.2 && p.user_ratings_total && p.user_ratings_total >= 20);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // Sort by rating then number of reviews
Â  Â  Â  Â  Â  filtered.sort((a,b) => {
Â  Â  Â  Â  Â  Â  const rDiff = (b.rating || 0) - (a.rating || 0);
Read-only
Â  Â  Â  Â  Â  Â  if (rDiff !== 0) return rDiff;
Â  Â  Â  Â  Â  Â  return (b.user_ratings_total || 0) - (a.user_ratings_total || 0);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  currentResults = filtered;
Â  Â  Â  Â  Â  displayResults(category, filtered);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('No results found.');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // Search for local events using the Ticketmaster Discovery API.
Â  Â  // Note: Replace YOUR_TICKETMASTER_API_KEY with your actual API key.
Â  Â  async function searchLocalEvents(item) {
Â  Â  Â  if (!currentPosition) {
Â  Â  Â  Â  alert('Please provide a location first.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // Use the key from keys.js or fall back to the userâ€‘provided Ticketmaster key
Â  Â  Â  const fallbackTicketmasterKey = 'XmzfrRHZilGDGfD63SmdamF288GZ3FxH';
Â  Â  Â  const apiKey = window.TICKETMASTER_API_KEY || fallbackTicketmasterKey;
Â  Â  Â  if (!apiKey) {
Â  Â  Â  Â  alert('Ticketmaster API key missing. Please define TICKETMASTER_API_KEY in keys.js');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const classification = (item.value && item.value !== 'all') ? item.value : '';
Â  Â  Â  const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${apiKey}&latlong=${currentPosition.lat},${currentPosition.lng}&radius=50${classification ? '&classificationName=' + classification : ''}`;
Â  Â  Â  try {
Â  Â  Â  Â  const resp = await fetch(url);
Â  Â  Â  Â  const data = await resp.json();
Â  Â  Â  Â  const events = (data._embedded && data._embedded.events) || [];
Â  Â  Â  Â  displayEventResults(events, item.name);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  alert('Unable to fetch events.');
Â  Â  Â  }
Â  Â  }

Â  Â  // Display event results in the results modal
Â  Â  function displayEventResults(events, subCategory) {
Â  Â  Â  const list = $("resultsList");
Â  Â  Â  list.innerHTML = '';
Â  Â  Â  events.forEach(event => {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.className = '';
Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  wrapper.className = 'results-item';
Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  let imgUrl = null;
Â  Â  Â  Â  if (event.images && event.images.length > 0) {
Â  Â  Â  Â  Â  // Use the first image
Â  Â  Â  Â  Â  imgUrl = event.images[0].url;
Â  Â  Â  Â  }
Â  Â  Â  Â  img.src = imgUrl || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  Â  Â  Â  wrapper.appendChild(img);
Â  Â  Â  Â  const info = document.createElement('div');
Â  Â  Â  Â  info.className = 'results-info';
Â  Â  Â  Â  const title = document.createElement('h4');
Â  Â  Â  Â  title.textContent = event.name;
Â  Â  Â  Â  info.appendChild(title);
Â  Â  Â  Â  // Date/time information
Â  Â  Â  Â  const dateSpan = document.createElement('span');
Â  Â  Â  Â  dateSpan.className = 'rating';
Â  Â  Â  Â  if (event.dates && event.dates.start) {
Â  Â  Â  Â  Â  const d = event.dates.start.localDate || '';
Â  Â  Â  Â  Â  const t = event.dates.start.localTime || '';
Â  Â  Â  Â  Â  dateSpan.textContent = d + (t ? ' ' + t : '');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  dateSpan.textContent = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  info.appendChild(dateSpan);
Â  Â  Â  Â  // Venue and location information
Â  Â  Â  Â  const venueSpan = document.createElement('span');
Â  Â  Â  Â  venueSpan.className = 'rating';
Â  Â  Â  Â  if (event._embedded && event._embedded.venues && event._embedded.venues.length > 0) {
Â  Â  Â  Â  Â  const venue = event._embedded.venues[0];
Â  Â  Â  Â  Â  const city = venue.city ? venue.city.name : '';
Â  Â  Â  Â  Â  const state = venue.state ? (venue.state.name || venue.state.stateCode) : '';
Â  Â  Â  Â  Â  const locStr = city && state ? `${city}, ${state}` : city || state;
Â  Â  Â  Â  Â  venueSpan.textContent = venue.name + (locStr ? ' â€” ' + locStr : '');
Â  Â  Â  Â  }
Â  Â  Â  Â  info.appendChild(venueSpan);
Â  Â  Â  Â  // Classification / genre information
Â  Â  Â  Â  const classSpan = document.createElement('span');
Read-only
Â  Â  Â  Â  classSpan.className = 'rating';
Â  Â  Â  Â  if (event.classifications && event.classifications.length > 0) {
Â  Â  Â  Â  Â  const cls = event.classifications[0];
Â  Â  Â  Â  Â  const seg = cls.segment && cls.segment.name;
Â  Â  Â  Â  Â  const genre = cls.genre && cls.genre.name;
Â  Â  Â  Â  Â  const subg = cls.subGenre && cls.subGenre.name;
Â  Â  Â  Â  Â  const parts = [];
Â  Â  Â  Â  Â  if (genre && genre.toLowerCase() !== 'undefined') parts.push(genre);
Â  Â  Â  Â  Â  if (subg && subg.toLowerCase() !== 'undefined' && subg !== genre) parts.push(subg);
Â  Â  Â  Â  Â  if (parts.length === 0 && seg) parts.push(seg);
Â  Â  Â  Â  Â  classSpan.textContent = parts.join(' / ');
Â  Â  Â  Â  }
Â  Â  Â  Â  info.appendChild(classSpan);
Â  Â  Â  Â  // Price range information
Â  Â  Â  Â  const priceSpan = document.createElement('span');
Â  Â  Â  Â  priceSpan.className = 'rating';
Â  Â  Â  Â  if (event.priceRanges && event.priceRanges.length > 0) {
Â  Â  Â  Â  Â  const pr = event.priceRanges[0];
Â  Â  Â  Â  Â  if (pr.min && pr.max) {
Â  Â  Â  Â  Â  Â  priceSpan.textContent = `$${pr.min.toFixed(0)}â€“$${pr.max.toFixed(0)} ${pr.currency || ''}`;
Â  Â  Â  Â  Â  } else if (pr.min) {
Â  Â  Â  Â  Â  Â  priceSpan.textContent = `$${pr.min.toFixed(0)}+`;
Â  Â  Â  Â  Â  } else if (pr.max) {
Â  Â  Â  Â  Â  Â  priceSpan.textContent = `$${pr.max.toFixed(0)}`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  info.appendChild(priceSpan);
Â  Â  Â  Â  wrapper.appendChild(info);
Â  Â  Â  Â  btn.appendChild(wrapper);
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  if (event.url) window.open(event.url);
Â  Â  Â  Â  });
Â  Â  Â  Â  list.appendChild(btn);
Â  Â  Â  });
Â  Â  Â  $("resultsTitle").textContent = subCategory + ' Events';
Â  Â  Â  $("resultsModal").classList.add('active');
Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  hideGhost();
Â  Â  }

Â  Â  function displayResults(category, results) {
Â  Â  Â  $("resultsTitle").textContent = `${category} Results`;
Â  Â  Â  const list = $("resultsList");
Â  Â  Â  list.innerHTML = '';
Â  Â  Â  // Determine which places are saved in the current plan and which have been visited
Â  Â  Â  const planIds = getPlan().map(p => p.place_id);
Â  Â  Â  const visitedIds = getVisitedPlan();
Â  Â  Â  results.forEach(place => {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.addEventListener('click', () => showDetails(place.place_id));
Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  wrapper.className = 'results-item';
Â  Â  Â  Â  // Photo
Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  if (place.photos && place.photos.length > 0) {
Â  Â  Â  Â  Â  img.src = place.photos[0].getUrl({ maxWidth: 80, maxHeight: 80 });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  Â  Â  Â  }
Â  Â  Â  Â  wrapper.appendChild(img);
Â  Â  Â  Â  // Info
Â  Â  Â  Â  const info = document.createElement('div');
Â  Â  Â  Â  info.className = 'results-info';
Â  Â  Â  Â  const title = document.createElement('h4');
Â  Â  Â  Â  title.textContent = place.name;
Â  Â  Â  Â  info.appendChild(title);
Â  Â  Â  Â  const rating = document.createElement('span');
Â  Â  Â  Â  rating.className = 'rating';
Â  Â  Â  Â  if (place.rating) {
Â  Â  Â  Â  Â  rating.textContent = `â˜…${place.rating.toFixed(1)} (${place.user_ratings_total})`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  rating.textContent = 'No rating';
Â  Â  Â  Â  }
Â  Â  Â  Â  info.appendChild(rating);
Â  Â  Â  Â  // Visited indicator if the place is in the plan
Â  Â  Â  Â  if (planIds.includes(place.place_id)) {
Â  Â  Â  Â  Â  const visitSpan = document.createElement('span');
Â  Â  Â  Â  Â  visitSpan.className = 'rating';
Â  Â  Â  Â  Â  // Show a filled check mark if visited, or an empty box if not yet visited
Â  Â  Â  Â  Â  visitSpan.textContent = visitedIds.includes(place.place_id) ? 'âœ”ï¸' : 'â—»ï¸';
Â  Â  Â  Â  Â  visitSpan.style.marginLeft = '0.3rem';
Â  Â  Â  Â  Â  info.appendChild(visitSpan);
Â  Â  Â  Â  }
Â  Â  Â  Â  wrapper.appendChild(info);
Â  Â  Â  Â  btn.appendChild(wrapper);
Â  Â  Â  Â  list.appendChild(btn);
Â  Â  Â  });
Â  Â  Â  $("resultsModal").classList.add('active');
Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  hideGhost();
Â  Â  }
Â  Â  $("closeResults").addEventListener('click', () => {
Â  Â  Â  $("resultsModal").classList.remove('active');
Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  showGhost();
Â  Â  });

Â  Â  // Allow closing the results modal by tapping outside its content
Â  Â  $("resultsModal").addEventListener('click', (e) => {
Â  Â  Â  if (e.target.id === 'resultsModal') {
Â  Â  Â  Â  $("resultsModal").classList.remove('active');
Â  Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  Â  showGhost();
Â  Â  Â  }
Â  Â  });

Â  Â  // Surprise Me search
Â  Â  $("surpriseBtn").addEventListener('click', () => {
Â  Â  Â  if (!currentPosition) {
Â  Â  Â  Â  alert('Please allow geolocation or search for a location first.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const request = {
Â  Â  Â  Â  location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
Â  Â  Â  Â  radius: 8000,
Â  Â  Â  Â  rankBy: google.maps.places.RankBy.PROMINENCE,
Â  Â  Â  Â  type: ['tourist_attraction', 'point_of_interest']
Â  Â  Â  };
Â  Â  Â  placesService.nearbySearch(request, (results, status) => {
Â  Â  Â  Â  if (status === google.maps.places.PlacesServiceStatus.OK) {
Â  Â  Â  Â  Â  const good = results.filter(p => p.rating && p.rating >= 4.5 && p.user_ratings_total >= 50);
Â  Â  Â  Â  Â  if (good.length > 0) {
Â  Â  Â  Â  Â  Â  const randomPlace = good[Math.floor(Math.random() * good.length)];
Â  Â  Â  Â  Â  Â  showDetails(randomPlace.place_id);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert('No highâ€‘quality places found nearby.');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('No results found.');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });

Â  Â  // Dark side Easter egg opens the Dark Side category menu
Â  Â  $("ghostBtn").addEventListener('click', () => {
Â  Â  Â  openSubMenu('Dark Side');
Â  Â  });

Â  Â  // Results details view
Â  Â  function showDetails(placeId) {
Â  Â  Â  placesService.getDetails({ placeId: placeId, fields: ['name','formatted_address','formatted_phone_number','rating','reviews','photos','price_level','geometry','website','url','opening_hours','place_id'] }, (place, status) => {
Â  Â  Â  Â  if (status === google.maps.places.PlacesServiceStatus.OK) {
Â  Â  Â  Â  Â  currentPlaceDetails = place;
Â  Â  Â  Â  Â  // Prepare Street View panorama and default to hidden. We request
Â  Â  Â  Â  Â  // the panorama near the place and if none is available we
Â  Â  Â  Â  Â  // position the viewer at the place's coordinates. After
Â  Â  Â  Â  Â  // initialising, we hide the panorama and show a static photo.
Â  Â  Â  Â  Â  const loc = place.geometry.location;
Â  Â  Â  Â  Â  const streetService = new google.maps.StreetViewService();
Â  Â  Â  Â  Â  streetService.getPanorama({ location: loc, radius: 50 }, (data, status) => {
Â  Â  Â  Â  Â  Â  let panoOptions;
Â  Â  Â  Â  Â  Â  if (status === google.maps.StreetViewStatus.OK && data && data.location) {
Â  Â  Â  Â  Â  Â  Â  panoOptions = { pano: data.location.pano, pov: { heading: 270, pitch: 0 }, zoom: 1 };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  panoOptions = { position: loc, pov: { heading: 0, pitch: 0 }, zoom: 0 };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!streetViewPanorama) {
Â  Â  Â  Â  Â  Â  Â  streetViewPanorama = new google.maps.StreetViewPanorama($("detailsMap"), panoOptions);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  if (panoOptions.pano) {
Â  Â  Â  Â  Â  Â  Â  Â  streetViewPanorama.setPano(panoOptions.pano);
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  S Â  Â  streetViewPanorama.setPosition(panoOptions.position);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  streetViewPanorama.setPov(panoOptions.pov);
Â  Â  Â  Â  Â  Â  Â  streetViewPanorama.setZoom(panoOptions.zoom);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Hide the panorama initially
Â  Â  Â  Â  Â  Â  streetViewVisible = false;
Â  Â  Â  Â  Â  Â  streetViewPanorama.setVisible(false);
Â  Â  Â  Â  Â  Â  // Apply static background image if available
Â  Â  Â  Â  Â  Â  if (place.photos && place.photos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  const photoUrl = place.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 });
Â  Â  Â  Â  Â  Â  Â  $("detailsMap").style.backgroundImage = `url('${photoUrl}')`;
Â  Â  Â  Â  Â  Â  Â  $("detailsMap").style.backgroundSize = 'cover';
Â  Â  Â  Â  Â  Â  Â  $("detailsMap").style.backgroundPosition = 'center';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  $("detailsMap").style.backgroundImage = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const tBtn = $("toggleStreetBtn");
Â  Â  Â  Â  Â  Â  if (tBtn) tBtn.textContent = 'ğŸ–¼ï¸ Street View';
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // Name
Â  Â  Â  Â  Â  $("detailsName").textContent = place.name;
Â  Â  Â  Â  Â  // Rating and price
Â  Â  Â  Â  Â  let starStr = '';
Â  Â  Â  Â  Â  if (place.rating) {
Â  Â  Â  Â  Â  Â  const full = Math.floor(place.rating);
Â  Â  Â  Â  Â  Â  const half = (place.rating - full) >= 0.5;
Â  Â  Â  Â  Â  Â  starStr = 'â˜…'.repeat(full) + (half ? 'Â½' : '') + ` (${place.rating.toFixed(1)})`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  $("detailsRating").textContent = starStr;
Â  Â  Â  Â  Â  $("detailsPrice").textContent = place.price_level ? '$'.repeat(place.price_level) : '';
Â  Â  Â  Â  Â  $("detailsPhone").textContent = place.formatted_phone_number || '';
Â  Â  Â  Â  Â  $("detailsAddress").textContent = place.formatted_address || '';
Â  Â  Â  Â  Â  // Save button state
Â  Â  Â  Â  Â  updateSaveButtonState(place.place_id);
Read-only
Â  Â  Â  Â  Â  // Reviews
Â  Â  Â  Â  Â  populateReviews(place.reviews || []);
Â  Â  Â  Â  Â  // Hours
Â  Â  Â  Â  Â  populateHours(place.opening_hours);
Â  Â  Â  Â  Â  // Actions
Â  Â  Â  Â  Â  $("openMapsBtn").onclick = () => {
Â  Â  Â  Â  Â  Â  window.open(place.url || `http://googleusercontent.com/maps/google.com/0{encodeURIComponent(place.name)}&query_place_id=${place.place_id}`);
sÂ  Â  Â  };
Â  Â  Â  Â  Â  $("websiteBtn").style.display = place.website ? 'inline-flex' : 'none';
Â  Â  Â  Â  Â  $("websiteBtn").onclick = () => {
Â  Â  Â  Â  Â  Â  if (place.website) window.open(place.website);
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  $("shareBtn").onclick = () => {
Â  Â  Â  Â  Â  Â  if (navigator.share) {
Â  Â  Â  Â  Â  Â  Â  navigator.share({ title: place.name, text: place.formatted_address, url: place.url || window.location.href }).catch(err => console.log(err));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  alert('Sharing not supported on this device.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  $("compassBtn").onclick = () => openCompass(loc);
Â  Â  Â  Â  Â  // Bind Street View toggle
Â  Â  Â  Â  Â  $("toggleStreetBtn").onclick = toggleStreetView;
Â  Â  Â  Â  Â  // Show sheet and lock background scroll
Â  Â  Â  Â  Â  $("detailsSheet").classList.add('active');
Â  Â  Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  Â  Â  hideGhost();
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // Close details sheet helper
Â  Â  function closeDetails() {
Â  Â  Â  $("detailsSheet").classList.remove('active');
Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  showGhost();
Â  Â  }

Â  Â  // Tap outside details content closes sheet
Â  Â  $("detailsSheet").addEventListener('click', function(e) {
Â  Â  Â  // When clicking on sheet background (not the content overlay)
Â  Â  Â  if (e.target.id === 'detailsSheet') {
Â  Â  Â  Â  closeDetails();
Â  Â  Â  }
Â  Â  });

Â  Â  // Close button inside details sheet
Â  Â  $("closeDetailsBtn").addEventListener('click', () => {
Â  Â  Â  closeDetails();
Â  Â  });

Â  Â  /*
Â  Â  Â  Toggle Street View visibility.
Â  Â  Â  Street View imagery is disabled by default to reduce data usage. When
Â  Â  Â  activated, the static background image is removed and the panorama
Â  Â  Â  becomes visible. Toggling again hides the panorama and restores the
Â  Â  Â  photo background if one exists.
Â  Â  */
Â  Â  function toggleStreetView() {
Â  Â  Â  if (!streetViewPanorama) return;
Â  Â  Â  streetViewVisible = !streetViewVisible;
Â  Â  Â  streetViewPanorama.setVisible(streetViewVisible);
Â  Â  Â  const btn = $("toggleStreetBtn");
Â  Â  Â  if (streetViewVisible) {
Â  Â  Â  Â  if (btn) btn.textContent = 'ğŸ–¼ï¸ Hide Street View';
Â  Â  Â  Â  $("detailsMap").style.backgroundImage = '';
Â  Â  Â  } else {
Â  Â  Â  Â  if (btn) btn.textContent = 'ğŸ–¼ï¸ Street View';
Â  Â  Â  Â  if (currentPlaceDetails && currentPlaceDetails.photos && currentPlaceDetails.photos.length > 0) {
Â  Â  Â  Â  Â  const photoUrl = currentPlaceDetails.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 });
Â  Â  Â  Â  Â  $("detailsMap").style.backgroundImage = `url('${photoUrl}')`;
Â  Â  Â  Â  Â  $("detailsMap").style.backgroundSize = 'cover';
Â  Â  Â  Â  Â  $("detailsMap").style.backgroundPosition = 'center';
isÂ  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  // Populate reviews accordion
Â  Â  function populateReviews(reviews) {
Â  Â  Â  const reviewsContent = $("reviewsContent");
Â  Â  Â  reviewsContent.innerHTML = '';
Â  Â  Â  if (!reviews || reviews.length === 0) {
Â  Â  Â  Â  reviewsContent.innerHTML = '<p>No reviews available.</p>';
Â  Â  Â  } else {
Â  Â  Â  Â  reviews.slice(0,5).forEach(r => {
Â  Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  Â  p.style.marginBottom = '0.5rem';
Â  Â  Â  Â  Â  p.textContent = `"${r.text}" â€” ${r.author_name}`;
Â  Â  Â  Â  Â  reviewsContent.appendChild(p);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  // Populate hours accordion
Â  Â  function populateHours(hours) {
Read-only
Â  Â  Â  const hoursContent = $("hoursContent");
Â  Â  Â  hoursContent.innerHTML = '';
Â  Â  Â  if (!hours || !hours.weekday_text) {
Â  Â  Â  Â  hoursContent.innerHTML = '<p>No hours available.</p>';
Â  Â  Â  } else {
Â  Â  Â  Â  hours.weekday_text.forEach(l => {
Â  Â  Â  Â  Â  const p = document.createElement('p');
Read-only
Â  Â  Â  Â  Â  p.textContent = l;
Â  Â  Â  Â  Â  hoursContent.appendChild(p);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  // Accordion toggling
Â  Â  function setupAccordions() {
Â  Â  Â  document.querySelectorAll('.accordion').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  btn.classList.toggle('active');
Read-only
Â  Â  Â  Â  Â  const content = btn.nextElementSibling;
Â  Â  Â  Â  Â  if (btn.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  content.style.maxHeight = content.scrollHeight + 'px';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  content.style.maxHeight = null;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  // Save functionality using localStorage
Â  Â  function getSavedList() {
Â  Â  Â  try {
Â  Â  Â  Â  const data = localStorage.getItem('myPlaces');
Â  Â  Â  Â  return data ? JSON.parse(data) : [];
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  return [];
Â  Â  Â  }
Â  Â  }
Â  Â  function savePlace(place) {
Â  Â  Â  let list = getSavedList();
Â  Â  Â  if (!list.find(p => p.place_id === place.place_id)) {
Â  Â  Â  Â  // Limit stored places to 50 to avoid unbounded localStorage growth
Â  Â  Â  Â  if (list.length >= 50) {
Â  Â  Â  Â  Â  list.shift();
Â  Â  Â  Â  }
Â  Â  Â  Â  list.push({
Â  Â  Â  Â  Â  place_id: place.place_id,
Â  Â  Â  Â  Â  name: place.name,
Â  Â  Â  Â  Â  address: place.formatted_address,
Â  Â  Â  Â  Â  rating: place.rating,
Â  Â  Â  Â  Â  url: place.url,
Â  Â  Â  Â  Â  photo: (place.photos && place.photos.length > 0) ? place.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 }) : null
Â  Â  Â  Â  });
Â  Â  Â  Â  localStorage.setItem('myPlaces', JSON.stringify(list));
Â  Â  Â  }
Â  Â  }
Â  Â  function removePlace(placeId) {
Â  Â  Â  let list = getSavedList();
Â  Â  Â  list = list.filter(p => p.place_id !== placeId);
sÂ  Â  localStorage.setItem('myPlaces', JSON.stringify(list));
Â  Â  }
Â  Â  function updateSaveButtonState(placeId) {
Â  Â  Â  const list = getSavedList();
Â  Â  Â  const saved = list.some(p => p.place_id === placeId);
Â  Â  Â  $("saveBtn").textContent = saved ? 'â˜… Saved' : 'â˜† Save';
Â  Â  Â  $("saveBtn").onclick = () => {
Â  Â  Â  Â  if (list.some(p => p.place_id === placeId)) {
Â  Â  Â  Â  Â  removePlace(placeId);
Â  Â  Â  Â  Â  $("saveBtn").textContent = 'â˜† Save';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  savePlace(currentPlaceDetails);
Â  Â  Â  Â  Â  $("saveBtn").textContent = 'â˜… Saved';
Â  Â  Â  Â  }
Â  Â  Â  Â  loadMyList();
Â  Â  Â  };
Â  Â  }

Â  Â  /*
Â  Â  Â  Plan management
Â  Â  Â  Allows users to curate a list of places into a shareable plan. Plans are
Â  Â  Â  stored in localStorage under the 'myPlan' key. A separate 'visitedPlan'
Â  Â  Â  array tracks which places have been marked as visited to provide badge
Â  Â  Â  progress for the user.
Â  Â  */
Â  Â  function getPlan() {
Â  Â  Â  try {
Â  Â  Â  Â  const data = localStorage.getItem('myPlan');
Â  Â  Â  Â  return data ? JSON.parse(data) : [];
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  return [];
Â  Â  Â  }
Â  Â  }
Â  Â  function savePlan(list) {
Â  Â  Â  localStorage.setItem('myPlan', JSON.stringify(list));
Â  Â  }
Â  Â  function getVisitedPlan() {
Â  Â  Â  try {
Â  Â  Â  Â  const data = localStorage.getItem('visitedPlan');
Â  Â  Â  Â  return data ? JSON.parse(data) : [];
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  return [];
Â  Â  Â  }
Â  Â  }
Â  Â  function saveVisitedPlan(list) {
Â  Â  Â  localStorage.setItem('visitedPlan', JSON.stringify(list));
Â  Â  }
Â  Â  function addToPlan(place) {
Â  Â  Â  let list = getPlan();
Â  Â  Â  if (!list.some(p => p.place_id === place.place_id)) {
Â  Â  Â  Â  list.push({
Â  Â  Â  Â  Â  place_id: place.place_id,
Â  Read-only
Â  Â  Â  Â  Â  name: place.name,
Â  Â  Â  Â  Â  lat: place.geometry.location.lat(),
Â  Â  Â  Â  Â  lng: place.geometry.location.lng(),
Â  Â  Â  Â  Â  address: place.formatted_address || '',
Â  Â  Â  Â  Â  category: '',
Â  Â  Â  Â  Â  photo: (place.photos && place.photos.length) ? place.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 }) : null
Â  Â  Â  Â  });
Â  Â  Â  Â  savePlan(list);
Â  Â  Â  }
Â  Â  }
Â  Â  function removeFromPlan(placeId) {
Â  Â  Â  let list = getPlan();
Â  Â  Â  list = list.filter(p => p.place_id !== placeId);
Â  Â  Â  savePlan(list);
Â  Â  }
Â  Â  function toggleVisited(placeId) {
Â  Â  Â  let visited = getVisitedPlan();
Â  Â  Â  if (visited.includes(placeId)) {
Â  Â  Â  Â  visited = visited.filter(id => id !== placeId);
Â  Â  Â  } else {
Â  Â  Â  Â  visited.push(placeId);
Â  Â  Â  }
Â  Â  Â  saveVisitedPlan(visited);
Â  Â  }
Â  Â  function loadPlan() {
Â  Â  Â  const list = getPlan();
Â  Â  Â  const content = $("planContent");
Â  Â  Â  const empty = $("planEmpty");
Â  Â  Â  const summary = $("planSummary");
Â  Â  Â  content.innerHTML = '';
Â  Â  Â  const visited = getVisitedPlan();
Â  Â  Â  if (!list.length) {
Â  Â  Â  Â  empty.style.display = 'block';
Â  Â  Â  Â  summary.textContent = '';
Â  Â  Â  } else {
Â  Â  Â  Â  empty.style.display = 'none';
Â  Â  Â  Â  // Summary and badge calculation
Â  Â  Â  Â  const visitedCount = list.filter(item => visited.includes(item.place_id)).length;
Â  Â  Â  Â  const totalCount = list.length;
Â  Â  Â  Â  let badge = '';
Â  Â  Â  Â  const ratio = visitedCount / totalCount;
Â  Read-only
Â  Â  Â  Â  if (ratio === 1) {
Â  Â  Â  Â  Â  badge = 'ğŸ–ï¸';
Â  Â  Â  Â  } else if (ratio >= 0.8) {
Â  Â  Â  Â  Â  badge = 'ğŸ¥‡';
Â  Â  Â  Â  } else if (ratio >= 0.5) {
Â  Â  Â  Â  Â  badge = 'ğŸ¥ˆ';
Â  Â  Â  Â  } else if (ratio >= 0.3) {
Â  Â  Â  Â  Â  badge = 'ğŸ¥‰';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  badge = 'ğŸ”°';
Â  Â  Â  Â  }
Â  Â  Â  Â  summary.textContent = `Visited ${visitedCount} of ${totalCount} places ${badge}`;
Â  Â  Â  Â  list.forEach(item => {
Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  btn.style.display = 'flex';
Â  Â  Â  Â  Â  btn.style.justifyContent = 'space-between';
Â  Â  Â  Â  Â  btn.style.alignItems = 'center';
Â  Â  Â  Â  Â  btn.style.width = '100%';
Â  Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  Â  wrapper.className = 'results-item';
Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  img.src = item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  Â  Â  Â  Â  wrapper.appendChild(img);
Â  Â  Â  Â  Â  const info = document.createElement('div');
Â  Â  Â  Â  Â  info.className = 'results-info';
Â  Â  Â  Â  Â  const title = document.createElement('h4');
Â  Â  Â  Â  Â  title.textContent = item.name;
Â  Â  Â  Â  Â  info.appendChild(title);
Â  Â  Â  Â  Â  const visitedSpan = document.createElement('span');
Â  Â  Â  Â  Â  visitedSpan.className = 'rating';
Â  Â  Â  Â  Â  visitedSpan.textContent = visited.includes(item.place_id) ? 'Visited' : 'Not visited';
Â  Â  Â  Â  Â  info.appendChild(visitedSpan);
Â  Â  Â  Â  Â  wrapper.appendChild(info);
Â  Â  Â  Â  Â  btn.appendChild(wrapper);
Â  Â  Â  Â  Â  // Toggle visited on context menu (long press)
Â  Â  Â  Â  Â  btn.addEventListener('contextmenu', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  toggleVisited(item.place_id);
Â  Â  Â  Â  Â  Â  loadPlan();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // Clicking opens details
Â  Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  showDetails(item.place_id);
Â  Â  Â  Â  Â  Â  closePlan();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  content.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  function closePlan() {
Â  Â  Â  $("planModal").classList.remove('active');
Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  showGhost();
Â  Â  }

Â  Â  // Open My Plan modal from the main button
Â  Â  $("myPlanBtn").addEventListener('click', () => {
Â  Â  Â  loadPlan();
Â  Â  Â  $("planModal").classList.add('active');
Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  hideGhost();
Â  Â  });

Â  Â  // Share Plan button handler. Encodes the current plan as a base64
Â  Â  // string and appends it as a query parameter to the current URL. If
Â  Â  // Web Share API is available the link is passed to navigator.share,
Â  Â  // otherwise a prompt is shown so the user can copy the link manually.
Â  Â  $("sharePlanBtn").addEventListener('click', () => {
Â  Â  Â  const plan = getPlan();
Â  Â  Â  if (!plan || plan.length === 0) {
Â  Â  Â  Â  alert('Your plan is empty. Add some places before sharing.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  try {
Â  Â  Â  Â  const data = { items: plan };
Â  Â  Â  Â  const json = JSON.stringify(data);
sÂ  Â  Â  const encoded = btoa(encodeURIComponent(json));
Â  Â  Â  Â  const base = window.location.origin + window.location.pathname;
Â  Â  Â  Â  const url = `${base}?plan=${encoded}`;
Â  Â  Â  Â  if (navigator.share) {
Â  Â  Â  Â  Â  navigator.share({
Â  Â  Â  Â  Â  Â  title: 'My Local Explorer Plan',
Â  Â  Â  Â  Â  Â  text: 'Check out my travel plan on Local Explorer',
Â  Â  Â  Â  Â  Â  url: url
Â  Â  Â  Â  Â  }).catch(err => console.log(err));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  window.prompt('Copy and share this link to load your plan:', url);
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  alert('Unable to share plan.');
Â  Â  Â  }
Â  Â  });

Â  Â  // My List modal
Â  Â  $("myListBtn").addEventListener('click', () => {
Â  Â  Â  loadMyList();
Â  Â  Â  $("myListModal").classList.add('active');
Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  hideGhost();
Â  Â  });
Â  Â  $("closeMyList").addEventListener('click', () => {
Â  Â  Â  $("myListModal").classList.remove('active');
Â  Â  Â  document.body.classList.remove('modal-open');
sÂ  Â  showGhost();
Â  Â  });

Â  Â  // Close Plan modal via close button
Â  Â  $("closePlan").addEventListener('click', () => {
Â  Â  Â  closePlan();
Â  Â  });
Â  Â  // Close Plan modal by tapping outside its content
Â  Â  $("planModal").addEventListener('click', (e) => {
Â  Â  Â  if (e.target.id === 'planModal') {
Â  Â  Â  Â  closePlan();
Â  Â  Â  }
Â  Â  });

Â  Â  // Donate button handler opens the Venmo page in a new tab

Â  Â  // Close donate modal
Â  Â  $("closeDonate").addEventListener('click', () => {
Â  Â  Â  $("donateModal").classList.remove('active');
Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  showGhost();
Â  Â  });
Â  Â  // Also close donate modal when tapping outside content
Â  Â  $("donateModal").addEventListener('click', (e) => {
Â  Â  Â  if (e.target.id === 'donateModal') {
Â  Â  Â  Â  $("donateModal").classList.remove('active');
Â  Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  Â  Â  showGhost();
Â  Â  Â  }
Â  Â  });
Â  Â  // Open Venmo page in new tab
Â  Â  $("openVenmoBtn").addEventListener('click', () => {
Â  Â  Â  const venmoUrl = 'https://venmo.com/Stephen-Mohamed-1';
Â  Â  Â  window.open(venmoUrl);
Â  Â  });
Â  Â  // Copy Venmo handle to clipboard
Â  Â  $("copyVenmoBtn").addEventListener('click', async () => {
Â  Â  Â  try {
Â  Â  Â  Â  await navigator.clipboard.writeText('@Stephen-Mohamed-1');
Read-only
Â  Â  Â  Â  alert('Venmo handle copied to clipboard!');
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  alert('Unable to copy. Please copy manually.');
Â  Â  Â  }
Â  Â  });
Â  Â  function loadMyList() {
Â  Â  Â  const list = getSavedList();
Â  Â  Â  const content = $("myListContent");
Â  Â  Â  const empty = $("myListEmpty");
Â  Â  Â  content.innerHTML = '';
Â  Â  Â  if (list.length === 0) {
Â  Â  Â  Â  empty.style.display = 'block';
Â  Â  Â  } else {
Â  Â  Â  Â  empty.style.display = 'none';
Â  Â  Â  Â  list.forEach(item => {
Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  btn.addEventListener('click', () => showDetails(item.place_id));
Â  Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  Â  wrapper.className = 'results-item';
Â  Read-only
Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  img.src = item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  Â  Â  Â  Â  wrapper.appendChild(img);
Â  Â  Â  Â  Â  const info = document.createElement('div');
Â  Â  Â  Â  Â  info.className = 'results-info';
Â  Â  Â  Â  Â  const title = document.createElement('h4');
Â  Â  Â  Â  Â  title.textContent = item.name;
Â  Â  Â  Â  Â  info.appendChild(title);
Â  Â  Â  Â  Â  const rating = document.createElement('span');
Â  Â  Â  Â  Â  rating.className = 'rating';
Â  Â  Â  Â  Â  rating.textContent = item.rating ? `â˜…${item.rating.toFixed(1)}` : '';
Â  Â  Â  Â  Â  info.appendChild(rating);
Â  Â  Â  Â  Â  wrapper.appendChild(info);
Â  Â  Â  Â  Â  btn.appendChild(wrapper);
Â  Â  Â  Â  Â  // Delete icon
Â  Â  Â  Â  Â  const delSpan = document.createElement('span');
Â  Â  Â  Â  Â  delSpan.textContent = 'ğŸ—‘ï¸';
Â  Â  Â  Â  Â  btn.appendChild(delSpan);
Â  Â  Â  Â  Â  btn.style.justifyContent = 'space-between';
Â  Â  Â  Â  Â  btn.addEventListener('contextmenu', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  removePlace(item.place_id);
Read-only
Â  Â  Â  Â  Â  Â  loadMyList();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  content.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  // Update details sheet close click to use closeDetails()
Â  Â  $("detailsSheet").addEventListener('click', (e) => {
Â  Â  Â  if (e.target === $("detailsSheet")) {
Â  Â  Â  Â  closeDetails();
Â  Â  Â  }
Â  Â  });

Â  Â  /*
Read-only
Â  Â  Â  Compass & Navigation Logic

Â  Â  Â  When a user taps the compass button in the details sheet, a modern navigation
Â  Â  Â  overlay slides up from the bottom of the screen. It calculates a route from
Â  Â  Â  the user's current location to the selected place using the Google Directions
Â  Â  Â  Service, displays the stepâ€‘byâ€‘step directions, and provides voice guidance
Â  Â  Â  via the Web Speech API. Users can choose from available device voices and
Â  Â  Â  start/stop the spoken navigation. A close button hides the overlay and
Â  Â  Â  cleans up listeners.
Â  Â  */
Â  Â  let navigationStopped = false;
Â  Â  function openCompass(destLatLng) {
Â  Â  Â  const overlay = $("compassOverlay");
Â  Â  Â  overlay.classList.add('active');
Â  Â  Â  document.body.classList.add('modal-open');
Â  Â  Â  hideGhost();
Â  Â  Â  // Populate voice selector
Â  Â  Â  const voiceSelect = $("voiceSelect");
Â  Â  Â  function populateVoices() {
Â  Â  Â  Â  const voices = window.speechSynthesis.getVoices();
Â  Â  Â  Â  if (!voices || voices.length === 0) return;
Â  Â  Â  Â  voiceSelect.innerHTML = '';
Â  Â  Â  Â  voices.forEach((voice, idx) => {
Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  opt.value = idx;
Â  Â  Â  Â  Â  opt.textContent = `${voice.name}${voice.lang ? ' (' + voice.lang + ')' : ''}`;
Â  Â  Â  Â  Â  voiceSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  populateVoices();
Â  Â  Â  // Some browsers load voices asynchronously
Â  Â  Â  window.speechSynthesis.onvoiceschanged = populateVoices;
Â  Â  Â  // Reset buttons
Â  Â  Â  $("startNavigationBtn").disabled = false;
Â  Â  Â  $("stopNavigationBtn").disabled = true;
Â  Â  Â  // Clear directions list
Â  Â  Â  const directionsList = $("directionsList");
Â  Â  Â  directionsList.innerHTML = 'Calculating routeâ€¦';
Â  Â  Â  // Initialize compass arrow updates
Â  Â  Â  let orientationListener;
Â  Â  Â  const updateCompassArrow = (event) => {
Â  Â  Â  Â  // Compute heading using Google geometry library
Â  Â  Â  Â  if (!currentPosition) return;
Â  Â  Â  Â  const heading = google.maps.geometry.spherical.computeHeading(currentPosition, destLatLng);
Â  Â  Â  Â  const deviceHeading = event.alpha;
Â  Â  Â  Â  if (typeof heading === 'number' && typeof deviceHeading === 'number') {
Â  Â  Â  Â  Â  const rotation = heading - deviceHeading;
Â  Â  Â  Â  Â  $("compassArrow").style.transform = `rotate(${rotation}deg)`;
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  // Request permission for device orientation (iOS) if needed
Read-only
Â  Â  Â  if (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function') {
Â  Â  Â  Â  window.DeviceOrientationEvent.requestPermission().then(response => {
Â  Â  Â  Â  Â  if (response === 'granted') {
Â  Â  Â  Â  Â  Â  orientationListener = updateCompassArrow;
Â  Â  Â  Â  Â  Â  window.addEventListener('deviceorientation', orientationListener, true);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }).catch(console.error);
Â  Â  Â  } else if (window.DeviceOrientationEvent) {
Â  Â  Â  Â  orientationListener = updateCompassArrow;
Â  Â  Â  Â  window.addEventListener('deviceorientation', orientationListener, true);
sÂ  Â  }
Â  Â  Â  // Start watching geolocation for orientation updates
Â  Â  Â  if (navigator.geolocation) {
Â  Â  Â  Â  if (compassWatchId) navigator.geolocation.clearWatch(compassWatchId);
Â  Â  Â  Â  compassWatchId = navigator.geolocation.watchPosition((pos) => {
Â  Â  Â  Â  Â  currentPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  // Use DirectionsService to compute route
Â  Â  Â  const directionsService = new google.maps.DirectionsService();
Â  Â  Â  directionsService.route({
Â  Â  Â  Â  origin: currentPosition,
Â  Â  Â  Â  destination: destLatLng,
Â  Â  Â  Â  travelMode: google.maps.TravelMode.DRIVING
Â  Â  Â  }, (result, status) => {
Â  Â  Â  Â  directionsList.innerHTML = '';
Â  Â  Â  Â  if (status === google.maps.DirectionsStatus.OK) {
Â  Â  Â  Â  Â  const steps = result.routes[0].legs[0].steps;
Â  Â  Â  Â  Â  // Populate list
Â  Â  Â  Â  Â  steps.forEach((step, index) => {
Read-only
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.dataset.index = index;
Â  Â  Â  Â  Â  Â  div.innerHTML = step.instructions;
Â  Â  Â  Â  Â  Â  directionsList.appendChild(div);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // Start navigation function
Â  Â  Â  Â  Â  function startNavigation() {
Â  Â  Â  Â  Â  Â  navigationStopped = false;
Â  Â  Â  Â  Â  Â  $("startNavigationBtn").disabled = true;
Â  Â  Â  Â  Â  Â  $("stopNavigationBtn").disabled = false;
Â  Â  Â  Â  Â  Â  let idx = 0;
Â  Â  Â  Â  Â  Â  function speakNext() {
Â  Â  Â  Â  Â  Â  Â  if (navigationStopped || idx >= steps.length) {
Â  Â  Â  Â  Â  Â  Â  Â  $("startNavigationBtn").disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  $("stopNavigationBtn").disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  // Highlight current step
Â  Â  Â  Â  Â  Â  Â  Array.from(directionsList.children).forEach(el => el.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â  const currentEl = directionsList.children[idx];
Â  Â  Â  Â  Â  Â  Â  if (currentEl) currentEl.classList.add('active');
Read-only
Â  Â  Â  Â  Â  Â  Â  // Remove HTML tags from instructions and preface with step number
Â  Â  Â  Â  Â  Â  Â  const clean = steps[idx].instructions.replace(/<[^>]+>/g, '');
Â  Â  Â  Â  Â  Â  Â  const text = `Step ${idx + 1}: ${clean}.`;
Â  Â  Â  Â  Â  Â  Â  const utter = new SpeechSynthesisUtterance(text);
Â  Â  Â  Â  Â  Â  Â  const voices = window.speechSynthesis.getVoices();
Â  Â  Â  Â  Â  Â  Â  const selectedVoice = voices[voiceSelect.value] || voices[0];
Â  Â  Â  Â  Â  Â  Â  utter.voice = selectedVoice;
Â  Â  Â  Â  Â  Â  Â  // Slightly lower pitch and slower rate for a rugged, confident tone
Â  Â  Â  Â  Â  Â  Â  utter.pitch = 0.85;
Â  Â  Â  Â  Â  Â  Â  utter.rate = 0.95;
Â  Â  Â  Â  Â  Â  Â  utter.volume = 1;
Â  Â  Â  Â  Â  Â  Â  window.speechSynthesis.speak(utter);
Â  Â  Â  Â  Â  Â  Â  idx++;
Â  Â  Â  Â  Â  Â  Â  utter.onend = () => {
read-only
Â  Â  Â  Â  Â  Â  Â  Â  if (!navigationStopped) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Small delay before next instruction
Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(speakNext, 3000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  S Â  };
Â  Â  	}
Â  Â  Â  Â  Â  Â  speakNext();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  function stopNavigation() {
Â  Â  Â  Â  Â  Â  navigationStopped = true;
Â  Â  Â  Â  Â  Â  window.speechSynthesis.cancel();
Â  Â  Â  Â  Â  Â  $("startNavigationBtn").disabled = false;
Â  Â  Â  Â  Â  Â  $("stopNavigationBtn").disabled = true;
Â  	}
Â  Â  Â  Â  Â  $("startNavigationBtn").onclick = startNavigation;
Â  Â  Â  Â  Â  $("stopNavigationBtn").onclick = stopNavigation;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  directionsList.textContent = 'Unable to compute route.';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  // Initialize or update the mini map inside radar
Â  Â  Â  if (typeof google !== 'undefined' && google.maps) {
Read-only
Â  Â  Â  Â  if (miniMap) {
Â  Â  Â  Â  Â  miniMap.setCenter(destLatLng);
Â  Â  Â  Â  Â  miniMap.setZoom(15);
Â  	} else {
Â  Â  Â  Â  Â  miniMap = new google.maps.Map($("miniMap"), {
Â  Â  Â  Â  Â  Â  center: destLatLng,
Â  Â  Â  Â  Â  Â  zoom: 15,
Â  Â  Â  Â  Â  Â  disableDefaultUI: true,
SÂ  Â  Â  Â  Â  gestureHandling: 'none'
Â  Â  Â  Â  Â  });
Â  	}
Â  Â  Â  }
Â  Â  Â  // Bind radar control sliders
Â  	const zoomSlider = $("radarZoom");
Â  Â  Â  const brightnessSlider = $("radarBrightness");
Â  	if (zoomSlider) {
Â  Â  Â  Â  zoomSlider.oninput = () => {
Â  Â  Â  Â  Â  const z = parseInt(zoomSlider.value);
Â  Â  Â  Â  Â  if (miniMap) miniMap.setZoom(z);
Â  Â  Â  Â  };
Â  	}
Â  	if (brightnessSlider) {
Â  Â  Â  Â  brightnessSlider.oninput = () => {
Â  Â  Â  Â  Â  const b = parseInt(brightnessSlider.value);
Two-way
Â  Â  Â  Â  Â  // Adjust overall radar brightness using CSS filter
Â  	S $("radar").style.filter = `brightness(${b/50})`;
Â  	};
Â  	}
Â  	// Close overlay button handler
Â  	$("closeCompassBtn").onclick = () => {
Â  	Â  overlay.classList.remove('active');
Â  	Â  document.body.classList.remove('modal-open');
Â  	Â  if (navigator.geolocation && compassWatchId) {
Â  	Â  Â  navigator.geolocation.clearWatch(compassWatchId);
Â  	Â  }
Â  	Â  if (orientationListener) {
Â  	Â  Â  window.removeEventListener('deviceorientation', orientationListener, true);
Â  	Â  }
Â  	Â  window.speechSynthesis.cancel();
Â  	Â  navigationStopped = true;
Â  	Â  showGhost();
Â  	};
Â  	}

Â  	// Local facts from Wikipedia
Â  	async function fetchLocalFacts(pos) {
Â  	Â  // Cancel any existing fact interval
Â  	Â  clearInterval(factInterval);
Â  	Â  const bubble = $("factBubble");
Â  	Â  if (!bubble) return;
Â  	Â  bubble.textContent = 'Fetching local factsâ€¦';
Â  	Â  try {
Â  	Â  Â  // Query Wikipedia for up to 20 nearby pages within a 20 km radius to gather a wider variety of facts
Â  	Â  Â  const url = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${pos.lat}%7C${pos.lng}&gsradius=20000&gslimit=20&format=json&origin=*`;
Â  	Â  Â  const geoData = await fetch(url).then(res => res.json());
Â  	Â  Â  const pageIds = geoData.query.geosearch.map(item => item.pageid).join('|');
Â  	Â  Â  const extractsUrl = `https://en.wikipedia.org/w/api.php?action=query&pageids=${pageIds}&prop=extracts&explaintext=1&exchars=280&format=json&origin=*`;
Â  	Â  Â  const extracts = await fetch(extractsUrl).then(res => res.json());
Â  	Â  Â  const facts = [];
Â  	Â  Â  Object.values(extracts.query.pages).forEach(page => {
Â  	Â  Â  Â  if (page.extract) {
Â  	Â  Â  Â  Â  // Flatten newlines and remove section headings (e.g., '== References ==')
s Â  	Â  Â  Â  let text = page.extract.replace(/\n+/g, ' ').trim();
Â  	Â  Â  Â  Â  text = text.replace(/==.*?==/g, '');
Â  	Â  Â  Â  Â  // Normalize multiple spaces
Â  	Â  Â  Â  Â  text = text.replace(/\s{2,}/g, ' ').trim();
Â  	Â  Â  Â  Â  if (text.length >= 50 && text.length <= 280) {
Â  	Â  Â  Â  Â  Â  facts.push(text);
Â  	Â  Â  Â  Â  }
Â  	Â  Â  Â  }
Â  	Â  Â  });
Â  	Â  Â  // Remove duplicate facts and use the resulting list for rotation
Â  	Â  Â  const uniqueFacts = [];
Â  	Â  Â  facts.forEach(f => {
Â  	Â  Â  Â  if (!uniqueFacts.includes(f)) uniqueFacts.push(f);
This is a text file, not a code file.
Â  	Â  Â  });
Â  	Â  Â  if (uniqueFacts.length === 0) {
Â  	Â  Â  Â  bubble.textContent = 'No local facts found.';
Â  	Â  Â  Â  return;
Â  	Â  Â  }
Â  	Â  Â  const factsList = uniqueFacts;
Â  	Â  Â  // Index to track which fact is currently displayed
Â  	Â  Â  let idx = 0;
Â  	Â  Â  function showNextFact() {
Â  	Â  Â  Â  // Drop current bubble out
Â  	Â  Â  Â  bubble.classList.add('out');
Â  	Â  Â  Â  setTimeout(() => {
Â  	Â  Â  Â  Â  bubble.textContent = factsList[idx];
Â  	Â  Â  Â  Â  bubble.classList.remove('out');
Â  Next step: 
I will try to reproduce the issue. 	Â  Â  Â  idx = (idx + 1) % factsList.length;
Â  	Â  Â  Â  }, 400);
Â  	Â  Â  }
Â  	Â  Â  // Show first fact immediately
Â  	Â  Â  idx = 0;
Â  	Â  Â  bubble.textContent = factsList[idx];
SÂ  	Â  // Start rotation interval
Â  	Â  Â  clearInterval(factInterval);
Â  	Â  Â  factInterval = setInterval(showNextFact, 8000);
Â  	Â  } catch (err) {
Â  	Â  Â  console.error(err);
Â  	Â  Â  bubble.textContent = 'Unable to fetch facts.';
Â  	Â  }
Â  	}

Â  	// Initialize accordions
Â  	setupAccordions();

Â  	// Register service worker
Â  	if ('serviceWorker' in navigator) {
sÂ  	Â  window.addEventListener('load', () => {
        // *** MODIFIED THIS LINE ***
Â  	Â  Â  Â  navigator.serviceWorker.register('service-worker-v2.js');
Â  	Â  Â  });
Â  	}

Â  	// Start app after Google Maps script loaded
Â  	window.initMap = initApp;
Â  </script>
</body>
</html>
