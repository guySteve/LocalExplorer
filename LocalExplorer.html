<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Local Explorer</title>

  <!-- Google Maps JS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places&callback=initApp" async defer></script>

  <!-- Styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body { font-family:'Raleway',sans-serif; background:#f8f7f2; }
    h1,h2,h3,.font-header { font-family:'Poppins',sans-serif; }
    #panorama { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
    .action-card { background:#111827; color:#f8f7f2; transition:.2s all; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .action-card:hover:not(:disabled){ transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
    .action-card:active:not(:disabled){ transform:translateY(-1px) scale(.98); }
    .action-card:disabled{ opacity:.6; cursor:not-allowed; }

    #result-card{ background:rgba(17,24,39,.9); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      transition:transform .5s cubic-bezier(.19,1,.22,1), opacity .5s ease-out; max-height:90vh; overflow-y:auto;
      border-top:1px solid rgba(248,247,242,.2); }
    #result-screen.hidden #result-card, #result-screen.hidden #result-buttons-container{ opacity:0; transform:translateY(100%); }
    #result-buttons-container{ transition:transform .5s cubic-bezier(.19,1,.22,1), opacity .5s ease-out; }
    .place-type-tag{ background:rgba(248,247,242,.1); border:1px solid rgba(248,247,242,.2); padding:2px 10px; border-radius:9999px; font-size:.75rem; text-transform:capitalize; font-weight:600; }

    #dark-side-button{ position:fixed; bottom:1rem; left:1rem; font-size:1.5rem; opacity:.3; transition:opacity .2s; cursor:pointer; z-index:20; }
    #dark-side-button:hover{ opacity:1; }

    .accordion-content{ max-height:0; overflow:hidden; transition:max-height .3s ease-out; }
    #save-place-button.saved{ transform:scale(1.25); }

    /* Prevent hidden panorama from blocking clicks */
    #panorama-container { pointer-events: none; }
    #panorama-container.opacity-100 { pointer-events: auto; }
  </style>
</head>
<body class="text-gray-900 flex flex-col items-center justify-center min-h-screen p-4">

  <!-- Street View backdrop -->
  <div id="panorama-container" class="fixed inset-0 transition-opacity duration-1000 opacity-0">
    <div id="panorama"></div>
  </div>

  <div id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center">
    <!-- Main -->
    <div id="main-screen">
      <h1 class="text-4xl md:text-5xl font-header font-bold text-gray-900 mb-4">Local Explorer</h1>

      <div id="fun-fact-container" class="text-left mb-4 px-2">
        <h3 class="font-header font-bold mb-1 text-orange-500 text-sm tracking-wider uppercase">Local Fact</h3>
        <p id="fun-fact-text" class="text-sm text-gray-600 border-t-2 border-gray-200 pt-2">Loading...</p>
      </div>

      <p id="location-status" class="text-lg font-semibold text-gray-700 my-4 transition-all">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" placeholder="Enter a city or place" class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-r-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </button>
        </div>
      </div>

      <div class="flex items-center gap-4 mb-4">
        <button id="my-list-button" class="action-card rounded-lg font-bold py-3 text-base flex-1 flex items-center justify-center gap-2">
          <span class="text-xl">📋</span> My List
        </button>
      </div>

      <div id="filter-container" class="grid grid-cols-2 gap-4">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">🍽️</span> Foodie Finds</button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">🏛️</span> Iconic Sights</button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">🌙</span> Night Out</button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">💎</span> Hidden Gems</button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">🐾</span> Pet Friendly</button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">🛠️</span> Utilities & Help</button>
      </div>

      <button id="random-button" class="action-card w-full mt-4 rounded-lg font-bold py-3 text-base flex items-center justify-center gap-2 bg-orange-500 text-white">
        <span class="text-xl">🤷</span> Surprise Me!
      </button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden mt-4 text-gray-600 underline">Back to main filters</button>

      <noscript>
        <p class="text-white bg-red-500 p-4 rounded-lg mt-4">This app requires JavaScript to function.</p>
      </noscript>
    </div>
  </div>

  <button id="dark-side-button" data-filter="dark">👻</button>

  <!-- Result -->
  <div id="result-screen" class="hidden fixed inset-0 z-20 flex flex-col justify-end items-center p-4">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center text-stone-100">
      <img id="place-photo" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Photo of the location" class="w-full h-48 object-cover rounded-lg mb-4" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform">☆</button>
        </div>
      </div>

      <div class="flex justify-center items-baseline gap-4 text-xl my-2">
        <p class="font-semibold text-orange-400" id="place-rating">★ ...</p>
        <p class="font-semibold text-green-400" id="place-price">...</p>
        <a id="phone-link" href="#" class="text-blue-400 hover:underline text-lg"></a>
      </div>

      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>

      <!-- Summary block -->
      <div id="place-summary" class="text-left text-sm space-y-2 hidden"></div>

      <!-- Accordion -->
      <div class="space-y-2 my-4 text-left">
        <div class="bg-black bg-opacity-20 rounded-lg">
          <button class="accordion-toggle w-full p-3 font-bold flex justify-between items-center"><span>Reviews</span><span>▼</span></button>
          <div class="accordion-content px-3 pb-3">
            <div id="place-reviews" class="space-y-2"></div>
          </div>
        </div>
        <div class="bg-black bg-opacity-20 rounded-lg">
          <button class="accordion-toggle w-full p-3 font-bold flex justify-between items-center"><span>Hours</span><span>▼</span></button>
          <div class="accordion-content px-3 pb-3">
            <div id="place-hours"></div>
          </div>
        </div>
        <div class="bg-black bg-opacity-20 rounded-lg">
          <button id="toggle-directions-button" class="accordion-toggle w-full p-3 font-bold flex justify-between items-center"><span>Walking Directions</span><span>▼</span></button>
          <div class="accordion-content px-3 pb-3">
            <div id="directions-panel"></div>
          </div>
        </div>
      </div>

      <div class="flex justify-center gap-4 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Map View</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hidden">Website</a>
        <button id="share-button" class="flex-1 action-card bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Share</button>
      </div>
    </div>

    <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
      <button id="try-again-button" class="flex-1 action-card bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Back</button>
      <button id="next-suggestion-button" class="flex-1 action-card bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
    </div>
  </div>

  <!-- My List Modal -->
  <div id="my-list-modal" class="hidden fixed inset-0 z-30 bg-black bg-opacity-80 flex items-center justify-center p-4">
    <div class="bg-gray-900 p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col text-stone-100">
      <h2 class="text-3xl font-header font-bold mb-4">My Saved Places</h2>
      <div id="my-list-content" class="flex-1 overflow-y-auto space-y-3"></div>
      <button id="close-my-list-button" class="mt-4 action-card bg-rose-700 text-white font-bold py-3 px-6 rounded-lg">Close</button>
    </div>
  </div>

  <script>
    // Register SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./serviceworker.js').catch(err => console.log('SW registration failed:', err));
      });
    }

    // ELEMENTS
    const mainScreen = document.getElementById('main-screen');
    const resultScreen = document.getElementById('result-screen');
    const filterContainer = document.getElementById('filter-container');
    const tryAgainButton = document.getElementById('try-again-button');
    const locationStatus = document.getElementById('location-status');
    const panoramaContainer = document.getElementById('panorama-container');
    const panoramaDiv = document.getElementById('panorama');
    const manualLocationEntry = document.getElementById('manual-location-entry');
    const locationInput = document.getElementById('location-input');
    const searchButton = document.getElementById('search-button');
    const subMenuContainer = document.getElementById('sub-menu-container');
    const backToMainFiltersButton = document.getElementById('back-to-main-filters');
    const randomButton = document.getElementById('random-button');
    const nextSuggestionButton = document.getElementById('next-suggestion-button');
    const funFactText = document.getElementById('fun-fact-text');
    const darkSideButton = document.getElementById('dark-side-button');
    const placeNameEl = document.getElementById('place-name');
    const placeRatingEl = document.getElementById('place-rating');
    const placePriceEl = document.getElementById('place-price');
    const placePhotoEl = document.getElementById('place-photo');
    const placeHoursEl = document.getElementById('place-hours');
    const directionsLink = document.getElementById('directions-link');
    const websiteLink = document.getElementById('website-link');
    const placeTypesContainer = document.getElementById('place-types-container');
    const phoneLink = document.getElementById('phone-link');
    const placeAccessibility = document.getElementById('place-accessibility');
    const placeSummaryEl = document.getElementById('place-summary');
    const placeReviews = document.getElementById('place-reviews');
    const directionsPanel = document.getElementById('directions-panel');
    const savePlaceButton = document.getElementById('save-place-button');
    const myListButton = document.getElementById('my-list-button');
    const myListModal = document.getElementById('my-list-modal');
    const myListContent = document.getElementById('my-list-content');
    const closeMyListButton = document.getElementById('close-my-list-button');
    const shareButton = document.getElementById('share-button');

    // STATE
    let placesService, panorama, geocoder, directionsService;
    let currentUserLocation;
    let lastSearchRequest;
    let localFacts = [];
    let factInterval, currentFactIndex = 0;
    let currentPlace;
    let savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');

    const subFilterMap = {
      eat: { "🍕 Surprise Me": { keyword: "food", type: "restaurant" }, "Italian": { type: "italian_restaurant" }, "Mexican": { type: "mexican_restaurant" }, "Japanese": { type: "japanese_restaurant" }, "Chinese": { type: "chinese_restaurant" }, "Indian": { type: "indian_restaurant" }, "Pizza": { type: "pizza_restaurant" }, "Cafes": { type: "cafe" }, "Desserts": { type: "bakery" } },
      see: { "Museums": { type: "museum" }, "Art Galleries": { type: "art_gallery" }, "Tourist Attractions": { type: "tourist_attraction" } },
      night:{ "Bars": { type: "bar" }, "Night Clubs": { type: "night_club" } },
      gems: { "Quirky Shops": { keyword: "vintage store" }, "Indie Coffee": { type: "cafe" }, "Local Art": { type: "art_gallery" }, "Quiet Spots": { type: "park" } },
      pets: { "Dog Park": { type: "park", keyword: "dog" }, "Pet Store": { type: "pet_store" }, "Veterinarian": { type: "veterinary_care" } },
      utilities: { "Hospital": { type: "hospital" }, "Pharmacy": { type: "pharmacy" }, "Police": { type: "police" }, "Gas Station": { type: "gas_station" }, "Car Rental": { type: "car_rental" }, "ATM": { type: "atm" } },
      dark: { "Cemeteries": { type: "cemetery" }, "Historic Crimes": { keyword: "haunted tour" }, "Notable Tombs": { type: "cemetery", keyword: "famous grave" } }
    };

    function toggleFilterButtons(disabled){
      document.querySelectorAll('#main-screen button').forEach(b => b.disabled = disabled);
    }

    // My List
    function updateSaveButtonState(){
      if (!currentPlace) return;
      if (savedPlaces[currentPlace.place_id]){
        savePlaceButton.textContent = '★';
        savePlaceButton.classList.add('text-orange-400','saved');
      } else {
        savePlaceButton.textContent = '☆';
        savePlaceButton.classList.remove('text-orange-400','saved');
      }
    }
    function toggleSavePlace(){
      if (!currentPlace) return;
      savePlaceButton.classList.add('transform','scale-150');
      setTimeout(() => savePlaceButton.classList.remove('transform','scale-150'), 200);
      if (savedPlaces[currentPlace.place_id]) {
        delete savedPlaces[currentPlace.place_id];
      } else {
        savedPlaces[currentPlace.place_id] = { name: currentPlace.name, vicinity: directionsLink.href };
      }
      localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces));
      updateSaveButtonState();
    }
    function showMyList(){
      myListContent.innerHTML = '';
      if (Object.keys(savedPlaces).length === 0){
        myListContent.innerHTML = '<p class="text-gray-400">You haven\'t saved any places yet! Use the ☆ icon to add one.</p>';
      } else {
        for (const [id, place] of Object.entries(savedPlaces)){
          myListContent.innerHTML += `<div class="p-3 bg-gray-800 rounded-lg flex justify-between items-center">
              <div><h3 class="font-bold">${place.name}</h3>
              <a href="${place.vicinity}" target="_blank" rel="noopener" class="text-xs text-orange-400 hover:underline">Get Directions</a></div>
              <button data-id="${id}" class="text-rose-500 text-2xl remove-place-button">&times;</button>
            </div>`;
        }
      }
      myListModal.classList.remove('hidden');
    }
    function removeSavedPlace(id){
      delete savedPlaces[id];
      localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces));
      showMyList();
    }

    // Fun Facts
    async function getFunFact(coords, retries = 3){
      if (factInterval) clearInterval(factInterval);
      funFactText.textContent = "Finding local facts...";
      try {
        const geoRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=10000&gslimit=10&gscoord=${coords.lat}|${coords.lng}&format=json&origin=*`);
        const geo = await geoRes.json();
        const ids = (geo.query?.geosearch || []).map(p => p.pageid);
        if (!ids.length){ funFactText.textContent = "No local facts found nearby."; return; }

        const extractsRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${ids.join('|')}&format=json&origin=*`);
        const extractsData = await extractsRes.json();
        const pages = extractsData.query?.pages || {};
        localFacts = Object.values(pages)
          .map(p => p.extract)
          .filter(e => e && e.length > 50 && e.length < 280)
          .sort((a,b) => a.length - b.length);

        if (localFacts.length) startFactCycling();
        else funFactText.textContent = "No detailed local facts found.";
      } catch (e){
        console.error(e);
        if (retries > 0) setTimeout(() => getFunFact(coords, retries-1), 1500);
        else funFactText.textContent = "Local facts are currently unavailable.";
      }
    }
    function startFactCycling(){
      if (factInterval) clearInterval(factInterval);
      currentFactIndex = 0;
      funFactText.textContent = localFacts[currentFactIndex];
      if (localFacts.length > 1){
        factInterval = setInterval(() => {
          currentFactIndex = (currentFactIndex + 1) % localFacts.length;
          funFactText.textContent = localFacts[currentFactIndex];
        }, 7000);
      }
    }

    // Google Places — KEEP SUBMENU OPEN on zero results
    function findAdventure(searchParams, retries = 2){
      if (!placesService || !currentUserLocation) return;
      lastSearchRequest = searchParams;
      toggleFilterButtons(true);
      backToMainFiltersButton.disabled = true;
      locationStatus.textContent = "Searching for the perfect spot...";

      // Numeric radius; start without openNow to avoid empty sets in sparse areas
      const request = { location: currentUserLocation, radius: 5000, /* openNow: true, */ ...searchParams };

      const utilityTypes = Object.values(subFilterMap.utilities).map(f => f.type);
      const darkTypes = Object.values(subFilterMap.dark).map(f => f.type).filter(Boolean);
      const isUtilityOrDarkSearch = utilityTypes.includes(request.type) || darkTypes.includes(request.type) || !!searchParams.keyword;

      const previouslyShown = currentPlace?.place_id ? [currentPlace.place_id] : [];

      placesService.nearbySearch(request, (results, status) => {
        console.log('[nearbySearch]', status, results?.length ?? 0, request);

        if (status === google.maps.places.PlacesServiceStatus.OK && results?.length){
          let good = isUtilityOrDarkSearch ? results
            : results.filter(p => (p.rating ?? 0) >= 4.2 && (p.user_ratings_total ?? 0) > 25);

          good = good.filter(p => !previouslyShown.includes(p.place_id));

          // Progressive relaxation if too strict
          if (!good.length && !isUtilityOrDarkSearch) {
            const relaxed = results.filter(p => (p.rating ?? 0) >= 4.0 && (p.user_ratings_total ?? 0) > 5);
            if (relaxed.length) good = relaxed;
          }
          if (!good.length) good = results;

          getPlaceDetails(good[Math.floor(Math.random() * good.length)]);
          return;
        }

        // ✅ Keep submenu visible; no bounce home
        if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
          locationStatus.textContent = "No places found here. Try another sub-filter or widen the radius.";
          toggleFilterButtons(false);
          backToMainFiltersButton.disabled = false;
          return;
        }

        // API/network error
        locationStatus.textContent = "Search failed. Check API key/billing or try again.";
        console.error('Places error:', status);
        toggleFilterButtons(false);
        backToMainFiltersButton.disabled = false;
      });
    }

    function getPlaceDetails(placeSummary){
      resultScreen.classList.remove('hidden');
      panorama.setPosition(placeSummary.geometry.location);
      panoramaContainer.classList.add('opacity-100');
      currentPlace = placeSummary;
      updateSaveButtonState();

      // reset UI
      document.querySelectorAll('.accordion-content').forEach(el => el.style.maxHeight = null);
      document.querySelectorAll('.accordion-toggle span:last-child').forEach(el => el.textContent = '▼');
      placeNameEl.textContent = 'Loading Details...';
      placePhotoEl.src = `https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(placeSummary.name)}`;
      placeRatingEl.textContent = ''; placePriceEl.textContent = '';
      placeHoursEl.innerHTML = '';
      websiteLink.classList.add('hidden');
      placeTypesContainer.innerHTML = '';
      phoneLink.textContent=''; phoneLink.removeAttribute('href');
      placeAccessibility.textContent = ''; placeAccessibility.style.display = 'none';
      placeSummaryEl.classList.add('hidden'); placeSummaryEl.innerHTML = '';
      placeReviews.innerHTML = '';

      const request = {
        placeId: placeSummary.place_id,
        fields: ['name','rating','user_ratings_total','price_level','photos','website','opening_hours','vicinity','types','formatted_phone_number','editorial_summary','reviews','geometry','wheelchair_accessible_entrance']
      };
      placesService.getDetails(request, (place, status) => {
        console.log('[getDetails]', status, place?.name || '');
        if (status === google.maps.places.PlacesServiceStatus.OK && place){
          currentPlace = place;
          placeNameEl.textContent = place.name;
          placeRatingEl.textContent = `★ ${place.rating ?? 'N/A'}`;
          placePriceEl.textContent = place.price_level ? '$'.repeat(place.price_level) : '';
          if (place.photos?.length) placePhotoEl.src = place.photos[0].getUrl({ maxWidth: 600, maxHeight: 400 });
          if (place.website){ websiteLink.href = place.website; websiteLink.classList.remove('hidden'); }
          if (place.formatted_phone_number){ phoneLink.href = `tel:${place.formatted_phone_number}`; phoneLink.textContent = place.formatted_phone_number; }
          if (place.wheelchair_accessible_entrance){ placeAccessibility.textContent = '♿'; placeAccessibility.style.display = 'inline'; }
          if (place.editorial_summary?.overview){
            placeSummaryEl.innerHTML = `<strong>What Google Says:</strong><p class="text-xs italic">${place.editorial_summary.overview}</p>`;
            placeSummaryEl.classList.remove('hidden');
          }
          if (place.reviews?.length){
            place.reviews.slice(0,2).forEach(r => {
              const text = (r.text || '').trim();
              if (text) placeReviews.innerHTML += `<div class="review-card mt-1"><p>"${text.substring(0, 140)}${text.length>140?'…':''}"</p><p class="font-bold text-right">- ${r.author_name || 'Reviewer'}</p></div>`;
            });
          }
          if (place.opening_hours?.weekday_text?.length){
            placeHoursEl.innerHTML = place.opening_hours.weekday_text.join('<br>');
          }
          if (place.types?.length){
            place.types.filter(t => !['point_of_interest','establishment'].includes(t)).slice(0,3).forEach(type => {
              placeTypesContainer.innerHTML += `<span class="place-type-tag">${type.replace(/_/g,' ')}</span>`;
            });
          }
          const destination = encodeURIComponent(`${place.name}, ${place.vicinity || ''}`);
          directionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;
          fetchDirections(place.geometry.location);
          updateSaveButtonState();
        }
      });
    }

    function fetchDirections(destination){
      if (!currentUserLocation) return;
      const request = { origin: currentUserLocation, destination, travelMode: google.maps.TravelMode.WALKING };
      directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK){
          const steps = result.routes[0].legs[0].steps;
          directionsPanel.innerHTML = '<ol class="list-decimal list-inside space-y-1">' +
            steps.map(s => `<li>${s.instructions} (${s.distance.text})</li>`).join('') + '</ol>';
        } else {
          directionsPanel.innerHTML = "Could not retrieve walking directions.";
        }
      });
    }

    // Init
    function initApp(){
      panorama = new google.maps.StreetViewPanorama(panoramaDiv, {
        addressControl:false, showRoadLabels:false, linksControl:false, panControl:false, enableCloseButton:false, fullscreenControl:false, zoomControl:false
      });
      placesService = new google.maps.places.PlacesService(document.createElement('div'));
      geocoder = new google.maps.Geocoder();
      directionsService = new google.maps.DirectionsService();
      toggleFilterButtons(true);

      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          geocoder.geocode({ location: coords }, (results, status) => {
            if (status === 'OK' && results?.[0]) setLocationAndEnableApp(coords, results[0].formatted_address.split(',').slice(0,2).join(','));
            else setLocationAndEnableApp(coords, "Your Current Location");
          });
        }, handleLocationError);
      } else {
        handleLocationError();
      }
    }
    window.initApp = initApp; // expose for callback

    function handleLocationError(){
      locationStatus.textContent = "Couldn't get your location. Please enter one manually.";
      manualLocationEntry.classList.remove('hidden');
      const fallback = { lat: 51.5074, lng: -0.1278 }; // London
      getFunFact(fallback);
      toggleFilterButtons(false);
    }

    function geocodeLocation(){
      const address = locationInput.value.trim();
      if (!address) return;
      locationStatus.textContent = `Searching for "${address}"...`;
      geocoder.geocode({ address }, (results, status) => {
        if (status === 'OK' && results?.[0]){
          const loc = results[0].geometry.location;
          setLocationAndEnableApp({ lat: loc.lat(), lng: loc.lng() }, results[0].formatted_address);
        } else {
          locationStatus.textContent = `Could not find "${address}". Please try again.`;
        }
      });
    }

    function setLocationAndEnableApp(coords, locationName){
      currentUserLocation = coords;
      locationStatus.textContent = `Exploring: ${locationName}`;
      manualLocationEntry.classList.add('hidden');
      toggleFilterButtons(false);
      getFunFact(coords);
    }

    // UI nav
    function showSubMenu(filter){
      filterContainer.classList.add('hidden');
      randomButton.classList.add('hidden'); // only hide the button, not its parent
      darkSideButton.style.display = 'none';
      subMenuContainer.innerHTML = '';
      const subFilters = subFilterMap[filter];
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 gap-4 sub-menu';
      for (const name in subFilters){
        const b = document.createElement('button');
        b.textContent = name; b.dataset.name = name; b.className = 'action-card rounded-lg font-bold py-3 text-base';
        grid.appendChild(b);
      }
      subMenuContainer.appendChild(grid);
      subMenuContainer.classList.remove('hidden');
      backToMainFiltersButton.classList.remove('hidden');
    }
    function hideSubMenu(){
      subMenuContainer.classList.add('hidden');
      backToMainFiltersButton.classList.add('hidden');
      filterContainer.classList.remove('hidden');
      randomButton.classList.remove('hidden');
      darkSideButton.style.display = 'block';
    }
    function findRandomAdventure(){
      const randomizable = { ...subFilterMap };
      ['utilities','pets','dark'].forEach(f => delete randomizable[f]);
      const all = Object.values(randomizable).flatMap(obj => Object.values(obj));
      hideSubMenu();
      findAdventure(all[Math.floor(Math.random() * all.length)]);
    }
    function resetApp(hidePanorama = true){
      resultScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      hideSubMenu();
      toggleFilterButtons(false);
      backToMainFiltersButton.disabled = false;
      if (currentUserLocation) locationStatus.textContent = "Location set! Where to next?";
      if (hidePanorama) panoramaContainer.classList.remove('opacity-100');
    }

    // Events (robust delegation)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn || btn.disabled) return;

      // Main filter buttons
      if (btn.matches('#filter-container > button[data-filter]')) {
        showSubMenu(btn.dataset.filter);
        return;
      }

      // Sub-menu buttons
      if (btn.closest('.sub-menu') && btn.dataset.name) {
        const filterName = btn.dataset.name;
        let parentFilter;
        for (const key in subFilterMap) if (subFilterMap[key][filterName]) parentFilter = key;
        let params = subFilterMap[parentFilter][filterName];

        if (filterName === '🍕 Surprise Me') {
          const food = Object.values(subFilterMap.eat).filter(f => f.keyword !== 'food');
          params = food[Math.floor(Math.random() * food.length)];
        }
        findAdventure(params);
        return;
      }

      // Other controls
      switch (btn.id){
        case 'dark-side-button': showSubMenu('dark'); break;
        case 'back-to-main-filters': hideSubMenu(); break;
        case 'try-again-button': resetApp(); break;
        case 'search-button': geocodeLocation(); break;
        case 'random-button': findRandomAdventure(); break;
        case 'next-suggestion-button': if (lastSearchRequest) findAdventure(lastSearchRequest); break;
        case 'save-place-button': toggleSavePlace(); break;
        case 'my-list-button': showMyList(); break;
        case 'close-my-list-button': myListModal.classList.add('hidden'); break;
        case 'share-button':
          if (navigator.share && currentPlace){
            navigator.share({ title: currentPlace.name, text: `Check out this place I found with Local Explorer: ${currentPlace.name}`, url: directionsLink.href });
          }
          break;
      }

      if (btn.classList.contains('accordion-toggle')){
        const content = btn.nextElementSibling;
        const icon = btn.querySelector('span:last-child');
        if (content.style.maxHeight){ content.style.maxHeight = null; if (icon) icon.textContent = '▼'; }
        else { content.style.maxHeight = content.scrollHeight + 'px'; if (icon) icon.textContent = '▲'; }
      }

      if (btn.classList.contains('remove-place-button')){
        removeSavedPlace(btn.dataset.id);
      }
    });

    locationInput.addEventListener('keyup', e => { if (e.key === 'Enter') geocodeLocation(); });
  </script>
</body>
</html>
