<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Local Explorer</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --navy:#111827; --ivory:#f8f7f2; --amber:#f59e0b; --mint:#10b981;
    }
    body{font-family:'Raleway',sans-serif;background:#f8f7f2;}
    h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
    #panorama{position:absolute;inset:0;z-index:1}
    .action-card{background:#111827;color:#f8f7f2;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .action-card:hover:not(:disabled){transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .action-card:active:not(:disabled){transform:translateY(-1px) scale(.98)}
    .action-card:disabled{opacity:.6;cursor:not-allowed}
    #dark-side-button{position:fixed;bottom:1rem;left:1rem;font-size:1.5rem;opacity:.3;transition:opacity .2s;cursor:pointer;z-index:20}
    #dark-side-button:hover{opacity:1}

    #result-card{background:rgba(17,24,39,.92);color:#f8f7f2;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      transition:transform .5s cubic-bezier(.19,1,.22,1),opacity .5s;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2)}
    .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}

    #panorama-container{pointer-events:none;opacity:0;visibility:hidden}
    #panorama-container.shown{pointer-events:auto;opacity:1;visibility:visible;transition:opacity 1s}

    /* Results overlay: dark + blur so BG doesn‚Äôt distract */
    #results-list-screen{position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem;
      background:rgba(0,0,0,.7);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
    #results-list-card{background:rgba(17,24,39,.96);color:#f8f7f2;border-top-left-radius:1rem;border-top-right-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:0 auto}
    .result-item{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:.75rem;padding:.75rem;display:flex;gap:.75rem}
    .result-thumb{width:84px;height:84px;object-fit:cover;border-radius:.5rem;background:#111827}
    .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

    /* Wavy pop-out + animated compass */
    #compass-hud{position:fixed;right:1rem;bottom:7.5rem;z-index:40;display:none;align-items:center;gap:.6rem}
    #nav-bubble{
      position:relative;max-width:62vw;color:var(--ivory);padding:.65rem .8rem .7rem .85rem;font-size:13px;line-height:1.25;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      background:radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%);
      border:1px solid rgba(255,255,255,.12);animation:blobMorph 9s ease-in-out infinite;
      backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);display:none
    }
    #nav-bubble::after{content:'';position:absolute;right:-10px;bottom:14px;width:0;height:0;border-left:12px solid rgba(17,24,39,.96);
      border-top:10px solid transparent;border-bottom:10px solid transparent;filter:drop-shadow(0 4px 6px rgba(0,0,0,.35))}
    #nav-main{font-weight:700;letter-spacing:.2px}
    #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
    @keyframes blobMorph{
      0%{border-radius:24px 18px 22px 28px / 26px 18px 26px 22px}
      25%{border-radius:18px 26px 20px 24px / 18px 28px 18px 26px}
      50%{border-radius:26px 24px 28px 18px / 22px 24px 18px 28px}
      75%{border-radius:20px 28px 24px 20px / 24px 18px 28px 18px}
      100%{border-radius:24px 18px 22px 28px / 26px 18px 26px 22px}
    }

    #compass-overlay{
      width:100px;height:100px;border-radius:9999px;position:relative;
      background:
        radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
        conic-gradient(from 0deg, rgba(245,158,11,.5), rgba(245,158,11,.1) 30%, rgba(16,185,129,.5) 60%, rgba(16,185,129,.12) 75%, rgba(245,158,11,.35));
      border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden
    }
    #compass-overlay::before{content:'';position:absolute;inset:-30%;
      background:conic-gradient(from 0deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.22) 6%, rgba(255,255,255,0) 12%);
      animation:sweep 4s linear infinite;mix-blend-mode:overlay}
    @keyframes sweep{to{transform:rotate(360deg)}}
    #compass-overlay::after{content:'';position:absolute;width:84%;height:84%;border-radius:9999px;box-shadow:0 0 0 0 rgba(245,158,11,.35);animation:pulse 2.6s ease-out infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245,158,11,.28)}70%{box-shadow:0 0 0 14px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}
    #compass-arrow{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:30px solid var(--amber);
      transform-origin:50% 90%;filter:drop-shadow(0 6px 8px rgba(245,158,11,.45));margin-bottom:6px}
    #compass-dist{font-size:12px;color:#e5e7eb;font-weight:600;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}

    /* Guide button */
    #guide-button{white-space:nowrap}
  </style>
</head>
<body class="text-gray-900 flex flex-col items-center justify-center min-h-screen p-4">

  <div id="panorama-container" class="fixed inset-0">
    <div id="panorama"></div>
  </div>

  <div id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center">
    <div id="main-screen">
      <h1 class="text-4xl md:text-5xl font-header font-bold text-gray-900 mb-4">Local Explorer</h1>

      <div id="fun-fact-container" class="text-left mb-4 px-2">
        <h3 class="font-header font-bold mb-1 text-orange-500 text-sm tracking-wider uppercase">Local Fact</h3>
        <p id="fun-fact-text" class="text-sm text-gray-600 border-t-2 border-gray-200 pt-2">Loading...</p>
      </div>

      <p id="location-status" class="text-lg font-semibold text-gray-700 my-4 transition-all">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" placeholder="Enter a city or place" class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-r-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </button>
        </div>
      </div>

      <div class="flex items-center gap-4 mb-4">
        <button id="my-list-button" class="action-card rounded-lg font-bold py-3 text-base flex-1 flex items-center justify-center gap-2">
          <span class="text-xl">üìã</span> My List
        </button>
      </div>

      <div id="filter-container" class="grid grid-cols-2 gap-4">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üçΩÔ∏è</span> Foodie Finds</button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üèõÔ∏è</span> Iconic Sights</button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üåô</span> Night Out</button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üíé</span> Hidden Gems</button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üêæ</span> Pet Friendly</button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üõ†Ô∏è</span> Utilities & Help</button>
      </div>

      <button id="random-button" class="action-card w-full mt-4 rounded-lg font-bold py-3 text-base flex items-center justify-center gap-2 bg-orange-500 text-white">
        <span class="text-xl">ü§∑</span> Surprise Me!
      </button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden mt-4 text-gray-600 underline">Back to main filters</button>
    </div>
  </div>

  <button id="dark-side-button" data-filter="dark">üëª</button>

  <!-- Results LIST -->
  <div id="results-list-screen" style="display:none;">
    <div id="results-list-card" class="w-full">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card bg-gray-700 text-white font-bold py-2 px-3 rounded-lg">Back</button>
      </div>
      <div id="results-meta" class="text-sm text-gray-300 mb-3"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </div>

  <!-- Detail RESULT -->
  <div id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Photo of the location" class="w-full h-48 object-cover rounded-lg mb-4" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform">‚òÜ</button>
        </div>
      </div>

      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold text-orange-400" id="place-rating">...</p>
        <p class="font-semibold text-green-400" id="place-price">...</p>
        <a id="phone-link" href="#" class="text-blue-300 hover:underline text-sm"></a>
      </div>

      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>

      <!-- Reviews -->
      <div id="reviews-block" class="text-left mt-3 hidden">
        <h3 class="font-bold mb-2">Recent Reviews</h3>
        <div id="place-reviews" class="space-y-2"></div>
      </div>

      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Map View</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hidden">Website</a>
        <button id="share-button" class="flex-1 action-card bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg">Compass</button>
        <button id="guide-button" class="action-card bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Guide Me ‚ñ∂Ô∏é</button>
      </div>

      <!-- Wavy compass HUD -->
      <div id="compass-hud">
        <div id="nav-bubble">
          <div id="nav-main">Head toward destination</div>
          <div id="nav-sub">Follow the arrow</div>
        </div>
        <div id="compass-overlay">
          <div id="compass-arrow"></div>
          <div id="compass-dist">--</div>
        </div>
      </div>
    </div>

    <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
      <button id="try-again-button" class="flex-1 action-card bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Back</button>
      <button id="next-suggestion-button" class="flex-1 action-card bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
    </div>
  </div>

  <script>
    /* ====== Basic setup (SW, elements, state) ====== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./serviceworker.js').catch(err => console.log('SW registration failed:', err));
      });
    }

    const mainScreen = document.getElementById('main-screen');
    const resultsListScreen = document.getElementById('results-list-screen');
    const resultsTitle = document.getElementById('results-title');
    const resultsMeta = document.getElementById('results-meta');
    const resultsList = document.getElementById('results-list');

    const resultScreen = document.getElementById('result-screen');
    const filterContainer = document.getElementById('filter-container');
    const locationStatus = document.getElementById('location-status');
    const panoramaContainer = document.getElementById('panorama-container');
    const panoramaDiv = document.getElementById('panorama');
    const manualLocationEntry = document.getElementById('manual-location-entry');
    const locationInput = document.getElementById('location-input');
    const subMenuContainer = document.getElementById('sub-menu-container');
    const backToMainFiltersButton = document.getElementById('back-to-main-filters');
    const randomButton = document.getElementById('random-button');
    const funFactContainer = document.getElementById('fun-fact-container');
    const funFactText = document.getElementById('fun-fact-text');
    const darkSideButton = document.getElementById('dark-side-button');

    const placeNameEl = document.getElementById('place-name');
    const placeRatingEl = document.getElementById('place-rating');
    const placeStarsEl = document.getElementById('place-stars');
    const placePriceEl = document.getElementById('place-price');
    const placePhotoEl = document.getElementById('place-photo');
    const directionsLink = document.getElementById('directions-link');
    const websiteLink = document.getElementById('website-link');
    const placeTypesContainer = document.getElementById('place-types-container');
    const phoneLink = document.getElementById('phone-link');
    const placeAccessibility = document.getElementById('place-accessibility');
    const savePlaceButton = document.getElementById('save-place-button');
    const nextSuggestionButton = document.getElementById('next-suggestion-button');

    const compassHud = document.getElementById('compass-hud');
    const compassOverlay = document.getElementById('compass-overlay');
    const compassArrow = document.getElementById('compass-arrow');
    const compassDist = document.getElementById('compass-dist');
    const navBubble = document.getElementById('nav-bubble');
    const navMain = document.getElementById('nav-main');
    const navSub = document.getElementById('nav-sub');

    const guideButton = document.getElementById('guide-button');

    const reviewsBlock = document.getElementById('reviews-block');
    const placeReviews = document.getElementById('place-reviews');

    let placesService, panorama, geocoder, directionsService;
    let currentUserLocation;
    let currentLocality = '';
    let currentPlace;
    let currentResults = [];
    let savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');

    // Navigation state
    let compassActive = false;
    let guideSpeaking = false; // audio only when true (user tapped)
    let watchId = null;
    let headingDeg = 0;

    // Route/steps
    let routeSteps = [];
    let stepIndex = 0;
    let stepTarget = null; // LatLng of current step's end

    /* ====== Categories (same strict filters) ====== */
    const subFilterMap = {
      eat: {"üçï Surprise Me":{type:"restaurant"},"Italian":{type:"italian_restaurant",keyword:"italian"},"Mexican":{type:"mexican_restaurant",keyword:"mexican"},"Japanese":{type:"japanese_restaurant",keyword:"japanese"},"Chinese":{type:"chinese_restaurant",keyword:"chinese"},"Indian":{type:"indian_restaurant",keyword:"indian"},"Pizza":{type:"pizza_restaurant",keyword:"pizza"},"Cafes":{type:"cafe",keyword:"cafe"},"Desserts":{type:"bakery",keyword:"dessert bakery"}},
      see:{"Museums":{type:"museum"},"Art Galleries":{type:"art_gallery"},"Tourist Attractions":{type:"tourist_attraction"}},
      night:{"Bars":{type:"bar"},"Night Clubs":{type:"night_club"}},
      gems:{"Quirky Shops":{keyword:"vintage store"},"Indie Coffee":{type:"cafe"},"Local Art":{type:"art_gallery"},"Quiet Spots":{type:"park"}},
      pets:{"Dog Park":{type:"park",keyword:"dog"},"Pet Store":{type:"pet_store"},"Veterinarian":{type:"veterinary_care"}},
      utilities:{"Hospital":{type:"hospital"},"Pharmacy":{type:"pharmacy"},"Police":{type:"police"},"Gas Station":{type:"gas_station"},"Car Rental":{type:"car_rental"},"ATM":{type:"atm"}},
      dark:{"Cemeteries":{type:"cemetery"},"Historic Crimes":{keyword:"haunted tour"},"Notable Tombs":{type:"cemetery",keyword:"famous grave"}}
    };
    const allowedByCategory = {
      eat:new Set(['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant']),
      night:new Set(['bar','night_club']), see:new Set(['museum','art_gallery','tourist_attraction']),
      pets:new Set(['park','pet_store','veterinary_care']), utilities:new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']),
      gems:new Set(['art_gallery','park','cafe']), dark:new Set(['cemetery'])
    };
    const bannedRetailish = new Set(['grocery_or_supermarket','supermarket','department_store','shopping_mall','convenience_store','store']);

    /* ====== Utils ====== */
    function metersToImperial(m){const ft=m*3.28084;if(ft<1000)return `${Math.round(ft)} ft`;const mi=m*0.000621371;return `${mi.toFixed(mi<10?1:0)} mi`}
    function toggleFilterButtons(d){document.querySelectorAll('#main-screen button').forEach(b=>b.disabled=d)}
    function renderStarsHTML(r){r=Math.round(r||0);let h='';for(let i=1;i<=5;i++)h+=`<span class="star${i<=r?' filled':''}">‚òÖ</span>${i<5?' ':''}`;return h}
    function renderStars(el,r){el.innerHTML=renderStarsHTML(r)}
    function updateSaveButtonState(){if(!currentPlace)return;savePlaceButton.textContent=savedPlaces[currentPlace.place_id]?'‚òÖ':'‚òÜ';savePlaceButton.classList.toggle('text-orange-400',!!savedPlaces[currentPlace.place_id])}
    function isRestaurantCandidate(p,kw,reqType){const t=new Set(p.types||[]);const ish=t.has('restaurant')||[...t].some(x=>x.endsWith('_restaurant'))||t.has('cafe')||t.has('bakery')||t.has('meal_takeaway');if(!ish)return false;for(const x of t)if(bannedRetailish.has(x))return false;if(reqType&&!t.has(reqType)){if(!(t.has('restaurant')&&kw&&new RegExp(kw,'i').test(p.name||'')))return false}return true}
    function filterByCategory(results,parent,reqType,kw){const allow=allowedByCategory[parent];if(!allow)return results||[];return (results||[]).filter(p=>{const t=new Set(p.types||[]);const ok=[...t].some(x=>allow.has(x));if(!ok)return false;return parent==='eat'?isRestaurantCandidate(p,kw,reqType):true})}
    function dedupe(items){const s=new Set(),o=[];for(const it of items){if(!s.has(it.place_id)){s.add(it.place_id);o.push(it)}}return o}
    function sortResults(a){return a.sort((x,y)=>(y.rating??0)-(x.rating??0)||(y.user_ratings_total??0)-(x.user_ratings_total??0)||(x.distanceMeters??Infinity)-(y.distanceMeters??Infinity)||x.name.localeCompare(y.name))}

    /* ====== Results List ====== */
    function showResultsList(parentFilter, subLabel){
      funFactContainer.classList.add('hidden');
      resultsListScreen.style.display='flex';
      resultsTitle.textContent=subLabel;
      resultsMeta.textContent=currentResults.length?`${currentResults.length} results`:'No results';
      resultsList.innerHTML='';
      currentResults.forEach(p=>{
        const photo=(p.photos&&p.photos[0])?p.photos[0].getUrl({maxWidth:200,maxHeight:200}):'https://placehold.co/200x200/111827/fff?text=No+Photo';
        const rating=p.rating??null; const price=p.price_level?'$'.repeat(p.price_level):''; const vic=p.vicinity||p.formatted_address||'';
        const card=document.createElement('div'); card.className='result-item';
        card.innerHTML=`
          <img class="result-thumb" src="${photo}" alt="">
          <div class="flex-1 text-left">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-base">${p.name}</h3>
              <div class="text-xs text-gray-300">${price}</div>
            </div>
            <div class="flex items-center gap-2 mt-1">
              <div class="star-row">${renderStarsHTML(rating)}</div>
              <div class="text-sm text-orange-300">${rating?rating.toFixed(1):'N/A'}</div>
              <div class="text-xs text-gray-400">(${p.user_ratings_total??0})</div>
            </div>
            <div class="text-xs text-gray-300 mt-1">${vic}</div>
            <div class="mt-2 flex gap-2">
              <button class="action-card px-2 py-1 rounded-md text-xs open-details" data-id="${p.place_id}">Details</button>
              <a class="action-card px-2 py-1 rounded-md text-xs" target="_blank" rel="noopener"
                 href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.name+', '+(vic||''))}">Map</a>
            </div>
          </div>`;
        resultsList.appendChild(card);
      });
    }

    /* ====== Search Cascade ====== */
    function findAdventure(searchParams,parentFilter,subLabel){
      if(!placesService||!currentUserLocation)return;
      toggleFilterButtons(true); backToMainFiltersButton.disabled=true;
      locationStatus.textContent="Searching nearby..."; currentResults=[];
      const reqType=searchParams.type||null;
      const kw=(parentFilter==='eat')?(searchParams.keyword||(reqType?reqType.replace('_restaurant',''):'')):'';
      const radii=[2000,5000,10000,20000]; let i=0;

      const nearby=()=>{ if(i>=radii.length)return text();
        const radius=radii[i++]; const req={location:currentUserLocation,radius,...(searchParams.type&&{type:searchParams.type}),...(searchParams.keyword&&{keyword:searchParams.keyword})};
        placesService.nearbySearch(req,(res,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK&&res?.length){
            const filtered=filterByCategory(res,parentFilter,reqType,kw).map(r=>({...r}));
            currentResults=dedupe([...currentResults,...filtered]);
            if(currentResults.length<12){locationStatus.textContent=`Searching wider (${metersToImperial(radius)} radius)...`;nearby();} else finalize();
          } else nearby();
        });
      };
      const text=()=>{
        const city=currentLocality||''; const query=kw?`${kw} restaurant ${city?'in '+city:''}`.trim():subLabel+(city?` in ${city}`:'');
        placesService.textSearch({query,location:currentUserLocation,radius:30000},(res,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK&&res?.length){
            const filtered=filterByCategory(res,parentFilter,reqType,kw);
            currentResults=dedupe([...currentResults,...filtered]);
          } finalize();
        });
      };
      const finalize=()=>{
        currentResults=sortResults(currentResults);
        showResultsList(parentFilter,subLabel);
        toggleFilterButtons(false); backToMainFiltersButton.disabled=false;
      };
      nearby();
    }

    /* ====== Details + Reviews ====== */
    function openDetailsById(placeId){const s=currentResults.find(r=>r.place_id===placeId); if(s)getPlaceDetails(s);}
    function stripHtml(h){const t=document.createElement('div'); t.innerHTML=h||''; return t.textContent||t.innerText||'';}

    function getPlaceDetails(summary){
      funFactContainer.classList.add('hidden'); resultsListScreen.style.display='none';
      resultScreen.style.display='flex'; panorama.setPosition(summary.geometry.location); panoramaContainer.classList.add('shown');

      currentPlace=summary; updateSaveButtonState();
      placeNameEl.textContent='Loading Details...';
      placePhotoEl.src=`https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(summary.name)}`;
      placeRatingEl.textContent=''; placeStarsEl.innerHTML=''; placePriceEl.textContent='';
      placeTypesContainer.innerHTML=''; websiteLink.classList.add('hidden');
      phoneLink.textContent=''; phoneLink.removeAttribute('href');
      placeAccessibility.textContent=''; placeAccessibility.style.display='none';
      reviewsBlock.classList.add('hidden'); placeReviews.innerHTML='';

      // Reset nav state
      stopCompass(); // stop old watchers
      routeSteps=[]; stepIndex=0; stepTarget=null;
      compassHud.style.display='flex'; navBubble.style.display='block';

      placesService.getDetails({
        placeId:summary.place_id,
        fields:['name','rating','user_ratings_total','price_level','photos','website','vicinity','types','formatted_phone_number','geometry','wheelchair_accessible_entrance','reviews']
      },(place,status)=>{
        if(status===google.maps.places.PlacesServiceStatus.OK&&place){
          currentPlace=place;
          placeNameEl.textContent=place.name;
          renderStars(placeStarsEl, place.rating??0);
          placeRatingEl.textContent=place.rating?place.rating.toFixed(1):'N/A';
          placePriceEl.textContent=place.price_level?'$'.repeat(place.price_level):'';
          if(place.photos?.length) placePhotoEl.src=place.photos[0].getUrl({maxWidth:600,maxHeight:400});
          if(place.website){websiteLink.href=place.website;websiteLink.classList.remove('hidden')}
          if(place.formatted_phone_number){phoneLink.href=`tel:${place.formatted_phone_number}`;phoneLink.textContent=place.formatted_phone_number}
          if(place.wheelchair_accessible_entrance){placeAccessibility.textContent='‚ôø';placeAccessibility.style.display='inline'}
          if(place.types?.length){
            place.types.filter(t=>!['point_of_interest','establishment'].includes(t)).slice(0,3).forEach(t=>{
              const s=document.createElement('span'); s.className='place-type-tag'; s.textContent=t.replace(/_/g,' '); placeTypesContainer.appendChild(s);
            });
          }
          const dest=`${place.name}, ${place.vicinity||''}`; directionsLink.href=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`;
          // Build route & sync compass with current step
          buildRouteTo(place.geometry.location);
          updateSaveButtonState();
        }
      });
    }

    /* ====== Directions + Compass + Voice (only when pressed) ====== */
    function speak(text){
      if(!guideSpeaking) return; // only if user pressed the Guide button
      try{ const u=new SpeechSynthesisUtterance(text); u.rate=1.0; u.pitch=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{}
    }

    function buildRouteTo(latLng){
      if(!directionsService||!currentUserLocation) return;
      directionsService.route({origin:currentUserLocation,destination:latLng,travelMode:'WALKING'},(res,status)=>{
        if(status==='OK'&&res.routes?.[0]?.legs?.[0]){
          const leg=res.routes[0].legs[0];
          routeSteps=leg.steps||[];
          stepIndex=0;
          setStep(stepIndex);
        } else {
          routeSteps=[]; stepIndex=0; stepTarget={lat:latLng.lat(),lng:latLng.lng()};
          navMain.textContent='Head toward destination'; navSub.textContent='Follow the arrow'; // fallback
        }
      });
    }

    function setStep(i){
      if(i>=routeSteps.length){
        navMain.textContent='Arrived';
        navSub.textContent='You made it üéâ';
        stepTarget=null;
        speak('Arrived.');
        return;
      }
      const st=routeSteps[i];
      const text=stripHtml(st.instructions||'Continue');
      const dist=st.distance?.text||'';
      navMain.textContent=text; navSub.textContent=dist?`Next ‚Ä¢ ${dist}`:'';
      stepTarget={lat:st.end_location.lat(), lng:st.end_location.lng()};
      if(guideSpeaking) speak(`${text}${dist?'. '+dist:''}`);
    }

    const toRad=d=>d*Math.PI/180, norm=a=>((a%360)+360)%360;
    function bearingFromTo(a,b){const œÜ1=toRad(a.lat),œÜ2=toRad(b.lat),ŒîŒª=toRad(b.lng-a.lng);const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);return norm((Math.atan2(y,x)*180)/Math.PI)}
    function haversineMeters(a,b){const R=6371000,dœÜ=toRad(b.lat-a.lat),dŒª=toRad(b.lng-a.lng),œÜ1=toRad(a.lat),œÜ2=toRad(b.lat);const s=Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;return 2*R*Math.asin(Math.sqrt(s))}
    function turnHint(delta){
      if(delta<12||delta>348) return 'Straight';
      if(delta<30) return 'Slight right';
      if(delta<60) return 'Right';
      if(delta<120) return 'Turn right';
      if(delta<180) return 'Sharp right';
      const left=360-delta;
      if(left<30) return 'Slight left';
      if(left<60) return 'Left';
      if(left<120) return 'Turn left';
      return 'Sharp left';
    }

    function updateCompassUI(){
      if(!compassActive||!currentUserLocation||!stepTarget) return;
      const brg=bearingFromTo(currentUserLocation, stepTarget);
      const delta=norm(brg - headingDeg);
      compassArrow.style.transform=`rotate(${delta}deg)`;
      const m=haversineMeters(currentUserLocation, stepTarget);
      compassDist.textContent=metersToImperial(m);
      navSub.textContent=`${turnHint(delta)} ‚Ä¢ ${metersToImperial(m)}`;

      // Step advance threshold (~50 ft)
      if(m < 15.24){ // 5 meters
        stepIndex++;
        setStep(stepIndex);
      }
    }

    function onOrientation(e){
      if(typeof e.webkitCompassHeading==='number'){ headingDeg=e.webkitCompassHeading; }
      else if(typeof e.alpha==='number'){ headingDeg=norm(360 - e.alpha); }
      updateCompassUI();
    }

    function startCompass(){
      if(!currentPlace) return;
      compassActive=true;
      compassHud.style.display='flex';
      navBubble.style.display='block';

      if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission==='function'){
        DeviceOrientationEvent.requestPermission().then(state=>{
          if(state==='granted') window.addEventListener('deviceorientation', onOrientation, true);
          else { alert('Compass permission denied.'); stopCompass(); }
        }).catch(()=>{ alert('Compass not available.'); stopCompass(); });
      } else if(window.DeviceOrientationEvent){
        window.addEventListener('deviceorientation', onOrientation, true);
      } else { alert('Compass not supported.'); stopCompass(); }

      if(navigator.geolocation){
        watchId=navigator.geolocation.watchPosition(
          pos=>{ currentUserLocation={lat:pos.coords.latitude,lng:pos.coords.longitude}; updateCompassUI(); },
          ()=>{}, {enableHighAccuracy:true, maximumAge:3000, timeout:10000}
        );
      }
    }

    function stopCompass(){
      compassActive=false;
      compassHud.style.display='none';
      navBubble.style.display='none';
      window.removeEventListener('deviceorientation', onOrientation, true);
      if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      // do NOT change guideSpeaking here; user controls it
    }

    /* ====== Init / Geocode ====== */
    function initApp(){
      panorama=new google.maps.StreetViewPanorama(panoramaDiv,{addressControl:false,showRoadLabels:false,linksControl:false,panControl:false,enableCloseButton:false,fullscreenControl:false,zoomControl:false});
      placesService=new google.maps.places.PlacesService(document.createElement('div'));
      geocoder=new google.maps.Geocoder();
      directionsService=new google.maps.DirectionsService();
      toggleFilterButtons(true);
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const coords={lat:pos.coords.latitude,lng:pos.coords.longitude};
          reverseGeocodeSetLocation(coords);
        }, handleLocationError);
      } else handleLocationError();
    }
    window.initApp=initApp;

    function handleLocationError(){locationStatus.textContent="Couldn't get your location. Please enter one manually."; manualLocationEntry.classList.remove('hidden'); toggleFilterButtons(false);}
    function reverseGeocodeSetLocation(coords){
      geocoder.geocode({location:coords},(results,status)=>{
        let label="Your Current Location"; currentLocality='';
        if(status==='OK'&&results?.[0]){
          const c=results[0].address_components||[];
          const city=c.find(x=>x.types.includes('locality'))?.long_name||c.find(x=>x.types.includes('postal_town'))?.long_name||c.find(x=>x.types.includes('sublocality'))?.long_name;
          const state=c.find(x=>x.types.includes('administrative_area_level_1'))?.short_name;
          if(city&&state) currentLocality=`${city}, ${state}`;
          label=results[0].formatted_address.split(',').slice(0,2).join(',');
        }
        setLocationAndEnableApp(coords,label);
      });
    }
    function geocodeLocation(){
      const address=locationInput.value.trim(); if(!address) return;
      locationStatus.textContent=`Searching for "${address}"...`;
      geocoder.geocode({address},(results,status)=>{
        if(status==='OK'&&results?.[0]){
          const loc=results[0].geometry.location;
          reverseGeocodeSetLocation({lat:loc.lat(),lng:loc.lng()});
        } else locationStatus.textContent=`Could not find "${address}". Please try again.`;
      });
    }
    function setLocationAndEnableApp(coords,label){currentUserLocation=coords;locationStatus.textContent=`Exploring: ${label}`;manualLocationEntry.classList.add('hidden');toggleFilterButtons(false)}

    /* ====== UI & Events ====== */
    function showSubMenu(filter){
      filterContainer.classList.add('hidden'); randomButton.classList.add('hidden'); darkSideButton.style.display='none';
      subMenuContainer.innerHTML=''; const sub=subFilterMap[filter]; const grid=document.createElement('div'); grid.className='grid grid-cols-2 gap-4 sub-menu';
      for(const name in sub){const b=document.createElement('button'); b.textContent=name; b.dataset.name=name; b.dataset.parent=filter; b.className='action-card rounded-lg font-bold py-3 text-base'; grid.appendChild(b);}
      subMenuContainer.appendChild(grid); subMenuContainer.classList.remove('hidden'); backToMainFiltersButton.classList.remove('hidden');
    }
    function hideSubMenu(){subMenuContainer.classList.add('hidden'); backToMainFiltersButton.classList.add('hidden'); filterContainer.classList.remove('hidden'); randomButton.classList.remove('hidden'); darkSideButton.style.display='block'}
    function resetApp(hide=true){stopCompass(); resultScreen.style.display='none'; resultsListScreen.style.display='none'; mainScreen.classList.remove('hidden'); funFactContainer.classList.remove('hidden'); hideSubMenu(); toggleFilterButtons(false); backToMainFiltersButton.disabled=false; if(currentUserLocation) locationStatus.textContent='Location set! Where to next?'; if(hide) panoramaContainer.classList.remove('shown')}

    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('button'); if(!btn||btn.disabled) return;

      if(btn.matches('#filter-container > button[data-filter]')){showSubMenu(btn.dataset.filter);return;}
      if(btn.closest('.sub-menu') && btn.dataset.name){
        const name=btn.dataset.name, parent=btn.dataset.parent;
        let params=subFilterMap[parent][name];
        if(parent==='eat' && name==='üçï Surprise Me'){const food=Object.values(subFilterMap.eat).filter(f=>f.type&&f.type.endsWith('_restaurant')); params=food[Math.floor(Math.random()*food.length)];}
        findAdventure(params,parent,name); return;
      }
      if(e.target.classList.contains('open-details') || e.target.closest('.open-details')){const t=e.target.closest('.open-details'); openDetailsById(t.dataset.id); return;}

      switch(btn.id){
        case 'dark-side-button': showSubMenu('dark'); break;
        case 'back-to-main-filters': hideSubMenu(); break;
        case 'close-results-button': resultsListScreen.style.display='none'; funFactContainer.classList.remove('hidden'); break;
        case 'try-again-button': resetApp(); break;
        case 'search-button': geocodeLocation(); break;
        case 'next-suggestion-button':
          if(currentResults.length){const idx=currentResults.findIndex(r=>r.place_id===(currentPlace?.place_id||'')); const next=currentResults[(idx+1)%currentResults.length]; if(next) getPlaceDetails(next);}
          break;
        case 'save-place-button':
          if(!currentPlace) break;
          if(savedPlaces[currentPlace.place_id]) delete savedPlaces[currentPlace.place_id];
          else savedPlaces[currentPlace.place_id]={name:currentPlace.name,vicinity:directionsLink.href};
          localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces)); updateSaveButtonState(); break;
        case 'compass-button':
          if(compassActive){ stopCompass(); } else { startCompass(); }
          break;
        case 'guide-button':
          // Toggle audio guidance ONLY by this button
          guideSpeaking = !guideSpeaking;
          btn.textContent = guideSpeaking ? 'Pause ‚è∏' : 'Guide Me ‚ñ∂Ô∏é';
          if(guideSpeaking){
            // read current step again
            if(routeSteps.length && stepIndex < routeSteps.length){
              const st=routeSteps[stepIndex]; const text=stripHtml(st.instructions||'Continue'); const dist=st.distance?.text||''; speak(`${text}${dist?'. '+dist:''}`);
            } else if(currentPlace){
              speak(`Head toward ${currentPlace.name}`);
            }
          } else { try{ speechSynthesis.cancel(); }catch{} }
          break;
      }
    });

    document.getElementById('location-input').addEventListener('keyup',e=>{if(e.key==='Enter') geocodeLocation();});
  </script>

  <!-- Google Maps (keep your restricted key) -->
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places&callback=initApp"></script>
</body>
</html>
