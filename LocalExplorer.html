<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" id="theme-color-meta" content="#0A192F" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Local Explorer" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <title>Local Explorer</title>

    <script src="./key.js"></script>
    <script>
      const GKEY = window.MAPS_API_KEY || 'MISSING_API_KEY';
      document.write(`<script src="https://maps.googleapis.com/maps/api/js?key=${GKEY}&libraries=places,geocoding,directions&callback=initApp" async defer><\/script>`);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        :root {
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #111827; --card-text: #f8f7f2; --card-bg-subtle: #374151;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #6366f1;
          --modal-bg: rgba(17, 24, 39, 0.92); --modal-blur: blur(12px);
          --list-bg: rgba(0, 0, 0, 0.75); --list-card-bg: rgba(17, 24, 39, 0.97);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="day-ops"] { /* Renamed 'light' */
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #ffffff; --card-text: #111827; --card-bg-subtle: #e5e7eb;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #4f46e5;
          --modal-bg: rgba(255, 255, 255, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(255, 255, 255, 0.85); --list-card-bg: rgba(248, 247, 242, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="rugged-explorer"] {
          --bg: #0A192F; --text: #CCD6F6; --text-subtle: #8892B0;
          --card-bg: #112240; --card-text: #CCD6F6; --card-bg-subtle: #0A192F;
          --accent: #64FFDA; --accent-alt: #f59e0b; --accent-dark: #57D3C1;
          --modal-bg: rgba(10, 25, 47, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(17, 34, 64, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }
        [data-theme="night-ops"] {
          --bg: #111111; --text: #E0E0E0; --text-subtle: #9E9E9E;
          --card-bg: #1F1F1F; --card-text: #E0E0E0; --card-bg-subtle: #000000;
          --accent: #FF4136; --accent-alt: #F012BE; --accent-dark: #B10000;
          --modal-bg: rgba(20, 20, 20, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(31, 31, 31, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body{font-family:'Raleway',sans-serif; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s;}
        h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
        .pt-safe{padding-top: calc(1rem + env(safe-area-inset-top));}
        .pb-safe{padding-bottom: calc(1rem + env(safe-area-inset-bottom));}

        .action-card{
          background: var(--card-bg); color: var(--card-text);
          transition: transform 0.2s, box-shadow 0.2s, background 0.3s, color 0.3s;
          box-shadow: 0 4px 12px var(--shadow-color); cursor: pointer;
          -webkit-tap-highlight-color: transparent; /* Touch optimization */
        }
        .action-card:hover:not(:disabled){transform:translateY(-2px); box-shadow:0 8px 20px var(--shadow-color)}
        .action-card:active:not(:disabled){transform:translateY(0) scale(.98)}
        .action-card:disabled{opacity:.4;cursor:not-allowed}

        .card-accent{ background: var(--accent); color: var(--card-bg); }
        .card-accent:hover:not(:disabled){ background: var(--accent); opacity: 0.9; }
        .card-accent-alt{ background: var(--accent-alt); color: var(--card-bg); }
        .card-accent-dark{ background: var(--accent-dark); color: var(--card-text); }

        #result-card{
          background: var(--modal-bg); color: var(--card-text); 
          backdrop-filter: var(--modal-blur); -webkit-backdrop-filter: var(--modal-blur);
          transition:transform .4s ease,opacity .3s ease;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2)
        }
        .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}
        .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

        .list-screen{position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem;
          background: var(--list-bg); backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        .list-card{background: var(--list-card-bg); color: var(--card-text); border-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:auto}
        
        .result-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.75rem;display:flex;gap:.75rem; cursor: pointer;}
        .result-item:hover{background: rgba(255,255,255,0.1);}
        .result-thumb{width:84px;height:84px;object-fit:cover;border-radius:.6rem;background: var(--card-bg); pointer-events: none;}

        .modal-base{position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);}
        .modal-dialog{width: min(92vw, 440px); background: var(--list-card-bg); color: var(--card-text);
          border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); padding:16px; outline:none;}

        #nav-bubble{position:relative;margin: 8px 0 12px 0;padding:.6rem .75rem;font-size:13px;line-height:1.25;
          box-shadow:0 10px 24px rgba(0,0,0,.35);background:radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%);
          border:1px solid rgba(255,255,255,.12)}
        #nav-main{font-weight:700;letter-spacing:.2px}
        #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
        #compass-overlay{width:240px;height:240px;border-radius:22px;margin: 6px auto 10px auto; padding: 18px; position:relative;
          background: radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
            conic-gradient(from 0deg, var(--accent), rgba(245,158,11,.1) 30%, var(--accent-alt), rgba(16,185,129,.12) 75%, var(--accent));
          border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06);
          display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden}
        #compass-arrow{width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:44px solid var(--accent);
          transform-origin:50% 90%;filter:drop-shadow(0 6px 8px var(--accent));margin-bottom:8px}
        #compass-dist{font-size:14px;font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}

        #settings-modal .modal-dialog { padding: 20px; }
        .theme-button { border: 2px solid var(--card-bg-subtle); padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .theme-button.active { border-color: var(--accent); box-shadow: 0 0 10px -2px var(--accent); }
        #voice-selector {
          background: var(--card-bg); color: var(--card-text); border: 1px solid var(--card-bg-subtle);
          padding: 8px 12px; border-radius: 8px; width: 100%; cursor: pointer;
        }
        
        .review-item {
          background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12);
          border-radius: .9rem; padding: .75rem 1rem;
        }
        .review-sort-button {
          background: var(--card-bg-subtle); color: var(--card-text);
          padding: 8px 12px; border-radius: 8px; font-weight: 600; opacity: 0.7; cursor: pointer;
        }
        .review-sort-button.active {
          background: var(--accent); color: var(--card-bg); opacity: 1;
        }
        /* NEW: Star Filter Buttons */
        .review-star-button {
           background: none; border: none; font-size: 1.25rem; padding: 4px; opacity: 0.5; cursor: pointer;
           color: var(--accent); /* Star color */
        }
        .review-star-button.active { opacity: 1; }

        #fun-fact-container {
          background: var(--card-bg); color: var(--text); border-radius: 1rem; padding: 1rem;
          box-shadow: 0 4px 12px var(--shadow-color); text-align: left; margin-bottom: 1.5rem;
        }
        #fun-fact-container h2 {
          color: var(--accent); font-family: 'Poppins', sans-serif; font-weight: 700;
          margin-bottom: 0.25rem; font-size: 0.875rem; letter-spacing: 0.05em; text-transform: uppercase;
        }
        #fun-fact-text {
          color: var(--text-subtle); border-top: 2px solid var(--card-bg-subtle);
          padding-top: 0.5rem; font-size: 0.875rem;
        }

        #searching-modal {
          position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        #searching-dialog {
          background: var(--list-card-bg); color: var(--card-text); border-radius: 1.5rem; padding: 2.5rem;
          display: flex; flex-direction: column; align-items: center; gap: 1rem;
          box-shadow: 0 20px 60px rgba(0,0,0,.5);
        }
        #searching-dialog-icon { font-size: 3.5rem; animation: spin 2s linear infinite; }
        #searching-dialog-text { font-size: 1.25rem; font-family: 'Poppins', sans-serif; font-weight: 700; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pt-safe pb-safe">

  <button id="settings-button" class="action-card rounded-full fixed top-4 right-4 z-30 w-12 h-12 flex items-center justify-center text-2xl" aria-label="Settings">⚙️</button>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center" role="main" aria-live="polite">
    <section id="main-screen" aria-labelledby="app-title">
      <h1 id="app-title" class="text-4xl md:text-5xl font-header font-bold mb-4" style="color: var(--text);">Local Explorer</h1>

      <section id="fun-fact-container">
        <h2>Local Fact</h2>
        <p id="fun-fact-text">Loading...</p>
      </section>

      <p id="location-status" class="text-lg font-semibold my-4" style="color: var(--text-subtle);">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" inputmode="search" placeholder="Enter a city or place"
                 class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card card-accent text-white p-3 rounded-r-lg" aria-label="Search">🔍</button>
        </div>
      </div>

      <nav id="filter-container" class="grid grid-cols-3 gap-3">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🍽️<span class="mt-1">Foodie Finds</span></button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🏛️<span class="mt-1">Iconic Sights</span></button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🌙<span class="mt-1">Night Out</span></button>
        <button data-filter="outdoors" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🏞️<span class="mt-1">Outdoors</span></button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">💎<span class="mt-1">Hidden Gems</span></button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🐾<span class="mt-1">Pet Friendly</span></button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-4 text-sm col-span-3">🛠️ Utilities & Help</button>
      </nav>

      <button id="show-saved-button" class="action-card card-accent-alt w-full mt-4 rounded-lg font-bold py-3 text-base">⭐ My Saved Places</button>
      <button id="local-events-button" class="action-card card-accent-dark w-full mt-4 rounded-lg font-bold py-3 text-base">🎟️ Local Events</button>
      <button id="random-button" class="action-card card-accent w-full mt-4 rounded-lg font-bold py-3 text-base">🤷 Surprise Me!</button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden action-card w-full mt-4 rounded-lg font-bold py-3 text-base" style="background: var(--card-bg-subtle);">← Back to Main Menu</button>
    </section>
  </main>

  <section id="results-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="results-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="results-meta" class="text-sm opacity-80 mb-3"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  <section id="saved-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="saved-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="saved-title" class="text-xl font-header font-bold">My Saved Places</h2>
        <button id="close-saved-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="saved-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  <section id="events-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="events-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="events-title" class="text-xl font-header font-bold">Local Events</h2>
        <button id="close-events-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div class="text-xs opacity-60 text-center mb-2 -mt-2">
        Events provided by <a href="https://ticketmaster.com" target="_blank" rel="noopener" class="underline">Ticketmaster</a>
      </div>
      <div id="events-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  
  <section id="reviews-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="reviews-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="reviews-title" class="text-xl font-header font-bold">Reviews</h2>
        <button id="close-reviews-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="review-sort-container" class="flex gap-2 mb-3">
        <button id="sort-reviews-best" class="review-sort-button flex-1">Best</button>
        <button id="sort-reviews-worst" class="review-sort-button flex-1">Worst</button>
        <button id="sort-reviews-recent" class="review-sort-button flex-1 active">Recent</button>
      </div>
      <div id="review-star-filter-container" class="flex justify-center gap-1 mb-3">
        <button class="review-star-button" data-rating="5">★★★★★</button>
        <button class="review-star-button" data-rating="4">★★★★☆</button>
        <button class="review-star-button" data-rating="3">★★★☆☆</button>
        <button class="review-star-button" data-rating="2">★★☆☆☆</button>
        <button class="review-star-button" data-rating="1">★☆☆☆☆</button>
        <button id="clear-star-filter" class="review-star-button text-xs font-bold" style="opacity: 0.8; color: var(--text-subtle);">Clear</button>
      </div>
      <div id="reviews-list" class="space-y-2 max-h-[55vh] overflow-y-auto"></div>
    </div>
  </section>

  <section id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" loading="lazy" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Place photo" class="w-full h-32 object-cover rounded-lg mb-4" style="background-color: var(--card-bg);" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform" aria-pressed="false">☆</button>
        </div>
      </div>
      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold" style="color: var(--accent);" id="place-rating">...</p>
        <p class="font-semibold" style="color: var(--accent-alt);" id="place-price">...</p>
        <a id="phone-link" href="#" class="hover:underline text-sm" style="color: var(--text-subtle);"></a>
      </div>
      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>
      <button id="show-reviews-button" class="action-card card-accent-dark w-full mt-3 mb-4 rounded-lg font-bold py-3 text-base" disabled>
        Show Reviews (0)
      </button>
      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card card-accent font-bold py-3 px-4 rounded-lg">Map</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card font-bold py-3 px-4 rounded-lg hidden" style="background: var(--card-bg-subtle);">Website</a>
        <button id="share-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Compass</button>
      </div>
      <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
        <button id="try-again-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl" style="background: var(--card-bg-subtle);">Back</button>
        <button id="next-suggestion-button" class="flex-1 action-card card-accent-dark font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
      </div>
    </div>
  </section>

  <div id="compass-modal" class="modal-base">
    <div id="compass-dialog" class="modal-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-2">
        <h2 id="modal-title" class="font-header text-lg">Live Compass</h2>
        <div class="flex gap-2">
          <button id="guide-button" class="action-card card-accent-dark font-bold py-2 px-3 rounded-lg">Guide Me ▶︎</button>
          <button id="close-compass" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button>
        </div>
      </header>
      <div id="nav-bubble">
        <div id="nav-main">Head toward destination</div>
        <div id="nav-sub">Follow the arrow</div>
      </div>
      <div id="compass-overlay">
        <div id="compass-arrow"></div>
        <div id="compass-dist">--</div>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal-base">
    <div id="settings-dialog" class="modal-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-4">
        <h2 class="font-header text-xl">Settings</h2>
        <button id="close-settings-button" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button>
      </header>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Theme</h3>
          <div class="grid grid-cols-3 gap-2">
            <button class="theme-button flex-1" data-theme="day-ops">☀️ Day Ops</button>
            <button class="theme-button flex-1" data-theme="rugged-explorer">⚓ Rugged</button>
            <button class="theme-button flex-1" data-theme="night-ops">🌙 Night Ops</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Guide Voice</h3>
          <select id="voice-selector"> <option value="">Loading voices...</option> </select>
        </div>
        <a id="donate-button" href="https://venmo.com/u/Stephen-Mohamed-1" target="_blank" rel="noopener" 
           class="action-card card-accent-alt font-bold py-3 px-4 rounded-lg w-full block text-center">
          Buy me a coffee (Venmo)
        </a>
        <p id="app-version" class="text-center text-xs opacity-60 mt-4">App Version 9.0</p>
      </div>
    </div>
  </div>
  
  <div id="searching-modal">
    <div id="searching-dialog">
      <div id="searching-dialog-icon">🧭</div>
      <div id="searching-dialog-text">Acquiring Target...</div>
    </div>
  </div>

<!-- ... HTML head and body omitted for brevity ... -->

<script>
    /* ====== Service Worker Registration ====== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker-v2.js')
          .then(reg => console.log('Service worker registered!', reg))
          .catch(err => console.error('Service worker registration failed:', err));
      });
    }

    /* ====== Element References ====== */
    const funFactContainer = document.getElementById('fun-fact-container');
    const funFactText = document.getElementById('fun-fact-text');
    const mainScreen = document.getElementById('main-screen');
    const resultsListScreen = document.getElementById('results-list-screen');
    const resultsTitle = document.getElementById('results-title');
    const resultsMeta = document.getElementById('results-meta');
    const resultsList = document.getElementById('results-list');
    const resultScreen = document.getElementById('result-screen');
    const filterContainer = document.getElementById('filter-container');
    const locationStatus = document.getElementById('location-status');
    const manualLocationEntry = document.getElementById('manual-location-entry');
    const locationInput = document.getElementById('location-input');
    const subMenuContainer = document.getElementById('sub-menu-container');
    const backToMainFiltersButton = document.getElementById('back-to-main-filters');
    const placeNameEl = document.getElementById('place-name');
    const placeRatingEl = document.getElementById('place-rating');
    const placeStarsEl = document.getElementById('place-stars');
    const placePriceEl = document.getElementById('place-price');
    const placePhotoEl = document.getElementById('place-photo');
    const directionsLink = document.getElementById('directions-link');
    const websiteLink = document.getElementById('website-link');
    const placeTypesContainer = document.getElementById('place-types-container');
    const phoneLink = document.getElementById('phone-link');
    const placeAccessibility = document.getElementById('place-accessibility');
    const savePlaceButton = document.getElementById('save-place-button');
    const compassModal = document.getElementById('compass-modal');
    const compassDialog = document.getElementById('compass-dialog');
    const closeCompassBtn = document.getElementById('close-compass');
    const guideButton = document.getElementById('guide-button');
    const navMain = document.getElementById('nav-main');
    const navSub = document.getElementById('nav-sub');
    const compassArrow = document.getElementById('compass-arrow');
    const compassDist = document.getElementById('compass-dist');
    const shareButton = document.getElementById('share-button');
    const randomButton = document.getElementById('random-button');
    const savedListScreen = document.getElementById('saved-list-screen');
    const savedList = document.getElementById('saved-list');
    const eventsListScreen = document.getElementById('events-list-screen');
    const eventsList = document.getElementById('events-list');
    const settingsModal = document.getElementById('settings-modal');
    const settingsDialog = document.getElementById('settings-dialog');
    const themeColorMeta = document.getElementById('theme-color-meta');
    const voiceSelector = document.getElementById('voice-selector');
    const reviewsListScreen = document.getElementById('reviews-list-screen');
    const reviewsList = document.getElementById('reviews-list');
    const showReviewsButton = document.getElementById('show-reviews-button');
    const searchingModal = document.getElementById('searching-modal');
    const reviewSortContainer = document.getElementById('review-sort-container');
    const reviewStarFilterContainer = document.getElementById('review-star-filter-container');

    /* ====== State Variables ====== */
    let placesService, geocoder, directionsService;
    let currentUserLocation;
    let currentLocality = '';
    let currentGeocodeLabel = 'Your Location';
    let currentPlace;
    let currentResults = [];
    let currentResultIndex = 0;
    let savedPlaces = {};
    let localFacts = [], factInterval = null, currentFactIndex = 0;
    let compassActive = false, guideSpeaking = false, watchId = null, headingDeg = 0;
    let routeSteps = [], stepIndex = 0, stepTarget = null, destLatLng = null;
    let voices = [];
    let currentVoiceURI = null;
    let currentReviews = [];
    let currentReviewSort = 'time';
    let currentStarFilter = null;  // null means no star filter

    /* ====== Categories and Filters ====== */
    const subFilterMap = {
      eat: {
        "🍕 Surprise Me": { type: "restaurant" },
        "Italian":       { type: "italian_restaurant", keyword: "italian" },
        "Mexican":       { type: "mexican_restaurant", keyword: "mexican" },
        "Japanese":      { type: "japanese_restaurant", keyword: "japanese" },
        "Chinese":       { type: "chinese_restaurant", keyword: "chinese" },
        "Indian":        { type: "indian_restaurant", keyword: "indian" },
        "Pizza":         { type: "pizza_restaurant", keyword: "pizza" },
        "Cafes":         { type: "cafe", keyword: "cafe" },
        "Desserts":      { type: "bakery", keyword: "dessert bakery" }
      },
      see: {
        "Museums":           { type: "museum" },
        "Art Galleries":     { type: "art_gallery" },
        "Tourist Attractions": { type: "tourist_attraction" }
      },
      night: {
        "Bars":      { type: "bar" },
        "Night Clubs": { type: "night_club" }
      },
      outdoors: {
        "Parks":          { type: "park" },
        "Hiking":         { keyword: "hiking area" },
        "Campground":     { type: "campground" },
        "Scenic Lookout": { type: "tourist_attraction", keyword: "scenic lookout" }
      },
      gems: {
        "Quirky Shops": { keyword: "vintage store" },
        "Indie Coffee": { type: "cafe" },
        "Local Art":    { type: "art_gallery" },
        "Quiet Spots":  { type: "park" }
      },
      pets: {
        "Dog Park":    { type: "park", keyword: "dog park" },
        "Pet Store":   { type: "pet_store", keyword: "pet supplies store" },
        "Veterinarian":{ type: "veterinary_care" }
      },
      utilities: {
        "Hospital":    { type: "hospital" },
        "Pharmacy":    { type: "pharmacy" },
        "Police":      { type: "police" },
        "Gas Station": { type: "gas_station" },
        "Car Rental":  { type: "car_rental" },
        "ATM":         { type: "atm" }
      }
    };
    const allowedByCategory = {
      eat: new Set([
        'restaurant','cafe','bakery','meal_takeaway',
        'pizza_restaurant','italian_restaurant','mexican_restaurant',
        'japanese_restaurant','chinese_restaurant','indian_restaurant'
      ]),
      night: new Set(['bar','night_club']),
      see: new Set(['museum','art_gallery','tourist_attraction']),
      outdoors: new Set(['park','tourist_attraction','campground']),
      gems: new Set(['art_gallery','park','cafe']),
      pets: new Set(['park','pet_store','veterinary_care']),
      utilities: new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']),
      random: new Set([
        // combination of multiple categories
        'restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant',
        'bar','night_club',
        'museum','art_gallery','tourist_attraction',
        'park','campground',
        'art_gallery','park','cafe'
      ])
    };
    const bannedRetailish = new Set([
      'grocery_or_supermarket','supermarket','department_store',
      'shopping_mall','convenience_store','store','lodging','hotel'
    ]);

    /* ====== Utility Functions ====== */
    const metersToImperial = m => {
      const ft = m * 3.28084;
      return ft < 1000 ? `${Math.round(ft)} ft` : `${(m * 0.000621371).toFixed(1)} mi`;
    };
    const toggleFilterButtons = d => 
      document.querySelectorAll('#main-screen button').forEach(b => b.disabled = d);
    const renderStarsHTML = r => {
      r = Math.round(r || 0);
      let h = '';
      for (let i = 1; i <= 5; i++) {
        h += `<span class="star${i <= r ? ' filled' : ''}">★</span>${i < 5 ? ' ' : ''}`;
      }
      return h;
    };
    const renderStars = (el, r) => { el.innerHTML = renderStarsHTML(r); };
    const stripHtml = h => { 
      const t = document.createElement('div');
      t.innerHTML = h || '';
      return t.textContent || t.innerText || '';
    };
    const dedupe = items => {
      const seen = new Set(), out = [];
      for (const it of items) {
        if (!seen.has(it.place_id)) {
          seen.add(it.place_id);
          out.push(it);
        }
      }
      return out;
    };
    const sortResults = a => 
      a.sort((x,y) =>
        (y.rating ?? 0) - (x.rating ?? 0) ||
        (y.user_ratings_total ?? 0) - (x.user_ratings_total ?? 0) ||
        (x.distanceMeters ?? Infinity) - (y.distanceMeters ?? Infinity) ||
        x.name.localeCompare(y.name)
      );

    // Define the missing candidate filter function
    function isCandidate(p, kw, reqType, allowedSet) {
      const t = new Set(p.types || []);
      if (![...t].some(x => allowedSet.has(x))) return false;
      for (const x of t) {
        if (bannedRetailish.has(x)) return false;
      }
      if (reqType && !t.has(reqType)) {
        // Allow keyword match if type doesn't match (e.g., pet store appears as generic "store")
        if (!(kw && new RegExp(kw, 'i').test(p.name || ''))) return false;
      }
      return true;
    }

    function updateSaveButtonState(){
      const pressed = currentPlace && !!savedPlaces[currentPlace.place_id];
      savePlaceButton.setAttribute('aria-pressed', String(pressed));
      savePlaceButton.textContent = pressed ? '★' : '☆';
    }
    function speak(text){
      try {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if (currentVoiceURI) {
          const selectedVoice = voices.find(v => v.voiceURI === currentVoiceURI);
          if (selectedVoice) u.voice = selectedVoice;
        }
        speechSynthesis.speak(u);
      } catch(e) {
        console.error("Speech synthesis error:", e);
      }
    }

    /* ====== Local Facts (unchanged logic) ====== */
    async function getFunFact(coords){ /* ... */ }
    function startFactCycling(){ /* ... */ }

    /* ====== Results/Saved/Events/Reviews Lists ====== */
    function showResultsList(parentFilter, subLabel){
      mainScreen.style.display = 'none';
      savedListScreen.style.display = 'none';
      eventsListScreen.style.display = 'none';
      reviewsListScreen.style.display = 'none';
      resultsListScreen.style.display = 'flex';
      resultsTitle.textContent = subLabel || 'Results';
      resultsMeta.textContent = currentResults.length ? `${currentResults.length} results` : 'No results';
      resultsList.innerHTML = '';
      currentResults.forEach(p => {
        const photo = 'https://placehold.co/200x200/111827/fff?text=N/A';
        const rating = p.rating ?? null;
        const price = p.price_level ? '$'.repeat(p.price_level) : '';
        const vic = p.vicinity || p.formatted_address || '';
        const card = document.createElement('button');
        card.className = 'result-item';
        card.dataset.id = p.place_id;
        card.innerHTML = `
          <img class="result-thumb" loading="lazy" src="${photo}" alt="" />
          <div class="flex-1 text-left">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-base">${p.name}</h3>
              <div class="text-xs opacity-70">${price}</div>
            </div>
            <div class="flex items-center gap-2 mt-1">
              <div class="star-row">${renderStarsHTML(rating)}</div>
              <div class="text-sm" style="color: var(--accent);">
                ${rating ? rating.toFixed(1) : 'N/A'}
              </div>
              <div class="text-xs opacity-60">(${p.user_ratings_total ?? 0})</div>
            </div>
            <div class="text-xs opacity-80 mt-1">${vic}</div>
          </div>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.name + ', ' + vic)}"
             target="_blank" rel="noopener"
             class="p-2 rounded-full card-accent text-white self-center map-link-icon">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
            </svg>
          </a>`;
        resultsList.appendChild(card);
      });
    }

    function showSavedList() {
      mainScreen.style.display = 'none';
      resultsListScreen.style.display = 'none';
      eventsListScreen.style.display = 'none';
      reviewsListScreen.style.display = 'none';
      savedListScreen.style.display = 'flex';
      savedList.innerHTML = '';
      const places = Object.values(savedPlaces);
      if (places.length === 0) {
        savedList.innerHTML = '<p class="opacity-70 text-center">You haven’t saved any places yet.</p>';
        return;
      }
      places.forEach(p => {
        const card = document.createElement('div');
        card.className = 'result-item';
        card.innerHTML = `
          <button class="flex-1 text-left saved-item-details" data-id="${p.place_id}">
            <h3 class="font-semibold text-base">${p.name}</h3>
            <div class="text-xs opacity-80 mt-1">${p.vicinity || ''}</div>
          </button>
          <button class="remove-saved-button action-card font-bold py-2 px-3 rounded-lg"
                  style="background: var(--card-bg-subtle);" data-id="${p.place_id}">
            X
          </button>
        `;
        savedList.appendChild(card);
      });
    }

    function showEventsList(events) {
      mainScreen.style.display = 'none';
      resultsListScreen.style.display = 'none';
      savedListScreen.style.display = 'none';
      reviewsListScreen.style.display = 'none';
      eventsListScreen.style.display = 'flex';
      eventsList.innerHTML = '';
      if (!events || events.length === 0) {
        eventsList.innerHTML = '<p class="opacity-70 text-center">No local events found on Ticketmaster.</p>';
        return;
      }
      events.forEach(event => {
        // ... (render event details here) ...
      });
    }

    function showReviews() {
      // When showing reviews, hide other screens:
      mainScreen.style.display = 'none';
      resultScreen.style.display = 'none';  // hide place detail
      reviewsListScreen.style.display = 'flex';

      // Prepare the filtered & sorted reviews list
      const filteredReviews = currentStarFilter === null 
        ? [...currentReviews] 
        : currentReviews.filter(r => r.rating === currentStarFilter);

      // Apply sorting to reviews:
      if (currentReviewSort === 'time') {
        filteredReviews.sort((a,b) => b.time - a.time);
      } else if (currentReviewSort === 'rating-desc') {
        filteredReviews.sort((a,b) => b.rating - a.rating);
      } else if (currentReviewSort === 'rating-asc') {
        filteredReviews.sort((a,b) => a.rating - b.rating);
      }

      // Update active sort button styling:
      document.querySelectorAll('.review-sort-button').forEach(btn => {
        btn.classList.toggle('active', btn.id.includes(currentReviewSort.split('-')[0]));
      });
      // Update active star filter button styling:
      document.querySelectorAll('.review-star-button').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.rating) === currentStarFilter);
      });

      // Render the review items:
      reviewsList.innerHTML = '';
      if (filteredReviews.length === 0) {
        reviewsList.innerHTML = `<p class="opacity-70 text-center">
                                   No reviews match ${currentStarFilter !== null ? currentStarFilter + '-star filter' : 'your criteria'}.
                                 </p>`;
        return;
      }
      filteredReviews.forEach(review => {
        const card = document.createElement('div');
        card.className = 'review-item';
        card.innerHTML = `
          <div class="flex items-center gap-3 mb-2">
            <img loading="lazy" src="${review.profile_photo_url}" alt="${review.author_name}" 
                 class="w-10 h-10 rounded-full" />
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${review.author_name}</h4>
              <p class="text-xs opacity-70">${review.relative_time_description}</p>
            </div>
            <div class="star-row text-right">${renderStarsHTML(review.rating)}</div>
          </div>
          <p class="text-sm opacity-90">
            ${review.text || '<i>(No text provided)</i>'}
          </p>
        `;
        reviewsList.appendChild(card);
      });
    }

    /* ====== Search Functions ====== */
    async function findLocalEvents() {
      // ... (Ticketmaster API integration if any) ...
    }

    function findAdventure(searchParams, parentFilter, subLabel){
      if (!placesService || !currentUserLocation) return;
      mainScreen.style.display = 'none';
      searchingModal.style.display = 'flex';
      toggleFilterButtons(true);
      backToMainFiltersButton.disabled = true;
      currentResults = [];
      const reqType = searchParams.type || null;
      // Adjust keyword for certain categories (e.g., Pet Store, restaurants):
      let kw = searchParams.keyword || '';
      if (parentFilter === 'pets' && subLabel === 'Pet Store') {
        kw = 'pet supplies store';
      } else if (parentFilter === 'eat') {
        kw = searchParams.keyword || (reqType ? reqType.replace('_restaurant','') : '');
      }

      const radii = [2000, 5000, 10000, 20000, 35000, 50000];
      let i = 0;
      const nearby = () => {
        if (i >= radii.length) return text(); // If no results in all radii, try text search
        const radius = radii[i++];
        const req = { location: currentUserLocation, radius };
        if (searchParams.type) req.type = searchParams.type;
        if (kw) req.keyword = kw;

        placesService.nearbySearch(req, (res, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && res?.length) {
            const allowed = allowedByCategory[parentFilter] || new Set();
            const filtered = (p) => isCandidate(p, kw, reqType, allowed);
            currentResults.push(...res.filter(p => filtered(p)));
            // If not enough results yet, expand search radius:
            if (currentResults.length < 12 && i < radii.length) {
              nearby();
            } else {
              // We have enough results or reached max radius
              finalize();
            }
          } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS && i < radii.length) {
            // No results at this radius, try next radius
            nearby();
          } else {
            // No results or error (e.g., OVER_QUERY_LIMIT); fallback to text search
            console.warn("Nearby search ended (status:", status, "). Switching to text search.");
            text();
          }
        });
      };

      const text = () => {
        const city = currentLocality || '';
        const query = kw ? `${kw} in ${city}` : `${subLabel || searchParams.type || ''} in ${city}`;
        placesService.textSearch({ query, location: currentUserLocation, radius: 50000 }, (res, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && res?.length) {
            const allowed = allowedByCategory[parentFilter] || new Set();
            const filtered = (p) => isCandidate(p, kw, reqType, allowed);
            currentResults.push(...res.filter(p => filtered(p)));
          }
          // Always finalize after text search (regardless of results found or not)
          finalize();
        });
      };

      const finalize = () => {
        currentResults = sortResults(currentResults);
        showResultsList(parentFilter, subLabel);
        searchingModal.style.display = 'none';
        toggleFilterButtons(false);
        backToMainFiltersButton.disabled = false;
      };

      nearby();
    }

    /* ====== Place Details, Directions, and Compass ====== */
    function openDetailsById(placeId){
      // Use PlacesService to get full details by placeId, then call getPlaceDetails
      if (!placesService) return;
      placesService.getDetails({ placeId, fields: ['name'] }, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          // Only summary fetched (just name or minimal fields), call getPlaceDetails with that
          getPlaceDetails({ place_id: placeId, name: place.name });
        } else {
          console.error("Failed to fetch place details for ID:", placeId);
        }
      });
    }

    function getPlaceDetails(summary){
      // Hide other screens and show the detail screen
      mainScreen.style.display = 'none';
      resultsListScreen.style.display = 'none';
      savedListScreen.style.display = 'none';
      eventsListScreen.style.display = 'none';
      reviewsListScreen.style.display = 'none';
      resultScreen.style.display = 'flex';

      currentPlace = summary;
      currentReviews = [];
      currentStarFilter = null;
      currentReviewSort = 'time';
      updateSaveButtonState();

      // Show loading placeholders
      placeNameEl.textContent = 'Loading Details...';
      const placeholdURL = `https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(summary.name)}`;
      placePhotoEl.src = placeholdURL;
      placePhotoEl.onerror = null;
      placeRatingEl.textContent = '';
      placeStarsEl.innerHTML = '';
      placePriceEl.textContent = '';
      placeTypesContainer.innerHTML = '';
      websiteLink.classList.add('hidden');
      phoneLink.textContent = '';
      phoneLink.removeAttribute('href');
      placeAccessibility.textContent = '';
      placeAccessibility.style.display = 'none';
      showReviewsButton.disabled = true;
      showReviewsButton.textContent = 'Loading Reviews...';

      // Reset any compass/navigation state
      routeSteps = [];
      stepIndex = 0;
      stepTarget = null;
      stopCompass();

      // Fetch full place details
      placesService.getDetails({
        placeId: summary.place_id,
        fields: [
          'name','rating','user_ratings_total','price_level','website','vicinity','types',
          'formatted_phone_number','geometry','wheelchair_accessible_entrance','reviews'
        ]
      }, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place) {
          currentPlace = place;
          // Populate details on UI
          placeNameEl.textContent = place.name;
          renderStars(placeStarsEl, place.rating ?? 0);
          placeRatingEl.textContent = place.rating ? place.rating.toFixed(1) : 'N/A';
          placePriceEl.textContent = place.price_level ? '$'.repeat(place.price_level) : '';
          if (place.website) {
            // If you want, you could show a "Website" button (already present as #website-link)
            websiteLink.href = place.website;
            websiteLink.classList.remove('hidden');
          } else {
            // no website, consider showing a different image or keep placeholder
            placePhotoEl.src = placeholdURL;
          }
          if (place.formatted_phone_number) {
            phoneLink.href = `tel:${place.formatted_phone_number}`;
            phoneLink.textContent = place.formatted_phone_number;
          }
          if (place.wheelchair_accessible_entrance) {
            placeAccessibility.textContent = '♿';
            placeAccessibility.style.display = 'inline';
          }
          if (place.types?.length) {
            place.types.forEach(t => {
              if (!t.includes('point_of_interest') && !t.includes('establishment')) {
                const span = document.createElement('span');
                span.className = 'place-type-tag';
                span.textContent = t.replace(/_/g, ' ');
                placeTypesContainer.appendChild(span);
              }
            });
          }

          // Load reviews for this place
          currentReviews = place.reviews || [];
          showReviewsButton.textContent = `Show Reviews (${currentReviews.length})`;
          showReviewsButton.disabled = (currentReviews.length === 0);

          // Show/hide review sort & filter controls based on number of reviews
          const showFilters = currentReviews.length >= 10;
          reviewSortContainer.style.display = showFilters ? 'flex' : 'none';
          reviewStarFilterContainer.style.display = showFilters ? 'flex' : 'none';

          // Set up navigation link and enable compass
          const dest = `${place.name}, ${place.vicinity || ''}`;
          directionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`;
          buildRouteTo(place.geometry.location);
          updateSaveButtonState();
        } else {
          showReviewsButton.textContent = 'Reviews Unavailable';
          console.error("getPlaceDetails: PlacesService status not OK or place not found.");
        }
      });
    }

    function buildRouteTo(latLng){
      destLatLng = null;
      if (!currentUserLocation || !directionsService) {
        console.warn("buildRouteTo: missing user location or directions service.");
        return;
      }
      if (!latLng || typeof latLng.lat !== 'function' || typeof latLng.lng !== 'function') {
        console.error("buildRouteTo: invalid latLng received:", latLng);
        return;
      }
      destLatLng = latLng;
      console.log("DEBUG: destLatLng set to:", destLatLng.toJSON());
      directionsService.route({
        origin: currentUserLocation,
        destination: latLng,
        travelMode: 'WALKING'
      }, (response, status) => {
        if (status === 'OK' && response.routes[0]?.legs[0]?.steps) {
          // Process steps if needed for Guide Me feature...
          routeSteps = response.routes[0].legs[0].steps;
          stepIndex = 0;
          stepTarget = routeSteps[0]?.end_location || null;
        } else {
          // Even if routing fails, we can still use compass to direct to destLatLng
          routeSteps = [];
          stepTarget = null;
          console.warn("Directions service failed or no route:", status);
        }
      });
    }

    // ... (Compass UI functions like setStep, onOrientation, openCompass, etc., unchanged) ...

    /* ====== Settings and Preferences ====== */
    function applyTheme(theme) {
      document.documentElement.dataset.theme = theme;
      localStorage.setItem('appTheme', theme);
      document.querySelectorAll('.theme-button').forEach(b => {
        b.classList.toggle('active', b.dataset.theme === theme);
      });
      const newThemeColor = theme === 'rugged-explorer' ? '#0A192F'
                         : (theme === 'night-ops' ? '#111111' : '#f8f7f2');
      themeColorMeta.content = newThemeColor;
    }

    function applyVoice(voiceURI) {
      currentVoiceURI = voiceURI;
      localStorage.setItem('appVoice', voiceURI);
    }

    function loadVoices() {
      // ... (populate voiceSelector with available voices) ...
    }

    function loadSettings() {
      // Load theme preference
      const theme = localStorage.getItem('appTheme') || 'rugged-explorer';
      applyTheme(theme);
      // Load voice preference
      currentVoiceURI = localStorage.getItem('appVoice') || null;
      loadVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
      }
      // Load saved places from localStorage
      try {
        savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');
      } catch (e) {
        console.error("Error loading saved places:", e);
        savedPlaces = {};
        localStorage.setItem('savedPlaces', '{}');
      }
    }

    function openSettings() {
      settingsModal.style.display = 'flex';
      settingsDialog.focus();
    }
    function closeSettings() {
      settingsModal.style.display = 'none';
    }

    /* ====== Initialization & Geolocation ====== */
    function initApp(){
      loadSettings();
      placesService = new google.maps.places.PlacesService(document.createElement('div'));
      geocoder = new google.maps.Geocoder();
      directionsService = new google.maps.DirectionsService();
      toggleFilterButtons(true);
      locationStatus.textContent = 'Acquiring location...';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          reverseGeocodeSetLocation(coords);
        }, handleLocationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
      } else {
        handleLocationError();
      }
    }
    window.initApp = initApp;  // Google Maps API will call initApp when loaded

    function handleLocationError(error){
      console.warn("Geolocation error:", error);
      locationStatus.textContent = "Couldn't get location. Enter manually?";
      manualLocationEntry.classList.remove('hidden');
      // Load a default fun fact (e.g., for NYC) since we don't have a location
      getFunFact({ lat:40.7128, lng:-74.0060 });
      toggleFilterButtons(false);
    }

    function reverseGeocodeSetLocation(coords){
      // ... (Geocode the coords to get locality, update currentUserLocation, etc.) ...
      // After obtaining address:
      currentUserLocation = coords;
      currentLocality = /* e.g., city name from geocoder result */ '';
      currentGeocodeLabel = /* e.g., formatted location name */ 'Your Location';
      locationStatus.textContent = `Exploring: ${currentGeocodeLabel}`;
      toggleFilterButtons(false);
      // Start cycling local facts
      getFunFact(coords).then(startFactCycling);
    }

    function geocodeLocation(){
      const query = locationInput.value.trim();
      if (!query) return;
      geocoder.geocode({ address: query }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const coords = {
            lat: results[0].geometry.location.lat(),
            lng: results[0].geometry.location.lng()
          };
          setLocationAndEnableApp(coords, results[0].formatted_address);
        } else {
          alert("Location not found. Please try a different query.");
        }
      });
    }

    function setLocationAndEnableApp(coords, label){
      currentUserLocation = coords;
      currentGeocodeLabel = label || 'Custom Location';
      locationStatus.textContent = `Exploring: ${currentGeocodeLabel}`;
      manualLocationEntry.classList.add('hidden');
      toggleFilterButtons(false);
      // Optionally, fetch new fun facts for this location
      getFunFact(coords).then(startFactCycling);
    }

    /* ====== UI & Event Handlers ====== */
    function showSubMenu(filter){
      // ... (show sub-category buttons for chosen filter) ...
    }
    function hideSubMenu(){
      subMenuContainer.innerHTML = '';
      subMenuContainer.classList.add('hidden');
      backToMainFiltersButton.classList.add('hidden');
    }
    function findRandomAdventure() {
      // ... (pick a random category and trigger findAdventure) ...
    }
    function resetApp(){
      closeCompass();
      resultScreen.style.display = 'none';
      resultsListScreen.style.display = 'none';
      savedListScreen.style.display = 'none';
      eventsListScreen.style.display = 'none';
      reviewsListScreen.style.display = 'none';
      mainScreen.style.display = 'block';
      funFactContainer.style.display = 'block';
      hideSubMenu();
      toggleFilterButtons(false);
      backToMainFiltersButton.disabled = false;
      if (currentUserLocation) {
        locationStatus.textContent = `Exploring: ${currentGeocodeLabel}`;
      } else {
        locationStatus.textContent = "Set your location.";
      }
    }

    // Global click handler (navigation & buttons)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn || btn.disabled) return;
      if (e.target.closest('.map-link-icon')) {
        // Let anchor links for map directions work naturally
        return;
      }

      // Main category filter buttons
      if (btn.matches('#filter-container > button[data-filter]')) {
        showSubMenu(btn.dataset.filter);
        return;
      }
      // Sub-menu filter buttons (data-name attribute holds chosen sub-filter info)
      if (btn.closest('.sub-menu') && btn.dataset.name) {
        const { type, keyword } = subFilterMap[btn.closest('.sub-menu').dataset.filter][btn.dataset.name];
        findAdventure({ type, keyword }, btn.closest('.sub-menu').dataset.filter, btn.dataset.name);
        return;
      }

      // Result list item click -> show details
      if (btn.closest('#results-list') && btn.classList.contains('result-item')) {
        openDetailsById(btn.dataset.id);
        return;
      }
      // Saved place item click
      if (btn.classList.contains('saved-item-details')) {
        openDetailsById(btn.dataset.id);
        return;
      }
      // Remove Saved Place button (the "X")
      if (btn.classList.contains('remove-saved-button')) {
        const placeId = btn.dataset.id;
        if (placeId && savedPlaces[placeId]) {
          delete savedPlaces[placeId];
          localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces));
          showSavedList();
        }
        return;
      }
      // Theme selection buttons
      if (btn.classList.contains('theme-button')) {
        applyTheme(btn.dataset.theme);
        return;
      }

      // Review sort buttons
      if (btn.id === 'sort-reviews-best') {
        currentReviewSort = 'rating-desc';
        showReviews();
        return;
      }
      if (btn.id === 'sort-reviews-worst') {
        currentReviewSort = 'rating-asc';
        showReviews();
        return;
      }
      if (btn.id === 'sort-reviews-recent') {
        currentReviewSort = 'time';
        showReviews();
        return;
      }
      // Review star filter buttons
      if (btn.classList.contains('review-star-button')) {
        currentStarFilter = parseInt(btn.dataset.rating);
        showReviews();
        return;
      }
      if (btn.id === 'clear-star-filter') {
        currentStarFilter = null;
        showReviews();
        return;
      }

      // Other button actions (switch by id)
      switch (btn.id) {
        case 'back-to-main-filters':
          hideSubMenu();
          break;
        case 'close-results-button':
        case 'close-saved-button':
        case 'close-events-button':
          resetApp();
          break;
        case 'close-reviews-button':
          // Go back from reviews list to the place details screen
          resultScreen.style.display = 'flex';
          reviewsListScreen.style.display = 'none';
          break;
        case 'show-saved-button':
          showSavedList();
          break;
        case 'local-events-button':
          findLocalEvents();
          break;
        case 'show-reviews-button':
          showReviews();
          break;
        case 'settings-button':
          openSettings();
          break;
        case 'close-settings-button':
          closeSettings();
          break;
        case 'try-again-button':
          resetApp();
          break;
        case 'search-button':
          geocodeLocation();
          break;
        case 'random-button':
          findRandomAdventure();
          break;
        case 'next-suggestion-button':
          // ... (logic to show next suggestion in currentResults) ...
          break;
        case 'save-place-button':
          if (currentPlace) {
            const placeId = currentPlace.place_id;
            if (!placeId) {
              console.error("Cannot save place - place_id is missing!");
              return;
            }
            if (savedPlaces[placeId]) {
              // Already saved -> remove it
              delete savedPlaces[placeId];
            } else {
              // Not saved -> add to savedPlaces
              const vicinityText = currentPlace.vicinity || currentPlace.formatted_address || 'Location saved';
              if (currentPlace.geometry && currentPlace.geometry.location) {
                savedPlaces[placeId] = {
                  name: currentPlace.name || 'Unnamed Place',
                  place_id: placeId,
                  vicinity: vicinityText,
                  geometry: currentPlace.geometry.location.toJSON()
                };
              } else {
                console.error("Cannot save place - geometry is missing!");
                alert("Could not save place - missing location data.");
                return;
              }
            }
            // Update storage and UI star icon
            try {
              localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces));
            } catch(err) {
              console.error("Error saving to localStorage:", err);
              alert("Error saving place. Storage might be full.");
            }
            updateSaveButtonState();
          }
          break;
        case 'compass-button':
          openCompass();
          break;
        case 'close-compass':
          closeCompass();
          break;
        case 'guide-button':
          // ... (speak next navigation step if applicable) ...
          break;
        case 'share-button':
          // ... (share current place logic) ...
          break;
      }
    });

    // Input field events
    document.getElementById('location-input').addEventListener('keyup', e => {
      if (e.key === 'Enter') geocodeLocation();
    });
    voiceSelector.addEventListener('change', e => {
      applyVoice(e.target.value);
    });
</script>

</body>
</html>
