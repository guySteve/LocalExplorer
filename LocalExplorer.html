<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Local Explorer</title>
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  Â  Â  <meta name="theme-color" content="#f8f7f2">
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
Â  Â  <script src="key.js"></script>
<style>
:root {
  /* Modern rugged naval explorer palette */
  --background: #f5f5f2; /* off-white */
  --card: #061f3e;       /* deep navy blue reminiscent of naval uniforms */
  --primary: #e95420;    /* bright orange accent for call-to-actions */
  --secondary: #0a324a;  /* dark teal for secondary highlights */
  --text-dark: #061f3e;
  --text-light: #ffffff;
  --accent: #b38a5e;     /* rope-tan accent color */
  --radius: 12px;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Raleway', sans-serif;
  background-color: var(--background);
  color: var(--text-dark);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  overscroll-behavior: contain; /* Prevent scroll bounce on mobile */
}

h1, h2, h3 {
  font-family: 'Poppins', sans-serif;
  margin: 0;
}

h1 {
  font-size: 1.8rem;
  color: var(--card);
  text-align: center;
  padding: 1rem 0;
  letter-spacing: 0.05rem;
  text-transform: uppercase;
  font-weight: 700;
  border-bottom: 3px solid var(--accent);
}

#locationDisplay {
  text-align: center;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
  color: var(--card);
  font-weight: 500;
  letter-spacing: 0.02rem;
}

#manualInputContainer {
  display: none;
  margin: 0.5rem auto;
  max-width: 90%;
}

#manualInputContainer input {
  width: 100%;
  padding: 0.6rem;
  border-radius: var(--radius);
  border: 1px solid var(--accent);
  font-size: 1rem;
  background-color: var(--background);
  color: var(--card);
  outline: none;
}

/* Fact Widget */
#factWidget {
  background-color: var(--secondary);
  color: var(--text-light);
  margin: 0.5rem auto;
  padding: 0.75rem 1rem;
  border-radius: var(--radius);
  max-width: 90%;
  min-height: 80px;
  border: 2px dashed var(--accent);
  position: relative;
  overflow: hidden;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Single fact bubble styling */
#factBubble {
  background-color: var(--card);
  color: var(--text-light);
  padding: 0.7rem 1rem;
  border-radius: 1rem;
  border: 2px solid var(--accent);
  max-width: 100%;
  min-height: 80px;
  margin: auto;
  text-align: center;
  line-height: 1.4;
  font-size: 1rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  transition: transform 0.4s ease, opacity 0.4s ease;
}

#factBubble.out {
  transform: translateY(20px);
  opacity: 0;
}

/* Filters */
.filters {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 0.5rem;
  max-width: 90%;
  margin: 1rem auto;
}

.filter-btn {
  background-color: var(--card);
  color: var(--text-light);
  border: 1px solid var(--accent);
  border-radius: var(--radius);
  padding: 0.75rem;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  cursor: pointer;
  transition: transform 0.1s ease, background-color 0.2s ease;
}

.filter-btn:active {
  transform: scale(0.96);
  background-color: var(--secondary);
}

/* Special steel-like support button */
.support-btn,
#donateBtn {
  background: linear-gradient(145deg, #48586b, #7b8b9e);
  color: var(--text-light);
  border: 1px solid #a4b0bc;
  box-shadow: inset 1px 1px 2px rgba(255,255,255,0.3),
              inset -2px -2px 3px rgba(0,0,0,0.4);
}

/* Primary actions */
#primaryActions {
  max-width: 90%;
  margin: 1rem auto;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#myListBtn,
#surpriseBtn,
#myPlanBtn {
  border: none;
  border-radius: var(--radius);
  font-size: 1rem;
  padding: 0.8rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

#myListBtn,
#myPlanBtn {
  background-color: var(--secondary);
  color: var(--text-light);
  border: 1px solid var(--accent);
}

#surpriseBtn {
  background-color: var(--primary);
  color: var(--text-light);
  font-weight: 600;
  border: 1px solid var(--primary);
}

/* Ghost button */
#ghostBtn {
  position: fixed;
  bottom: 1rem;
  left: 1rem;
  background: transparent;
  border: none;
  font-size: 2.2rem;
  opacity: 0.4;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.3s;
  z-index: 30;
}

#ghostBtn:hover {
  opacity: 1;
  transform: rotate(5deg);
}

/* Modal overlay */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 20;
}

.modal.active {
  display: flex;
  backdrop-filter: blur(2px);
}

body.modal-open {
  overflow: hidden;
}

.modal-content {
  background-color: var(--background);
  border-radius: var(--radius);
  max-height: 80vh;
  overflow-y: auto;
  width: 92%;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  padding: 1rem;
  position: relative;
  border: 2px solid var(--accent);
  transform: scale(0.95) translateY(20px);
  transition: transform 0.3s ease;
}

.modal.active .modal-content {
  transform: scale(1) translateY(0);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--card);
  padding: 0.2rem;
}

/* List & submenu buttons */
.subMenuList button,
.results-list button {
  width: 100%;
  background: var(--card);
  color: var(--text-light);
  border: none;
  border-radius: var(--radius);
  padding: 0.75rem;
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.special-btn {
  background: var(--primary);
  color: var(--text-light);
  font-weight: 600;
}

.subMenuList button:hover,
.results-list button:hover {
  background: #1e293b;
}

.results-item {
  display: flex;
  gap: 0.75rem;
}

.results-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: var(--radius);
  flex-shrink: 0;
}

.results-info {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.results-info h4 {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  font-size: 1rem;
  color: var(--text-light);
  letter-spacing: 0.03rem;
}

.results-info .rating {
  font-size: 0.8rem;
  color: #fbbf24;
}

/* Details sheet */
#detailsSheet {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 70vh;
  background-color: var(--card);
  color: var(--text-light);
  border-radius: 20px 20px 0 0;
  transform: translateY(100%);
  transition: transform 0.35s ease;
  z-index: 25;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sheet-close {
  position: absolute;
  top: 0.3rem;
  right: 0.5rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-light);
  cursor: pointer;
}

#detailsSheet.active {
  transform: translateY(0);
}

#detailsMap {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 40%;
  background: #000;
}

#detailsContent {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60%;
  overflow-y: auto;
  padding: 1rem;
  background: rgba(17,24,39,0.95);
  backdrop-filter: blur(4px);
}

#detailsContent h3 {
  margin-top: 0;
  font-size: 1.4rem;
}

#detailsContent .stars,
#detailsContent .price {
  color: #fbbf24;
  font-size: 1.1rem;
}

#detailsActions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

#detailsActions button {
  flex: 1;
  min-width: 100px;
  border: none;
  border-radius: var(--radius);
  padding: 0.5rem;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.3rem;
}

#saveBtn {
  background: #4b5563;
  color: var(--text-light);
}

#openMapsBtn,
#websiteBtn {
  background: #334155;
  color: var(--text-light);
}

#shareBtn {
  background: var(--primary);
  color: var(--text-light);
}

#compassBtn {
  background: #0f172a;
  color: var(--text-light);
}

/* Accordion */
.accordion {
  background: #1e293b;
  color: var(--text-light);
  border: none;
  border-radius: var(--radius);
  padding: 0.75rem;
  width: 100%;
  text-align: left;
  outline: none;
  cursor: pointer;
  margin-top: 0.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.accordion-content {
  background: #1e293b;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  border-radius: 0 0 var(--radius) var(--radius);
  padding: 0 0.5rem;
}

.accordion.active + .accordion-content {
  max-height: 300px;
  padding: 0.5rem;
}

/* My List modal */
#myListModal .results-list button,
#planModal .results-list button {
  background-color: var(--secondary);
  border: 1px solid var(--accent);
  margin-bottom: 0.4rem;
  padding: 0.7rem;
}

#myListModal .results-list button:hover,
#planModal .results-list button:hover {
  background-color: #1e293b;
}

#myListModal .empty-state {
  text-align: center;
  color: var(--card);
  font-size: 0.9rem;
  margin: 1rem 0;
}

/* Compass & radar overlay */
#compassOverlay {
  position: fixed;
  bottom: 0.5rem;
  right: 0.5rem;
  transform: translateY(100%);
  width: 300px;
  max-width: 90%;
  background: var(--card);
  color: var(--text-light);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  z-index: 40;
  transition: transform 0.4s ease;
  overflow: hidden;
}

#compassOverlay.active {
  transform: translateY(0);
}

#compassTop {
  padding: 1rem;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

#compassArrow {
  width: 0;
  height: 0;
  border-top: 45px solid var(--primary);
  border-left: 12px solid transparent;
  border-right: 12px solid transparent;
  transform-origin: center bottom;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(0deg);
}

/* Radar scanning animation */
#radar {
  position: relative;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  background: radial-gradient(circle at center, rgba(233,84,32,0.4) 0%, transparent 70%);
  border: 2px solid var(--primary);
  overflow: hidden;
}

#miniMap {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;
  z-index: 0;
}

#radar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  width: 100%;
  height: 100%;
  transform-origin: left center;
  background: linear-gradient(to right, transparent, var(--primary) 5%, transparent 15%);
  animation: radarSweep 6s linear infinite;
}

@keyframes radarSweep {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#compassControls {
  padding: 0.5rem 1rem 1rem 1rem;
  border-top: 1px solid var(--secondary);
  background-color: var(--secondary);
}

#voiceSelect {
  width: 100%;
  padding: 0.4rem;
  border-radius: var(--radius);
  border: 1px solid var(--accent);
  margin-bottom: 0.5rem;
  background-color: var(--card);
  color: var(--text-light);
}

#navigationButtons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

#navigationButtons button {
  flex: 1;
  padding: 0.4rem;
  border-radius: var(--radius);
  border: 1px solid var(--accent);
  background-color: var(--card);
  color: var(--text-light);
  cursor: pointer;
}

#navigationButtons button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#directionsList {
  max-height: 150px;
  overflow-y: auto;
  font-size: 0.85rem;
  line-height: 1.3;
}

#radarControls label {
  color: var(--text-light);
}

/* Hidden map container */
#hiddenMap {
  position: absolute;
  top: 0;
  left: 0;
  width: 1px;
  height: 1px;
  overflow: hidden;
}

/* Responsive adjustments */
@media (min-width: 768px) {
  h1 { font-size: 2rem; }
  #detailsSheet { height: 60vh; }
  #detailsMap { height: 45%; }
  #detailsContent { height: 55%; }
}
</style>

</head>
<body>
Â  <h1>Local Explorer</h1>
Â  <div id="locationDisplay">Determining your locationâ€¦</div>
Â  <div id="manualInputContainer">
Â  Â  <input type="text" id="manualInput" placeholder="Enter a location">
Â  </div>
Â  <div id="factWidget">
Â  Â  <div id="factBubble">Fetching local factsâ€¦</div>
Â  </div>
Â  <div class="filters" id="filterGrid">
Â  Â   </div>
Â  <div id="primaryActions">
Â  Â  <button id="myListBtn">ğŸ“‹ My List</button>
Â  Â  <button id="myPlanBtn">ğŸ—ºï¸ My Plan</button>
Â  Â  <button id="surpriseBtn">ğŸ¤· Surprise Me!</button>
Â  </div>
Â  <button id="ghostBtn">ğŸ‘»</button>

Â  Â  <div id="hiddenMap"></div>

Â  Â  <div id="subMenuModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3 id="subMenuTitle">Categories</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeSubMenu">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="subMenuList" id="subMenuList"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="resultsModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3 id="resultsTitle">Results</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeResults">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="results-list" id="resultsList"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="myListModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3>My List</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeMyList">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="results-list" id="myListContent"></div>
Â  Â  Â  <div class="empty-state" id="myListEmpty" style="display:none;">Your saved places will appear here.</div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="planModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3>My Plan</h3>
Â  Â  Â  Â  <button class="close-btn" id="closePlan">Ã—</button>
  Â  Â  </div>
Â  Â  Â  <div id="planSummary" style="margin-bottom:0.5rem; font-size:0.85rem; color:var(--card);"></div>
Â  Â  Â  <div class="results-list" id="planContent"></div>
Â  Â  Â  <div class="empty-state" id="planEmpty" style="display:none;">Your plan is empty. Add places to your plan from the details view.</div>
Â  Â  Â  <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
Â  Â  Â  Â  <button id="sharePlanBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--primary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Share Plan</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="donateModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h3>Support Local Explorer</h3>
Â  Â  Â  Â  <button class="close-btn" id="closeDonate">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <p style="color: var(--card); font-size: 0.9rem; margin-bottom: 1rem;">
Â  Â  Â  Â  If you enjoy using Local Explorer, consider supporting development. Donations help keep this sailorâ€™s app afloat!
Â  Â  Â  </p>
Â  Â  Â  <p style="color: var(--card); font-size: 0.9rem; margin-bottom: 1rem; text-align:center;">
Â  Â  Â  Â  Venmo: <strong>@Stephen-Mohamed-1</strong>
Â  Â  Â  </p>
Â  Â  Â  <div style="display:flex; gap:0.5rem;">
Â  Â  Â  Â  <button id="openVenmoBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--primary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Open Venmo</button>
Â  Â  Â  Â  <button id="copyVenmoBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--secondary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Copy Handle</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="detailsSheet">
Â  Â  <div id="detailsMap"></div>
Â  Â  <div id="detailsContent">
Â  Â  Â  <button id="closeDetailsBtn" class="sheet-close">Ã—</button>
Â  Â  Â  <h3 id="detailsName"></h3>
Â  Â  Â  <div id="detailsRating"></div>
Â  Â  Â  <div id="detailsPhone"></div>
Â  Â  Â  <div id="detailsAddress"></div>
Â  Â  Â  <div id="detailsPrice"></div>
Â  Â  Â  <div id="detailsActions">
Â  Â  Â  Â  <button id="saveBtn">â˜† Save</button>
Â  Â  Â  Â  <button id="openMapsBtn">ğŸ“ Open in Maps</button>
Â  Â  Â  Â  <button id="websiteBtn">ğŸ”— Website</button>
Â  Â  Â  Â  <button id="shareBtn">ğŸ”— Share</button>
Â  Â  Â  Â  <button id="compassBtn">ğŸ§­ Compass</button>
Â  Â  Â  Â  <button id="addToPlanBtn">ğŸ—ºï¸ Add to Plan</button>
Â  Â  Â  Â  <button id="toggleStreetBtn">ğŸ–¼ï¸ Street View</button>
Â  Â  Â  </div>
Â  Â  Â  <button class="accordion" id="reviewsAccordion">Reviews</button>
Â  Â  Â  <div class="accordion-content" id="reviewsContent"></div>
Â  Â  Â  <button class="accordion" id="hoursAccordion">Weekly Hours</button>
Â  Â  Â  <div class="accordion-content" id="hoursContent"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="compassOverlay">
Â  Â  <div id="compassTop">
Â  Â  Â  <div id="radar">
Â  Â  Â  Â  <div id="miniMap"></div>
Â  Â  Â  Â  <div id="compassArrow"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="compassControls">
Â  Â  Â  <select id="voiceSelect"></select>
Â  Â  Â  <div id="navigationButtons">
Â  Â  Â  Â  <button id="startNavigationBtn">Start</button>
Â  Â  Â  Â  <button id="stopNavigationBtn" disabled>Stop</button>
Â  Â  Â  Â  <button id="closeCompassBtn">Close</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="directionsList"></div>
Â  	  <div id="radarControls">
Â  Â  Â  Â  <label style="display:block; margin-top:0.5rem; font-size:0.8rem;">Zoom
Â  Â  Â  Â  Â  <input type="range" id="radarZoom" min="12" max="20" value="15" style="width:100%;">
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label style="display:block; margin-top:0.5rem; font-size:0.8rem;">Brightness
Â  Â  Â  Â  Â  <input type="range" id="radarBrightness" min="30" max="100" value="50" style="width:100%;">
  Â  Â  Â  </label>
Â  	  </div>
Â  	</div>
Â  </div>

Â  Â  <script>
Â  Â  // Create the script tag for Google Maps after reading the API key from keys.js
Â  Â  (function() {
Â  Â  Â  // Use the key defined in keys.js, or fall back to the userâ€‘provided key if the
Â  Â  Â  // external file fails to load. This ensures the Maps API always receives a key.
Â  Â  Â  const fallbackKey = 'AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY';
Â  Â  Â  const mapsKey = window.MAPS_API_KEY || fallbackKey;
Â  Â  Â  const mapsScript = document.createElement('script');
Â  Â  Â  mapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${mapsKey}&libraries=places,geometry&callback=initMap`;
Â  Â  Â  mapsScript.async = true;
Â  Â  Â  mapsScript.defer = true;
Â  Â  Â  document.head.appendChild(mapsScript);
Â  Â  })();
Â  Â  // Utility functions
Â  Â  function $(id) { return document.getElementById(id); }

Â  Â  // Show/hide the ghost Easter egg depending on whether the user is on the main page
  Â  function hideGhost() {
Â  Â  Â  const ghost = $("ghostBtn");
Â  Â  Â  if (ghost) ghost.style.display = 'none';
Â  Â  }
Â  Â  function showGhost() {
Â  Â  Â  const ghost = $("ghostBtn");
Â  Â  Â  if (ghost) ghost.style.display = 'block';
Â  Â  }

Â  Â  // Store state
Â  Â  let currentPosition = null;
Â  Â  let currentAddress = '';
Â  Â  let map, placesService, geocoder, streetViewPanorama;
Â  Â  let currentResults = [];
Â  Â  let factInterval;
Â  Â  let currentPlaceDetails;
Â  Â  let compassWatching = false;
  Â  let compassWatchId;
Â  Â  let miniMap;
// Track the visibility of Street View for the details view. By default the
// panorama is hidden and a static photo is shown instead.
let streetViewVisible = false;

Â  Â  // Categories definition
Â  Â  const categories = {
Â  Â  Â  "Foodie Finds": [
Â  Â  Â  Â  { name: "Italian", keyword: "italian restaurant", type: "restaurant" },
Â  Â  Â  Â  { name: "Pizza", keyword: "pizza", type: "restaurant" },
Â  Â  Â  Â  { name: "Cafes", keyword: "cafe", type: "cafe" },
Â  Â  Â  Â  { name: "Bakeries", keyword: "bakery", type: "bakery" },
Â  Â  Â  Â  { name: "Sushi", keyword: "sushi", type: "restaurant" }
Â  Â  Â  ],
Â  Â  Â  "Iconic Sights": [
Â  	  { name: "Tourist Attractions", type: "tourist_attraction" },
Â  	  { name: "Museums", type: "museum" },
Â  	  { name: "Art Galleries", type: "art_gallery" },
Â  	  { name: "Parks", type: "park" },
Â  	  { name: "Landmarks", keyword: "landmark", type: "point_of_interest" }
Â  	],
Â  	"Night Out": [
Â  	  { name: "Bars", type: "bar" },
Â  	  { name: "Night Clubs", type: "night_club" },
Â  	  { name: "Movie Theaters", type: "movie_theater" },
Â  	  { name: "Bowling Alleys", type: "bowling_alley" },
Â  	  { name: "Concert Venues", keyword: "concert", type: "point_of_interest" }
Â  	],
Â  	"Hidden Gems": [
Â  	  { name: "Libraries", type: "library" },
Â  	  { name: "Book Stores", type: "book_store" },
Â  	  { name: "Gardens", keyword: "garden", type: "park" },
Â  	  { name: "Historical Sites", keyword: "historical site", type: "point_of_interest" },
Â  	  { name: "Local Favorites", keyword: "local favorite", type: "point_of_interest" }
Â  	],
Â  	"Pet Friendly": [
Â  	  { name: "Dog Parks", keyword: "dog park", type: "park" },
Â  	  { name: "Pet Stores", type: "pet_store" },
Â  	  { name: "Veterinary Care", type: "veterinary_care" },
  	  { name: "Pet Friendly Cafes", keyword: "pet friendly cafe", type: "cafe" },
Â  	  { name: "Pet Friendly Hotels", keyword: "pet friendly hotel", type: "lodging" }
Â  	],
Â  	"Utilities & Help": [
Â  	  { name: "Hospitals", type: "hospital", ignoreRating: true },
Â  	  { name: "Pharmacies", type: "pharmacy", ignoreRating: true },
Â  	  { name: "Police", type: "police", ignoreRating: true },
Â  	  { name: "Gas Stations", type: "gas_station", ignoreRating: true },
Â  	  { name: "ATMs", type: "atm", ignoreRating: true }
Â  	],
Â  	"Dark Side": [
Â  	  { name: "Cemeteries", type: "cemetery", ignoreRating: true },
Â  	  { name: "Funeral Homes", type: "funeral_home", ignoreRating: true },
Â  	  { name: "Psychic", keyword: "psychic", type: "point_of_interest", ignoreRating: true },
Â  	  { name: "Bars", type: "bar", ignoreRating: true },
Â  	  { name: "Haunted Places", keyword: "haunted", type: "point_of_interest", ignoreRating: true }
Â  	]
Â  	,
Â  	"Outdoor": [
Â  	  { name: "Parks", type: "park" },
Â  	  { name: "Trails", keyword: "hiking trail", type: "park" },
Â  	  { name: "Nature Reserves", keyword: "nature reserve", type: "park" },
Â  	  { name: "Beaches", keyword: "beach", type: "park" },
Â  	  { name: "Campgrounds", keyword: "campground", type: "campground" }
Â  	],
Â  	"Local Events": [
Â  	  { name: "All Events", value: "all" },
Â  	  { name: "Music", value: "music" },
Â  	  { name: "Sports", value: "sports" },
  	  { name: "Comedy", value: "comedy" },
Â  	  { name: "Festivals", value: "festival" }
Â  	]
Â   };

Â  	// Initialize the app after Google script loads
Â  	function initApp() {
Â  	  map = new google.maps.Map($("hiddenMap"), { center: { lat: 0, lng: 0 }, zoom: 15 });
Â  	  placesService = new google.maps.places.PlacesService(map);
Â  	  geocoder = new google.maps.Geocoder();
Â  	  // Attempt geolocation
Â  	  if (navigator.geolocation) {
Â  	  	// *** MODIFIED THIS CALL ***
Â  	  	navigator.geolocation.getCurrentPosition(
Â  	  	  onLocationSuccess, 
Â  	  	  onLocationError,
Â  	  	  {
Â  	  	  	enableHighAccuracy: false, // Use faster Wi-Fi/Cellular
Â  	  	  	timeout: 15000, Â  Â  Â  Â  Â // Give it 15 seconds
Â  	  	  	maximumAge: 60000 Â  Â  Â  Â  // Allow a location up to 1 min old
Â  	  	  }
Â  	  	);
Â  	  	// *** END OF MODIFICATION ***
Â  	  } else {
Â  	  	showManualInput();
Â  	  }
Â  	  populateFilterButtons();

Â  	  // If a plan is encoded in the URL (as ?plan=...), decode it and load
Â  	  // it into localStorage, then open the plan modal. The data is
Â  	  // expected to be a base64-encoded, URI-encoded JSON string
Â  	  // containing an object with an `items` array.
Â  	  try {
Â  	  	const params = new URLSearchParams(window.location.search);
Â  	  	if (params.has('plan')) {
Â  	  	  const encoded = params.get('plan');
Â  	  	  const decoded = decodeURIComponent(atob(encoded));
Â  	  	  const data = JSON.parse(decoded);
Â  	  	  if (data && Array.isArray(data.items)) {
Â  	  	  	localStorage.setItem('myPlan', JSON.stringify(data.items));
Â  	  	  	localStorage.removeItem('visitedPlan');
Â  	  	  	// Open the plan modal after a brief delay to allow the UI to initialise
Â  	  	  	setTimeout(() => {
Â  	  	  	  loadPlan();
Â  	  	  	  $("planModal").classList.add('active');
Â  	  	  	  document.body.classList.add('modal-open');
Â  	  	  	  hideGhost();
Â  	  	  	}, 500);
Â  	  	  }
Â  	  	}
Â  	  } catch (e) {
Â  	  	console.warn('Failed to decode shared plan', e);
Â  	  }
Â  	}

Â  	function onLocationSuccess(position) {
Â  	  currentPosition = {
Â  	  	lat: position.coords.latitude,
Â  	  	lng: position.coords.longitude
Â  	  };
Â  	  // Reverse geocode to get address
Â  	  reverseGeocode(currentPosition);
Â  	  // Fetch local facts
Â  	  fetchLocalFacts(currentPosition);
Â  	}

Â  	function onLocationError(err) {
Â  	  console.warn('Geolocation failed', err);
Â  	  $("locationDisplay").textContent = "Enter a location to begin";
Â  	  showManualInput();
Â  	}

Â  	function showManualInput() {
Â  	  $("manualInputContainer").style.display = 'block';
Â  	  const input = $("manualInput");
Â  	  input.addEventListener('keypress', function(e) {
Â  	  	if (e.key === 'Enter') {
Â  	  	  const addr = input.value.trim();
Â  	  	  if (addr) {
Â  	  	  	geocodeAddress(addr);
Â  	  	  }
Â  	  	}
Â  	  });
Â  	}

Â  	function geocodeAddress(address) {
Â  	  geocoder.geocode({ address: address }, (results, status) => {
Â  	  	if (status === 'OK' && results[0]) {
Â  	  	  currentPosition = {
Â  	  	  	lat: results[0].geometry.location.lat(),
Â  	  	  	lng: results[0].geometry.location.lng()
Â  	  	  };
Â  	  	  currentAddress = results[0].formatted_address;
Â  	  	  // Display city/state with small coordinates beneath
Â  	  	  let city = '', state = '';
Â  	  	  if (results[0].address_components) {
Â  	  	  	results[0].address_components.forEach(comp => {
Â  	  	  	  if (comp.types.includes('locality')) city = comp.long_name;
Â  	  	  	  if (comp.types.includes('administrative_area_level_1')) state = comp.short_name || comp.long_name;
Â  	  	  	});
Â  	  	  }
Â  	  	  let locStr = city && state ? `${city}, ${state}` : city || state || currentAddress;
Â  	  	  $("locationDisplay").innerHTML = locStr + '<br><span style="font-size:0.75rem; opacity:0.8;">' + currentPosition.lat.toFixed(4) + ', ' + currentPosition.lng.toFixed(4) + '</span>';
Â  	  	  fetchLocalFacts(currentPosition);
Â  	  	} else {
Â  	  	  alert('Location not found. Please try again.');
Â  	  	}
Â  	  });
Â  	}

Â  	function reverseGeocode(pos) {
Â  	  geocoder.geocode({ location: pos }, (results, status) => {
Â  	  	if (status === 'OK' && results[0]) {
Â  	  	  currentAddress = results[0].formatted_address;
Â  	  	  // Extract city and state for a concise display
Â  	  	  let city = '', state = '';
Â  	  	  if (results[0].address_components) {
Â  	  	  	results[0].address_components.forEach(comp => {
Â  	  	  	  if (comp.types.includes('locality')) city = comp.long_name;
Â  	  	  	  if (comp.types.includes('administrative_area_level_1')) state = comp.short_name || comp.long_name;
Â  	  	  	});
Â  	  	  }
Â  	  	  let locStr = city && state ? `${city}, ${state}` : city || state || currentAddress;
Â  	  	  $("locationDisplay").innerHTML = locStr + '<br><span style="font-size:0.75rem; opacity:0.8;">' + pos.lat.toFixed(4) + ', ' + pos.lng.toFixed(4) + '</span>';
Â  	  	} else {
Â  	  	  // Fallback: display coordinates if reverse geocoding fails
Â  	  	  $("locationDisplay").innerHTML = '<span style="font-size:0.85rem;">' + pos.lat.toFixed(4) + ', ' + pos.lng.toFixed(4) + '</span>';
Â  	  	}
Â  	  });
Â  	}

Â  	function populateFilterButtons() {
Â  	  const grid = $("filterGrid");
Â  	  grid.innerHTML = '';
Â  	  Object.keys(categories).forEach(cat => {
Â  	  	const btn = document.createElement('button');
Â  	  	btn.className = 'filter-btn';
Â  	  	btn.innerHTML = `${getIconForCategory(cat)} ${cat}`;
Â  	  	btn.addEventListener('click', () => openSubMenu(cat));
Â  	  	grid.appendChild(btn);
Â  	  });

Â  	  // Append donation button near the end of the filter grid
Â  	  const supportBtn = document.createElement('button');
Â  	  supportBtn.className = 'filter-btn support-btn';
Â  	  // Clarify that this button is for donations, not technical support
Â  	  supportBtn.innerHTML = 'âš“ Donate';
Â  	  supportBtn.addEventListener('click', () => {
Â  	  	$("donateModal").classList.add('active');
Â  	  	document.body.classList.add('modal-open');
Â  	  	hideGhost();
Â  	  });
Â  	  grid.appendChild(supportBtn);
Â  	}

Â  	function getIconForCategory(cat) {
Â  	  switch (cat) {
Â  	  	case 'Foodie Finds': return 'ğŸ½ï¸';
Â  	  	case 'Iconic Sights': return 'ğŸ›ï¸';
Â  	  	case 'Night Out': return 'ğŸŒ™';
Â  	  	case 'Hidden Gems': return 'ğŸ’';
Â  	  	case 'Pet Friendly': return 'ğŸ¾';
Â  	  	case 'Utilities & Help': return 'ğŸ› ï¸';
Â  	  	case 'Dark Side': return 'ğŸ‘»';
Â  	  	case 'Outdoor': return 'ğŸŒ²';
Â  	  	case 'Local Events': return 'ğŸŸï¸';
Â  	  	default: return '';
Â  	  }
Â  	}

Â  	// Sub menu handling
Â  	function openSubMenu(categoryName) {
Â  	  // Hide ghost when navigating away from home screen
Â  	  hideGhost();
Â  	  $("subMenuTitle").textContent = categoryName;
Â  	  const list = $("subMenuList");
Â  	  list.innerHTML = '';
Â  	  const items = categories[categoryName];
Â  	  items.forEach(item => {
Â  	  	const btn = document.createElement('button');
Â  	  	btn.textContent = item.name;
Â  	  	btn.addEventListener('click', () => {
Â  	  	  closeSubMenu();
Â  	  	  performSearch(categoryName, item);
Â  	  	});
Â  	  	list.appendChild(btn);
Â  	  });
Â  	  // Foodie Finds special: add Surprise Me button
Â  	  if (categoryName === 'Foodie Finds') {
Â  	  	const surpriseBtn = document.createElement('button');
Â  	  	surpriseBtn.className = 'special-btn';
Â  	  	surpriseBtn.textContent = 'ğŸ¤¤ Surprise Me!';
Â  	  	surpriseBtn.addEventListener('click', () => {
Â  	  	  // Randomly pick a subcategory for Foodie Finds
Â  	  	  const options = categories['Foodie Finds'];
Â  	  	  const randomItem = options[Math.floor(Math.random() * options.length)];
Â  	  	  closeSubMenu();
Â  	  	  performSearch('Foodie Finds', randomItem);
Â  	  	});
Â  	  	list.appendChild(surpriseBtn);
Â  	  }
Â  	  $("subMenuModal").classList.add('active');
Â  	  document.body.classList.add('modal-open');
Â  	}

Â  	function closeSubMenu() {
Â  	  $("subMenuModal").classList.remove('active');
Â  	  document.body.classList.remove('modal-open');
Â  	  showGhost();
Â  	}
Â  	$("closeSubMenu").addEventListener('click', closeSubMenu);

Â  	// Results handling
Â  	function performSearch(category, item) {
Â  	  if (!currentPosition) {
Â  	  	alert('Please provide a location first.');
Â  	  	return;
Â  	  }
Â  	  // Handle Local Events separately
Â  	  if (category === 'Local Events') {
Â  	  	searchLocalEvents(item);
Â  	  	return;
Â  	  }
Â  	  const request = {
Â  	  	location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
Â  	  	radius: 7000,
Â  	  	type: item.type || undefined,
Â  	  	keyword: item.keyword || undefined,
Â  	  	rankBy: google.maps.places.RankBy.PROMINENCE
Â  	  };
Â  	  // Use nearbySearch for relevant results
Â  	  placesService.nearbySearch(request, (results, status) => {
Â  	  	if (status === google.maps.places.PlacesServiceStatus.OK) {
Â  	  	  // Filter by rating if needed
Â  	  	  let filtered = results;
Â  	  	  if (!item.ignoreRating) {
Â  	  	  	filtered = results.filter(p => p.rating && p.rating >= 4.2 && p.user_ratings_total && p.user_ratings_total >= 20);
Â  	  	  }
Â  	  	  // Sort by rating then number of reviews
Â  	  	  filtered.sort((a,b) => {
Â  	  	  	const rDiff = (b.rating || 0) - (a.rating || 0);
Â  	  	  	if (rDiff !== 0) return rDiff;
Â  	  	  	return (b.user_ratings_total || 0) - (a.user_ratings_total || 0);
Â  	  	  });
Â  	  	  currentResults = filtered;
Â  	  	  displayResults(category, filtered);
Â  	  	} else {
Â  	  	  alert('No results found.');
Â  	  	}
Â  	  });
Â  	}

Â  	// Search for local events using the Ticketmaster Discovery API.
Â  	// Note: Replace YOUR_TICKETMASTER_API_KEY with your actual API key.
Â  	async function searchLocalEvents(item) {
Â  	  if (!currentPosition) {
Â  	  	alert('Please provide a location first.');
Â  	  	return;
Â  	  }
Â  	  // Use the key from keys.js or fall back to the userâ€‘provided Ticketmaster key
Â  	  const fallbackTicketmasterKey = 'XmzfrRHZilGDGfD63SmdamF288GZ3FxH';
Â  	  const apiKey = window.TICKETMASTER_API_KEY || fallbackTicketmasterKey;
Â  	  if (!apiKey) {
Â  	  	alert('Ticketmaster API key missing. Please define TICKETMASTER_API_KEY in keys.js');
Â  	  	return;
Â  	  }
Â  	  const classification = (item.value && item.value !== 'all') ? item.value : '';
Â  	  const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${apiKey}&latlong=${currentPosition.lat},${currentPosition.lng}&radius=50${classification ? '&classificationName=' + classification : ''}`;
Â  	  try {
Â  	  	const resp = await fetch(url);
Â  	  	const data = await resp.json();
Â  	  	const events = (data._embedded && data._embedded.events) || [];
Â  	  	displayEventResults(events, item.name);
Â  	  } catch (err) {
Â  	  	console.error(err);
Â  	  	alert('Unable to fetch events.');
Â  	  }
Â  	}

Â  	// Display event results in the results modal
Â  	function displayEventResults(events, subCategory) {
Â  	  const list = $("resultsList");
Â  	  list.innerHTML = '';
Â  	  events.forEach(event => {
Â  	  	const btn = document.createElement('button');
Â  	  	btn.className = '';
Â  	  	const wrapper = document.createElement('div');
Â  	  	wrapper.className = 'results-item';
Â  	  	const img = document.createElement('img');
Â  	  	let imgUrl = null;
Â  	  	if (event.images && event.images.length > 0) {
Â  	  	  // Use the first image
Â  	  	  imgUrl = event.images[0].url;
Â  	  	}
Â  	  	img.src = imgUrl || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  	  	wrapper.appendChild(img);
Â  	  	const info = document.createElement('div');
Â  	  	info.className = 'results-info';
Â  	  	const title = document.createElement('h4');
Â  	  	title.textContent = event.name;
Â  	  	info.appendChild(title);
Â  	  	// Date/time information
Â  	  	const dateSpan = document.createElement('span');
Â  	  	dateSpan.className = 'rating';
Â  	  	if (event.dates && event.dates.start) {
Â  	  	  const d = event.dates.start.localDate || '';
Â  	  	  const t = event.dates.start.localTime || '';
Â  	  	  dateSpan.textContent = d + (t ? ' ' + t : '');
Â  	  	} else {
Â  	  	  dateSpan.textContent = '';
Â  	  	}
Â  	  	info.appendChild(dateSpan);
Â  	  	// Venue and location information
Â  	  	const venueSpan = document.createElement('span');
Â  	  	venueSpan.className = 'rating';
Â  	  	if (event._embedded && event._embedded.venues && event._embedded.venues.length > 0) {
Â  	  	  const venue = event._embedded.venues[0];
Â  	  	  const city = venue.city ? venue.city.name : '';
Â  	  	  const state = venue.state ? (venue.state.name || venue.state.stateCode) : '';
Â  	  	  const locStr = city && state ? `${city}, ${state}` : city || state;
Â  	  	  venueSpan.textContent = venue.name + (locStr ? ' â€” ' + locStr : '');
Â  	  	}
Â  	  	info.appendChild(venueSpan);
Â  	  	// Classification / genre information
Â  	  	const classSpan = document.createElement('span');
Â  	  	classSpan.className = 'rating';
Â  	  	if (event.classifications && event.classifications.length > 0) {
Â  	  	  const cls = event.classifications[0];
Â  	  	  const seg = cls.segment && cls.segment.name;
Â  	  	  const genre = cls.genre && cls.genre.name;
Â  	  	  const subg = cls.subGenre && cls.subGenre.name;
Â  	  	  const parts = [];
Â  	  	  if (genre && genre.toLowerCase() !== 'undefined') parts.push(genre);
Â  	  	  if (subg && subg.toLowerCase() !== 'undefined' && subg !== genre) parts.push(subg);
Â  	  	  if (parts.length === 0 && seg) parts.push(seg);
Â  	  	  classSpan.textContent = parts.join(' / ');
Â  	  	}
Â  	  	info.appendChild(classSpan);
Â  	  	// Price range information
Â  	  	const priceSpan = document.createElement('span');
Â  	  	priceSpan.className = 'rating';
Â  	  	if (event.priceRanges && event.priceRanges.length > 0) {
Â  	  	  const pr = event.priceRanges[0];
Â  	  	  if (pr.min && pr.max) {
Â  	  	  	priceSpan.textContent = `$${pr.min.toFixed(0)}â€“$${pr.max.toFixed(0)} ${pr.currency || ''}`;
Â  	  	  } else if (pr.min) {
Â  	  	  	priceSpan.textContent = `$${pr.min.toFixed(0)}+`;
Â  	  	  } else if (pr.max) {
Â  	  	  	priceSpan.textContent = `$${pr.max.toFixed(0)}`;
Â  	  	  }
Â  	  	}
Â  	  	info.appendChild(priceSpan);
Â  	  	wrapper.appendChild(info);
Â  	  	btn.appendChild(wrapper);
Â  	  	btn.addEventListener('click', () => {
Â  	  	  if (event.url) window.open(event.url);
Â  	  	});
Â  	  	list.appendChild(btn);
Â  	  });
Â  	  $("resultsTitle").textContent = subCategory + ' Events';
Â  	  $("resultsModal").classList.add('active');
Â  	  document.body.classList.add('modal-open');
Â  	  hideGhost();
Â  	}

Â  	function displayResults(category, results) {
Â  	  $("resultsTitle").textContent = `${category} Results`;
Â  	  const list = $("resultsList");
Â  	  list.innerHTML = '';
Â  	  // Determine which places are saved in the current plan and which have been visited
Â  	  const planIds = getPlan().map(p => p.place_id);
Â  	  const visitedIds = getVisitedPlan();
Â  	  results.forEach(place => {
Â  	  	const btn = document.createElement('button');
Â  	  	btn.addEventListener('click', () => showDetails(place.place_id));
Â  	  	const wrapper = document.createElement('div');
Â  	  	wrapper.className = 'results-item';
Â  	  	// Photo
Â  	  	const img = document.createElement('img');
Â  	  	if (place.photos && place.photos.length > 0) {
Â  	  	  img.src = place.photos[0].getUrl({ maxWidth: 80, maxHeight: 80 });
Â  	  	} else {
Â  	  	  img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  	  	}
Â  	  	wrapper.appendChild(img);
Â  	  	// Info
Â  	  	const info = document.createElement('div');
Â  	  	info.className = 'results-info';
Â  	  	const title = document.createElement('h4');
Â  	  	title.textContent = place.name;
Â  	  	info.appendChild(title);
Â  	  	const rating = document.createElement('span');
Â  	  	rating.className = 'rating';
Â  	  	if (place.rating) {
Â  	  	  rating.textContent = `â˜…${place.rating.toFixed(1)} (${place.user_ratings_total})`;
Â  	  	} else {
Â  	  	  rating.textContent = 'No rating';
Â  	  	}
Â  	  	info.appendChild(rating);
Â  	  	// Visited indicator if the place is in the plan
Â  	  	if (planIds.includes(place.place_id)) {
Â  	  	  const visitSpan = document.createElement('span');
Â  	  	  visitSpan.className = 'rating';
Â  	  	  // Show a filled check mark if visited, or an empty box if not yet visited
Â  	  	  visitSpan.textContent = visitedIds.includes(place.place_id) ? 'âœ”ï¸' : 'â—»ï¸';
Â  	  	  visitSpan.style.marginLeft = '0.3rem';
Â  	  	  info.appendChild(visitSpan);
Â  	  	}
Â  	  	wrapper.appendChild(info);
Â  	  	btn.appendChild(wrapper);
Â  	  	list.appendChild(btn);
Â  	  });
Â  	  $("resultsModal").classList.add('active');
Â  	  document.body.classList.add('modal-open');
Â  	  hideGhost();
Â  	}
Â  	$("closeResults").addEventListener('click', () => {
Â  	  $("resultsModal").classList.remove('active');
Â  	  document.body.classList.remove('modal-open');
Â  	  showGhost();
Â  	});

Â  	// Allow closing the results modal by tapping outside its content
Â  	$("resultsModal").addEventListener('click', (e) => {
Â  	  if (e.target.id === 'resultsModal') {
Â  	  	$("resultsModal").classList.remove('active');
Â  	  	document.body.classList.remove('modal-open');
Â  	  	showGhost();
Â  	  }
Â  	});

Â  	// Surprise Me search
Â  	$("surpriseBtn").addEventListener('click', () => {
Â  	  if (!currentPosition) {
Â  	  	alert('Please allow geolocation or search for a location first.');
Â  	  	return;
Â  	  }
Â  	  const request = {
Â  	  	location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
Â  	  	radius: 8000,
Â  	  	rankBy: google.maps.places.RankBy.PROMINENCE,
Â  	  	type: ['tourist_attraction', 'point_of_interest']
Â  	  };
Â  	  placesService.nearbySearch(request, (results, status) => {
Â  	  	if (status === google.maps.places.PlacesServiceStatus.OK) {
Â  	  	  const good = results.filter(p => p.rating && p.rating >= 4.5 && p.user_ratings_total >= 50);
Â  	  	  if (good.length > 0) {
Â  	  	  	const randomPlace = good[Math.floor(Math.random() * good.length)];
Â  	  	  	showDetails(randomPlace.place_id);
Â  	  	  } else {
Â  	  	  	alert('No highâ€‘quality places found nearby.');
Â  	  	  }
Â  	  	} else {
Â  	  	  alert('No results found.');
Â  	  	}
Â  	  });
Â  	});

Â  	// Dark side Easter egg opens the Dark Side category menu
Â  	$("ghostBtn").addEventListener('click', () => {
Â  	  openSubMenu('Dark Side');
Â  	});

Â  	// Results details view
Â  	function showDetails(placeId) {
Â  	  placesService.getDetails({ placeId: placeId, fields: ['name','formatted_address','formatted_phone_number','rating','reviews','photos','price_level','geometry','website','url','opening_hours','place_id'] }, (place, status) => {
Â  	  	if (status === google.maps.places.PlacesServiceStatus.OK) {
Â  	  	  currentPlaceDetails = place;
Â  	  	  // Prepare Street View panorama and default to hidden. We request
Â  	  	  // the panorama near the place and if none is available we
Â  	  	  // position the viewer at the place's coordinates. After
Â  	  	  // initialising, we hide the panorama and show a static photo.
Â  	  	  const loc = place.geometry.location;
Â  	  	  const streetService = new google.maps.StreetViewService();
Â  	  	  streetService.getPanorama({ location: loc, radius: 50 }, (data, status) => {
Â  	  	  	let panoOptions;
Â  	  	  	if (status === google.maps.StreetViewStatus.OK && data && data.location) {
Â  	  	  	  panoOptions = { pano: data.location.pano, pov: { heading: 270, pitch: 0 }, zoom: 1 };
Â  	  	  	} else {
Â  	  	  	  panoOptions = { position: loc, pov: { heading: 0, pitch: 0 }, zoom: 0 };
Â  	  	  	}
Â  	  	  	if (!streetViewPanorama) {
Â  	  	  	  streetViewPanorama = new google.maps.StreetViewPanorama($("detailsMap"), panoOptions);
Â  	  	  	} else {
Â  	  	  	  if (panoOptions.pano) {
Â  	  	  	  	streetViewPanorama.setPano(panoOptions.pano);
Â  	  	  	  } else {
Â  	  	  	  	streetViewPanorama.setPosition(panoOptions.position);
Â  	  	  	  }
Â  	  	  	  streetViewPanorama.setPov(panoOptions.pov);
Â  	  	  	  streetViewPanorama.setZoom(panoOptions.zoom);
Â  	  	  	}
Â  	  	  	// Hide the panorama initially
Â  	  	  	streetViewVisible = false;
Â  	  	  	streetViewPanorama.setVisible(false);
Â  	  	  	// Apply static background image if available
Â  	  	  	if (place.photos && place.photos.length > 0) {
Â  	  	  	  const photoUrl = place.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 });
Â  	  	  	  $("detailsMap").style.backgroundImage = `url('${photoUrl}')`;
Â  	  	  	  $("detailsMap").style.backgroundSize = 'cover';
Â  	  	  	  $("detailsMap").style.backgroundPosition = 'center';
Â  	  	  	} else {
Â  	  	  	  $("detailsMap").style.backgroundImage = '';
Â  	  	  	}
Â  	  	  	const tBtn = $("toggleStreetBtn");
Â  	  	  	if (tBtn) tBtn.textContent = 'ğŸ–¼ï¸ Street View';
Â  	  	  });
Â  	  	  // Name
Â  	  	  $("detailsName").textContent = place.name;
Â  	  	  // Rating and price
Â  	  	  let starStr = '';
Â  	  	  if (place.rating) {
Â  	  	  	const full = Math.floor(place.rating);
Â  	  	  	const half = (place.rating - full) >= 0.5;
Â  	  	  	starStr = 'â˜…'.repeat(full) + (half ? 'Â½' : '') + ` (${place.rating.toFixed(1)})`;
Â  	  	  }
Â  	  	  $("detailsRating").textContent = starStr;
Â  	  	  $("detailsPrice").textContent = place.price_level ? '$'.repeat(place.price_level) : '';
Â  	  	  $("detailsPhone").textContent = place.formatted_phone_number || '';
Â  	  	  $("detailsAddress").textContent = place.formatted_address || '';
Â  	  	  // Save button state
Â  	  	  updateSaveButtonState(place.place_id);
Â  	  	  // Reviews
Â  	  	  populateReviews(place.reviews || []);
Â  	  	  // Hours
Â  	  	  populateHours(place.opening_hours);
Â  	  	  // Actions
Â  	  	  $("openMapsBtn").onclick = () => {
Â  	  	  	window.open(place.url || `http://googleusercontent.com/maps/google.com/0{encodeURIComponent(place.name)}&query_place_id=${place.place_id}`);
Â  	  	  };
Â  	  	  $("websiteBtn").style.display = place.website ? 'inline-flex' : 'none';
Â  	  	  $("websiteBtn").onclick = () => {
Â  	  	  	if (place.website) window.open(place.website);
Â  	  	  };
Â  	  	  $("shareBtn").onclick = () => {
Â  	  	  	if (navigator.share) {
Â  	  	  	  navigator.share({ title: place.name, text: place.formatted_address, url: place.url || window.location.href }).catch(err => console.log(err));
Â  	  	  	} else {
Â  	  	  	  alert('Sharing not supported on this device.');
Â  	  	  	}
Â  	  	  };
Â  	  	  $("compassBtn").onclick = () => openCompass(loc);
Â  	  	  // Bind Street View toggle
Â  	  	  $("toggleStreetBtn").onclick = toggleStreetView;
Â  	  	  // Show sheet and lock background scroll
Â  	  	  $("detailsSheet").classList.add('active');
Â  	  	  document.body.classList.add('modal-open');
Â  	  	  hideGhost();
			$("addToPlanBtn").onclick = () => {
  addToPlan(currentPlaceDetails);
  alert('Added to your plan!');
  loadPlan(); // Refresh if plan modal is open
};
Â  	  	}
Â  	  });
Â  	}

Â  	// Close details sheet helper
Â  	function closeDetails() {
Â  	  $("detailsSheet").classList.remove('active');
Â  	  document.body.classList.remove('modal-open');
Â  	  showGhost();
Â  	}

Â  	// Tap outside details content closes sheet
Â  	$("detailsSheet").addEventListener('click', function(e) {
Â  	  // When clicking on sheet background (not the content overlay)
Â  	  if (e.target.id === 'detailsSheet') {
Â  	  	closeDetails();
Â  	  }
Â  	});

Â  	// Close button inside details sheet
Â  	$("closeDetailsBtn").addEventListener('click', () => {
Â  	  closeDetails();
Â  	});

Â  	/*
Â  	  Toggle Street View visibility.
Â  	  Street View imagery is disabled by default to reduce data usage. When
Â  	  activated, the static background image is removed and the panorama
Â  	  becomes visible. Toggling again hides the panorama and restores the
Â  	  photo background if one exists.
Â  	*/
Â  	function toggleStreetView() {
Â  	  if (!streetViewPanorama) return;
Â  	  streetViewVisible = !streetViewVisible;
Â  	  streetViewPanorama.setVisible(streetViewVisible);
Â  	  const btn = $("toggleStreetBtn");
Â  	  if (streetViewVisible) {
Â  	  	if (btn) btn.textContent = 'ğŸ–¼ï¸ Hide Street View';
Â  	  	$("detailsMap").style.backgroundImage = '';
Â  	  } else {
Â  	  	if (btn) btn.textContent = 'ğŸ–¼ï¸ Street View';
Â  	  	if (currentPlaceDetails && currentPlaceDetails.photos && currentPlaceDetails.photos.length > 0) {
Â  	  	  const photoUrl = currentPlaceDetails.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 });
Â  	  	  $("detailsMap").style.backgroundImage = `url('${photoUrl}')`;
Â  	  	  $("detailsMap").style.backgroundSize = 'cover';
Â  	  	  $("detailsMap").style.backgroundPosition = 'center';
Â  	  	}
Â  	  }
Â  	}

Â  	// Populate reviews accordion
Â  	function populateReviews(reviews) {
Â  	  const reviewsContent = $("reviewsContent");
Â  	  reviewsContent.innerHTML = '';
Â  	  if (!reviews || reviews.length === 0) {
Â  	  	reviewsContent.innerHTML = '<p>No reviews available.</p>';
Â  	  } else {
Â  	  	reviews.slice(0,5).forEach(r => {
Â  	  	  const p = document.createElement('p');
Â  	  	  p.style.marginBottom = '0.5rem';
Â  	  	  p.textContent = `"${r.text}" â€” ${r.author_name}`;
Â  	  	  reviewsContent.appendChild(p);
Â  	  	});
Â  	  }
Â  	}
Â  	// Populate hours accordion
Â  	function populateHours(hours) {
Â  	  const hoursContent = $("hoursContent");
Â  	  hoursContent.innerHTML = '';
Â  	  if (!hours || !hours.weekday_text) {
Â  	  	hoursContent.innerHTML = '<p>No hours available.</p>';
Â  	  } else {
Â  	  	hours.weekday_text.forEach(l => {
Â  	  	  const p = document.createElement('p');
Â  	  	  p.textContent = l;
Â  	  	  hoursContent.appendChild(p);
Â  	  	});
Â  	  }
Â  	}
Â  	// Accordion toggling
Â  	function setupAccordions() {
Â  	  document.querySelectorAll('.accordion').forEach(btn => {
Â  	  	btn.addEventListener('click', () => {
Â  	  	  btn.classList.toggle('active');
Â  	  	  const content = btn.nextElementSibling;
Â  	  	  if (btn.classList.contains('active')) {
Â  	  	  	content.style.maxHeight = content.scrollHeight + 'px';
Â  	  	  } else {
Â  	  	  	content.style.maxHeight = null;
Â  	  	  }
Â  	  	});
Â  	  });
Â  	}

Â  	// Save functionality using localStorage
Â  	function getSavedList() {
Â  	  try {
Â  	  	const data = localStorage.getItem('myPlaces');
Â  	  	return data ? JSON.parse(data) : [];
Â  	  } catch (e) {
Â  	  	return [];
Â  	  }
Â  	}
Â  	function savePlace(place) {
Â  	  let list = getSavedList();
Â  	  if (!list.find(p => p.place_id === place.place_id)) {
Â  	  	// Limit stored places to 50 to avoid unbounded localStorage growth
Â  	  	if (list.length >= 50) {
Â  	  	  list.shift();
Â  	  	}
Â  	  	list.push({
Â  	  	  place_id: place.place_id,
Â  	  	  name: place.name,
Â  	  	  address: place.formatted_address,
Â  	  	  rating: place.rating,
Â  	  	  url: place.url,
Â  	  	  photo: (place.photos && place.photos.length > 0) ? place.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 }) : null
Â  	  	});
Â  	  	localStorage.setItem('myPlaces', JSON.stringify(list));
Â  	  }
Â  	}
Â  	function removePlace(placeId) {
Â  	  let list = getSavedList();
Â  	  list = list.filter(p => p.place_id !== placeId);
Â  	  localStorage.setItem('myPlaces', JSON.stringify(list));
Â  	}
Â  	function updateSaveButtonState(placeId) {
Â  	  const list = getSavedList();
Â  	  const saved = list.some(p => p.place_id === placeId);
Â  	  $("saveBtn").textContent = saved ? 'â˜… Saved' : 'â˜† Save';
Â  	  $("saveBtn").onclick = () => {
Â  	  	if (list.some(p => p.place_id === placeId)) {
Â  	  	  removePlace(placeId);
Â  	  	  $("saveBtn").textContent = 'â˜† Save';
Â  	  	} else {
Â  	  	  savePlace(currentPlaceDetails);
Â  	  	  $("saveBtn").textContent = 'â˜… Saved';
Â  	  	}
Â  	  	loadMyList();
Â  	  };
Â  	}

Â  	/*
Â  	  Plan management
Â  	  Allows users to curate a list of places into a shareable plan. Plans are
Â  	  stored in localStorage under the 'myPlan' key. A separate 'visitedPlan'
Â  	  array tracks which places have been marked as visited to provide badge
Â  	  progress for the user.
Â  	*/
Â  	function getPlan() {
Â  	  try {
Â  	  	const data = localStorage.getItem('myPlan');
Â  	  	return data ? JSON.parse(data) : [];
Â  	  } catch (e) {
Â  	  	return [];
Â  	  }
Â  	}
Â  	function savePlan(list) {
Â  	  localStorage.setItem('myPlan', JSON.stringify(list));
Â  	}
Â  	function getVisitedPlan() {
Â  	  try {
Â  	  	const data = localStorage.getItem('visitedPlan');
Â  	  	return data ? JSON.parse(data) : [];
Â  	  } catch (e) {
Â  	  	return [];
Â  	  }
Â  	}
Â  	function saveVisitedPlan(list) {
Â  	  localStorage.setItem('visitedPlan', JSON.stringify(list));
Â  	}
Â  	function addToPlan(place) {
Â  	  let list = getPlan();
Â  	  if (!list.some(p => p.place_id === place.place_id)) {
Â  	  	list.push({
Â  	  	  place_id: place.place_id,
Â  	  	  name: place.name,
Â  	  	  lat: place.geometry.location.lat(),
Â  	  	  lng: place.geometry.location.lng(),
Â  	  	  address: place.formatted_address || '',
Â  	  	  category: '',
Â  	  	  photo: (place.photos && place.photos.length) ? place.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 }) : null
Â  	  	});
Â  	  	savePlan(list);
Â  	  }
Â  	}
Â  	function removeFromPlan(placeId) {
Â  	  let list = getPlan();
  	  list = list.filter(p => p.place_id !== placeId);
Â  	  savePlan(list);
Â  	}
Â  	function toggleVisited(placeId) {
Â  	  let visited = getVisitedPlan();
Â  	  if (visited.includes(placeId)) {
Â  	  	visited = visited.filter(id => id !== placeId);
Â  	  } else {
Â  	  	visited.push(placeId);
Â  	  }
Â  	  saveVisitedPlan(visited);
Â  	}
Â  	function loadPlan() {
Â  	  const list = getPlan();
Â  	  const content = $("planContent");
Â  	  const empty = $("planEmpty");
Â  	  const summary = $("planSummary");
Â  	  content.innerHTML = '';
Â  	  const visited = getVisitedPlan();
Â  	  if (!list.length) {
Â  	  	empty.style.display = 'block';
Â  	  	summary.textContent = '';
Â  	  } else {
Â  	  	empty.style.display = 'none';
Â  	  	// Summary and badge calculation
Â  	  	const visitedCount = list.filter(item => visited.includes(item.place_id)).length;
Â  	  	const totalCount = list.length;
Â  	  	let badge = '';
Â  	  	const ratio = visitedCount / totalCount;
Â  	  	if (ratio === 1) {
Â  	  	  badge = 'ğŸ–ï¸';
Â  	  	} else if (ratio >= 0.8) {
Â  	  	  badge = 'ğŸ¥‡';
Â  	  	} else if (ratio >= 0.5) {
Â  	  	  badge = 'ğŸ¥ˆ';
Â  	  	} else if (ratio >= 0.3) {
Â  	  	  badge = 'ğŸ¥‰';
Â  	  	} else {
Â  	  	  badge = 'ğŸ”°';
Â  	  	}
Â  	  	summary.textContent = `Visited ${visitedCount} of ${totalCount} places ${badge}`;
Â  	  	list.forEach(item => {
Â  	  	  const btn = document.createElement('button');
Â  	  	  btn.style.display = 'flex';
Â  	  	  btn.style.justifyContent = 'space-between';
Â  	  	  btn.style.alignItems = 'center';
Â  	  	  btn.style.width = '100%';
Â  	  	  const wrapper = document.createElement('div');
Â  	  	  wrapper.className = 'results-item';
Â  	  	  const img = document.createElement('img');
Â  	  	  img.src = item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  	  	  wrapper.appendChild(img);
Â  	  	  const info = document.createElement('div');
Â  	  	  info.className = 'results-info';
Â  	  	  const title = document.createElement('h4');
Â  	  	  title.textContent = item.name;
Â  	  	  info.appendChild(title);
Â  	  	  const visitedSpan = document.createElement('span');
Â  	  	  visitedSpan.className = 'rating';
Â  	  	  visitedSpan.textContent = visited.includes(item.place_id) ? 'Visited' : 'Not visited';
Â  	  	  info.appendChild(visitedSpan);
Â  	  	  wrapper.appendChild(info);
Â  	  	  btn.appendChild(wrapper);
Â  	  	  // Toggle visited on context menu (long press)
Â  	  	  btn.addEventListener('contextmenu', (e) => {
Â  	  	  	e.preventDefault();
Â  	  	  	toggleVisited(item.place_id);
Â  	  	  	loadPlan();
Â  	  	  });
Â  	  	  // Clicking opens details
Â  	  	  btn.addEventListener('click', () => {
Â  	  	  	showDetails(item.place_id);
Â  	  	  	closePlan();
Â  	  	  });
Â  	  	  content.appendChild(btn);
Â  	  	});
Â  	  }
Â  	}
Â  	function closePlan() {
Â  	  $("planModal").classList.remove('active');
Â  	  document.body.classList.remove('modal-open');
Â  	  showGhost();
Â  	}

Â  	// Open My Plan modal from the main button
Â  	$("myPlanBtn").addEventListener('click', () => {
Â  	  loadPlan();
Â  	  $("planModal").classList.add('active');
Â  	  document.body.classList.add('modal-open');
Â  	  hideGhost();
Â  	});

Â 
Â  	$("sharePlanBtn").addEventListener('click', () => {
Â  	  const plan = getPlan();
Â  	  if (!plan || plan.length === 0) {
Â  	  	alert('Your plan is empty. Add some places before sharing.');
Â  	  	return;
Â  	  }
Â  	  try {
Â  	  	const data = { items: plan };
Â  	  	const json = JSON.stringify(data);
Â  	  	const encoded = btoa(encodeURIComponent(json));
Â  	  	const base = window.location.origin + window.location.pathname;
Â  	  	const url = `${base}?plan=${encoded}`;
Â  	  	if (navigator.share) {
Â  	  	  navigator.share({
Â  	  	  	title: 'My Local Explorer Plan',
Â  	  	  	text: 'Check out my travel plan on Local Explorer',
Â  	  	  	url: url
Â  	  	  }).catch(err => console.log(err));
Â  	  	} else {
Â  	  	  window.prompt('Copy and share this link to load your plan:', url);
Â  	  	}
Â  	  } catch (err) {
Â  	  	console.error(err);
Â  	  	alert('Unable to share plan.');
Â  	  }
Â  	});

Â  
Â  	$("myListBtn").addEventListener('click', () => {
Â  	  loadMyList();
Â  	  $("myListModal").classList.add('active');
Â  	  document.body.classList.add('modal-open');
Â  	  hideGhost();
Â  	});
Â  	$("closeMyList").addEventListener('click', () => {
Â  	  $("myListModal").classList.remove('active');
Â  	  document.body.classList.remove('modal-open');
Â  	  showGhost();
Â  	});

Â  	
Â  	$("closePlan").addEventListener('click', () => {
Â  	  closePlan();
Â  	});
Â  	
 	$("planModal").addEventListener('click', (e) => {
Â  	  if (e.target.id === 'planModal') {
Â  	  	closePlan();
Â  	  }
Â  	});

Â  	

Â  	
Â  	$("closeDonate").addEventListener('click', () => {
Â  	  $("donateModal").classList.remove('active');
Â  	  document.body.classList.remove('modal-open');
Â  	  showGhost();
Â  	});
Â  	
Â  	$("donateModal").addEventListener('click', (e) => {
Â  	  if (e.target.id === 'donateModal') {
Â  	  	$("donateModal").classList.remove('active');
Â  	  	document.body.classList.remove('modal-open');
Â  	  	showGhost();
Â  	  }
Â  	});

Â  	$("openVenmoBtn").addEventListener('click', () => {
Â  	  const venmoUrl = 'https://venmo.com/Stephen-Mohamed-1';
Â  	  window.open(venmoUrl);
Â  	});
Â  	
Â  	$("copyVenmoBtn").addEventListener('click', async () => {
Â  	  try {
Â  	  	await navigator.clipboard.writeText('@Stephen-Mohamed-1');
Â  	  	alert('Venmo handle copied to clipboard!');
Â  	  } catch (err) {
Â  	  	alert('Unable to copy. Please copy manually.');
Â  	  }
Â  	});
Â  	function loadMyList() {
Â  	  const list = getSavedList();
Â  	  const content = $("myListContent");
Â  	  const empty = $("myListEmpty");
Â  	  content.innerHTML = '';
Â  	  if (list.length === 0) {
Â  	  	empty.style.display = 'block';
Â  	  } else {
Â  	  	empty.style.display = 'none';
Â  	  	list.forEach(item => {
Â  	  	  const btn = document.createElement('button');
Â  	  	  btn.addEventListener('click', () => showDetails(item.place_id));
Â  	  	  const wrapper = document.createElement('div');
Â  	  	  wrapper.className = 'results-item';
Â  	  	  const img = document.createElement('img');
Â  	  	  img.src = item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
Â  	  	  wrapper.appendChild(img);
Â  	  	  const info = document.createElement('div');
Â  	  	  info.className = 'results-info';
Â  	  	  const title = document.createElement('h4');
Â  	  	  title.textContent = item.name;
Â  	  	  info.appendChild(title);
  	  	  const rating = document.createElement('span');
Â  	  	  rating.className = 'rating';
Â  	  	  rating.textContent = item.rating ? `â˜…${item.rating.toFixed(1)}` : '';
Â  	  	  info.appendChild(rating);
Â  	  	  wrapper.appendChild(info);
Â  	  	  btn.appendChild(wrapper);
Â  	  	  // Delete icon
Â  	  	  const delSpan = document.createElement('span');
Â  	  	  delSpan.textContent = 'ğŸ—‘ï¸';
Â  	  	  btn.appendChild(delSpan);
  	  	  btn.style.justifyContent = 'space-between';
Â  	  	  btn.addEventListener('contextmenu', (e) => {
Â  	  	  	e.preventDefault();
Â  	  	  	removePlace(item.place_id);
Â  	  	  	loadMyList();
Â  	  	  });
Â  	  	  content.appendChild(btn);
Â  	  	});
Â  	  }
Â  	}

Â  	// Update details sheet close click to use closeDetails()
Â  	$("detailsSheet").addEventListener('click', (e) => {
Â  	  if (e.target === $("detailsSheet")) {
Â  	  	closeDetails();
Â  	  }
Â  	});
Â  	let navigationStopped = false;
Â  	function openCompass(destLatLng) {
Â  	  const overlay = $("compassOverlay");
Â  	  overlay.classList.add('active');
Â  	  document.body.classList.add('modal-open');
Â  	  hideGhost();
Â  	  // Populate voice selector
Â  	  const voiceSelect = $("voiceSelect");
Â  	  function populateVoices() {
Â  	  	const voices = window.speechSynthesis.getVoices();
Â  	  	if (!voices || voices.length === 0) return;
Â  	  	voiceSelect.innerHTML = '';
Â  	  	voices.forEach((voice, idx) => {
Â  	  	  const opt = document.createElement('option');
Â  	  	  opt.value = idx;
Â  	  	  opt.textContent = `${voice.name}${voice.lang ? ' (' + voice.lang + ')' : ''}`;
 	  	   voiceSelect.appendChild(opt);
Â  	  	});
Â  	  }
Â  	  populateVoices();
Â  	 
Â  	  window.speechSynthesis.onvoiceschanged = populateVoices;
Â  	  
Â  	  $("startNavigationBtn").disabled = false;
Â  	  $("stopNavigationBtn").disabled = true;
Â  	 
Â  	  const directionsList = $("directionsList");
Â  	  directionsList.innerHTML = 'Calculating routeâ€¦';
Â  	 
Â  	  let orientationListener;
Â  	  const updateCompassArrow = (event) => {
Â  	  	
Â  	  	if (!currentPosition) return;
Â  	  	const heading = google.maps.geometry.spherical.computeHeading(currentPosition, destLatLng);
Â  	  	const deviceHeading = event.alpha;
Â  	  	if (typeof heading === 'number' && typeof deviceHeading === 'number') {
Â  	  	  const rotation = heading - deviceHeading;
Â  	  	  $("compassArrow").style.transform = `rotate(${rotation}deg)`;
Â  	  	}
Â  	  };
Â  	  
Â  	  if (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function') {
Â  	  	window.DeviceOrientationEvent.requestPermission().then(response => {
Â  	  	  if (response === 'granted') {
Â  	  	  	orientationListener = updateCompassArrow;
Â  	  	  	window.addEventListener('deviceorientation', orientationListener, true);
Â  	  	  }
Â  	  	}).catch(console.error);
Â  	  } else if (window.DeviceOrientationEvent) {
Â  	  	orientationListener = updateCompassArrow;
Â  	  	window.addEventListener('deviceorientation', orientationListener, true);
Â  	  }
Â  	  
Â  	  if (navigator.geolocation) {
Â  	  	if (compassWatchId) navigator.geolocation.clearWatch(compassWatchId);
Â  	  	compassWatchId = navigator.geolocation.watchPosition((pos) => {
Â  	  	  currentPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
Â  	  	});
Â  	  }
Â  	  
Â  	  const directionsService = new google.maps.DirectionsService();
Â  	  directionsService.route({
Â  	  	origin: currentPosition,
Â  	  	destination: destLatLng,
Â  	  	travelMode: google.maps.TravelMode.DRIVING
Â  	  }, (result, status) => {
Â  	  	directionsList.innerHTML = '';
Â  	  	if (status === google.maps.DirectionsStatus.OK) {
Â  	  	  const steps = result.routes[0].legs[0].steps;
Â  	  	 
Â  	  	  steps.forEach((step, index) => {
Â  	  	  	const div = document.createElement('div');
Â  	  	  	div.dataset.index = index;
Â  	  	  	div.innerHTML = step.instructions;
Â  	  	  	directionsList.appendChild(div);
Â  	  	  });
Â  	  	  
Â  	  	  function startNavigation() {
Â  	  	  	navigationStopped = false;
Â  	  	  	$("startNavigationBtn").disabled = true;
Â  	  	  	$("stopNavigationBtn").disabled = false;
Â  	  	  	let idx = 0;
Â  	  	  	function speakNext() {
Â  	  	  	  if (navigationStopped || idx >= steps.length) {
Â  	  	  	  	$("startNavigationBtn").disabled = false;
Â  	  	  	  	$("stopNavigationBtn").disabled = true;
Â  	  	  	  	return;
Â  	  	  	  }
Â  	  	  	 
Â  	  	  	  Array.from(directionsList.children).forEach(el => el.classList.remove('active'));
Â  	  	  	  const currentEl = directionsList.children[idx];
Â  	  	  	  if (currentEl) currentEl.classList.add('active');
Â  	  	  	  
Â  	  	  	  const clean = steps[idx].instructions.replace(/<[^>]+>/g, '');
Â  	  	  	  const text = `Step ${idx + 1}: ${clean}.`;
Â  	  	  	  const utter = new SpeechSynthesisUtterance(text);
Â  	  	  	  const voices = window.speechSynthesis.getVoices();
Â  	  	  	  const selectedVoice = voices[voiceSelect.value] || voices[0];
Â  	  	  	  utter.voice = selectedVoice;
Â  	  	  	  
Â  	  	  	  utter.pitch = 0.85;
Â  	  	  	  utter.rate = 0.95;
Â  	  	  	  utter.volume = 1;
Â  	  	  	  window.speechSynthesis.speak(utter);
Â  	  	  	  idx++;
Â  	  	  	  utter.onend = () => {
Â  	  	  	  	if (!navigationStopped) {
Â  	  	  	  	  // Small delay before next instruction
Â  	  	  	  	  setTimeout(speakNext, 3000);
Â  	  	  	  	}
Â  	  	  	  };
Â  	  	  	}
Â  	  	  	speakNext();
Â  	  	  }
Â  	  	  function stopNavigation() {
Â  	  	  	navigationStopped = true;
Â  	  	  	window.speechSynthesis.cancel();
Â  	  	  	$("startNavigationBtn").disabled = false;
Â  	  	  	$("stopNavigationBtn").disabled = true;
Â  	  	  }
Â  	  	  $("startNavigationBtn").onclick = startNavigation;
Â  	  	  $("stopNavigationBtn").onclick = stopNavigation;
Â  	  	} else {
Â  	  	  directionsList.textContent = 'Unable to compute route.';
	  	}
Â  	  });
Â  	  
Â  	  if (typeof google !== 'undefined' && google.maps) {
Â  	  	if (miniMap) {
Â  	  	  miniMap.setCenter(destLatLng);
Â  	  	  miniMap.setZoom(15);
Â  	  	} else {
Â  	  	  miniMap = new google.maps.Map($("miniMap"), {
Â  	  	  	center: destLatLng,
Â  	  	  	zoom: 15,
  	  	  	disableDefaultUI: true,
Â  	  	  	gestureHandling: 'none'
Â  	  	  });
Â  	  	}
Â  	  }
Â  	 
Â  	  const zoomSlider = $("radarZoom");
Â  	  const brightnessSlider = $("radarBrightness");
Â  	  if (zoomSlider) {
Â  	  	zoomSlider.oninput = () => {
Â  	  	  const z = parseInt(zoomSlider.value);

Â  	  	  if (miniMap) miniMap.setZoom(z);
Â  	  	};
Â  	  }
Â  	  if (brightnessSlider) {
Â  	  	brightnessSlider.oninput = () => {
Â  	  	  const b = parseInt(brightnessSlider.value);
Â  	  	  // Adjust overall radar brightness using CSS filter
Â  	  	  $("radar").style.filter = `brightness(${b/50})`;
Â  	  	};
Â  	  }
Â  	  
Â  	  $("closeCompassBtn").onclick = () => {
Â  	  	overlay.classList.remove('active');
Â  	  	document.body.classList.remove('modal-open');

Â  	  	if (navigator.geolocation && compassWatchId) {
Â  	  	  navigator.geolocation.clearWatch(compassWatchId);
Â  	  	}
Â  	  	if (orientationListener) {
Â  	  	  window.removeEventListener('deviceorientation', orientationListener, true);
Â  	  	}
Â  	  	window.speechSynthesis.cancel();
Â  	  	navigationStopped = true;
Â  	  	showGhost();
Â  	  };
Â  	}

Â  	
Â  	async function fetchLocalFacts(pos) {
Â  	 
Â  	  clearInterval(factInterval);
Â  	  const bubble = $("factBubble");
Â  	  if (!bubble) return;
Â  	  bubble.textContent = 'Fetching local factsâ€¦';
Â  	  try {
Â  	  
Â  	  	const url = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${pos.lat}%7C${pos.lng}&gsradius=20000&gslimit=20&format=json&origin=*`;
Â  	  	const geoData = await fetch(url).then(res => res.json());
Â  	  	const pageIds = geoData.query.geosearch.map(item => item.pageid).join('|');
Â  	  	const extractsUrl = `https://en.wikipedia.org/w/api.php?action=query&pageids=${pageIds}&prop=extracts&explaintext=1&exchars=280&format=json&origin=*`;
Â  	  	const extracts = await fetch(extractsUrl).then(res => res.json());
Â  	  	const facts = [];
Â  	  	Object.values(extracts.query.pages).forEach(page => {
Â  	  	  if (page.extract) {

Â  	  	  	let text = page.extract.replace(/\n+/g, ' ').trim();
Â  	  	  	text = text.replace(/==.*?==/g, '');
Â  	  	 
Â  	  	  	text = text.replace(/\s{2,}/g, ' ').trim();

Â  	  	  	if (text.length >= 50 && text.length <= 280) {
Â  	  	  	  facts.push(text);
Â  	  	  	}
Â  	  	  }
Â  	  	});

Â  	  	const uniqueFacts = [];
      	facts.forEach(f => {
Â  	  	  if (!uniqueFacts.includes(f)) uniqueFacts.push(f);
Â  	  	});
Â  	  	if (uniqueFacts.length === 0) {
Â  	  	  bubble.textContent = 'No local facts found.';
Â  	  	  return;
Â  	  	}
Â  	  	const factsList = uniqueFacts;
Â  	  	
Â  	  	let idx = 0;
Â  	  	function showNextFact() {
Â  	  	  // Drop current bubble out
Â  	  	  bubble.classList.add('out');
Â  	  	  setTimeout(() => {
Â  	  	  	bubble.textContent = factsList[idx];
Â  	  	  	bubble.classList.remove('out');
Â  	  	  	idx = (idx + 1) % factsList.length;
Â  	  	  }, 400);
Â  	  	}
Â  	  
Â  	  	idx = 0;
Â  	  	bubble.textContent = factsList[idx];
Â  	  
Â  	  	clearInterval(factInterval);
Â  	  	factInterval = setInterval(showNextFact, 8000);
Â  	  } catch (err) {
Â  	  	console.error(err);
Â  	  	bubble.textContent = 'Unable to fetch facts.';
Â  	  }

Â  	}

Â  
Â  	setupAccordions();

Â  	
Â  	if ('serviceWorker' in navigator) {
Â  	  window.addEventListener('load', () => {
Â  	  	
Â  	  	navigator.serviceWorker.register('service-worker-v2.js');
Â  	  });
Â  	}

Â  	
Â  	window.initMap = initApp;
Â  </script>
</body>
</html>
