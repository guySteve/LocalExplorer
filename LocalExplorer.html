<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" id="theme-color-meta" content="#0A192F" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Local Explorer" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <title>Local Explorer</title>

    <script src="./key.js"></script>
    <script>
      const GKEY = window.MAPS_API_KEY || 'MISSING_API_KEY';
      document.write(`<script src="https://maps.googleapis.com/maps/api/js?key=${GKEY}&libraries=places,geocoding,directions&callback=initApp" async defer><\/script>`);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        :root {
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #111827; --card-text: #f8f7f2; --card-bg-subtle: #374151;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #6366f1;
          --modal-bg: rgba(17, 24, 39, 0.92); --modal-blur: blur(12px);
          --list-bg: rgba(0, 0, 0, 0.75); --list-card-bg: rgba(17, 24, 39, 0.97);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="day-ops"] { /* Renamed 'light' */
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #ffffff; --card-text: #111827; --card-bg-subtle: #e5e7eb;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #4f46e5;
          --modal-bg: rgba(255, 255, 255, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(255, 255, 255, 0.85); --list-card-bg: rgba(248, 247, 242, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="rugged-explorer"] {
          --bg: #0A192F; --text: #CCD6F6; --text-subtle: #8892B0;
          --card-bg: #112240; --card-text: #CCD6F6; --card-bg-subtle: #0A192F;
          --accent: #64FFDA; --accent-alt: #f59e0b; --accent-dark: #57D3C1;
          --modal-bg: rgba(10, 25, 47, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(17, 34, 64, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }
        [data-theme="night-ops"] {
          --bg: #111111; --text: #E0E0E0; --text-subtle: #9E9E9E;
          --card-bg: #1F1F1F; --card-text: #E0E0E0; --card-bg-subtle: #000000;
          --accent: #FF4136; --accent-alt: #F012BE; --accent-dark: #B10000;
          --modal-bg: rgba(20, 20, 20, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(31, 31, 31, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body{font-family:'Raleway',sans-serif; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s;}
        h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
        .pt-safe{padding-top: calc(1rem + env(safe-area-inset-top));}
        .pb-safe{padding-bottom: calc(1rem + env(safe-area-inset-bottom));}

        .action-card{
          background: var(--card-bg); color: var(--card-text);
          transition: transform 0.2s, box-shadow 0.2s, background 0.3s, color 0.3s;
          box-shadow: 0 4px 12px var(--shadow-color); cursor: pointer;
          -webkit-tap-highlight-color: transparent; /* Touch optimization */
        }
        .action-card:hover:not(:disabled){transform:translateY(-2px); box-shadow:0 8px 20px var(--shadow-color)}
        .action-card:active:not(:disabled){transform:translateY(0) scale(.98)}
        .action-card:disabled{opacity:.4;cursor:not-allowed}

        .card-accent{ background: var(--accent); color: var(--card-bg); }
        .card-accent:hover:not(:disabled){ background: var(--accent); opacity: 0.9; }
        .card-accent-alt{ background: var(--accent-alt); color: var(--card-bg); }
        .card-accent-dark{ background: var(--accent-dark); color: var(--card-text); }

        #result-card{
          background: var(--modal-bg); color: var(--card-text); 
          backdrop-filter: var(--modal-blur); -webkit-backdrop-filter: var(--modal-blur);
          transition:transform .4s ease,opacity .3s ease;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2)
        }
        .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}
        .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

        .list-screen{position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem;
          background: var(--list-bg); backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        .list-card{background: var(--list-card-bg); color: var(--card-text); border-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:auto}
        
        .result-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.75rem;display:flex;gap:.75rem; cursor: pointer;}
        .result-item:hover{background: rgba(255,255,255,0.1);}
        .result-thumb{width:84px;height:84px;object-fit:cover;border-radius:.6rem;background: var(--card-bg); pointer-events: none;}

        .modal-base{position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);}
        .modal-dialog{width: min(92vw, 440px); background: var(--list-card-bg); color: var(--card-text);
          border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); padding:16px; outline:none;}

        #nav-bubble{position:relative;margin: 8px 0 12px 0;padding:.6rem .75rem;font-size:13px;line-height:1.25;
          box-shadow:0 10px 24px rgba(0,0,0,.35);background:radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%);
          border:1px solid rgba(255,255,255,.12)}
        #nav-main{font-weight:700;letter-spacing:.2px}
        #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
        #compass-overlay{width:240px;height:240px;border-radius:22px;margin: 6px auto 10px auto; padding: 18px; position:relative;
          background: radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
            conic-gradient(from 0deg, var(--accent), rgba(245,158,11,.1) 30%, var(--accent-alt), rgba(16,185,129,.12) 75%, var(--accent));
          border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06);
          display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden}
        #compass-arrow{width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:44px solid var(--accent);
          transform-origin:50% 90%;filter:drop-shadow(0 6px 8px var(--accent));margin-bottom:8px}
        #compass-dist{font-size:14px;font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}

        #settings-modal .modal-dialog { padding: 20px; }
        .theme-button { border: 2px solid var(--card-bg-subtle); padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .theme-button.active { border-color: var(--accent); box-shadow: 0 0 10px -2px var(--accent); }
        #voice-selector {
          background: var(--card-bg); color: var(--card-text); border: 1px solid var(--card-bg-subtle);
          padding: 8px 12px; border-radius: 8px; width: 100%; cursor: pointer;
        }
        
        .review-item {
          background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12);
          border-radius: .9rem; padding: .75rem 1rem;
        }
        .review-sort-button {
          background: var(--card-bg-subtle); color: var(--card-text);
          padding: 8px 12px; border-radius: 8px; font-weight: 600; opacity: 0.7; cursor: pointer;
        }
        .review-sort-button.active {
          background: var(--accent); color: var(--card-bg); opacity: 1;
        }
        /* NEW: Star Filter Buttons */
        .review-star-button {
           background: none; border: none; font-size: 1.25rem; padding: 4px; opacity: 0.5; cursor: pointer;
           color: var(--accent); /* Star color */
        }
        .review-star-button.active { opacity: 1; }

        #fun-fact-container {
          background: var(--card-bg); color: var(--text); border-radius: 1rem; padding: 1rem;
          box-shadow: 0 4px 12px var(--shadow-color); text-align: left; margin-bottom: 1.5rem;
        }
        #fun-fact-container h2 {
          color: var(--accent); font-family: 'Poppins', sans-serif; font-weight: 700;
          margin-bottom: 0.25rem; font-size: 0.875rem; letter-spacing: 0.05em; text-transform: uppercase;
        }
        #fun-fact-text {
          color: var(--text-subtle); border-top: 2px solid var(--card-bg-subtle);
          padding-top: 0.5rem; font-size: 0.875rem;
        }

        #searching-modal {
          position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        #searching-dialog {
          background: var(--list-card-bg); color: var(--card-text); border-radius: 1.5rem; padding: 2.5rem;
          display: flex; flex-direction: column; align-items: center; gap: 1rem;
          box-shadow: 0 20px 60px rgba(0,0,0,.5);
        }
        #searching-dialog-icon { font-size: 3.5rem; animation: spin 2s linear infinite; }
        #searching-dialog-text { font-size: 1.25rem; font-family: 'Poppins', sans-serif; font-weight: 700; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pt-safe pb-safe">

  <button id="settings-button" class="action-card rounded-full fixed top-4 right-4 z-30 w-12 h-12 flex items-center justify-center text-2xl" aria-label="Settings">âš™ï¸</button>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center" role="main" aria-live="polite">
    <section id="main-screen" aria-labelledby="app-title">
      <h1 id="app-title" class="text-4xl md:text-5xl font-header font-bold mb-4" style="color: var(--text);">Local Explorer</h1>

      <section id="fun-fact-container">
        <h2>Local Fact</h2>
        <p id="fun-fact-text">Loading...</p>
      </section>

      <p id="location-status" class="text-lg font-semibold my-4" style="color: var(--text-subtle);">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" inputmode="search" placeholder="Enter a city or place"
                 class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card card-accent text-white p-3 rounded-r-lg" aria-label="Search">ğŸ”</button>
        </div>
      </div>

      <nav id="filter-container" class="grid grid-cols-3 gap-3">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">ğŸ½ï¸<span class="mt-1">Foodie Finds</span></button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">ğŸ›ï¸<span class="mt-1">Iconic Sights</span></button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">ğŸŒ™<span class="mt-1">Night Out</span></button>
        <button data-filter="outdoors" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">ğŸï¸<span class="mt-1">Outdoors</span></button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">ğŸ’<span class="mt-1">Hidden Gems</span></button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">ğŸ¾<span class="mt-1">Pet Friendly</span></button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-4 text-sm col-span-3">ğŸ› ï¸ Utilities & Help</button>
      </nav>

      <button id="show-saved-button" class="action-card card-accent-alt w-full mt-4 rounded-lg font-bold py-3 text-base">â­ My Saved Places</button>
      <button id="local-events-button" class="action-card card-accent-dark w-full mt-4 rounded-lg font-bold py-3 text-base">ğŸŸï¸ Local Events</button>
      <button id="random-button" class="action-card card-accent w-full mt-4 rounded-lg font-bold py-3 text-base">ğŸ¤· Surprise Me!</button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden action-card w-full mt-4 rounded-lg font-bold py-3 text-base" style="background: var(--card-bg-subtle);">â† Back to Main Menu</button>
    </section>
  </main>

  <section id="results-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="results-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="results-meta" class="text-sm opacity-80 mb-3"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  <section id="saved-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="saved-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="saved-title" class="text-xl font-header font-bold">My Saved Places</h2>
        <button id="close-saved-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="saved-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  <section id="events-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="events-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="events-title" class="text-xl font-header font-bold">Local Events</h2>
        <button id="close-events-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div class="text-xs opacity-60 text-center mb-2 -mt-2">
        Events provided by <a href="https://ticketmaster.com" target="_blank" rel="noopener" class="underline">Ticketmaster</a>
      </div>
      <div id="events-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  
  <section id="reviews-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="reviews-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="reviews-title" class="text-xl font-header font-bold">Reviews</h2>
        <button id="close-reviews-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="review-sort-container" class="flex gap-2 mb-3">
        <button id="sort-reviews-best" class="review-sort-button flex-1">Best</button>
        <button id="sort-reviews-worst" class="review-sort-button flex-1">Worst</button>
        <button id="sort-reviews-recent" class="review-sort-button flex-1 active">Recent</button>
      </div>
      <div id="review-star-filter-container" class="flex justify-center gap-1 mb-3">
        <button class="review-star-button" data-rating="5">â˜…â˜…â˜…â˜…â˜…</button>
        <button class="review-star-button" data-rating="4">â˜…â˜…â˜…â˜…â˜†</button>
        <button class="review-star-button" data-rating="3">â˜…â˜…â˜…â˜†â˜†</button>
        <button class="review-star-button" data-rating="2">â˜…â˜…â˜†â˜†â˜†</button>
        <button class="review-star-button" data-rating="1">â˜…â˜†â˜†â˜†â˜†</button>
        <button id="clear-star-filter" class="review-star-button text-xs font-bold" style="opacity: 0.8; color: var(--text-subtle);">Clear</button>
      </div>
      <div id="reviews-list" class="space-y-2 max-h-[55vh] overflow-y-auto"></div>
    </div>
  </section>

  <section id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" loading="lazy" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Place photo" class="w-full h-32 object-cover rounded-lg mb-4" style="background-color: var(--card-bg);" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform" aria-pressed="false">â˜†</button>
        </div>
      </div>
      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold" style="color: var(--accent);" id="place-rating">...</p>
        <p class="font-semibold" style="color: var(--accent-alt);" id="place-price">...</p>
        <a id="phone-link" href="#" class="hover:underline text-sm" style="color: var(--text-subtle);"></a>
      </div>
      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>
      <button id="show-reviews-button" class="action-card card-accent-dark w-full mt-3 mb-4 rounded-lg font-bold py-3 text-base" disabled>
        Show Reviews (0)
      </button>
      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card card-accent font-bold py-3 px-4 rounded-lg">Map</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card font-bold py-3 px-4 rounded-lg hidden" style="background: var(--card-bg-subtle);">Website</a>
        <button id="share-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Compass</button>
      </div>
      <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
        <button id="try-again-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl" style="background: var(--card-bg-subtle);">Back</button>
        <button id="next-suggestion-button" class="flex-1 action-card card-accent-dark font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
      </div>
    </div>
  </section>

  <div id="compass-modal" class="modal-base">
    <div id="compass-dialog" class="modal-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-2">
        <h2 id="modal-title" class="font-header text-lg">Live Compass</h2>
        <div class="flex gap-2">
          <button id="guide-button" class="action-card card-accent-dark font-bold py-2 px-3 rounded-lg">Guide Me â–¶ï¸</button>
          <button id="close-compass" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button>
        </div>
      </header>
      <div id="nav-bubble">
        <div id="nav-main">Head toward destination</div>
        <div id="nav-sub">Follow the arrow</div>
      </div>
      <div id="compass-overlay">
        <div id="compass-arrow"></div>
        <div id="compass-dist">--</div>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal-base">
    <div id="settings-dialog" class="modal-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-4">
        <h2 class="font-header text-xl">Settings</h2>
        <button id="close-settings-button" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button>
      </header>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Theme</h3>
          <div class="grid grid-cols-3 gap-2">
            <button class="theme-button flex-1" data-theme="day-ops">â˜€ï¸ Day Ops</button>
            <button class="theme-button flex-1" data-theme="rugged-explorer">âš“ Rugged</button>
            <button class="theme-button flex-1" data-theme="night-ops">ğŸŒ™ Night Ops</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Guide Voice</h3>
          <select id="voice-selector"> <option value="">Loading voices...</option> </select>
        </div>
        <a id="donate-button" href="https://venmo.com/u/Stephen-Mohamed-1" target="_blank" rel="noopener" 
           class="action-card card-accent-alt font-bold py-3 px-4 rounded-lg w-full block text-center">
          Buy me a coffee (Venmo)
        </a>
        <p id="app-version" class="text-center text-xs opacity-60 mt-4">App Version 9.0</p>
      </div>
    </div>
  </div>
  
  <div id="searching-modal">
    <div id="searching-dialog">
      <div id="searching-dialog-icon">ğŸ§­</div>
      <div id="searching-dialog-text">Acquiring Target...</div>
    </div>
  </div>

<script>
Â  Â  /* ====== SW Registration (Updated Filename!) ====== */
Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  navigator.serviceWorker.register('./service-worker-v2.js') // NEW FILENAME
Â  Â  Â  Â  Â  .then(reg => {
Â  Â  Â  Â  Â  Â  console.log('Service worker registered!', reg);
Â  Â  Â  Â  Â  Â  // Optional: Add logic here to check for updates on reload
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error('Service worker registration failed:', err);
Â  Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  /* ====== Refs (updated) ====== */
Â  Â  const funFactContainer = document.getElementById('fun-fact-container');
Â  Â  const funFactText = document.getElementById('fun-fact-text');
Â  Â  const mainScreen = document.getElementById('main-screen');
Â  Â  const resultsListScreen = document.getElementById('results-list-screen');
Â  Â  const resultsTitle = document.getElementById('results-title');
Â  Â  const resultsMeta = document.getElementById('results-meta');
Â  Â  const resultsList = document.getElementById('results-list');
Â  Â  const resultScreen = document.getElementById('result-screen');
Â  Â  const filterContainer = document.getElementById('filter-container');
Â  Â  const locationStatus = document.getElementById('location-status');
Â  Â  const manualLocationEntry = document.getElementById('manual-location-entry');
Â  Â  const locationInput = document.getElementById('location-input');
Â  Â  const subMenuContainer = document.getElementById('sub-menu-container');
Â  Â  const backToMainFiltersButton = document.getElementById('back-to-main-filters');
Â  Â  const placeNameEl = document.getElementById('place-name');
Â  Â  const placeRatingEl = document.getElementById('place-rating');
Â  Â  const placeStarsEl = document.getElementById('place-stars');
Â  Â  const placePriceEl = document.getElementById('place-price');
Â  Â  const placePhotoEl = document.getElementById('place-photo');
Â  Â  const directionsLink = document.getElementById('directions-link');
Â  Â  const websiteLink = document.getElementById('website-link');
Â  Â  const placeTypesContainer = document.getElementById('place-types-container');
Â  Â  const phoneLink = document.getElementById('phone-link');
Â  Â  const placeAccessibility = document.getElementById('place-accessibility');
Â  Â  const savePlaceButton = document.getElementById('save-place-button');
Â  Â  const compassModal = document.getElementById('compass-modal');
Â  Â  const compassDialog = document.getElementById('compass-dialog');
Â  Â  const closeCompassBtn = document.getElementById('close-compass');
Â  Â  const guideButton = document.getElementById('guide-button');
Â  Â  const navMain = document.getElementById('nav-main');
Â  Â  const navSub = document.getElementById('nav-sub');
Â  Â  const compassArrow = document.getElementById('compass-arrow');
Â  Â  const compassDist = document.getElementById('compass-dist');
Â  Â  const shareButton = document.getElementById('share-button');
Â  Â  const randomButton = document.getElementById('random-button');
Â  Â  const savedListScreen = document.getElementById('saved-list-screen');
Â  Â  const savedList = document.getElementById('saved-list');
Â  Â  const eventsListScreen = document.getElementById('events-list-screen');
Â  Â  const eventsList = document.getElementById('events-list');
Â  Â  const settingsModal = document.getElementById('settings-modal');
Â  Â  const settingsDialog = document.getElementById('settings-dialog');
Â  Â  const themeColorMeta = document.getElementById('theme-color-meta');
Â  Â  const voiceSelector = document.getElementById('voice-selector');
Â  Â  const reviewsListScreen = document.getElementById('reviews-list-screen');
Â  Â  const reviewsList = document.getElementById('reviews-list');
Â  Â  const showReviewsButton = document.getElementById('show-reviews-button');
Â  Â  const searchingModal = document.getElementById('searching-modal');
Â  Â  // NEW: Review filter refs
Â  Â  const reviewSortContainer = document.getElementById('review-sort-container');
Â  Â  const reviewStarFilterContainer = document.getElementById('review-star-filter-container');


Â  Â  /* ====== State (updated) ====== */
Â  Â  let placesService, geocoder, directionsService;
Â  Â  let currentUserLocation;
Â  Â  let currentLocality = '';
Â  Â  let currentGeocodeLabel = 'Your Location';
Â  Â  let currentPlace;
Â  Â  let currentResults = [];
Â  Â  let currentResultIndex = 0;
Â  Â  let savedPlaces = {};
Â  Â  let localFacts = [], factInterval = null, currentFactIndex = 0;
Â  Â  let compassActive = false, guideSpeaking = false, watchId = null, headingDeg = 0;
Â  Â  let routeSteps = [], stepIndex = 0, stepTarget = null, destLatLng = null;
Â  Â  let voices = [];
Â  Â  let currentVoiceURI = null;
Â  Â  let currentReviews = [];
Â  Â  // NEW: Review filter state
Â  Â  let currentReviewSort = 'time';
Â  Â  let currentStarFilter = null; // null means no filter

Â  Â  /* ====== Categories (updated Pet Store) ====== */
Â  Â  const subFilterMap = {
Â  Â  Â  eat: {"ğŸ• Surprise Me":{type:"restaurant"},"Italian":{type:"italian_restaurant",keyword:"italian"},"Mexican":{type:"mexican_restaurant",keyword:"mexican"},"Japanese":{type:"japanese_restaurant",keyword:"japanese"},"Chinese":{type:"chinese_restaurant",keyword:"chinese"},"Indian":{type:"indian_restaurant",keyword:"indian"},"Pizza":{type:"pizza_restaurant",keyword:"pizza"},"Cafes":{type:"cafe",keyword:"cafe"},"Desserts":{type:"bakery",keyword:"dessert bakery"}},
Â  Â  Â  see:{"Museums":{type:"museum"},"Art Galleries":{type:"art_gallery"},"Tourist Attractions":{type:"tourist_attraction"}},
Â  Â  Â  night:{"Bars":{type:"bar"},"Night Clubs":{type:"night_club"}},
Â  Â  Â  outdoors:{"Parks":{type:"park"}, "Hiking":{keyword:"hiking area"}, "Campground":{type:"campground"}, "Scenic Lookout":{type:"tourist_attraction", keyword:"scenic lookout"}},
Â  Â  Â  gems:{"Quirky Shops":{keyword:"vintage store"},"Indie Coffee":{type:"cafe"},"Local Art":{type:"art_gallery"},"Quiet Spots":{type:"park"}},
Â  Â  Â  // NEW: Broadened Pet Store search
Â  Â  Â  pets:{"Dog Park":{type:"park",keyword:"dog park"}, "Pet Store":{type:"pet_store", keyword:"pet supplies store"}, "Veterinarian":{type:"veterinary_care"}},
Â  Â  Â  utilities:{"Hospital":{type:"hospital"},"Pharmacy":{type:"pharmacy"},"Police":{type:"police"},"Gas Station":{type:"gas_station"},"Car Rental":{type:"car_rental"},"ATM":{type:"atm"}}
Â  Â  };
Â  Â  const allowedByCategory = {
Â  Â  Â  eat:new Set(['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant']),
Â  Â  Â  night:new Set(['bar','night_club']),
Â  Â  Â  see:new Set(['museum','art_gallery','tourist_attraction']),
Â  Â  Â  outdoors: new Set(['park', 'tourist_attraction', 'campground']),
Â  Â  Â  gems:new Set(['art_gallery','park','cafe']),
Â  Â  Â  pets:new Set(['park','pet_store','veterinary_care']),
Â  Â  Â  utilities:new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']),
Â  Â  Â  random: new Set([
Â  Â  Â  Â  ...['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant'],
Â  Â  Â  Â  ...['bar','night_club'],
Â  Â  Â  Â  ...['museum','art_gallery','tourist_attraction'],
Â  Â  Â  Â  ...['park', 'campground'],
Â  Â  Â  Â  ...['art_gallery','park','cafe']
Â  Â  Â  ])
Â  Â  };
Â  Â  const bannedRetailish = new Set(['grocery_or_supermarket','supermarket','department_store','shopping_mall','convenience_store','store','lodging','hotel']);

Â  Â  /* ====== Utils (unchanged) ====== */
Â  Â  const metersToImperial = m => { const ft=m*3.28084; return ft<1000?`${Math.round(ft)} ft`:`${(m*0.000621371).toFixed(1)} mi`; };
Â  Â  const toggleFilterButtons = d => document.querySelectorAll('#main-screen button').forEach(b=>b.disabled=d);
Â  Â  const renderStarsHTML = r => { r=Math.round(r||0); let h=''; for(let i=1;i<=5;i++)h+=`<span class="star${i<=r?' filled':''}">â˜…</span>${i<5?' ':''}`; return h; };
Â  Â  const renderStars = (el,r) => el.innerHTML=renderStarsHTML(r);
Â  Â  const stripHtml = h => { const t=document.createElement('div'); t.innerHTML=h||''; return t.textContent||t.innerText||''; };
Â  Â  const dedupe = items => { const s=new Set(),o=[]; for(const it of items) if(!s.has(it.place_id)){s.add(it.place_id);o.push(it)} return o; };
Â  Â  const sortResults = a => a.sort((x,y)=>(y.rating??0)-(x.rating??0)||(y.user_ratings_total??0)-(x.user_ratings_total??0)||(x.distanceMeters??Infinity)-(y.distanceMeters??Infinity)||x.name.localeCompare(y.name));
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  const t=new Set(p.types||[]);
Â  Â  Â  if (![...t].some(x => allowedSet.has(x))) return false;
Â  Â  Â  for (const x of t) if(bannedRetailish.has(x)) return false;
Â  Â  Â  if (reqType && !t.has(reqType)) {
Â  Â  Â  Â  // Allow keyword match even if type doesn't exactly match (e.g., "pet supplies store" found as type "store")
Â  Â  Â  Â  if(!(kw && new RegExp(kw,'i').test(p.name||''))) return false;
Â  Â  Â  }
Â  Â  Â  return true;
Â  Â  }
Â  Â  function updateSaveButtonState(){
Â  Â  Â  const pressed = currentPlace && !!savedPlaces[currentPlace.place_id];
Â  Â  Â  savePlaceButton.setAttribute('aria-pressed', String(pressed));
Â  Â  Â  savePlaceButton.textContent = pressed ? 'â˜…' : 'â˜†';
Â  Â  }
Â  Â  function speak(text){
Â  Â  Â  try{
Â  Â  Â  Â  speechSynthesis.cancel();
Â  Â  Â  Â  const u = new SpeechSynthesisUtterance(text);
Â  Â  Â  Â  if (currentVoiceURI) {
Â  Â  Â  Â  Â  const selectedVoice = voices.find(v => v.voiceURI === currentVoiceURI);
Â  Â  Â  Â  Â  if (selectedVoice) u.voice = selectedVoice;
Â  Â  Â  Â  }
Â  Â  Â  Â  speechSynthesis.speak(u);
Â  Â  Â  }catch{}
Â  Â  }

Â  Â  /* ====== Local Facts (unchanged) ====== */
Â  Â  async function getFunFact(coords){ /* ... */ }
Â  Â  function startFactCycling(){ /* ... */ }

Â  Â  /* ====== Results/Saved/Events/Reviews Lists (updated) ====== */
Â  Â  function showResultsList(parentFilter, subLabel){
Â  Â  Â  mainScreen.style.display = 'none';
Â  Â  Â  savedListScreen.style.display='none';
Â  Â  Â  eventsListScreen.style.display='none';
Â  Â  Â  reviewsListScreen.style.display = 'none';
Â  Â  Â  resultsListScreen.style.display='flex';Â 
Â  Â  Â  resultsTitle.textContent=subLabel || 'Results';
Â  Â  Â  resultsMeta.textContent=currentResults.length?`${currentResults.length} results`:'No results';
Â  Â  Â  resultsList.innerHTML='';
Â  Â  Â  currentResults.forEach(p=>{
Â  Â  Â  Â  const photo='https://placehold.co/200x200/111827/fff?text=N/A';
Â  Â  Â  Â  const rating=p.rating??null; const price=p.price_level?'$'.repeat(p.price_level):''; const vic=p.vicinity||p.formatted_address||'';
Â  Â  Â  Â  const card=document.createElement('button'); card.className='result-item'; card.dataset.id = p.place_id;
Â  Â  Â  Â  card.innerHTML=`<img class="result-thumb" loading="lazy" src="${photo}" alt="" /><div class="flex-1 text-left"><div class="flex items-center justify-between"><h3 class="font-semibold text-base">${p.name}</h3><div class="text-xs opacity-70">${price}</div></div><div class="flex items-center gap-2 mt-1"><div class="star-row">${renderStarsHTML(rating)}</div><div class="text-sm" style="color:var(--accent);">${rating?rating.toFixed(1):'N/A'}</div><div class="text-xs opacity-60">(${p.user_ratings_total??0})</div></div><div class="text-xs opacity-80 mt-1">${vic}</div></div><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.name+', '+(vic||''))}" target="_blank" rel="noopener" class="p-2 rounded-full card-accent text-white self-center map-link-icon"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></a>`;
Â  Â  Â  Â  resultsList.appendChild(card);
Â  Â  Â  });
Â  Â  }
Â  Â  function showSavedList() {
Â  Â  Â  mainScreen.style.display = 'none';
Â  Â  Â  resultsListScreen.style.display='none';
Â  Â  Â  eventsListScreen.style.display='none';
Â  Â  Â  reviewsListScreen.style.display = 'none';
Â  Â  Â  savedListScreen.style.display='flex';
Â  Â  Â  savedList.innerHTML='';
Â  Â  Â  const places = Object.values(savedPlaces);
Â  Â  Â  if (places.length === 0) {
Â  Â  Â  Â  savedList.innerHTML = '<p class="opacity-70 text-center">You haven\'t saved any places yet.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  places.forEach(p=>{
Â  Â  Â  Â  const card=document.createElement('div');
Â  Â  Â  Â  card.className='result-item';
Â  Â  Â  Â  card.innerHTML=`
Â  Â  Â  Â  Â  <button class="flex-1 text-left saved-item-details" data-id="${p.place_id}">
Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-base">${p.name}</h3>
Â  Â  Â  Â  Â  Â  <div class="text-xs opacity-80 mt-1">${p.vicinity||''}</div>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button class="remove-saved-button action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);" data-id="${p.place_id}">X</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  savedList.appendChild(card);
Â  Â  Â  });
Â  Â  }
Â  Â  function showEventsList(events) {
Â  Â  Â  mainScreen.style.display = 'none';
Â  Â  Â  resultsListScreen.style.display='none';
Â  Â  Â  savedListScreen.style.display='none';
Â  Â  Â  reviewsListScreen.style.display = 'none';
Â  Â  Â  eventsListScreen.style.display='flex';
Â  Â  Â  eventsList.innerHTML='';
Â  Â  Â  if (!events || events.length === 0) {
Â  Â  Â  Â  eventsList.innerHTML = '<p class="opacity-70 text-center">No local events found on Ticketmaster.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  events.forEach(event => { /* ... rendering unchanged ... */ });
Â  Â  }

Â  Â  // UPDATED: showReviews includes star filtering
Â  Â  function showReviews() {
Â  Â  Â  mainScreen.style.display = 'none';
Â  s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  resultScreen.style.display = 'none'; // Hide place detail when showing reviews
Â  Â  Â  reviewsListScreen.style.display = 'flex';

Â  Â  Â  // Show/hide sort buttons based on count (this is now handled in getPlaceDetails)
Â  Â  Â  // reviewSortContainer.style.display = currentReviews.length >= 10 ? 'flex' : 'none';

Â  Â  Â  // Apply star filter first
Â  Â  Â  const filteredReviews = currentStarFilter === null
Â  Â  Â  Â  ? [...currentReviews] // No filter, use all
Â  Â  Â  Â  : currentReviews.filter(r => r.rating === currentStarFilter);

Â  Â  Â  // Apply sort
Â  Â  Â  if (currentReviewSort === 'time') {
Â  Â  Â  Â  filteredReviews.sort((a, b) => b.time - a.time);
Â  Â  Â  } else if (currentReviewSort === 'rating-desc') {
Â  Â  Â  Â  filteredReviews.sort((a, b) => b.rating - a.rating);
Â  Â  Â  } else if (currentReviewSort === 'rating-asc') {
Â  Â  Â  Â  filteredReviews.sort((a, b) => a.rating - b.rating);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Update active sort button
Â  Â  Â  document.querySelectorAll('.review-sort-button').forEach(b => {
Â  Â  Â  Â  b.classList.toggle('active', b.id.includes(currentReviewSort.split('-')[0]));
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Update active star button
Â  Â  Â  document.querySelectorAll('.review-star-button').forEach(b => {
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  b.classList.toggle('active', parseInt(b.dataset.rating) === currentStarFilter);
Â  Â  Â  });

Â  Â  Â  // Render
Â  Â  Â  reviewsList.innerHTML = '';
Â  Â  Â  if (filteredReviews.length === 0) {
Â  Â  Â  Â  reviewsList.innerHTML = `<p class="opacity-70 text-center">No reviews match ${currentStarFilter !== null ? currentStarFilter +'-star filter' : 'your criteria'}.</p>`;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  filteredReviews.forEach(review => {
Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  card.className = 'review-item';
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  <div class="flex items-center gap-3 mb-2">
Â  Â  Â  Â  Â  Â  <img loading="lazy" src="${review.profile_photo_url}" alt="${review.author_name}" class="w-10 h-10 rounded-full" />
Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  <h4 class="font-semibold text-sm">${review.author_name}</h4>
Â  Â  Â  Â  Â  Â  Â  <p class="text-xs opacity-70">${review.relative_time_description}</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="star-row text-right">${renderStarsHTML(review.rating)}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p class="text-sm opacity-90">${review.text || '<i>(No text provided)</i>'}</p>Â 
Â  Â  Â  Â  `; // Added fallback for empty review text
Â  Â  Â  Â  reviewsList.appendChild(card);
Â  Â  Â  });
Â  Â  }

Â  Â  /* ====== Search (updated Pet Store query) ====== */
Â  Â  async function findLocalEvents() { /* ... unchanged ... */ }

Â  s.push(...res.filter(p => filtered(p))]);
Â  Â  function findAdventure(searchParams,parentFilter,subLabel){
Â  Â  Â  if(!placesService||!currentUserLocation)return;
Â  Â  Â  mainScreen.style.display = 'none';
Â  Â  Â  searchingModal.style.display = 'flex';
Â  Â  Â  toggleFilterButtons(true); backToMainFiltersButton.disabled=true;
Â  Â  Â  currentResults=[];
Â  Â  Â  const reqType=searchParams.type||null;
Â  Â  Â  // Combine type and keyword for better results, especially for Pet Store
Â  Â  Â  let kw = searchParams.keyword || '';
Â  Â  Â  if (parentFilter === 'pets' && subLabel === 'Pet Store') {
Â  Â  Â  Â  Â kw = 'pet supplies store'; // Use broader keyword
Â  Â  Â  } else if (parentFilter === 'eat') {
Â  Â  Â  Â  Â kw = searchParams.keyword || (reqType ? reqType.replace('_restaurant', '') : '');
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const radii=[2000,5000,10000,20000,35000,50000]; let i=0;

Â  Â  Â  const nearby=()=>{ if(i>=radii.length)return text(); // Stop if we've run out of radii
Â  Â  Â  Â  const radius=radii[i++];Â 
Â  Â  Â  Â  // Request includes both type and keyword if available
Â  Â  Â  Â  const req = { location: currentUserLocation, radius };
Â  Â  Â  Â  if (searchParams.type) req.type = searchParams.type;
Â  Â  Â  Â  if (kw) req.keyword = kw;Â 

Â  Â  Â  Â  placesService.nearbySearch(req,(res,status)=>{
Â  Â  Â  Â  Â  if(status === google.maps.places.PlacesServiceStatus.OK && res?.length){
Â  Â  Â  Â  Â  Â  const allowed = allowedByCategory[parentFilter] || new Set();
Â  Â  Â  Â  Â  Â  const filtered = (p) => isCandidate(p, kw, reqType, allowed);
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  // If we still don't have enough results, search wider
Â  Â  Â  Â  Â  Â  if(currentResults.length < 12 && i < radii.length){
Â  Â  Â  Â  Â  Â  Â  nearby();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // We have enough, or we've run out of radii
Â  Â  Â  Â  Â  Â  Â  finalize();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS && i < radii.length) {
Â  Â  Â  Â  Â  Â  // No results in this radius, search wider
Â  Â  Â  Â  Â  Â  nearby();
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // An error occurred (like OVER_QUERY_LIMIT) or we're out of radii
Â  Â  Â  Â  Â  Â  // Stop looping and try the text search as a fallback
Â  Â  Â  Â  Â  Â  console.warn("Nearby search failed or exhausted, moving to text search. Status:", status);
Â  Â  Â  Â  Â  Â  text();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  };
Â  Â  Â  const text=()=>{
Â  Â  Â  Â  const city=currentLocality||'';Â 
Â  Â  Â  Â  // Text query combines keyword and label/type for clarity
Â  Â  Â  Â  const query = kw ? `${kw} in ${city}` : `${subLabel||searchParams.type||''} in ${city}`;
Â  Â  Â  Â  placesService.textSearch({query,location:currentUserLocation,radius:50000},(res,status)=>{
Â  Â  Â  Â  Â  if(status===google.maps.places.PlacesServiceStatus.OK&&res?.length){
Â  Â  Â  Â  Â  Â  const allowed = allowedByCategory[parentFilter] || new Set();
Â  Â  Â  Â  Â  Â  const filtered = (p) => isCandidate(p, kw, reqType, allowed);
s.push(...res.filter(p => filtered(p))]);
S: Â  Â  Â  } finalize();
Â  Â  Â  Â  });
Â  Â  Â  };
Â  Â  Â  const finalize=()=>{
Â  Â  Â  Â  currentResults=sortResults(currentResults);
Â  Â  Â  Â  showResultsList(parentFilter,subLabel);
Â  Â  Â  Â  searchingModal.style.display = 'none';
Â  Â  Â  Â  toggleFilterButtons(false); backToMainFiltersButton.disabled=false;
Â  Â  Â  };
Â  Â  Â  nearby();
Â  Â  }

Â  Â  /* ====== Details, Directions, Compass (updated) ====== */
Â  Â  function openDetailsById(placeId){ /* ... unchanged ... */ }

Â  Â  Â  Â  function getPlaceDetails(summary){
Â  Â  Â  Â  mainScreen.style.display = 'none';
Â  Â  Â  Â  resultsListScreen.style.display = 'none';
Â  Â  Â  Â  savedListScreen.style.display = 'none';
Â  Â  Â  Â  eventsListScreen.style.display = 'none';
Â  Â  Â  Â  reviewsListScreen.style.display = 'none';
Â  Â  Â  Â  resultScreen.style.display='flex';
Â  Â  Â  Â Â 
Â  Â  Â  Â  currentPlace = summary;
Â  Â  Â  Â  currentReviews = [];
Â  Â  Â  Â  currentStarFilter = null; // Reset star filter
Â  Â  Â  Â  currentReviewSort = 'time'; // Reset sort
Â  Â  Â  Â  updateSaveButtonState();
Â  Â  Â  Â  placeNameEl.textContent = 'Loading Details...';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const placeholdURL = `https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(summary.name)}`;
Â  Â  Â  Â  placePhotoEl.src = placeholdURL;
Â  Â  Â  Â  placePhotoEl.onerror = null;

Â  Â  Â  Â  placeRatingEl.textContent=''; placeStarsEl.innerHTML=''; placePriceEl.textContent='';
Â  Â  Â  Â  placeTypesContainer.innerHTML=''; websiteLink.classList.add('hidden');
Â  Â  Â  Â  phoneLink.textContent=''; phoneLink.removeAttribute('href');
Â  Â  Â  Â  placeAccessibility.textContent=''; placeAccessibility.style.display='none';
Â  Â  Â  Â  showReviewsButton.disabled = true;
Â  Â  Â  Â  showReviewsButton.textContent = 'Loading Reviews...';
Â  Â  Â  Â Â 
Â  Â  Â  Â  routeSteps=[]; stepIndex=0; stepTarget=null; stopCompass();

Â  Â  Â  Â  placesService.getDetails({
Â  Â  Â  Â  Â  Â  placeId:summary.place_id,
Â  Â  Â  Â  Â  Â  fields:['name','rating','user_ratings_total','price_level','website','vicinity','types','formatted_phone_number','geometry','wheelchair_accessible_entrance', 'reviews']
Â  Â  Â  Â  },(place,status)=>{
Â  Â  Â  Â  Â  Â  if(status===google.maps.places.PlacesServiceStatus.OK&&place){
Â  Â  Â  Â  Â  Â  Â  Â  currentPlace=place;
Â  Â  Â  Â  Â  Â  Â  Â  placeNameEl.textContent=place.name;
Â  Â  Â  Â  Â  Â  Â  Â  renderStars(placeStarsEl, place.rating??0);
Â  Â  Â  Â  Â  Â  Â  Â  placeRatingEl.textContent=place.rating?place.rating.toFixed(1):'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  placePriceEl.textContent=place.price_level?'$'.repeat(place.price_level):'';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(place.website){ /* ... logo logic unchanged ... */ }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else { placePhotoEl.src = placeholdURL; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(place.formatted_phone_number){phoneLink.href=`tel:${place.formatted_phone_number}`;phoneLink.textContent=place.formatted_phone_number}
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  Â  Â  if(place.wheelchair_accessible_entrance){placeAccessibility.textContent='â™¿';placeAccessibility.style.display='inline'}
Â  Â  Â  Â  Â  Â  Â  Â  if(place.types?.length){ /* ... type rendering unchanged ... */ }

Â  Â  Â  Â  Â  Â  Â  Â  currentReviews = place.reviews || [];
Â  Â  s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  Â  showReviewsButton.textContent = `Show Reviews (${currentReviews.length})`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Hide/Show sort AND filter containers based on review count
Â  Â  Â  Â  Â  Â  Â  Â  const showFilters = currentReviews.length >= 10;
Â  Â  Â  Â  Â  Â  Â  Â  reviewSortContainer.style.display = showFilters ? 'flex' : 'none';
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  Â  Â  reviewStarFilterContainer.style.display = showFilters ? 'flex' : 'none';

Â  Â  Â  Â  Â  Â  Â  Â  const dest=`${place.name}, ${place.vicinity||''}`; directionsLink.href=`http://googleusercontent.com/maps/google.com/0{encodeURIComponent(dest)}`;
Â  Â  Â  Â  Â  Â  Â  Â  buildRouteTo(place.geometry.location);
Â  Â  Â  Â  Â  Â  Â  Â  updateSaveButtonState();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â showReviewsButton.textContent = 'Reviews Unavailable'; // Handle API error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â }
Â  Â  function buildRouteTo(latLng){ /* ... unchanged ... */ }
Â  Â  function setStep(i){ /* ... unchanged ... */ }
Â  Â  const toRad=d=>d*Math.PI/180, norm=a=>((a%360)+360)%360;
Â  Â  function bearingFromTo(a,b){ /* ... unchanged ... */ }
Â  Â  function haversineMeters(a,b){ /* ... unchanged ... */ }
Â  Â  function turnHint(delta){ /* ... unchanged ... */ }
Â  Â  function updateCompassUI(){ /* ... unchanged ... */ }
Â  Â  function onOrientation(e){ /* ... unchanged ... */ }
Â  Â  function openCompass(){ /* ... unchanged ... */ }
Â  Â  function closeCompass(){ /* ... unchanged ... */ }
Â  Â  function trapCompassTab(e){ /* ... unchanged ... */ }
Â  Â  function startCompass(){ /* ... unchanged ... */ }
Â  Â  function stopCompass(){ /* ... unchanged ... */ }
Â  Â Â 
Â  Â  /* ====== Settings (updated) ====== */
Â  s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  document.documentElement.dataset.theme = theme;
Â  Â  Â  localStorage.setItem('appTheme', theme); // FIXED: Saving now works
Â  Â  Â Â 
Â  Â  Â  document.querySelectorAll('.theme-button').forEach(b => {
Â  Â  Â  Â  b.classList.toggle('active', b.dataset.theme === theme);
Â  Â  Â  });

Â  Â  Â  const newThemeColor = theme === 'rugged-explorer' ? '#0A192F' : (theme === 'night-ops' ? '#111111' : '#f8f7f2'); // Updated day-ops color
Â  Â  Â  themeColorMeta.content = newThemeColor;
Â  Â  }
Â  Â  function applyVoice(voiceURI) {
Â  Â  Â  currentVoiceURI = voiceURI;
Â  Â  Â  localStorage.setItem('appVoice', voiceURI); // FIXED: Saving now works
Â  Â  }
Â  Â  function loadVoices() { /* ... unchanged ... */ }
Â  Â  function loadSettings() {
Â  Â  Â  // Load Theme
Â  Â  Â  const theme = localStorage.getItem('appTheme') || 'rugged-explorer';
Â  Â  Â  applyTheme(theme);
Â  Â  Â  // Load Voice
Â  Â  Â  currentVoiceURI = localStorage.getItem('appVoice') || null;
Â  Â  Â  loadVoices();
Â  Â  Â  if (speechSynthesis.onvoiceschanged !== undefined) {
Â  Â  Â  Â  speechSynthesis.onvoiceschanged = loadVoices;
Â  Â  Â  }
Â  Â  Â  // Load Saved Places (CRITICAL FIX)
Â  Â  Â  try {
Â  Â  Â  Â  savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error loading saved places:", e);
Â  Â  Â  Â  savedPlaces = {}; // Reset if data is corrupt
Â  Â  Â  Â  localStorage.setItem('savedPlaces', '{}');
Â  Â  Â  }
Â  Â  }
Â  Â  function openSettings() { /* ... unchanged ... */ }
Â  Â  function closeSettings() { /* ... unchanged ... */ }

Â  Â  /* ====== Init / Geocode (updated) ====== */
Â  Â  function initApp(){
Â  Â  Â  loadSettings(); // Ensures settings & saved places load reliably
Â  Â  Â  placesService=new google.maps.places.PlacesService(document.createElement('div'));
Â  Â  Â  geocoder=new google.maps.Geocoder();
Â  Â  Â  directionsService=new google.maps.DirectionsService();
Â  Â  Â  toggleFilterButtons(true);
Â  Â  Â  locationStatus.textContent = 'Acquiring location...'; // More active message
Â  Â  Â  if(navigator.geolocation){
Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(pos=>{
Â  Â  Â  Â  Â  const coords={lat:pos.coords.latitude,lng:pos.coords.longitude};
Â  Â  Â  Â  Â  reverseGeocodeSetLocation(coords);
Â  Â  Â  Â  }, handleLocationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); // Added options
Â  Â  Â  } else handleLocationError();
Â  Â  }
Â  Â  window.initApp=initApp;
Â  Â  function handleLocationError(error){ // Added error param
Â  Â  Â  console.warn("Geolocation error:", error);
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  locationStatus.textContent="Couldn't get location. Enter manually?";
Â  Â  Â  manualLocationEntry.classList.remove('hidden');
Â  Â  Â  // Use a default location for facts if needed (e.g., NYC)
Â  Â  Â  getFunFact({lat:40.7128,lng:-74.0060});Â 
Â  Â  Â  toggleFilterButtons(false);
Â  Â  }
Â  Â  function reverseGeocodeSetLocation(coords){ /* ... unchanged ... */ }
s.push(...res.filter(p => filtered(p))]);
Â  Â  function geocodeLocation(){ /* ... unchanged ... */ }
Â  Â  function setLocationAndEnableApp(coords,label){ /* ... unchanged ... */ }

Â  Â  /* ====== UI & Events (updated) ====== */
Â  Â  function showSubMenu(filter){ /* ... unchanged ... */ }
Â  Â  function hideSubMenu(){ /* ... unchanged ... */ }
Â  Â  function findRandomAdventure() { /* ... unchanged ... */ }
Â  Â  function resetApp(hide=true){
Â  Â  Â  closeCompass();
Â  Â  Â  resultScreen.style.display='none';Â 
Â  Â  Â  resultsListScreen.style.display='none';
Â  Â  Â  savedListScreen.style.display='none';
Â  Â  Â  eventsListScreen.style.display='none';
Â  Â  Â  reviewsListScreen.style.display='none';
Â  Â  Â  mainScreen.style.display='block';
Â  Â  Â  funFactContainer.style.display='block';
Â  Â  Â  hideSubMenu(); toggleFilterButtons(false); backToMainFiltersButton.disabled=false;
Read Â  Â  if(currentUserLocation) locationStatus.textContent=`Exploring: ${currentGeocodeLabel}`;
Â  Â  Â  else locationStatus.textContent="Set your location."; // Clearer if no location yet
Â  Â  }

s.push(...res.filter(p => filtered(p))]);
Â  Â  document.addEventListener('click', (e)=>{
Â  Â  Â  const btn=e.target.closest('button'); if(!btn||btn.disabled) return;
Â  Â  Â  if (e.target.closest('.map-link-icon')) return; // Allow map icon links

Â  Â  Â  // Main filter buttons
Â  Â  Â  if(btn.matches('#filter-container > button[data-filter]')){showSubMenu(btn.dataset.filter);return;}
Â  Â  Â  // Sub-menu buttons
Â  Â  Â  if(btn.closest('.sub-menu') && btn.dataset.name){ /* ... unchanged ... */ }
Â  Â  Â Â 
Â  Â  Â  // List item clicks
Â  Â  Â  if(btn.closest('#results-list') && btn.classList.contains('result-item')){ openDetailsById(btn.dataset.id); return;}
Indented Â  Â  Â  if(btn.classList.contains('saved-item-details')){ openDetailsById(btn.dataset.id); return;}
Â  Â  Â  // Remove Saved Place button
Â  Â  Â  if(btn.classList.contains('remove-saved-button')){Â 
Â  Â  Â  Â  const placeId = btn.dataset.id;Â 
Â  Â  Â  Â  if(placeId && savedPlaces[placeId]){Â 
Â  Â  Â  Â  Â  delete savedPlaces[placeId];Â 
Â  Â  Â  Â  Â  localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces)); // Save change
Â  Â  Â  Â  Â  showSavedList(); // Refresh list
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  return;Â 
Â  Â  Â  }
Â  Â  Â  // Theme selection buttons
Indented Â  Â  Â  if(btn.classList.contains('theme-button')){ applyTheme(btn.dataset.theme); return; }

s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  // Review Sort/Filter buttons
Â  Â  Â  if(btn.id === 'sort-reviews-best') { currentReviewSort = 'rating-desc'; showReviews(); return; }
Â  Â  Â  if(btn.id === 'sort-reviews-worst') { currentReviewSort = 'rating-asc'; showReviews(); return; }
Â  Â  Â  if(btn.id === 'sort-reviews-recent') { currentReviewSort = 'time'; showReviews(); return; }
Indented s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  currentStarFilter = parseInt(btn.dataset.rating);
Â  Â  Â  Â  Â  showReviews();
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if(btn.id === 'clear-star-filter') {
Â  Â  Â  Â  Â  currentStarFilter = null;
Â  Â  Â  Â  Â  showReviews();
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Switch based on button ID for other actions
Â  Â  Â  switch(btn.id){
Â  Â  Â  Â  case 'back-to-main-filters': hideSubMenu(); break;
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  // Back buttons now use resetApp to ensure correct state
Â  Â  Â  Â  case 'close-results-button': resetApp(); break;
Â  Â  Â  Â  case 'close-saved-button': resetApp(); break;
Â  Â  Â  Â  case 'close-events-button': resetApp(); break;
Â  Â  Â  Â  case 'close-reviews-button': resultScreen.style.display = 'flex'; reviewsListScreen.style.display = 'none'; break;
Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'show-saved-button': showSavedList(); break;
Â  Â  Â  Â  case 'local-events-button': findLocalEvents(); break;
Â  D: Â  Â  case 'show-reviews-button': showReviews(); break;Â 

Â  Â  Â  Â  case 'settings-button': openSettings(); break;
Â  Â  Â  Â  case 'close-settings-button': closeSettings(); break;

Â  Â  Â  Â  case 'try-again-button': resetApp(); break; // This button now resets the app view
Â  Â  Â  Â  case 'search-button': geocodeLocation(); break;
Â  Â  Â  Â  case 'random-button': findRandomAdventure(); break;
Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'next-suggestion-button': /* ... unchanged ... */ break;
Â  Â  Â  Â Â 
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  case 'save-place-button':
Â  Â  Â  Â  Â  if(currentPlace) {
Â  Â  Â  Â  Â  Â  const placeId = currentPlace.place_id;
Â  Â  Â  Â  Â  Â  if (!placeId) { console.error("Cannot save place - place_id is missing!"); return; }
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  if(savedPlaces[placeId]) {
Â  Â  Â  Â  Â  Â  Â  // It's already saved, so unsave it
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  Â  delete savedPlaces[placeId];
Â  A: Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // It's not saved, so save it
Â  Â  Â  Â  Â  Â  Â  const vicinityText = currentPlace.vicinity || currentPlace.formatted_address || 'Location details saved';
Â  Â  Â  Â  Â  Â  Â  if (currentPlace.geometry && currentPlace.geometry.location) {
Â  Â  Â  Â  Â  Â  Â  Â   savedPlaces[placeId] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  name: currentPlace.name || 'Unnamed Place',
Examples Â  Â  Â  Â  Â  Â  place_id: placeId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  vicinity: vicinityText,
Â  Â  Â  Â  Â  Â  Â  Â  Â  geometry: currentPlace.geometry.location.toJSON() // Save lat/lng
Â  Â  Â  Â  Â  Â  Â  Â   };
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â   console.error("Cannot save place - geometry is missing!");
source_code Â  Â  Â  Â  Â  Â  Â   alert("Could not save place - missing location data.");
Â  Â  Â  Â  Â  Â  Â  Â   return; // Don't proceed
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Save the updated object to localStorage
Â  Â  Â  Â  Â  Â  try {
s.push(...res.filter(p => filtered(p))]);
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces));
g> Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  console.error('Error saving to localStorage:', err);
Â  Â  Â  Â  Â  Â  Â  alert("Error saving place. Storage might be full.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  D: Â  // Update the button's appearance
Â  Â  Â  Â  Â  Â  updateSaveButtonState();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'compass-button': openCompass(); break;
Â  Â  Â  Â  case 'close-compass': closeCompass(); break;
Â  Â  Â  Â  case 'guide-button': /* ... unchanged ... */ break;
Â  Â  Â  Â  case 'share-button': /* ... unchanged ... */ break;
Â  CSS: }
Â  Â  });

Â  Â  // Input listeners
Â  Â  document.getElementById('location-input').addEventListener('keyup',e=>{if(e.key==='Enter') geocodeLocation();});
Example Â  document.getElementById('voice-selector').addEventListener('change', e => {
Â  Â  Â  applyVoice(e.target.value);
Â  Â  });
Â  </script>
</body>
</html>
