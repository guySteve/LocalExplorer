<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
  />
  <title>Local Explorer</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Load API keys early if file exists; app falls back to inline constants below -->
  <script src="keys.js" defer></script>

  <style>
    :root{
      --bg:#f8f7f2;         /* ivory */
      --ink:#111827;        /* deep navy */
      --cta:#ff4500;        /* orange */
      --accent:#d4b48a;     /* rope-tan */
      --steel1:#48586b;     /* steel gradient start */
      --steel2:#7b8b9e;     /* steel gradient end */
      --muted:#8b94a5;
      --card:#0f1522;
      --shadow:0 10px 24px rgba(0,0,0,.25);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:#e8ecf8;
      font-family:'Raleway',system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{
      max-width:980px;margin:0 auto;padding:12px 12px 84px;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;margin:10px auto 6px;border-radius:20px;
      background:var(--ink);box-shadow:var(--shadow);
    }
    h1{
      margin:0;color:#fff;font:700 22px/1.1 'Poppins',sans-serif;letter-spacing:.3px;
    }
    .loc{
      color:#dbe2ff;font-size:12px;line-height:1.15;text-align:right;
    }
    .loc .city{font-weight:600;color:#fff}
    .loc .coords{opacity:.7;font-size:11px}
    .loc .edit{display:inline-block;margin-top:4px;font-size:12px;color:var(--cta);text-decoration:underline;cursor:pointer}

    /* Facts widget (single-card) */
    #factWidget{
      margin:10px auto 12px; padding:10px 12px 14px; background:var(--ink);
      border-radius:var(--radius); border:2px dashed var(--accent);
      box-shadow:var(--shadow);
    }
    #factWidget.no-facts{ border-color:var(--cta); }
    #factHeader{
      position:relative; display:flex; align-items:center; justify-content:center;
      padding:2px 0 8px;
    }
    #factTitle{
      font:700 16px/1 'Poppins',sans-serif; color:#fff; text-align:center;
    }
    #factCardsWrapper{
      display:block; width:100%;
    }
    .fact-card{
      display:block; width:100%; background:var(--card);
      color:#f0f3ff; border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:12px 14px; line-height:1.35; font-size:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.35); margin:.4rem 0;
    }

    /* Grid of filters (mobile-first) */
    .grid{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;
      margin:10px 0 8px;
    }
    @media(min-width:520px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:var(--ink);color:#fff;border-radius:16px;padding:14px 12px;
      text-align:center;font-weight:600;box-shadow:var(--shadow);
      transition:transform .08s ease, background .15s ease;
    }
    .btn:active{ transform:scale(.98); background:#0f1624; }
    .btn.cta{ background:var(--cta); color:#fff; border:none; }

    /* Support button (steel) */
    .btn-steel{
      background:linear-gradient(145deg,var(--steel1),var(--steel2));
      border:1px solid #a4b0bc;color:#fff;
      box-shadow:inset 1px 1px 2px rgba(255,255,255,.25), 0 8px 18px rgba(0,0,0,.35);
    }

    /* Results modal (simple) */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:flex-end;justify-content:center;z-index:50;
      padding:0 0 env(safe-area-inset-bottom);
    }
    .modal.active{ display:flex; }
    .sheet{
      width:100%;max-width:980px;background:var(--ink);border-radius:20px 20px 0 0;
      box-shadow:var(--shadow);padding:12px 12px 16px;max-height:84vh;overflow:auto;
    }
    .sheet h3{ margin:6px 4px 10px;font:700 18px/1 'Poppins',sans-serif;color:#fff }
    .x{ float:right;border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer }

    /* Ghost Easter egg only on home */
    #ghost{
      position:fixed;left:10px;bottom:12px;opacity:.55;z-index:40;font-size:24px;display:block;
    }

    /* Sticky bottom bar */
    .bottom{
      position:fixed;left:0;right:0;bottom:0;background:var(--ink);padding:10px 12px;
      display:flex;gap:10px;z-index:30;box-shadow:0 -8px 18px rgba(0,0,0,.35);
    }
    .bottom .btn{flex:1}
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Local Explorer</h1>
      <div class="loc">
        <div class="city" id="cityLine">Locating‚Ä¶</div>
        <div class="coords" id="coordLine"></div>
        <span class="edit" id="editLocation">Enter location</span>
      </div>
    </header>

    <!-- Local facts (single-card mode) -->
    <section id="factWidget" class="">
      <div id="factHeader">
        <div id="factTitle">Local Info</div>
      </div>
      <div id="factCardsWrapper">
        <div class="fact-card">Fetching local facts‚Ä¶</div>
      </div>
    </section>

    <!-- Filters -->
    <section class="grid" id="filters">
      <button class="btn" data-cat="Food">üçΩÔ∏è Foodie Finds</button>
      <button class="btn" data-cat="Sights">üèõÔ∏è Iconic Sights</button>
      <button class="btn" data-cat="Night">üåô Night Out</button>
      <button class="btn" data-cat="Hidden">üíé Hidden Gems</button>
      <button class="btn" data-cat="Pet">üêæ Pet Friendly</button>
      <button class="btn" data-cat="Utilities">üõ†Ô∏è Utilities & Help</button>
    </section>

    <!-- Primary actions -->
    <section class="grid" style="grid-template-columns:repeat(1,1fr);">
      <button class="btn cta" id="surprise">ü§∑ Surprise Me!</button>
      <button class="btn btn-steel" id="donate">‚öì Donate</button>
    </section>

    <!-- Ghost Easter egg (hidden outside main) -->
    <div id="ghost">üëª</div>
  </div>

  <!-- Simple results modal (placeholder) -->
  <div class="modal" id="resultsModal" aria-hidden="true">
    <div class="sheet">
      <button class="x" id="closeResults">&times;</button>
      <h3 id="resultsTitle">Results</h3>
      <div id="resultsList"></div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottom">
    <button class="btn" id="myListBtn">üìã My List</button>
    <button class="btn" id="eventsBtn">üéüÔ∏è Local Events</button>
  </div>

<script>
/* ===== Keys (fallbacks if keys.js is missing) ===== */
const INLINE_MAPS_KEY = "AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY";
const INLINE_TM_KEY   = "XmzfrRHZilGDGfD63SmdamF288GZ3FxH";

/* ===== Globals ===== */
const $ = (id)=>document.getElementById(id);
let currentPosition = null;
let currentAddress  = "";
let currentState    = ""; // e.g., "FL"
let factInterval;        // (unused now but kept for safety)

/* ===== State-name map & State facts (seeded for FL) ===== */
const stateNames = { FL:"Florida" };
const stateFacts = {
  FL: [
    "Florida means ‚ÄúFeast of Flowers‚Äù in Spanish and welcomes ~1,000 new residents a day.",
    "Florida has 1,250+ golf courses and produces ~75% of U.S. oranges.",
    "Walt Disney World Resort is the world‚Äôs most-visited vacation resort.",
    "St. Augustine (1565) is the oldest continuously occupied European-established city in the continental U.S."
  ]
};
/* ===== General quirky travel trivia (fallback) ===== */
const quirkyFacts = [
  "Spending money on travel tends to make people happier than buying things.",
  "There‚Äôs a word for longing to travel: ‚Äòfernweh‚Äô (far-sickness).",
  "Some people have ‚Äòhodophobia‚Äô: a fear of traveling.",
  "The shortest commercial flight is under 2 minutes (Westray to Papa Westray, Scotland)."
];

/* ===== UI helpers ===== */
function setCityLine(city, state) {
  $("cityLine").textContent = city && state ? `${city}, ${state}` : (city || state || "Unknown");
}
function setCoordLine(lat, lng){
  $("coordLine").textContent = (lat && lng) ? `Lat ${lat.toFixed(4)}  |  Lng ${lng.toFixed(4)}` : "";
}
function setFactsMode(mode, stateAbbrev='') {
  const w = $("factWidget");
  const t = $("factTitle");
  if (!w || !t) return;
  if (mode === "local") {
    w.classList.remove("no-facts");
    t.textContent = "Local Info";
  } else if (mode === "state") {
    w.classList.add("no-facts");
    const name = stateNames[stateAbbrev] || stateAbbrev || "State";
    t.textContent = `${name} Facts`;
  } else {
    w.classList.add("no-facts");
    t.textContent = "Travel Trivia";
  }
}
function pickFirstGoodExtract(pages) {
  if (!pages) return "";
  const list = Array.isArray(pages) ? pages : Object.values(pages);
  for (const p of list) {
    const txt = (p.extract || "").replace(/\n+/g, " ").trim();
    if (txt.length >= 50) return txt;
  }
  return "";
}

/* ===== Facts: single-card reliable flow ===== */
async function fetchLocalFacts(pos) {
  clearInterval(factInterval); // ensure no timers
  const deck = $("factCardsWrapper");
  if (deck) deck.innerHTML = '<div class="fact-card">Fetching local facts‚Ä¶</div>';

  if (!pos || typeof pos.lat !== "number" || typeof pos.lng !== "number") {
    setFactsMode("trivia");
    if (deck) deck.innerHTML = '<div class="fact-card">Enter a location to see nearby facts.</div>';
    return;
  }

  try {
    const gsURL = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${pos.lat}%7C${pos.lng}&gsradius=10000&gslimit=10&format=json&origin=*`;
    const ctrl = new AbortController();
    const to = setTimeout(()=>ctrl.abort(), 6000);
    const gs = await fetch(gsURL,{signal:ctrl.signal}).then(r=>r.json()).catch(()=>null);
    clearTimeout(to);

    let extractText = "";
    if (gs && gs.query && gs.query.geosearch && gs.query.geosearch.length) {
      const pageids = gs.query.geosearch.slice(0,5).map(p=>p.pageid).join("|");
      const exURL = `https://en.wikipedia.org/w/api.php?action=query&pageids=${pageids}&prop=extracts&explaintext=1&exintro=1&exsentences=2&format=json&origin=*`;
      const ex = await fetch(exURL).then(r=>r.json()).catch(()=>null);
      if (ex && ex.query && ex.query.pages) {
        extractText = pickFirstGoodExtract(ex.query.pages);
      }
    }

    if (extractText) {
      setFactsMode("local");
      if (deck) deck.innerHTML = `<div class="fact-card">${extractText}</div>`;
      return;
    }

    // City failed ‚Üí try state
    if (currentState && stateFacts[currentState]?.length) {
      setFactsMode("state", currentState);
      const msg = `<div class="fact-card">No city facts found ‚Äî showing state fact:</div>`;
      const fact = `<div class="fact-card">${stateFacts[currentState][0]}</div>`;
      if (deck) deck.innerHTML = msg + fact;
      return;
    }

    // Fallback: travel trivia
    setFactsMode("trivia");
    const msg = `<div class="fact-card">No local facts found ‚Äî showing travel trivia:</div>`;
    const tip = `<div class="fact-card">${quirkyFacts[0] || "Explore freely and stay curious."}</div>`;
    if (deck) deck.innerHTML = msg + tip;

  } catch (e) {
    setFactsMode("trivia");
    if (deck) deck.innerHTML = `<div class="fact-card">Unable to fetch local facts right now.</div>`;
  }
}

/* ===== Geocoding ===== */
let maps; let geocoder;
function reverseGeocode(pos){
  if (!geocoder) geocoder = new maps.Geocoder();
  geocoder.geocode({location:{lat:pos.lat,lng:pos.lng}},(results,status)=>{
    if (status==="OK" && results[0]) {
      currentAddress = results[0].formatted_address;
      let city="", state="";
      const comps = results[0].address_components || [];
      comps.forEach(c=>{
        if (c.types.includes("locality")) city = c.long_name;
        if (c.types.includes("administrative_area_level_1")) state = c.short_name || c.long_name;
      });
      currentState = state || currentState;
      setCityLine(city || currentAddress, state);
      setCoordLine(pos.lat,pos.lng);
      fetchLocalFacts(pos);
    } else {
      setCityLine("Unknown","");
      setCoordLine(pos.lat,pos.lng);
      fetchLocalFacts(pos);
    }
  });
}
function geocodeAddress(address){
  if (!geocoder) geocoder = new maps.Geocoder();
  geocoder.geocode({address},(results,status)=>{
    if (status==="OK" && results[0]) {
      const loc = results[0].geometry.location;
      currentPosition = {lat:loc.lat(), lng:loc.lng()};
      currentAddress  = results[0].formatted_address;
      let city="",state="";
      (results[0].address_components||[]).forEach(c=>{
        if (c.types.includes("locality")) city = c.long_name;
        if (c.types.includes("administrative_area_level_1")) state = c.short_name || c.long_name;
      });
      currentState = state || currentState;
      setCityLine(city || currentAddress,state);
      setCoordLine(currentPosition.lat,currentPosition.lng);
      fetchLocalFacts(currentPosition);
    } else {
      $("cityLine").textContent = "Search failed";
      $("coordLine").textContent = "";
      fetchLocalFacts(null);
    }
  });
}

/* ===== Init & Maps loader ===== */
function initMap(){
  // nothing to render immediately; we mainly need geocoder & facts
  maps = google.maps;
  geocoder = new maps.Geocoder();

  // try geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        currentPosition = {lat:pos.coords.latitude, lng:pos.coords.longitude};
        reverseGeocode(currentPosition);
      },
      (_)=>{
        $("cityLine").textContent = "Enter a location";
        $("coordLine").textContent = "";
        fetchLocalFacts(null);
      },
      {enableHighAccuracy:true,timeout:8000,maximumAge:0}
    );
  } else {
    $("cityLine").textContent = "Enter a location";
    $("coordLine").textContent = "";
    fetchLocalFacts(null);
  }
}

/* Load Maps JS with key from keys.js or inline fallback */
(function loadMaps(){
  const key = (window.MAPS_API_KEY || INLINE_MAPS_KEY || "").trim();
  const s = document.createElement("script");
  s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places,geometry&callback=initMap`;
  s.async = true; s.defer = true;
  document.head.appendChild(s);
})();

/* ===== Simple UI wiring ===== */
$("editLocation").addEventListener("click",()=>{
  const addr = prompt("Enter a city or address:");
  if (addr && addr.trim()) geocodeAddress(addr.trim());
});
$("surprise").addEventListener("click",()=>{
  alert("Surprise Me! (hook your Places search here)");
});
$("donate").addEventListener("click",()=>{
  // Open a simple donate info; replace with your Venmo modal if desired
  const handle = "@Stephen-Mohamed-1";
  navigator.clipboard?.writeText(handle);
  alert(`Venmo handle copied: ${handle}`);
});

/* Basic modal controls (placeholder) */
$("closeResults").addEventListener("click",()=>{
  $("resultsModal").classList.remove("active");
});
</script>
</body>
</html>
