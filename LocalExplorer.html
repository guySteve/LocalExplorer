<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Local Explorer</title>
  <link rel="stylesheet" href="style.css">
  <script src="keys.js"></script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=" +
    window.MAPS_API_KEY + "&libraries=places"></script>
</head>
<body>
  <header>
    <h1>Local Explorer</h1>
    <p id="location-info"></p>
  </header>

  <main>
    <div id="filter-container" class="filters">
      <button class="filter" data-type="food">Food</button>
      <button class="filter" data-type="ghost">Ghosts</button>
      <button class="filter" data-type="events">Events</button>
      <button class="filter" data-type="outdoors">Outdoors</button>
      <button id="surprise-me">Surprise Me</button>
    </div>

    <section id="facts">
      <h2>Local Facts</h2>
      <p id="fact-text">Loading fact...</p>
    </section>

    <section id="results-list-screen" class="hidden">
      <button id="close-results">Close</button>
      <ul id="results-list"></ul>
    </section>

    <section id="compass-screen" class="hidden">
      <button id="close-compass">Ã—</button>
      <canvas id="radar"></canvas>
      <div id="voice-directions"></div>
    </section>
  </main>

  <footer>
    <button id="ghost-btn">ðŸ‘»</button>
    <button id="my-list-btn">My List</button>
    <button id="my-plan-btn">My Plan</button>
  </footer>

  <script>
  const MAPS_API_KEY = window.MAPS_API_KEY;
  const TICKETMASTER_API_KEY = window.TICKETMASTER_API_KEY;
  let map, service;

  document.addEventListener("DOMContentLoaded", () => {
    initApp();
  });

  function initApp() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        document.getElementById("location-info").textContent =
          `Lat: ${loc.lat.toFixed(3)} | Lng: ${loc.lng.toFixed(3)}`;
        loadMap(loc);
        fetchLocalFact(loc);
      });
    }
    setupFilters();
  }

  function loadMap(location) {
    map = new google.maps.Map(document.createElement("div"), {
      center: location, zoom: 14
    });
    service = new google.maps.places.PlacesService(map);
  }

  function setupFilters() {
    document.querySelectorAll(".filter").forEach(btn => {
      btn.addEventListener("click", () => searchPlaces(btn.dataset.type));
    });
    document.getElementById("surprise-me").onclick = () => randomPlace();
    document.getElementById("close-results").onclick = () => hideResults();
  }

  function searchPlaces(type) {
    const req = {location: map.getCenter(), radius: 3000, keyword: type};
    service.nearbySearch(req, (res, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        showResults(res);
      } else {
        alert("No results found");
      }
    });
  }

  function showResults(results) {
    const list = document.getElementById("results-list");
    list.innerHTML = "";
    results.forEach(p => {
      const li = document.createElement("li");
      li.textContent = p.name;
      list.appendChild(li);
    });
    document.getElementById("results-list-screen").classList.remove("hidden");
  }

  function hideResults() {
    document.getElementById("results-list-screen").classList.add("hidden");
  }

  function randomPlace() {
    const types = ["restaurant","park","museum","cafe"];
    searchPlaces(types[Math.floor(Math.random()*types.length)]);
  }

  function fetchLocalFact(loc) {
    fetch(`https://api.wikimedia.org/feed/v1/wikipedia/en/featured/${new Date().getFullYear()}/${new Date().getMonth()+1}/${new Date().getDate()}`)
      .then(r=>r.json())
      .then(d=>{
        document.getElementById("fact-text").textContent =
          d.tfa && d.tfa.extract ? d.tfa.extract : "No local fact found.";
      })
      .catch(()=>{
        document.getElementById("fact-text").textContent =
          "No fact available right now.";
      });
  }
  </script>
</body>
</html>
