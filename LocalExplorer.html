<!--
  Local Explorer Progressive Web App

  This single‚Äëfile application helps users discover interesting, highly‚Äërated or
  essential places near their current location. It leverages the Geolocation
  API to determine the user's location and Google Maps services for reverse
  geocoding and nearby searches. When the user grants permission, the app
  reverse geocodes the current coordinates into a human‚Äëreadable address and
  immediately enables category filters. If permission is denied or the device
  cannot provide location data, a manual search field is displayed so the
  traveller can type in a desired location. According to MDN, calls to
  `navigator.geolocation` trigger a prompt asking for permission, and if
  accepted the browser uses the best available capabilities (GPS, Wi‚ÄëFi
  positioning, etc.) to acquire coordinates„Äê880464987856886‚Ä†L189-L216„Äë. Reverse
  geocoding translates latitude/longitude into a formatted address
  „Äê646577427574699‚Ä†L259-L263„Äë. Results are cached by the service worker so
  that repeat visits work offline„Äê511078079400536‚Ä†L226-L241„Äë. A service worker
  runs in its own thread and intercepts network requests, returning cached
  responses when possible„Äê511078079400536‚Ä†L226-L241„Äë. Favourites are stored
  using `localStorage`, which persists key/value pairs across browser sessions
  for the same origin„Äê604651977893355‚Ä†L193-L204„Äë.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Explorer</title>
  <!-- Link the manifest file for PWA installation -->
  <link rel="manifest" href="manifest.json">
  <!-- App icons for browsers and OS shortcuts -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <!-- Theme color for mobile address bar -->
  <meta name="theme-color" content="#f8f7f2">
  <!-- Include Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Modern rugged naval explorer palette */
      --background: #f5f5f2; /* off‚Äëwhite */
      --card: #061f3e;      /* deep navy blue reminiscent of naval uniforms */
      --primary: #e95420;   /* bright orange accent for call‚Äëto‚Äëactions */
      --secondary: #0a324a; /* dark teal for secondary highlights */
      --text-dark: #061f3e;
      --text-light: #ffffff;
      --accent: #b38a5e;    /* rope‚Äëtan accent colour */
      --radius: 12px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Raleway', sans-serif;
      background-color: var(--background);
      color: var(--text-dark);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: contain; /* Prevent scroll bounce on mobile */
    }
    h1, h2, h3 {
      font-family: 'Poppins', sans-serif;
      margin: 0;
    }
    h1 {
      font-size: 1.8rem;
      color: var(--card);
      text-align: center;
      padding: 1rem 0;
      letter-spacing: 0.05rem;
      text-transform: uppercase;
      font-weight: 700;
      border-bottom: 3px solid var(--accent);
    }
    #locationDisplay {
      text-align: center;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      color: var(--card);
      font-weight: 500;
      letter-spacing: 0.02rem;
    }
    #manualInputContainer {
      display: none;
      margin: 0.5rem auto;
      max-width: 90%;
    }
    #manualInputContainer input {
      width: 100%;
      padding: 0.6rem;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      font-size: 1rem;
      background-color: var(--background);
      color: var(--card);
      outline: none;
    }
    #factWidget {
      background-color: var(--secondary);
      color: var(--text-light);
      margin: 0.5rem auto;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      max-width: 90%;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.95rem;
      border: 2px dashed var(--accent);
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      max-width: 90%;
      margin: 1rem auto;
    }
    .filter-btn {
      background-color: var(--card);
      color: var(--text-light);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: transform 0.1s ease, background-color 0.2s ease;
    }
    .filter-btn:active {
      transform: scale(0.96);
      background-color: var(--secondary);
    }
    #primaryActions {
      max-width: 90%;
      margin: 1rem auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    #myListBtn, #surpriseBtn {
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      padding: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    #myListBtn {
      background-color: var(--secondary);
      color: var(--text-light);
      border: 1px solid var(--accent);
    }
    #surpriseBtn {
      background-color: var(--primary);
      color: var(--text-light);
      font-weight: 600;
      border: 1px solid var(--primary);
    }
    #ghostBtn {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: transparent;
      border: none;
      font-size: 2.2rem;
      opacity: 0.4;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.3s;
      z-index: 30;
    }
    #ghostBtn:hover {
      opacity: 1;
      transform: rotate(5deg);
    }
    /* Modal overlay */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal.active {
      display: flex;
      /* Blur underlying content for focus */
      backdrop-filter: blur(2px);
    }

    /* When a modal is open, prevent scrolling on body */
    body.modal-open {
      overflow: hidden;
    }
    .modal-content {
      background-color: var(--background);
      border-radius: var(--radius);
      max-height: 80vh;
      overflow-y: auto;
      width: 92%;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      padding: 1rem;
      position: relative;
      border: 2px solid var(--accent);
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
    }

    /* Animate modal content expansion */
    .modal.active .modal-content {
      transform: scale(1) translateY(0);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--card);
      padding: 0.2rem;
    }
    .subMenuList button,
    .results-list button {
      width: 100%;
      background: var(--card);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .subMenuList button:hover,
    .results-list button:hover {
      background: #1e293b;
    }
    .results-item {
      display: flex;
      gap: 0.75rem;
    }
    .results-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--radius);
      flex-shrink: 0;
    }
    .results-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .results-info h4 {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: var(--text-light);
      letter-spacing: 0.03rem;
    }
    .results-info .rating {
      font-size: 0.8rem;
      color: #fbbf24;
    }
    /* Details sheet */
    #detailsSheet {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 70vh;
      background-color: var(--card);
      color: var(--text-light);
      border-radius: 20px 20px 0 0;
      transform: translateY(100%);
      transition: transform 0.35s ease;
      z-index: 25;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Details sheet close button */
    .sheet-close {
      position: absolute;
      top: 0.3rem;
      right: 0.5rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-light);
      cursor: pointer;
    }
    #detailsSheet.active {
      transform: translateY(0);
    }
    #detailsMap {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 40%;
      background: #000;
    }
    #detailsContent {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60%;
      overflow-y: auto;
      padding: 1rem;
      background: rgba(17,24,39,0.95);
      backdrop-filter: blur(4px);
    }
    #detailsContent h3 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    #detailsContent .stars {
      color: #fbbf24;
      font-size: 1.1rem;
      margin-right: 0.5rem;
    }
    #detailsContent .price {
      color: #fbbf24;
      font-size: 1.1rem;
    }
    #detailsActions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    #detailsActions button {
      flex: 1;
      min-width: 100px;
      border: none;
      border-radius: var(--radius);
      padding: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.3rem;
    }
    #saveBtn {
      background: #4b5563;
      color: var(--text-light);
    }
    #openMapsBtn, #websiteBtn {
      background: #334155;
      color: var(--text-light);
    }
    #shareBtn {
      background: var(--primary);
      color: var(--text-light);
    }
    #compassBtn {
      background: #0f172a;
      color: var(--text-light);
    }
    /* Accordion */
    .accordion {
      background: #1e293b;
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem;
      width: 100%;
      text-align: left;
      outline: none;
      cursor: pointer;
      margin-top: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-content {
      background: #1e293b;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 0 0.5rem;
    }
    .accordion.active + .accordion-content {
      max-height: 300px;
      padding: 0.5rem;
    }
    /* My List modal */
    #myListModal .results-list button {
      background: var(--card);
    }
    #myListModal .empty-state {
      text-align: center;
      color: var(--card);
      font-size: 0.9rem;
      margin: 1rem 0;
    }
    /* Compass & navigation overlay */
    #compassOverlay {
      position: fixed;
      bottom: 0.5rem;
      right: 0.5rem;
      transform: translateY(100%);
      width: 300px;
      max-width: 90%;
      background: var(--card);
      color: var(--text-light);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 40;
      transition: transform 0.4s ease;
      overflow: hidden;
    }
    #compassOverlay.active {
      transform: translateY(0);
    }
    #compassTop {
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    #compassArrow {
      width: 0;
      height: 0;
      border-top: 45px solid var(--primary);
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      transform-origin: center bottom;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(0deg);
    }
    /* Radar scanning container */
    #radar {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: radial-gradient(circle at center, rgba(233,84,32,0.4) 0%, transparent 70%);
      border: 2px solid var(--primary);
      overflow: hidden;
    }
    #radar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      width: 100%;
      height: 100%;
      transform-origin: left center;
      background: linear-gradient(to right, transparent, var(--primary) 20%, transparent 40%);
      animation: radarSweep 3s linear infinite;
    }
    @keyframes radarSweep {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    #compassControls {
      padding: 0.5rem 1rem 1rem 1rem;
      border-top: 1px solid var(--secondary);
      background-color: var(--secondary);
    }
    #voiceSelect {
      width: 100%;
      padding: 0.4rem;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      margin-bottom: 0.5rem;
      background-color: var(--card);
      color: var(--text-light);
    }
    #navigationButtons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    #navigationButtons button {
      flex: 1;
      padding: 0.4rem;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      background-color: var(--card);
      color: var(--text-light);
      cursor: pointer;
    }
    #navigationButtons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #directionsList {
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.3;
    }
    /* Hide map container used for Places Service */
    #hiddenMap {
      position: absolute;
      top: 0;
      left: 0;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    /* Responsive adjustments */
    @media (min-width: 768px) {
      h1 { font-size: 2rem; }
      #detailsSheet {
        height: 60vh;
      }
      #detailsMap { height: 45%; }
      #detailsContent { height: 55%; }
    }
  </style>
</head>
<body>
  <h1>Local Explorer</h1>
  <div id="locationDisplay">Determining your location‚Ä¶</div>
  <div id="manualInputContainer">
    <input type="text" id="manualInput" placeholder="Enter a location">
  </div>
  <div id="factWidget">Fetching local facts‚Ä¶</div>
  <div class="filters" id="filterGrid">
    <!-- Buttons populated by JS -->
  </div>
  <div id="primaryActions">
    <button id="myListBtn">üìã My List</button>
    <button id="surpriseBtn">ü§∑ Surprise Me!</button>
  </div>
  <button id="ghostBtn">üëª</button>

  <!-- Hidden map for PlacesService and Geocoder -->
  <div id="hiddenMap"></div>

  <!-- Sub‚Äëmenu modal -->
  <div id="subMenuModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="subMenuTitle">Categories</h3>
        <button class="close-btn" id="closeSubMenu">√ó</button>
      </div>
      <div class="subMenuList" id="subMenuList"></div>
    </div>
  </div>

  <!-- Results modal -->
  <div id="resultsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="resultsTitle">Results</h3>
        <button class="close-btn" id="closeResults">√ó</button>
      </div>
      <div class="results-list" id="resultsList"></div>
    </div>
  </div>

  <!-- My List modal -->
  <div id="myListModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>My List</h3>
        <button class="close-btn" id="closeMyList">√ó</button>
      </div>
      <div class="results-list" id="myListContent"></div>
      <div class="empty-state" id="myListEmpty" style="display:none;">Your saved places will appear here.</div>
    </div>
  </div>

  <!-- Details sheet -->
  <div id="detailsSheet">
    <div id="detailsMap"></div>
    <div id="detailsContent">
      <button id="closeDetailsBtn" class="sheet-close">√ó</button>
      <h3 id="detailsName"></h3>
      <div id="detailsRating"></div>
      <div id="detailsPhone"></div>
      <div id="detailsAddress"></div>
      <div id="detailsPrice"></div>
      <div id="detailsActions">
        <button id="saveBtn">‚òÜ Save</button>
        <button id="openMapsBtn">üìç Open in Maps</button>
        <button id="websiteBtn">üîó Website</button>
        <button id="shareBtn">üîó Share</button>
        <button id="compassBtn">üß≠ Compass</button>
      </div>
      <button class="accordion" id="reviewsAccordion">Reviews</button>
      <div class="accordion-content" id="reviewsContent"></div>
      <button class="accordion" id="hoursAccordion">Weekly Hours</button>
      <div class="accordion-content" id="hoursContent"></div>
    </div>
  </div>

  <!-- Compass & navigation overlay -->
  <div id="compassOverlay">
    <div id="compassTop">
      <div id="radar">
        <div id="compassArrow"></div>
      </div>
    </div>
    <div id="compassControls">
      <select id="voiceSelect"></select>
      <div id="navigationButtons">
        <button id="startNavigationBtn">Start</button>
        <button id="stopNavigationBtn" disabled>Stop</button>
        <button id="closeCompassBtn">Close</button>
      </div>
      <div id="directionsList"></div>
    </div>
  </div>

  <!-- Google Maps script (API key placeholder) -->
  <!-- Include callback to initMap so the app initializes once the API loads -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places,geometry&callback=initMap"></script>
  <script>
    // Utility functions
    function $(id) { return document.getElementById(id); }

    // Store state
    let currentPosition = null;
    let currentAddress = '';
    let map, placesService, geocoder, streetViewPanorama;
    let currentResults = [];
    let factInterval;
    let currentPlaceDetails;
    let compassWatching = false;
    let compassWatchId;

    // Categories definition
    const categories = {
      "Foodie Finds": [
        { name: "Italian", keyword: "italian restaurant", type: "restaurant" },
        { name: "Pizza", keyword: "pizza", type: "restaurant" },
        { name: "Cafes", keyword: "cafe", type: "cafe" },
        { name: "Bakeries", keyword: "bakery", type: "bakery" },
        { name: "Sushi", keyword: "sushi", type: "restaurant" }
      ],
      "Iconic Sights": [
        { name: "Tourist Attractions", type: "tourist_attraction" },
        { name: "Museums", type: "museum" },
        { name: "Art Galleries", type: "art_gallery" },
        { name: "Parks", type: "park" },
        { name: "Landmarks", keyword: "landmark", type: "point_of_interest" }
      ],
      "Night Out": [
        { name: "Bars", type: "bar" },
        { name: "Night Clubs", type: "night_club" },
        { name: "Movie Theaters", type: "movie_theater" },
        { name: "Bowling Alleys", type: "bowling_alley" },
        { name: "Concert Venues", keyword: "concert", type: "point_of_interest" }
      ],
      "Hidden Gems": [
        { name: "Libraries", type: "library" },
        { name: "Book Stores", type: "book_store" },
        { name: "Gardens", keyword: "garden", type: "park" },
        { name: "Historical Sites", keyword: "historical site", type: "point_of_interest" },
        { name: "Local Favorites", keyword: "local favorite", type: "point_of_interest" }
      ],
      "Pet Friendly": [
        { name: "Dog Parks", keyword: "dog park", type: "park" },
        { name: "Pet Stores", type: "pet_store" },
        { name: "Veterinary Care", type: "veterinary_care" },
        { name: "Pet Friendly Cafes", keyword: "pet friendly cafe", type: "cafe" },
        { name: "Pet Friendly Hotels", keyword: "pet friendly hotel", type: "lodging" }
      ],
      "Utilities & Help": [
        { name: "Hospitals", type: "hospital", ignoreRating: true },
        { name: "Pharmacies", type: "pharmacy", ignoreRating: true },
        { name: "Police", type: "police", ignoreRating: true },
        { name: "Gas Stations", type: "gas_station", ignoreRating: true },
        { name: "ATMs", type: "atm", ignoreRating: true }
      ],
      "Dark Side": [
        { name: "Cemeteries", type: "cemetery", ignoreRating: true },
        { name: "Funeral Homes", type: "funeral_home", ignoreRating: true },
        { name: "Psychic", keyword: "psychic", type: "point_of_interest", ignoreRating: true },
        { name: "Bars", type: "bar", ignoreRating: true },
        { name: "Haunted Places", keyword: "haunted", type: "point_of_interest", ignoreRating: true }
      ]
    };

    // Initialize the app after Google script loads
    function initApp() {
      map = new google.maps.Map($("hiddenMap"), { center: { lat: 0, lng: 0 }, zoom: 15 });
      placesService = new google.maps.places.PlacesService(map);
      geocoder = new google.maps.Geocoder();
      // Attempt geolocation
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError);
      } else {
        showManualInput();
      }
      populateFilterButtons();
    }

    function onLocationSuccess(position) {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      // Reverse geocode to get address
      reverseGeocode(currentPosition);
      // Fetch local facts
      fetchLocalFacts(currentPosition);
    }

    function onLocationError(err) {
      console.warn('Geolocation failed', err);
      $("locationDisplay").textContent = "Enter a location to begin";
      showManualInput();
    }

    function showManualInput() {
      $("manualInputContainer").style.display = 'block';
      const input = $("manualInput");
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const addr = input.value.trim();
          if (addr) {
            geocodeAddress(addr);
          }
        }
      });
    }

    function geocodeAddress(address) {
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          currentPosition = {
            lat: results[0].geometry.location.lat(),
            lng: results[0].geometry.location.lng()
          };
          currentAddress = results[0].formatted_address;
          $("locationDisplay").textContent = currentAddress;
          fetchLocalFacts(currentPosition);
        } else {
          alert('Location not found. Please try again.');
        }
      });
    }

    function reverseGeocode(pos) {
      geocoder.geocode({ location: pos }, (results, status) => {
        if (status === 'OK' && results[0]) {
          currentAddress = results[0].formatted_address;
          $("locationDisplay").textContent = currentAddress;
        } else {
          $("locationDisplay").textContent = `Lat: ${pos.lat.toFixed(4)}, Lng: ${pos.lng.toFixed(4)}`;
        }
      });
    }

    function populateFilterButtons() {
      const grid = $("filterGrid");
      grid.innerHTML = '';
      Object.keys(categories).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.innerHTML = `${getIconForCategory(cat)} ${cat}`;
        btn.addEventListener('click', () => openSubMenu(cat));
        grid.appendChild(btn);
      });
    }

    function getIconForCategory(cat) {
      switch (cat) {
        case 'Foodie Finds': return 'üçΩÔ∏è';
        case 'Iconic Sights': return 'üèõÔ∏è';
        case 'Night Out': return 'üåô';
        case 'Hidden Gems': return 'üíé';
        case 'Pet Friendly': return 'üêæ';
        case 'Utilities & Help': return 'üõ†Ô∏è';
        case 'Dark Side': return 'üëª';
        default: return '';
      }
    }

    // Sub menu handling
    function openSubMenu(categoryName) {
      $("subMenuTitle").textContent = categoryName;
      const list = $("subMenuList");
      list.innerHTML = '';
      const items = categories[categoryName];
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item.name;
        btn.addEventListener('click', () => {
          closeSubMenu();
          performSearch(categoryName, item);
        });
        list.appendChild(btn);
      });
      $("subMenuModal").classList.add('active');
      document.body.classList.add('modal-open');
    }

    function closeSubMenu() {
      $("subMenuModal").classList.remove('active');
      document.body.classList.remove('modal-open');
    }
    $("closeSubMenu").addEventListener('click', closeSubMenu);

    // Results handling
    function performSearch(category, item) {
      if (!currentPosition) {
        alert('Please provide a location first.');
        return;
      }
      const request = {
        location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
        radius: 7000,
        type: item.type || undefined,
        keyword: item.keyword || undefined,
        rankBy: google.maps.places.RankBy.PROMINENCE
      };
      // Use nearbySearch for relevant results
      placesService.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          // Filter by rating if needed
          let filtered = results;
          if (!item.ignoreRating) {
            filtered = results.filter(p => p.rating && p.rating >= 4.2 && p.user_ratings_total && p.user_ratings_total >= 20);
          }
          // Sort by rating then number of reviews
          filtered.sort((a,b) => {
            const rDiff = (b.rating || 0) - (a.rating || 0);
            if (rDiff !== 0) return rDiff;
            return (b.user_ratings_total || 0) - (a.user_ratings_total || 0);
          });
          currentResults = filtered;
          displayResults(category, filtered);
        } else {
          alert('No results found.');
        }
      });
    }

    function displayResults(category, results) {
      $("resultsTitle").textContent = `${category} Results`;
      const list = $("resultsList");
      list.innerHTML = '';
      results.forEach(place => {
        const btn = document.createElement('button');
        btn.addEventListener('click', () => showDetails(place.place_id));
        const wrapper = document.createElement('div');
        wrapper.className = 'results-item';
        // Photo
        const img = document.createElement('img');
        if (place.photos && place.photos.length > 0) {
          img.src = place.photos[0].getUrl({ maxWidth: 80, maxHeight: 80 });
        } else {
          img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
        }
        wrapper.appendChild(img);
        // Info
        const info = document.createElement('div');
        info.className = 'results-info';
        const title = document.createElement('h4');
        title.textContent = place.name;
        info.appendChild(title);
        const rating = document.createElement('span');
        rating.className = 'rating';
        if (place.rating) {
          rating.textContent = `‚òÖ${place.rating.toFixed(1)} (${place.user_ratings_total})`;
        } else {
          rating.textContent = 'No rating';
        }
        info.appendChild(rating);
        wrapper.appendChild(info);
        btn.appendChild(wrapper);
        list.appendChild(btn);
      });
      $("resultsModal").classList.add('active');
      document.body.classList.add('modal-open');
    }
    $("closeResults").addEventListener('click', () => {
      $("resultsModal").classList.remove('active');
      document.body.classList.remove('modal-open');
    });

    // Allow closing the results modal by tapping outside its content
    $("resultsModal").addEventListener('click', (e) => {
      if (e.target.id === 'resultsModal') {
        $("resultsModal").classList.remove('active');
        document.body.classList.remove('modal-open');
      }
    });

    // Surprise Me search
    $("surpriseBtn").addEventListener('click', () => {
      if (!currentPosition) {
        alert('Please allow geolocation or search for a location first.');
        return;
      }
      const request = {
        location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
        radius: 8000,
        rankBy: google.maps.places.RankBy.PROMINENCE,
        type: ['tourist_attraction', 'point_of_interest']
      };
      placesService.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          const good = results.filter(p => p.rating && p.rating >= 4.5 && p.user_ratings_total >= 50);
          if (good.length > 0) {
            const randomPlace = good[Math.floor(Math.random() * good.length)];
            showDetails(randomPlace.place_id);
          } else {
            alert('No high‚Äëquality places found nearby.');
          }
        } else {
          alert('No results found.');
        }
      });
    });

    // Dark side Easter egg opens the Dark Side category menu
    $("ghostBtn").addEventListener('click', () => {
      openSubMenu('Dark Side');
    });

    // Results details view
    function showDetails(placeId) {
      placesService.getDetails({ placeId: placeId, fields: ['name','formatted_address','formatted_phone_number','rating','reviews','photos','price_level','geometry','website','url','opening_hours','place_id'] }, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          currentPlaceDetails = place;
          // Set Street View panorama with best available imagery
          const loc = place.geometry.location;
          const streetService = new google.maps.StreetViewService();
          streetService.getPanorama({ location: loc, radius: 50 }, (data, status) => {
            if (status === google.maps.StreetViewStatus.OK && data && data.location) {
              if (!streetViewPanorama) {
                streetViewPanorama = new google.maps.StreetViewPanorama($("detailsMap"), {
                  pano: data.location.pano,
                  pov: { heading: 270, pitch: 0 },
                  zoom: 1
                });
              } else {
                streetViewPanorama.setPano(data.location.pano);
                streetViewPanorama.setPov({ heading: 270, pitch: 0 });
                streetViewPanorama.setZoom(1);
              }
            } else {
              // Fallback: position street view at place location
              if (!streetViewPanorama) {
                streetViewPanorama = new google.maps.StreetViewPanorama($("detailsMap"), {
                  position: loc,
                  pov: { heading: 0, pitch: 0 },
                  zoom: 0
                });
              } else {
                streetViewPanorama.setPosition(loc);
              }
            }
          });
          // Name
          $("detailsName").textContent = place.name;
          // Rating and price
          let starStr = '';
          if (place.rating) {
            const full = Math.floor(place.rating);
            const half = (place.rating - full) >= 0.5;
            starStr = '‚òÖ'.repeat(full) + (half ? '¬Ω' : '') + ` (${place.rating.toFixed(1)})`;
          }
          $("detailsRating").textContent = starStr;
          $("detailsPrice").textContent = place.price_level ? '$'.repeat(place.price_level) : '';
          $("detailsPhone").textContent = place.formatted_phone_number || '';
          $("detailsAddress").textContent = place.formatted_address || '';
          // Save button state
          updateSaveButtonState(place.place_id);
          // Reviews
          populateReviews(place.reviews || []);
          // Hours
          populateHours(place.opening_hours);
          // Actions
          $("openMapsBtn").onclick = () => {
            window.open(place.url || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}`);
          };
          $("websiteBtn").style.display = place.website ? 'inline-flex' : 'none';
          $("websiteBtn").onclick = () => {
            if (place.website) window.open(place.website);
          };
          $("shareBtn").onclick = () => {
            if (navigator.share) {
              navigator.share({ title: place.name, text: place.formatted_address, url: place.url || window.location.href }).catch(err => console.log(err));
            } else {
              alert('Sharing not supported on this device.');
            }
          };
          $("compassBtn").onclick = () => openCompass(loc);
          // Show sheet and lock background scroll
          $("detailsSheet").classList.add('active');
          document.body.classList.add('modal-open');
        }
      });
    }

    // Close details sheet helper
    function closeDetails() {
      $("detailsSheet").classList.remove('active');
      document.body.classList.remove('modal-open');
    }

    // Tap outside details content closes sheet
    $("detailsSheet").addEventListener('click', function(e) {
      // When clicking on sheet background (not the content overlay)
      if (e.target.id === 'detailsSheet') {
        closeDetails();
      }
    });

    // Close button inside details sheet
    $("closeDetailsBtn").addEventListener('click', () => {
      closeDetails();
    });

    // Populate reviews accordion
    function populateReviews(reviews) {
      const reviewsContent = $("reviewsContent");
      reviewsContent.innerHTML = '';
      if (!reviews || reviews.length === 0) {
        reviewsContent.innerHTML = '<p>No reviews available.</p>';
      } else {
        reviews.slice(0,5).forEach(r => {
          const p = document.createElement('p');
          p.style.marginBottom = '0.5rem';
          p.textContent = `"${r.text}" ‚Äî ${r.author_name}`;
          reviewsContent.appendChild(p);
        });
      }
    }
    // Populate hours accordion
    function populateHours(hours) {
      const hoursContent = $("hoursContent");
      hoursContent.innerHTML = '';
      if (!hours || !hours.weekday_text) {
        hoursContent.innerHTML = '<p>No hours available.</p>';
      } else {
        hours.weekday_text.forEach(l => {
          const p = document.createElement('p');
          p.textContent = l;
          hoursContent.appendChild(p);
        });
      }
    }
    // Accordion toggling
    function setupAccordions() {
      document.querySelectorAll('.accordion').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
          const content = btn.nextElementSibling;
          if (btn.classList.contains('active')) {
            content.style.maxHeight = content.scrollHeight + 'px';
          } else {
            content.style.maxHeight = null;
          }
        });
      });
    }

    // Save functionality using localStorage
    function getSavedList() {
      try {
        const data = localStorage.getItem('myPlaces');
        return data ? JSON.parse(data) : [];
      } catch (e) {
        return [];
      }
    }
    function savePlace(place) {
      let list = getSavedList();
      if (!list.find(p => p.place_id === place.place_id)) {
        // Limit stored places to 50 to avoid unbounded localStorage growth
        if (list.length >= 50) {
          list.shift();
        }
        list.push({
          place_id: place.place_id,
          name: place.name,
          address: place.formatted_address,
          rating: place.rating,
          url: place.url,
          photo: (place.photos && place.photos.length > 0) ? place.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 }) : null
        });
        localStorage.setItem('myPlaces', JSON.stringify(list));
      }
    }
    function removePlace(placeId) {
      let list = getSavedList();
      list = list.filter(p => p.place_id !== placeId);
      localStorage.setItem('myPlaces', JSON.stringify(list));
    }
    function updateSaveButtonState(placeId) {
      const list = getSavedList();
      const saved = list.some(p => p.place_id === placeId);
      $("saveBtn").textContent = saved ? '‚òÖ Saved' : '‚òÜ Save';
      $("saveBtn").onclick = () => {
        if (list.some(p => p.place_id === placeId)) {
          removePlace(placeId);
          $("saveBtn").textContent = '‚òÜ Save';
        } else {
          savePlace(currentPlaceDetails);
          $("saveBtn").textContent = '‚òÖ Saved';
        }
        loadMyList();
      };
    }

    // My List modal
    $("myListBtn").addEventListener('click', () => {
      loadMyList();
      $("myListModal").classList.add('active');
      document.body.classList.add('modal-open');
    });
    $("closeMyList").addEventListener('click', () => {
      $("myListModal").classList.remove('active');
      document.body.classList.remove('modal-open');
    });
    function loadMyList() {
      const list = getSavedList();
      const content = $("myListContent");
      const empty = $("myListEmpty");
      content.innerHTML = '';
      if (list.length === 0) {
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        list.forEach(item => {
          const btn = document.createElement('button');
          btn.addEventListener('click', () => showDetails(item.place_id));
          const wrapper = document.createElement('div');
          wrapper.className = 'results-item';
          const img = document.createElement('img');
          img.src = item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABt0lEQVR4Xu3bMU7DMAwG4Ay0BfwEdwOVyUBua6mTZEiuCCgU3hRd9xLax/vBLpqMbMLm3NHfv98bOw8DSBt3XE3MggDBljpA9Z33b+4CrzcFhVaCvA2e40D3QC4AgAmsr0MJfsuQAQEkDAACqzAUAIkEACyAKCEvNeigRN28p4EMDvUbWadND1U5sAIAJrMAdblXUg9wM4RZ2Pmdx9nYHv4gGIZAIDYD4gcQVAPqMcy7zXENr8U1WZ2zLvLXQm7YRMTgAQEAAAggxUwDQAGpAQNlxuqtXu3rbWw9weTgZ2VSPMR2pAQBIYh+gTn7IC0/nRSmDKaAFv/MxPAAAFQAGhUVL7S8b14ssoctKj/ncoPwwAICjS5tNvp0XLFaaK7ebHpQLNld4e2G9rY7aqGIb21vfgDBeCQAcIh4IgBwHbyOT7GyvN0aVaCuDXIl08WJWuZkcEzgSAIAPYldB8h8m7iRe98QjM85EJKiAdzdGOABAAAsZ4QAdyXmF+gQAdIWZ/j/t/v0y1mVldndWiZ6+ARIFfA2CXI8NwBAgZK3+1S1C7uPdhgGdzPAhgO9jUwEAAPZqSyvYf8DcnMt5XvNOtHJn2uf4H8vWlMbGv8cgwAAAAASUVORK5CYII=';
          wrapper.appendChild(img);
          const info = document.createElement('div');
          info.className = 'results-info';
          const title = document.createElement('h4');
          title.textContent = item.name;
          info.appendChild(title);
          const rating = document.createElement('span');
          rating.className = 'rating';
          rating.textContent = item.rating ? `‚òÖ${item.rating.toFixed(1)}` : '';
          info.appendChild(rating);
          wrapper.appendChild(info);
          btn.appendChild(wrapper);
          // Delete icon
          const delSpan = document.createElement('span');
          delSpan.textContent = 'üóëÔ∏è';
          btn.appendChild(delSpan);
          btn.style.justifyContent = 'space-between';
          btn.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            removePlace(item.place_id);
            loadMyList();
          });
          content.appendChild(btn);
        });
      }
    }

    // Update details sheet close click to use closeDetails()
    $("detailsSheet").addEventListener('click', (e) => {
      if (e.target === $("detailsSheet")) {
        closeDetails();
      }
    });

    /*
      Compass & Navigation Logic

      When a user taps the compass button in the details sheet, a modern navigation
      overlay slides up from the bottom of the screen. It calculates a route from
      the user's current location to the selected place using the Google Directions
      Service, displays the step‚Äëby‚Äëstep directions, and provides voice guidance
      via the Web Speech API. Users can choose from available device voices and
      start/stop the spoken navigation. A close button hides the overlay and
      cleans up listeners.
    */
    let navigationStopped = false;
    function openCompass(destLatLng) {
      const overlay = $("compassOverlay");
      overlay.classList.add('active');
      document.body.classList.add('modal-open');
      // Populate voice selector
      const voiceSelect = $("voiceSelect");
      function populateVoices() {
        const voices = window.speechSynthesis.getVoices();
        if (!voices || voices.length === 0) return;
        voiceSelect.innerHTML = '';
        voices.forEach((voice, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = `${voice.name}${voice.lang ? ' (' + voice.lang + ')' : ''}`;
          voiceSelect.appendChild(opt);
        });
      }
      populateVoices();
      // Some browsers load voices asynchronously
      window.speechSynthesis.onvoiceschanged = populateVoices;
      // Reset buttons
      $("startNavigationBtn").disabled = false;
      $("stopNavigationBtn").disabled = true;
      // Clear directions list
      const directionsList = $("directionsList");
      directionsList.innerHTML = 'Calculating route‚Ä¶';
      // Initialize compass arrow updates
      let orientationListener;
      const updateCompassArrow = (event) => {
        // Compute heading using Google geometry library
        if (!currentPosition) return;
        const heading = google.maps.geometry.spherical.computeHeading(currentPosition, destLatLng);
        const deviceHeading = event.alpha;
        if (typeof heading === 'number' && typeof deviceHeading === 'number') {
          const rotation = heading - deviceHeading;
          $("compassArrow").style.transform = `rotate(${rotation}deg)`;
        }
      };
      // Request permission for device orientation (iOS) if needed
      if (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function') {
        window.DeviceOrientationEvent.requestPermission().then(response => {
          if (response === 'granted') {
            orientationListener = updateCompassArrow;
            window.addEventListener('deviceorientation', orientationListener, true);
          }
        }).catch(console.error);
      } else if (window.DeviceOrientationEvent) {
        orientationListener = updateCompassArrow;
        window.addEventListener('deviceorientation', orientationListener, true);
      }
      // Start watching geolocation for orientation updates
      if (navigator.geolocation) {
        if (compassWatchId) navigator.geolocation.clearWatch(compassWatchId);
        compassWatchId = navigator.geolocation.watchPosition((pos) => {
          currentPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        });
      }
      // Use DirectionsService to compute route
      const directionsService = new google.maps.DirectionsService();
      directionsService.route({
        origin: currentPosition,
        destination: destLatLng,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        directionsList.innerHTML = '';
        if (status === google.maps.DirectionsStatus.OK) {
          const steps = result.routes[0].legs[0].steps;
          // Populate list
          steps.forEach((step, index) => {
            const div = document.createElement('div');
            div.dataset.index = index;
            div.innerHTML = step.instructions;
            directionsList.appendChild(div);
          });
          // Start navigation function
          function startNavigation() {
            navigationStopped = false;
            $("startNavigationBtn").disabled = true;
            $("stopNavigationBtn").disabled = false;
            let idx = 0;
            function speakNext() {
              if (navigationStopped || idx >= steps.length) {
                $("startNavigationBtn").disabled = false;
                $("stopNavigationBtn").disabled = true;
                return;
              }
              // Highlight current step
              Array.from(directionsList.children).forEach(el => el.classList.remove('active'));
              const currentEl = directionsList.children[idx];
              if (currentEl) currentEl.classList.add('active');
              // Remove HTML tags from instructions and preface with step number
              const clean = steps[idx].instructions.replace(/<[^>]+>/g, '');
              const text = `Step ${idx + 1}: ${clean}.`;
              const utter = new SpeechSynthesisUtterance(text);
              const voices = window.speechSynthesis.getVoices();
              const selectedVoice = voices[voiceSelect.value] || voices[0];
              utter.voice = selectedVoice;
              // Slightly lower pitch and slower rate for a rugged, confident tone
              utter.pitch = 0.85;
              utter.rate = 0.95;
              utter.volume = 1;
              window.speechSynthesis.speak(utter);
              idx++;
              utter.onend = () => {
                if (!navigationStopped) {
                  // Small delay before next instruction
                  setTimeout(speakNext, 3000);
                }
              };
            }
            speakNext();
          }
          function stopNavigation() {
            navigationStopped = true;
            window.speechSynthesis.cancel();
            $("startNavigationBtn").disabled = false;
            $("stopNavigationBtn").disabled = true;
          }
          $("startNavigationBtn").onclick = startNavigation;
          $("stopNavigationBtn").onclick = stopNavigation;
        } else {
          directionsList.textContent = 'Unable to compute route.';
        }
      });
      // Close overlay button handler
      $("closeCompassBtn").onclick = () => {
        overlay.classList.remove('active');
        document.body.classList.remove('modal-open');
        if (navigator.geolocation && compassWatchId) {
          navigator.geolocation.clearWatch(compassWatchId);
        }
        if (orientationListener) {
          window.removeEventListener('deviceorientation', orientationListener, true);
        }
        window.speechSynthesis.cancel();
        navigationStopped = true;
      };
    }

    // Local facts from Wikipedia
    async function fetchLocalFacts(pos) {
      clearInterval(factInterval);
      $("factWidget").textContent = 'Fetching local facts‚Ä¶';
      try {
        const url = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${pos.lat}%7C${pos.lng}&gsradius=10000&gslimit=10&format=json&origin=*`;
        const geoData = await fetch(url).then(res => res.json());
        const pageIds = geoData.query.geosearch.map(item => item.pageid).join('|');
        const extractsUrl = `https://en.wikipedia.org/w/api.php?action=query&pageids=${pageIds}&prop=extracts&explaintext=1&exchars=280&format=json&origin=*`;
        const extracts = await fetch(extractsUrl).then(res => res.json());
        const facts = [];
        Object.values(extracts.query.pages).forEach(page => {
          if (page.extract) {
            const text = page.extract.replace(/\n+/g,' ').trim();
            if (text.length >= 50 && text.length <= 280) {
              facts.push(text);
            }
          }
        });
        if (facts.length === 0) {
          $("factWidget").textContent = 'No local facts found.';
          return;
        }
        let index = 0;
        $("factWidget").textContent = facts[index];
        factInterval = setInterval(() => {
          index = (index + 1) % facts.length;
          $("factWidget").textContent = facts[index];
        }, 7000);
      } catch (err) {
        console.error(err);
        $("factWidget").textContent = 'Unable to fetch facts.';
      }
    }

    // Initialize accordions
    setupAccordions();

    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }

    // Start app after Google Maps script loaded
    window.initMap = initApp;
  </script>
</body>
</html>
