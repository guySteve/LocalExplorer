<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Local Explorer</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. Root Variables & Reset --- */
        :root {
            --bg-ivory: #f8f7f2;
            --panel-navy: #111827;
            --cta-orange: #ff4500;
            --text-light: #f9fafb;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Raleway', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Critical for SPA feel */
            font-family: var(--font-body);
            background-color: var(--bg-ivory);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4 {
            font-family: var(--font-heading);
            font-weight: 700;
            color: var(--panel-navy);
        }

        button {
            font-family: inherit;
            border: none;
            cursor: pointer;
            background: none;
            color: inherit;
        }

        /* --- 2. Main Layout & Header --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .app-header {
            padding: 24px 20px 16px;
            background: var(--bg-ivory);
            border-bottom: 1px solid #e5e7eb;
        }

        .app-header h1 {
            font-size: 2.25rem;
            line-height: 1.1;
            text-align: center;
        }

        #location-display {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 8px;
            height: 40px; /* Reserve space */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #manual-search-bar {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }

        /* --- 3. Main Screen Content --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Fact Widget */
        #fact-widget {
            background-color: var(--panel-navy);
            color: var(--text-light);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: opacity 0.5s ease-in-out;
        }

        /* Filter Grid */
        #filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background-color: var(--panel-navy);
            color: var(--text-light);
            border-radius: 12px;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            padding: 10px;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .filter-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .filter-btn span {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        /* Premium button press */
        .filter-btn:not(:disabled):active, .primary-btn:not(:disabled):active, .submenu-btn:not(:disabled):active {
            transform: scale(0.97);
        }

        /* Primary Actions */
        #primary-actions {
            margin-top: auto; /* Pushes to bottom */
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .primary-btn {
            padding: 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        #my-list-btn {
            background-color: #fff;
            color: var(--panel-navy);
            border: 1px solid #e5e7eb;
        }

        #surprise-btn {
            background-color: var(--cta-orange);
            color: var(--text-light);
            width: 100%;
        }

        /* Easter Egg */
        #easter-egg {
            position: fixed;
            bottom: 15px;
            left: 15px;
            font-size: 2.5rem;
            opacity: 0.2;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 100;
        }
        #easter-egg:hover {
            opacity: 0.7;
            transform: scale(1.1);
        }

        /* --- 4. Modals & Overlays --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -45%) scale(0.95);
            background-color: var(--bg-ivory);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.visible .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
        }

        .close-btn {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-muted);
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* Sub-menu Modal */
        #submenu-modal .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .submenu-btn {
            background-color: var(--panel-navy);
            color: var(--text-light);
            padding: 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
        }

        /* Results Modal */
        #results-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #results-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .result-card {
            display: flex;
            gap: 15px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: box-shadow 0.2s ease;
        }
        .result-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .result-card-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .result-card-info {
            padding: 12px 0;
            flex-grow: 1;
        }
        .result-card-info h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        .result-card-rating {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .result-card-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-right: 20px;
        }
        
        .map-link-btn {
            font-size: 1.5rem;
            color: var(--cta-orange);
            padding: 10px;
        }

        /* "My List" Modal */
        #my-list-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 0;
        }

        #my-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .saved-item-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .saved-item-info {
            flex-grow: 1;
        }
        .saved-item-info h3 {
            font-size: 1.1rem;
        }
        .saved-item-info p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .saved-item-actions button {
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 8px;
            margin-left: 8px;
        }
        .saved-item-remove {
            background: #fee2e2;
            color: #dc2626;
        }
        .saved-item-nav {
            background: #dbeafe;
            color: #2563eb;
        }

        /* --- 5. Place Detail View --- */
        #detail-view {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #detail-view.visible {
            transform: translateY(0);
        }

        #detail-street-view {
            width: 100%;
            height: 40%;
            background-color: #333;
        }

        #detail-content-card {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65%; /* Slight overlap */
            background-color: var(--bg-ivory);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        #detail-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.5rem;
            padding: 5px;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
            line-height: 1;
            z-index: 2010;
        }

        #detail-header-img {
            width: 120px;
            height: 120px;
            border-radius: 16px;
            object-fit: cover;
            border: 4px solid var(--bg-ivory);
            position: absolute;
            top: -60px; /* Halfway up */
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #detail-scroll-content {
            padding: 80px 20px 20px; /* Top padding to clear image */
            overflow-y: auto;
            flex-grow: 1;
        }

        #detail-title-bar {
            text-align: center;
            margin-bottom: 20px;
        }
        #detail-title-bar h2 {
            font-size: 1.75rem;
            margin-bottom: 4px;
        }
        #detail-meta {
            font-size: 1rem;
            color: var(--text-muted);
        }
        #detail-meta span {
            margin: 0 5px;
        }

        #detail-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }
        
        .detail-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 5px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--panel-navy);
        }
        .detail-action-btn span {
            font-size: 1.5rem;
            margin-bottom: 6px;
            color: var(--cta-orange);
        }
        #detail-save-btn.saved {
            background-color: var(--panel-navy);
            color: var(--text-light);
        }
        #detail-save-btn.saved span {
            color: var(--cta-orange);
        }

        #detail-links {
            display: flex;
            gap: 15px;
            margin-bottom: 24px;
        }
        .detail-link {
            flex: 1;
            padding: 14px;
            text-align: center;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 700;
        }
        #detail-maps-link {
            background-color: var(--panel-navy);
            color: var(--text-light);
        }
        #detail-web-link {
            background-color: #fff;
            color: var(--panel-navy);
            border: 1px solid var(--panel-navy);
        }

        /* Accordion */
        .accordion-item {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .accordion-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content-inner {
            padding: 0 16px 16px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        #detail-reviews-list, #detail-hours-list {
            list-style: none;
        }
        #detail-hours-list li {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        #detail-reviews-list li {
            margin-bottom: 12px;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 12px;
        }
        #detail-reviews-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        #detail-reviews-list strong {
            color: var(--panel-navy);
        }
        
        /* --- 6. Compass Modal --- */
        #compass-modal {
            background-color: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(20px);
            z-index: 3000; /* Highest */
        }
        #compass-modal .modal-content {
            background: none;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            transform: none;
        }
        
        #compass-dial {
            position: relative;
            width: 300px;
            height: 300px;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Compass_Card.svg/1024px-Compass_Card.svg.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s linear;
        }

        #compass-needle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 140px solid var(--cta-orange);
            position: absolute;
            top: 10px; /* Points from top-center down */
            transform-origin: 50% 140px; /* Rotate around bottom-center */
        }

        #compass-info {
            position: absolute;
            bottom: 10%;
            color: var(--text-light);
            text-align: center;
        }
        #compass-info h3 {
            color: var(--text-light);
            font-size: 1.5rem;
        }
        
        #compass-close-btn {
            position: absolute;
            top: 40px;
            right: 20px;
            font-size: 2rem;
            color: #fff;
            opacity: 0.8;
            z-index: 3010;
        }

        /* --- 7. Utility & Loading --- */
        .hidden {
            display: none !important;
        }
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 69, 0, 0.3);
            border-top-color: var(--cta-orange);
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- 8. Responsive Design --- */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            
            .main-content {
                width: 400px;
                flex-shrink: 0;
                border-right: 1px solid #e5e7eb;
                height: 100vh;
                padding-bottom: 100px; /* Space for actions */
            }

            #primary-actions {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 400px;
                padding: 20px;
                background: var(--bg-ivory);
                border-top: 1px solid #e5e7eb;
            }

            /* On desktop, modals are just part of the layout */
            .modal-overlay {
                position: relative;
                flex-grow: 1;
                background: none;
                backdrop-filter: none;
                opacity: 1;
                visibility: visible;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                max-height: 95vh;
            }
            
            /* Hide modal-related controls */
            .modal-overlay .close-btn { display: none; }
            #my-list-btn { display: none; } /* Show "My List" permanently */
            
            /* Show My List and Results permanently */
            #results-modal {
                display: block;
                background-color: #f9fafb;
            }
            #results-modal .modal-content,
            #my-list-modal .modal-content {
                width: 95%;
                height: 95%;
                max-width: 600px;
            }

            #my-list-modal {
                display: block;
                background-color: #f3f4f6;
            }
            #my-list-modal .modal-header h2 { font-size: 1.25rem; }

            /* Detail view slides from right */
            #detail-view {
                transform: translateX(100%);
                height: 100%;
                width: 50%;
                max-width: 600px;
                left: auto;
                right: 0;
                z-index: 2000;
            }
            #detail-view.visible {
                transform: translateX(0);
            }
            #detail-content-card {
                height: 60%;
            }
            #detail-close-btn { display: block; } /* Show close btn on desktop */
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <main class="main-content">
            <header class="app-header">
                <h1>Local Explorer</h1>
                <p id="location-display">
                    <span class="loading-spinner"></span>
                </p>
                <form id="manual-search-form" class="hidden">
                    <input type="text" id="manual-search-bar" placeholder="Enter a city or address...">
                </form>
            </header>

            <div id="fact-widget">Fetching local facts...</div>
            
            <div id="filter-grid">
                <button class="filter-btn" data-category="foodie" disabled><span>🍽️</span> Foodie Finds</button>
                <button class="filter-btn" data-category="sights" disabled><span>🏛️</span> Iconic Sights</button>
                <button class="filter-btn" data-category="nightlife" disabled><span>🌙</span> Night Out</button>
                <button class="filter-btn" data-category="gems" disabled><span>💎</span> Hidden Gems</button>
                <button class="filter-btn" data-category="pets" disabled><span>🐾</span> Pet Friendly</button>
                <button class="filter-btn" data-category="utils" disabled><span>🛠️</span> Utilities & Help</button>
            </div>

            <div id="primary-actions">
                <button id="my-list-btn" class="primary-btn">📋 My List</button>
                <button id="surprise-btn" class="primary-btn">🤷 Surprise Me!</button>
            </div>
            
            <button id="easter-egg">👻</button>
        </main>

        <div id="submenu-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="submenu-title"></h2>
                    <button class="close-btn" data-close="submenu-modal">×</button>
                </div>
                <div id="submenu-body" class="modal-body">
                    </div>
            </div>
        </div>
        
        <div id="results-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="results-title">Results</h2>
                    <button class="close-btn" data-close="results-modal">×</button>
                </div>
                <div id="results-list" class="modal-body">
                    <p id="results-empty">No results found. Try a different category!</p>
                </div>
            </div>
        </div>
        
        <div id="my-list-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="my-list-title">📋 My Saved Places</h2>
                    <button class="close-btn" data-close="my-list-modal">×</button>
                </div>
                <div id="my-list-container" class="modal-body">
                    <p id="my-list-empty">You haven't saved any places yet. Start exploring!</p>
                </div>
            </div>
        </div>

        <div id="detail-view">
            <button id="detail-close-btn" class="close-btn">×</button>
            <div id="detail-street-view"></div>
            <div id="detail-content-card">
                <img id="detail-header-img" src="https://via.placeholder.com/120" alt="Place image">
                <div id="detail-scroll-content">
                    
                    <div id="detail-title-bar">
                        <h2 id="detail-name">Place Name</h2>
                        <div id="detail-meta">
                            <span id="detail-rating">...</span>
                            <span id="detail-price">...</span>
                        </div>
                    </div>

                    <div id="detail-actions">
                        <button class="detail-action-btn" id="detail-save-btn" data-place-id="">
                            <span>☆</span>Save
                        </button>
                        <button class="detail-action-btn" id="detail-share-btn">
                            <span>📤</span>Share
                        </button>
                        <button class="detail-action-btn" id="detail-compass-btn">
                            <span>🧭</span>Compass
                        </button>
                    </div>

                    <div id="detail-links">
                        <a href="#" id="detail-maps-link" class="detail-link" target="_blank">Open in Maps</a>
                        <a href="#" id="detail-web-link" class="detail-link" target="_blank">Visit Website</a>
                    </div>

                    <div class="accordion-item">
                        <div class="accordion-header" data-accordion="hours">
                            Weekly Hours <span>▼</span>
                        </div>
                        <div class="accordion-content" id="hours-content">
                            <ul id="detail-hours-list" class="accordion-content-inner">
                                </ul>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <div class="accordion-header" data-accordion="reviews">
                            Reviews <span>▼</span>
                        </div>
                        <div class="accordion-content" id="reviews-content">
                            <ul id="detail-reviews-list" class="accordion-content-inner">
                                </ul>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <div id="compass-modal" class="modal-overlay">
            <button id="compass-close-btn" class="close-btn" data-close="compass-modal">×</button>
            <div class="modal-content">
                <div id="compass-dial">
                    <div id="compass-needle"></div>
                </div>
                <div id="compass-info">
                    <h3 id="compass-dest-name">...</h3>
                    <p id="compass-distance">...</p>
                    <p id="compass-support-warning" class="hidden">Device orientation not supported or not permitted.</p>
                </div>
            </div>
        </div>

    </div> <script>
        // --- 1. CONFIGURATION ---
        
        // -----------------------------------------------------------------
        // ! CRITICAL: REPLACE WITH YOUR GOOGLE MAPS API KEY
        // -----------------------------------------------------------------
        const API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY_HERE';
        
        // Application Namespace
        const App = {
            // API Services
            map: null,
            geocoder: null,
            placesService: null,
            streetViewService: null,
            panorama: null,

            // State
            userLocation: null, // { lat, lng }
            currentDestination: null, // { lat, lng, name }
            savedPlaces: [],
            factTimer: null,
            
            // DOM References
            dom: {},

            // Sub-menu definitions
            categories: {
                foodie: {
                    title: "Foodie Finds 🍽️",
                    items: [ "restaurant", "cafe", "bakery", "bar", "meal_delivery", "meal_takeaway" ]
                },
                sights: {
                    title: "Iconic Sights 🏛️",
                    items: [ "tourist_attraction", "museum", "park", "art_gallery", "church", "landmark" ]
                },
                nightlife: {
                    title: "Night Out 🌙",
                    items: [ "night_club", "bar", "casino", "bowling_alley", "movie_theater" ]
                },
                gems: {
                    title: "Hidden Gems 💎",
                    items: [ "book_store", "library", "local_government_office", "city_hall", "point_of_interest" ]
                },
                pets: {
                    title: "Pet Friendly 🐾",
                    items: [ "pet_store", "veterinary_care", "dog_park" ]
                },
                utils: {
                    title: "Utilities & Help 🛠️",
                    items: [ "hospital", "police", "pharmacy", "gas_station", "atm", "bank", "embassy" ]
                },
                DarkSide: {
                    title: "Dark Side 👻",
                    items: [ "cemetery", "funeral_home", "haunted_house" ]
                }
            }
        };

        // --- 2. INITIALIZATION ---

        /**
         * Main entry point. Called after Google Maps script loads.
         */
        function initMap() {
            console.log("Google Maps API loaded.");
            
            // Initialize API services
            App.geocoder = new google.maps.Geocoder();
            // Need a dummy map div, even if not shown
            const mapEl = document.createElement('div');
            mapEl.id = 'dummy-map';
            mapEl.style.display = 'none';
            document.body.appendChild(mapEl);
            App.map = new google.maps.Map(mapEl);
            
            App.placesService = new google.maps.places.PlacesService(App.map);
            App.streetViewService = new google.maps.StreetViewService();

            // Cache DOM elements
            App.dom.locationDisplay = document.getElementById('location-display');
            App.dom.manualSearchForm = document.getElementById('manual-search-form');
            App.dom.manualSearchBar = document.getElementById('manual-search-bar');
            App.dom.factWidget = document.getElementById('fact-widget');
            App.dom.filterGrid = document.getElementById('filter-grid');
            App.dom.filterButtons = document.querySelectorAll('.filter-btn');
            App.dom.surpriseBtn = document.getElementById('surprise-btn');
            App.dom.myListBtn = document.getElementById('my-list-btn');
            App.dom.easterEggBtn = document.getElementById('easter-egg');
            
            // Modals
            App.dom.submenuModal = document.getElementById('submenu-modal');
            App.dom.submenuTitle = document.getElementById('submenu-title');
            App.dom.submenuBody = document.getElementById('submenu-body');
            App.dom.resultsModal = document.getElementById('results-modal');
            App.dom.resultsTitle = document.getElementById('results-title');
            App.dom.resultsList = document.getElementById('results-list');
            App.dom.resultsEmpty = document.getElementById('results-empty');
            App.dom.myListModal = document.getElementById('my-list-modal');
            App.dom.myListContainer = document.getElementById('my-list-container');
            App.dom.myListEmpty = document.getElementById('my-list-empty');
            
            // Detail View
            App.dom.detailView = document.getElementById('detail-view');
            App.dom.detailCloseBtn = document.getElementById('detail-close-btn');
            App.dom.detailStreetView = document.getElementById('detail-street-view');
            App.dom.detailHeaderImg = document.getElementById('detail-header-img');
            App.dom.detailName = document.getElementById('detail-name');
            App.dom.detailMeta = document.getElementById('detail-meta');
            App.dom.detailRating = document.getElementById('detail-rating');
            App.dom.detailPrice = document.getElementById('detail-price');
            App.dom.detailSaveBtn = document.getElementById('detail-save-btn');
            App.dom.detailShareBtn = document.getElementById('detail-share-btn');
            App.dom.detailCompassBtn = document.getElementById('detail-compass-btn');
            App.dom.detailMapsLink = document.getElementById('detail-maps-link');
            App.dom.detailWebLink = document.getElementById('detail-web-link');
            App.dom.detailHoursList = document.getElementById('detail-hours-list');
            App.dom.detailReviewsList = document.getElementById('detail-reviews-list');
            
            // Compass Modal
            App.dom.compassModal = document.getElementById('compass-modal');
            App.dom.compassCloseBtn = document.getElementById('compass-close-btn');
            App.dom.compassDial = document.getElementById('compass-dial');
            App.dom.compassNeedle = document.getElementById('compass-needle');
            App.dom.compassDestName = document.getElementById('compass-dest-name');
            App.dom.compassDistance = document.getElementById('compass-distance');
            App.dom.compassSupportWarning = document.getElementById('compass-support-warning');

            // Initialize Street View Panorama
            App.panorama = new google.maps.StreetViewPanorama(App.dom.detailStreetView, {
                position: { lat: 40.758, lng: -73.985 }, // Default
                pov: { heading: 165, pitch: 0 },
                zoom: 1,
                addressControl: false,
                linksControl: false,
                panControl: false,
                enableCloseButton: false
            });

            // Start app logic
            registerServiceWorker();
            loadSavedPlaces();
            attachEventListeners();
            getLocation();
        }

        /**
         * Register the PWA Service Worker
         */
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(reg => console.log('Service worker registered.', reg))
                        .catch(err => console.error('Service worker registration failed:', err));
                });
            }
        }
        
        /**
         * Attach all static event listeners
         */
        function attachEventListeners() {
            // Main filter buttons
            App.dom.filterGrid.addEventListener('click', e => {
                const btn = e.target.closest('.filter-btn');
                if (btn && !btn.disabled) {
                    showSubMenu(btn.dataset.category);
                }
            });
            
            // Primary actions
            App.dom.myListBtn.addEventListener('click', () => showModal(App.dom.myListModal));
            App.dom.surpriseBtn.addEventListener('click', surpriseMe);
            App.dom.easterEggBtn.addEventListener('click', () => showSubMenu('DarkSide'));
            
            // Manual search
            App.dom.manualSearchForm.addEventListener('submit', e => {
                e.preventDefault();
                const query = App.dom.manualSearchBar.value;
                if (query) {
                    geocodeAddress(query);
                }
            });

            // Modal close buttons
            document.querySelectorAll('[data-close]').forEach(btn => {
                btn.addEventListener('click', () => {
                    hideModal(document.getElementById(btn.dataset.close));
                });
            });
            
            // Detail view close
            App.dom.detailCloseBtn.addEventListener('click', () => hideModal(App.dom.detailView));
            
            // Accordions
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const isOpen = content.style.maxHeight;
                    
                    if (isOpen) {
                        content.style.maxHeight = null;
                        header.querySelector('span').textContent = '▼';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        header.querySelector('span').textContent = '▲';
                    }
                });
            });
            
            // Detail view actions
            App.dom.detailSaveBtn.addEventListener('click', toggleSavePlace);
            App.dom.detailShareBtn.addEventListener('click', sharePlace);
            App.dom.detailCompassBtn.addEventListener('click', showCompass);
            
            // Compass close
            App.dom.compassCloseBtn.addEventListener('click', hideCompass);
        }
        
        // --- 3. LOCATION SERVICES ---

        /**
         * Request user's geolocation
         */
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    geolocationSuccess,
                    geolocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                geolocationError();
            }
        }

        /**
         * Geolocation Success Callback
         */
        function geolocationSuccess(position) {
            App.userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            console.log("Location found:", App.userLocation);
            reverseGeocode(App.userLocation);
            fetchWikiFacts(App.userLocation.lat, App.userLocation.lng);
            enableFilters();
        }

        /**
         * Geolocation Error Callback
         */
        function geolocationError(error) {
            console.warn("Geolocation error:", error ? error.message : "Not supported");
            App.dom.locationDisplay.textContent = "Location denied or unavailable.";
            App.dom.manualSearchForm.classList.remove('hidden');
            App.dom.manualSearchBar.focus();
            enableFilters(); // Enable filters for manual search
            
            // Set a default location (e.g., New York City) for Wikipedia facts
            const defaultLocation = { lat: 40.7128, lng: -74.0060 };
            App.userLocation = defaultLocation; // Set for manual searches
            fetchWikiFacts(defaultLocation.lat, defaultLocation.lng);
        }

        /**
         * Convert Lat/Lng to human-readable address
         */
        function reverseGeocode(latLng) {
            App.geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    // Find a good, human-readable address
                    const address = results[0].formatted_address;
                    App.dom.locationDisplay.textContent = `📍 Near ${address}`;
                } else {
                    App.dom.locationDisplay.textContent = "Could not find address.";
                }
            });
        }
        
        /**
         * Convert address string to Lat/Lng
         */
        function geocodeAddress(address) {
            App.dom.locationDisplay.innerHTML = '<span class="loading-spinner"></span>';
            App.geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK') {
                    const loc = results[0].geometry.location;
                    App.userLocation = { lat: loc.lat(), lng: loc.lng() };
                    App.dom.locationDisplay.textContent = `📍 Near ${results[0].formatted_address}`;
                    fetchWikiFacts(App.userLocation.lat, App.userLocation.lng);
                } else {
                    App.dom.locationDisplay.textContent = "Could not find that location.";
                }
            });
        }
        
        /**
         * Enable all filter buttons
         */
        function enableFilters() {
            App.dom.filterButtons.forEach(btn => btn.disabled = false);
        }

        // --- 4. WIKIPEDIA FACT WIDGET ---
        
        /**
         * Fetch facts from Wikipedia based on location
         */
        async function fetchWikiFacts(lat, lng) {
            if (App.factTimer) clearInterval(App.factTimer);
            App.dom.factWidget.textContent = "Finding local facts...";
            
            const WIKI_API = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lng}&gsradius=10000&gslimit=10&format=json&origin=*`;
            
            try {
                const geoResponse = await fetch(WIKI_API);
                const geoData = await geoResponse.json();
                const pages = geoData.query.geosearch;

                if (!pages || pages.length === 0) {
                    App.dom.factWidget.textContent = "No local facts found nearby.";
                    return;
                }
                
                const pageIds = pages.map(p => p.pageid).join('|');
                const EXTRACT_API = `https://en.wikipedia.org/w/api.php?action=query&pageids=${pageIds}&prop=extracts&exintro=true&explaintext=true&format=json&origin=*`;
                
                const extractResponse = await fetch(EXTRACT_API);
                const extractData = await extractResponse.json();
                const pageExtracts = extractData.query.pages;
                
                const facts = Object.values(pageExtracts)
                    .map(page => page.extract)
                    .filter(extract => extract && extract.length > 50 && extract.length < 280)
                    .map(fact => fact.split('. ')[0] + '.'); // Get first sentence
                
                if (facts.length > 0) {
                    let factIndex = 0;
                    const cycleFacts = () => {
                        App.dom.factWidget.style.opacity = 0;
                        setTimeout(() => {
                            factIndex = (factIndex + 1) % facts.length;
                            App.dom.factWidget.textContent = facts[factIndex];
                            App.dom.factWidget.style.opacity = 1;
                        }, 500);
                    };
                    App.dom.factWidget.textContent = facts[0];
                    App.factTimer = setInterval(cycleFacts, 7000); // Cycle every 7s
                } else {
                    App.dom.factWidget.textContent = "No interesting facts found nearby.";
                }

            } catch (error) {
                console.error("Failed to fetch Wiki facts:", error);
                App.dom.factWidget.textContent = "Could not load local facts.";
            }
        }
        
        // --- 5. UI & MODAL CONTROLS ---

        /**
         * Generic function to show a modal
         * @param {HTMLElement} modalEl The modal element to show
         */
        function showModal(modalEl) {
            modalEl.classList.add('visible');
        }

        /**
         * Generic function to hide a modal
         * @param {HTMLElement} modalEl The modal element to hide
         */
        function hideModal(modalEl) {
            modalEl.classList.remove('visible');
        }
        
        /**
         * Show the sub-menu for a given category
         * @param {string} categoryKey Key from App.categories
         */
        function showSubMenu(categoryKey) {
            const category = App.categories[categoryKey];
            if (!category) return;
            
            App.dom.submenuTitle.textContent = category.title;
            App.dom.submenuBody.innerHTML = ''; // Clear old items
            
            category.items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'submenu-btn';
                btn.textContent = item.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                btn.dataset.query = item;
                btn.dataset.category = categoryKey;
                btn.addEventListener('click', () => {
                    performSearch(item, categoryKey);
                    hideModal(App.dom.submenuModal);
                });
                App.dom.submenuBody.appendChild(btn);
            });
            
            showModal(App.dom.submenuModal);
        }

        // --- 6. SEARCH & RESULTS ---
        
        /**
         * Perform a search using Google Places API
         * @param {string} query The search query (e.g., 'cafe', 'hospital')
         * @param {string} category The parent category (e.g., 'foodie', 'utils')
         */
        function performSearch(query, category) {
            if (!App.userLocation) {
                alert("Please set a location first.");
                return;
            }
            
            App.dom.resultsTitle.textContent = `Results for "${query.replace(/_/g, ' ')}"`;
            App.dom.resultsList.innerHTML = '<div class="loading-spinner" style="margin: 40px auto;"></div>';
            App.dom.resultsEmpty.classList.add('hidden');
            showModal(App.dom.resultsModal);

            const isException = category === 'utils' || category === 'DarkSide';
            
            const request = {
                location: App.userLocation,
                radius: '5000', // 5km
                keyword: query
            };
            
            // Use rankBy: 'distance' for exceptions, 'prominence' for others
            if (isException) {
                delete request.radius;
                request.rankBy = google.maps.places.RankBy.DISTANCE;
            } else {
                request.rankBy = google.maps.places.RankBy.PROMINENCE;
            }

            App.placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    let filteredResults = results;
                    
                    // Apply rating filter for non-exception categories
                    if (!isException) {
                        filteredResults = results.filter(place => 
                            place.rating && place.rating >= 4.2 && place.user_ratings_total > 50
                        );
                    }
                    
                    displayResults(filteredResults);
                } else {
                    console.error("Places search failed:", status);
                    App.dom.resultsList.innerHTML = '';
                    App.dom.resultsEmpty.classList.remove('hidden');
                }
            });
        }
        
        /**
         * Handle the "Surprise Me!" button click
         */
        function surpriseMe() {
            const queries = [
                { query: "park", category: "sights" },
                { query: "cafe", category: "foodie" },
                { query: "museum", category: "sights" },
                { query: "book_store", category: "gems" },
                { query: "tourist_attraction", category: "sights" }
            ];
            const randomQuery = queries[Math.floor(Math.random() * queries.length)];
            
            // Surprise Me should *always* find highly-rated
            performSearch(randomQuery.query, randomQuery.category);
        }

        /**
         * Populate the results modal with place cards
         * @param {Array} places Array of Google Place results
         */
        function displayResults(places) {
            App.dom.resultsList.innerHTML = ''; // Clear loading spinner
            
            if (!places || places.length === 0) {
                App.dom.resultsEmpty.classList.remove('hidden');
                return;
            }
            
            App.dom.resultsEmpty.classList.add('hidden');
            
            places.forEach(place => {
                const photoUrl = place.photos && place.photos.length > 0 
                    ? place.photos[0].getUrl({ maxWidth: 200, maxHeight: 200 })
                    : 'https://via.placeholder.com/100?text=No+Image';

                const card = document.createElement('div');
                card.className = 'result-card';
                card.dataset.placeId = place.place_id;
                
                card.innerHTML = `
                    <img src="${photoUrl}" alt="${place.name}" class="result-card-img">
                    <div class="result-card-info">
                        <h3>${place.name}</h3>
                        <div class="result-card-rating">
                            ${place.rating || 'N/A'} ★ (${place.user_ratings_total || 0} reviews)
                        </div>
                    </div>
                    <div class="result-card-actions">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}" 
                           target="_blank" 
                           class="map-link-btn" 
                           onclick="event.stopPropagation()">
                           🗺️
                        </a>
                    </div>
                `;
                
                // Click listener for the whole card
                card.addEventListener('click', ().replace(/"/g, "'") => {
                    showPlaceDetails(place.place_id, place);
                });
                
                App.dom.resultsList.appendChild(card);
            });
        }

        // --- 7. PLACE DETAIL VIEW ---
        
        /**
         * Fetch full details and show the slide-up detail view
         * @param {string} placeId The Google Place ID
         * @param {Object} [basicPlace] Optional basic place data from search
         */
        function showPlaceDetails(placeId, basicPlace) {
            App.dom.detailView.scrollTop = 0; // Reset scroll
            
            // Set basic info immediately for responsiveness
            if (basicPlace) {
                App.dom.detailName.textContent = basicPlace.name;
                App.dom.detailRating.textContent = `${basicPlace.rating || 'N/A'} ★`;
                const photoUrl = basicPlace.photos && basicPlace.photos.length > 0
                    ? basicPlace.photos[0].getUrl({ maxWidth: 240, maxHeight: 240 })
                    : 'https://via.placeholder.com/120?text=No+Image';
                App.dom.detailHeaderImg.src = photoUrl;
            } else {
                // Reset to loading state if no basic info
                App.dom.detailName.textContent = 'Loading...';
                App.dom.detailRating.textContent = '...';
                App.dom.detailPrice.textContent = '...';
                App.dom.detailHeaderImg.src = 'https://via.placeholder.com/120';
            }

            // Reset accordions
            document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
            document.querySelectorAll('.accordion-header span').forEach(s => s.textContent = '▼');

            showModal(App.dom.detailView);
            
            const fields = [
                'name', 'formatted_address', 'formatted_phone_number', 'opening_hours',
                'photos', 'place_id', 'price_level', 'rating', 'reviews',
                'website', 'url', 'geometry'
            ];
            
            App.placesService.getDetails({ placeId, fields }, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    console.log("Place Details:", place);
                    
                    // Set destination for compass
                    App.currentDestination = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng(),
                        name: place.name
                    };
                    
                    // Update Street View
                    App.streetViewService.getPanorama(
                        { location: place.geometry.location, radius: 50 },
                        (data, status) => {
                            if (status === 'OK') {
                                App.panorama.setPano(data.location.pano);
                                App.panorama.setPov({ heading: 165, pitch: 0 });
                                App.panorama.setVisible(true);
                            } else {
                                // No street view, use a map fallback?
                                console.warn("No Street View found.");
                                App.panorama.setVisible(false);
                                App.dom.detailStreetView.style.background = '#333'; // Reset
                            }
                        }
                    );
                    
                    // --- Populate Header Card ---
                    const photoUrl = place.photos && place.photos.length > 0
                        ? place.photos[0].getUrl({ maxWidth: 240, maxHeight: 240 })
                        : 'https://via.placeholder.com/120?text=No+Image';
                    App.dom.detailHeaderImg.src = photoUrl;
                    
                    App.dom.detailName.textContent = place.name;
                    App.dom.detailRating.textContent = `${place.rating || 'N/A'} ★`;
                    App.dom.detailPrice.textContent = place.price_level ? '$'.repeat(place.price_level) : '';
                    
                    // --- Populate Actions ---
                    App.dom.detailSaveBtn.dataset.placeId = place.place_id;
                    App.dom.detailSaveBtn.dataset.placeName = place.name;
                    App.dom.detailSaveBtn.dataset.placeAddress = place.formatted_address;
                    updateSaveButton(place.place_id);
                    
                    // --- Populate Links ---
                    App.dom.detailMapsLink.href = place.url;
                    if (place.website) {
                        App.dom.detailWebLink.href = place.website;
                        App.dom.detailWebLink.classList.remove('hidden');
                    } else {
                        App.dom.detailWebLink.classList.add('hidden');
                    }
                    
                    // --- Populate Accordions ---
                    
                    // Hours
                    if (place.opening_hours) {
                        const days = place.opening_hours.weekday_text;
                        App.dom.detailHoursList.innerHTML = days.map(day => {
                            const [dayName, ...time] = day.split(': ');
                            return `<li><strong>${dayName}:</strong> <span>${time.join(': ') || 'N/A'}</span></li>`;
                        }).join('');
                    } else {
                        App.dom.detailHoursList.innerHTML = '<li>Hours not available.</li>';
                    }

                    // Reviews
                    if (place.reviews) {
                        App.dom.detailReviewsList.innerHTML = place.reviews.map(review => `
                            <li>
                                <strong>${review.author_name} (${review.rating} ★)</strong>
                                <p>${review.text}</p>
                            </li>
                        `).join('');
                    } else {
                        App.dom.detailReviewsList.innerHTML = '<li>No reviews available.</li>';
                    }

                } else {
                    console.error("Failed to get place details:", status);
                    hideModal(App.dom.detailView);
                    alert("Could not load place details.");
                }
            });
        }

        // --- 8. "MY LIST" (LOCALSTORAGE) ---

        /**
         * Load saved places from localStorage
         */
        function loadSavedPlaces() {
            const places = localStorage.getItem('localExplorerPlaces');
            App.savedPlaces = places ? JSON.parse(places) : [];
            updateMyListModal();
        }

        /**
         * Save the current list to localStorage
         */
        function persistSavedPlaces() {
            localStorage.setItem('localExplorerPlaces', JSON.stringify(App.savedPlaces));
        }

        /**
         * Check if a place is already saved
         * @param {string} placeId 
         */
        function isPlaceSaved(placeId) {
            return App.savedPlaces.some(p => p.id === placeId);
        }

        /**
         * Update the UI of the save button
         * @param {string} placeId 
         */
        function updateSaveButton(placeId) {
            if (isPlaceSaved(placeId)) {
                App.dom.detailSaveBtn.classList.add('saved');
                App.dom.detailSaveBtn.innerHTML = '<span>★</span>Saved';
            } else {
                App.dom.detailSaveBtn.classList.remove('saved');
                App.dom.detailSaveBtn.innerHTML = '<span>☆</span>Save';
            }
        }
        
        /**
         * Toggle saving/unsaving a place
         */
        function toggleSavePlace() {
            const btn = App.dom.detailSaveBtn;
            const place = {
                id: btn.dataset.placeId,
                name: btn.dataset.placeName,
                address: btn.dataset.placeAddress
            };
            
            if (isPlaceSaved(place.id)) {
                // Remove it
                App.savedPlaces = App.savedPlaces.filter(p => p.id !== place.id);
            } else {
                // Add it
                App.savedPlaces.push(place);
            }
            
            persistSavedPlaces();
            updateSaveButton(place.id);
            updateMyListModal();
        }
        
        /**
         * Repopulate the "My List" modal
         */
        function updateMyListModal() {
            if (App.savedPlaces.length === 0) {
                App.dom.myListContainer.innerHTML = '';
                App.dom.myListEmpty.classList.remove('hidden');
            } else {
                App.dom.myListEmpty.classList.add('hidden');
                App.dom.myListContainer.innerHTML = App.savedPlaces.map(place => `
                    <div class="saved-item-card" data-place-id="${place.id}">
                        <div class="saved-item-info">
                            <h3>${place.name}</h3>
                            <p>${place.address}</p>
                        </div>
                        <div class="saved-item-actions">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.id}" target="_blank">
                                <button class="saved-item-nav">Nav</button>
                            </a>
                            <button class="saved-item-remove" data-id="${place.id}">Del</button>
                        </div>
                    </div>
                `).join('');
                
                // Add listeners for new remove buttons
                App.dom.myListContainer.querySelectorAll('.saved-item-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.target.dataset.id;
                        App.savedPlaces = App.savedPlaces.filter(p => p.id !== id);
                        persistSavedPlaces();
                        updateMyListModal();
                        // Update detail view save btn if it's open
                        if (App.dom.detailSaveBtn.dataset.placeId === id) {
                            updateSaveButton(id);
                        }
                    });
                });
            }
        }

        // --- 9. WEB SHARE API ---

        /**
         * Share a place using the native Web Share API
         */
        async function sharePlace() {
            const place = {
                title: App.dom.detailName.textContent,
                text: `Check out ${App.dom.detailName.textContent}, I found it on Local Explorer!`,
                url: App.dom.detailMapsLink.href
            };
            
            if (navigator.share) {
                try {
                    await navigator.share(place);
                    console.log("Place shared successfully");
                } catch (error) {
                    console.error("Share failed:", error);
                }
            } else {
                // Fallback for desktop or non-supporting browsers
                alert("Share not supported on this device. Here's the link:\n" + place.url);
            }
        }
        
        // --- 10. COMPASS ---
        
        /**
         * Show the compass modal and start listening
         */
        function showCompass() {
            if (!App.currentDestination) return;
            
            App.dom.compassDestName.textContent = App.currentDestination.name;
            App.dom.compassDistance.textContent = 'Calculating...';
            
            if (App.userLocation) {
                const dist = getDistance(
                    App.userLocation.lat, App.userLocation.lng,
                    App.currentDestination.lat, App.currentDestination.lng
                );
                App.dom.compassDistance.textContent = `${dist.toFixed(2)} km away`;
            }
            
            if ('DeviceOrientationEvent' in window) {
                // Check for permissions
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientationabsolute', handleOrientation);
                                App.dom.compassSupportWarning.classList.add('hidden');
                            } else {
                                App.dom.compassSupportWarning.classList.remove('hidden');
                            }
                        })
                        .catch(console.error);
                } else {
                    // Non-iOS 13+ devices
                    window.addEventListener('deviceorientationabsolute', handleOrientation);
                }
            } else {
                App.dom.compassSupportWarning.classList.remove('hidden');
            }
            
            showModal(App.dom.compassModal);
        }

        /**
         * Hide compass and stop listening
         */
        function hideCompass() {
            hideModal(App.dom.compassModal);
            window.removeEventListener('deviceorientationabsolute', handleOrientation);
        }

        /**
         * Handle the device orientation event
         */
        function handleOrientation(event) {
            if (!App.userLocation || !App.currentDestination) return;
            
            let alpha = event.alpha; // Compass direction (0-360)
            if (typeof event.webkitCompassHeading !== 'undefined') {
                alpha = event.webkitCompassHeading; // iOS
            }
            
            const bearing = getBearing(
                App.userLocation.lat, App.userLocation.lng,
                App.currentDestination.lat, App.currentDestination.lng
            );
            
            // Adjust dial (device heading)
            App.dom.compassDial.style.transform = `rotate(${-alpha}deg)`;
            
            // Adjust needle (bearing relative to device heading)
            // The needle points to the destination
            const needleRotation = bearing - alpha;
            App.dom.compassNeedle.style.transform = `rotate(${needleRotation}deg)`;
        }
        
        // --- 11. GEOMETRY HELPERS ---

        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }

        /**
         * Get distance between two coords (Haversine formula)
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        /**
         * Get bearing between two coords
         */
        function getBearing(lat1, lon1, lat2, lon2) {
            lat1 = toRad(lat1);
            lon1 = toRad(lon1);
            lat2 = toRad(lat2);
            lon2 = toRad(lon2);
            
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            let brng = toDeg(Math.atan2(y, x));
            return (brng + 360) % 360; // Normalize to 0-360
        }

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY_HERE&libraries=places,geocoding,directions&callback=initMap">
    </script>
</body>
</html>
