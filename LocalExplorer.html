<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Local Explorer" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <title>Local Explorer</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places,geocoding,directions&callback=initApp" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        :root{ --navy:#111827; --ivory:#f8f7f2; --amber:#f59e0b; --teal:#10b981; }
        body{font-family:'Raleway',sans-serif;background:#f8f7f2;}
        h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
        .pt-safe{padding-top: calc(1rem + env(safe-area-inset-top));}
        .pb-safe{padding-bottom: calc(1rem + env(safe-area-inset-bottom));}

        #panorama{position:absolute;inset:0;z-index:1}
        #panorama-container{pointer-events:none;opacity:0;visibility:hidden}
        #panorama-container.shown{pointer-events:none;opacity:1;visibility:visible;transition:opacity 1s}

        .action-card{background:#111827;color:#f8f7f2;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .action-card:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
        .action-card:active:not(:disabled){transform:translateY(0) scale(.98)}
        .action-card:disabled{opacity:.6;cursor:not-allowed}

        #result-card{background:rgba(17,24,39,.92);color:#f8f7f2;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
          transition:transform .4s ease,opacity .3s ease;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2)}
        .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}
        .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

        #results-list-screen{position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem;
          background:rgba(0,0,0,.75);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        #results-list-card{background:rgba(17,24,39,.97);color:#f8f7f2;border-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:auto}
        .result-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.75rem;display:flex;gap:.75rem; cursor: pointer;}
        .result-item:hover{background: rgba(255,255,255,0.1);}
        .result-thumb{width:84px;height:84px;object-fit:cover;border-radius:.6rem;background:#111827; pointer-events: none;}

        /* Removed #dark-side-button styles */

        #compass-modal{position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);}
        #compass-dialog{width: min(92vw, 440px); background: rgba(17,24,39,.97); color: var(--ivory);
          border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); padding:16px; outline:none;}
        #nav-bubble{position:relative;margin: 8px 0 12px 0;color:var(--ivory);padding:.6rem .75rem;font-size:13px;line-height:1.25;
          box-shadow:0 10px 24px rgba(0,0,0,.35);background:radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%);
          border:1px solid rgba(255,255,255,.12)}
        #nav-main{font-weight:700;letter-spacing:.2px}
        #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
        #compass-overlay{width:240px;height:240px;border-radius:22px;margin: 6px auto 10px auto; padding: 18px; position:relative;
          background: radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
            conic-gradient(from 0deg, rgba(245,158,11,.5), rgba(245,158,11,.1) 30%, rgba(16,185,129,.5) 60%, rgba(16,185,129,.12) 75%, rgba(245,158,11,.35));
          border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06);
          display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden}
        #compass-arrow{width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:44px solid var(--amber);
          transform-origin:50% 90%;filter:drop-shadow(0 6px 8px rgba(245,158,11,.45));margin-bottom:8px}
        #compass-dist{font-size:14px;color:#e5e7eb;font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}
    </style>
</head>
<body class="text-gray-900 flex flex-col items-center justify-center min-h-screen p-4 pt-safe pb-safe">

  <div id="panorama-container" class="fixed inset-0">
    <div id="panorama" aria-hidden="true"></div>
  </div>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center" role="main" aria-live="polite">
    <section id="main-screen" aria-labelledby="app-title">
      <h1 id="app-title" class="text-4xl md:text-5xl font-header font-bold text-gray-900 mb-4">Local Explorer</h1>

      <section id="fun-fact-container" class="text-left mb-4 px-2">
        <h2 class="font-header font-bold mb-1 text-orange-500 text-sm tracking-wider uppercase">Local Fact</h2>
        <p id="fun-fact-text" class="text-sm text-gray-600 border-t-2 border-gray-200 pt-2">Loading...</p>
      </section>

      <p id="location-status" class="text-lg font-semibold text-gray-700 my-4">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" inputmode="search" placeholder="Enter a city or place"
                 class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-r-lg" aria-label="Search">üîç</button>
        </div>
      </div>

      <nav id="filter-container" class="grid grid-cols-2 gap-4">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">üçΩÔ∏è Foodie Finds</button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">üèõÔ∏è Iconic Sights</button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">üåô Night Out</button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">üíé Hidden Gems</button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">üêæ Pet Friendly</button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">üõ†Ô∏è Utilities & Help</button>
      </nav>

      <button id="random-button" class="action-card w-full mt-4 rounded-lg font-bold py-3 text-base bg-orange-500 text-white">ü§∑ Surprise Me!</button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden mt-4 text-gray-600 underline">Back to main filters</button>
    </section>
  </main>

  <section id="results-list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="results-list-card" class="w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card bg-gray-700 text-white font-bold py-2 px-3 rounded-lg">Back</button>
      </div>
      <div id="results-meta" class="text-sm text-gray-300 mb-3"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>

  <section id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" loading="lazy" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Place photo" class="w-full h-48 object-cover rounded-lg mb-4" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left text-white" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform text-white" aria-pressed="false">‚òÜ</button>
        </div>
      </div>

      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold text-orange-400" id="place-rating">...</p>
        <p class="font-semibold text-green-400" id="place-price">...</p>
        <a id="phone-link" href="#" class="text-blue-300 hover:underline text-sm"></a>
      </div>

      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>

      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Map</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hidden">Website</a>
        <button id="share-button" class="flex-1 action-card bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg">Compass</button>
      </div>

      <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
        <button id="try-again-button" class="flex-1 action-card bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Back</button>
        <button id="next-suggestion-button" class="flex-1 action-card bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
      </div>
    </div>
  </section>

  <div id="compass-modal">
    <div id="compass-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-2">
        <h2 id="modal-title" class="font-header text-lg">Live Compass</h2>
        <div class="flex gap-2">
          <button id="guide-button" class="action-card bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg">Guide Me ‚ñ∂Ô∏é</button>
          <button id="close-compass" class="action-card text-white font-bold py-2 px-3 rounded-lg bg-gray-700">Close</button>
        </div>
      </header>
      <div id="nav-bubble">
        <div id="nav-main">Head toward destination</div>
        <div id="nav-sub">Follow the arrow</div>
      </div>
      <div id="compass-overlay">
        <div id="compass-arrow"></div>
        <div id="compass-dist">--</div>
      </div>
    </div>
  </div>

  <script>
    /* ====== SW (non-blocking) ====== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }

    /* ====== Refs ====== */
    const funFactContainer = document.getElementById('fun-fact-container');
    const funFactText = document.getElementById('fun-fact-text');
    const mainScreen = document.getElementById('main-screen');
    const resultsListScreen = document.getElementById('results-list-screen');
    const resultsTitle = document.getElementById('results-title');
    const resultsMeta = document.getElementById('results-meta');
    const resultsList = document.getElementById('results-list');
    const resultScreen = document.getElementById('result-screen');
    const filterContainer = document.getElementById('filter-container');
    const locationStatus = document.getElementById('location-status');
    const panoramaContainer = document.getElementById('panorama-container');
    const panoramaDiv = document.getElementById('panorama');
    const manualLocationEntry = document.getElementById('manual-location-entry');
    const locationInput = document.getElementById('location-input');
    const subMenuContainer = document.getElementById('sub-menu-container');
    const backToMainFiltersButton = document.getElementById('back-to-main-filters');
    const placeNameEl = document.getElementById('place-name');
    const placeRatingEl = document.getElementById('place-rating');
    const placeStarsEl = document.getElementById('place-stars');
    const placePriceEl = document.getElementById('place-price');
    const placePhotoEl = document.getElementById('place-photo');
    const directionsLink = document.getElementById('directions-link');
    const websiteLink = document.getElementById('website-link');
    const placeTypesContainer = document.getElementById('place-types-container');
    const phoneLink = document.getElementById('phone-link');
    const placeAccessibility = document.getElementById('place-accessibility');
    const savePlaceButton = document.getElementById('save-place-button');
    const compassModal = document.getElementById('compass-modal');
    const compassDialog = document.getElementById('compass-dialog');
    const closeCompassBtn = document.getElementById('close-compass');
    const guideButton = document.getElementById('guide-button');
    const navMain = document.getElementById('nav-main');
    const navSub = document.getElementById('nav-sub');
    const compassArrow = document.getElementById('compass-arrow');
    const compassDist = document.getElementById('compass-dist');
    const shareButton = document.getElementById('share-button');
    const randomButton = document.getElementById('random-button');
    // const darkSideButton = document.getElementById('dark-side-button'); // Removed

    /* ====== State ====== */
    let placesService, panorama, geocoder, directionsService;
    let currentUserLocation;
    let currentLocality = '';
    let currentPlace;
    let currentResults = [];
    let savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');
    let localFacts = [], factInterval = null, currentFactIndex = 0;
    let compassActive = false, guideSpeaking = false, watchId = null, headingDeg = 0;
    let routeSteps = [], stepIndex = 0, stepTarget = null, destLatLng = null;

    /* ====== Categories ====== */
    const subFilterMap = {
      eat: {"üçï Surprise Me":{type:"restaurant"},"Italian":{type:"italian_restaurant",keyword:"italian"},"Mexican":{type:"mexican_restaurant",keyword:"mexican"},"Japanese":{type:"japanese_restaurant",keyword:"japanese"},"Chinese":{type:"chinese_restaurant",keyword:"chinese"},"Indian":{type:"indian_restaurant",keyword:"indian"},"Pizza":{type:"pizza_restaurant",keyword:"pizza"},"Cafes":{type:"cafe",keyword:"cafe"},"Desserts":{type:"bakery",keyword:"dessert bakery"}},
      see:{"Museums":{type:"museum"},"Art Galleries":{type:"art_gallery"},"Tourist Attractions":{type:"tourist_attraction"}},
      night:{"Bars":{type:"bar"},"Night Clubs":{type:"night_club"}},
      gems:{"Quirky Shops":{keyword:"vintage store"},"Indie Coffee":{type:"cafe"},"Local Art":{type:"art_gallery"},"Quiet Spots":{type:"park"}},
      pets:{"Dog Park":{type:"park",keyword:"dog"},"Pet Store":{type:"pet_store"},"Veterinarian":{type:"veterinary_care"}},
      utilities:{"Hospital":{type:"hospital"},"Pharmacy":{type:"pharmacy"},"Police":{type:"police"},"Gas Station":{type:"gas_station"},"Car Rental":{type:"car_rental"},"ATM":{type:"atm"}}
      // dark:{} // Removed
    };
    const allowedByCategory = {
      eat:new Set(['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant']),
      night:new Set(['bar','night_club']),
      see:new Set(['museum','art_gallery','tourist_attraction']),
      gems:new Set(['art_gallery','park','cafe']),
      pets:new Set(['park','pet_store','veterinary_care']),
      utilities:new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']),
      // dark:new Set(['cemetery','museum','tourist_attraction']), // Removed
      
      // *** FIX for "Surprise Me" ***
      // Add a 'random' category that includes all allowed 'fun' types
      random: new Set([
        ...['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant'],
        ...['bar','night_club'],
        ...['museum','art_gallery','tourist_attraction'],
        ...['art_gallery','park','cafe']
      ])
    };
    const bannedRetailish = new Set(['grocery_or_supermarket','supermarket','department_store','shopping_mall','convenience_store','store','lodging','hotel']);

    /* ====== Utils ====== */
    const metersToImperial = m => { const ft=m*3.28084; return ft<1000?`${Math.round(ft)} ft`:`${(m*0.000621371).toFixed(1)} mi`; };
    const toggleFilterButtons = d => document.querySelectorAll('#main-screen button').forEach(b=>b.disabled=d);
    const renderStarsHTML = r => { r=Math.round(r||0); let h=''; for(let i=1;i<=5;i++)h+=`<span class="star${i<=r?' filled':''}">‚òÖ</span>${i<5?' ':''}`; return h; };
    const renderStars = (el,r) => el.innerHTML=renderStarsHTML(r);
    const stripHtml = h => { const t=document.createElement('div'); t.innerHTML=h||''; return t.textContent||t.innerText||''; };
    const dedupe = items => { const s=new Set(),o=[]; for(const it of items) if(!s.has(it.place_id)){s.add(it.place_id);o.push(it)} return o; };
    const sortResults = a => a.sort((x,y)=>(y.rating??0)-(x.rating??0)||(y.user_ratings_total??0)-(x.user_ratings_total??0)||(x.distanceMeters??Infinity)-(y.distanceMeters??Infinity)||x.name.localeCompare(y.name));
    
    function isCandidate(p, kw, reqType, allowedSet) {
      const t=new Set(p.types||[]);
      if (![...t].some(x => allowedSet.has(x))) return false;
      for (const x of t) if(bannedRetailish.has(x)) return false;
      if (reqType && !t.has(reqType)) {
        if(!(t.has('restaurant') && kw && new RegExp(kw,'i').test(p.name||''))) return false;
      }
      return true;
    }

    function updateSaveButtonState(){
      const pressed = currentPlace && !!savedPlaces[currentPlace.place_id];
      savePlaceButton.setAttribute('aria-pressed', String(pressed));
      savePlaceButton.textContent = pressed ? '‚òÖ' : '‚òÜ';
    }

    function speak(text){
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(u);
      }catch{}
    }

    /* ====== Local Facts ====== */
    async function getFunFact(coords){
      try{
        funFactText.textContent = "Finding local facts...";
        const geoURL = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=10000&gslimit=10&gscoord=${coords.lat}|${coords.lng}&format=json&origin=*`;
        const geoRes = await fetch(geoURL); const geo = await geoRes.json();
        const ids = (geo?.query?.geosearch||[]).map(p=>p.pageid).slice(0,10);
        if(!ids.length){ funFactText.textContent="No local facts found nearby."; return; }
        const exURL = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${ids.join('|')}&format=json&origin=*`;
        const exRes = await fetch(exURL); const ex = await exRes.json();
        localFacts = Object.values(ex?.query?.pages||{}).map(p=>p.extract).filter(e => e && e.length > 60 && e.length < 280);
        if(localFacts.length) startFactCycling(); else funFactText.textContent="No detailed local facts found.";
      }catch{ funFactText.textContent="Local facts are currently unavailable."; }
    }
    function startFactCycling(){
      if(factInterval) clearInterval(factInterval);
      currentFactIndex=0; funFactText.textContent = localFacts[currentFactIndex] || "No local facts found nearby.";
      if(localFacts.length>1){ factInterval=setInterval(()=>{ currentFactIndex=(currentFactIndex+1)%localFacts.length; funFactText.textContent = localFacts[currentFactIndex]; },7000); }
    }

    /* ====== Results List ====== */
    function showResultsList(parentFilter, subLabel){
      resultsListScreen.style.display='flex'; funFactContainer.style.display='none';
      resultsTitle.textContent=subLabel || 'Results';
      resultsMeta.textContent=currentResults.length?`${currentResults.length} results`:'No results';
      resultsList.innerHTML='';
      currentResults.forEach(p=>{
        // Use placeholder for all list items to save cost
        const photo='https://placehold.co/200x200/111827/fff?text=N/A';
        const rating=p.rating??null; const price=p.price_level?'$'.repeat(p.price_level):''; const vic=p.vicinity||p.formatted_address||'';
        const card=document.createElement('button'); card.className='result-item'; card.dataset.id = p.place_id;
        card.innerHTML=`<img class="result-thumb" loading="lazy" src="${photo}" alt="" /><div class="flex-1 text-left"><div class="flex items-center justify-between"><h3 class="font-semibold text-base text-white">${p.name}</h3><div class="text-xs text-gray-300">${price}</div></div><div class="flex items-center gap-2 mt-1"><div class="star-row">${renderStarsHTML(rating)}</div><div class="text-sm text-orange-300">${rating?rating.toFixed(1):'N/A'}</div><div class="text-xs text-gray-400">(${p.user_ratings_total??0})</div></div><div class="text-xs text-gray-300 mt-1">${vic}</div></div><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.name+', '+(vic||''))}" target="_blank" rel="noopener" class="p-2 rounded-full bg-orange-500 text-white self-center map-link-icon"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></a>`;
        resultsList.appendChild(card);
      });
    }

    /* ====== Search ====== */
    function findAdventure(searchParams,parentFilter,subLabel){
      if(!placesService||!currentUserLocation)return;
      resultsListScreen.style.display='none'; toggleFilterButtons(true); backToMainFiltersButton.disabled=true;
      locationStatus.textContent="Searching nearby..."; currentResults=[];
      const reqType=searchParams.type||null;
      const kw=(parentFilter==='eat')?(searchParams.keyword||(reqType?reqType.replace('_restaurant',''):'')):searchParams.keyword||'';
      const radii=[2000,5000,10000,20000,35000,50000]; let i=0;

      const nearby=()=>{ if(i>=radii.length)return text();
        const radius=radii[i++]; const req={location:currentUserLocation,radius,...(searchParams.type&&{type:searchParams.type}),...(kw&&{keyword:kw})};
        placesService.nearbySearch(req,(res,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK&&res?.length){
            const allowed = allowedByCategory[parentFilter] || new Set();
            const filtered = (p) => isCandidate(p, kw, reqType, allowed);
            currentResults=dedupe([...currentResults,...res.filter(p => filtered(p))]);
            if(currentResults.length<12){locationStatus.textContent=`Searching wider (${metersToImperial(radius)})...`;nearby();} else finalize();
          } else nearby();
        });
      };
      const text=()=>{
        const city=currentLocality||''; const query = kw ? `${kw} in ${city}` : `${subLabel||''} in ${city}`;
        placesService.textSearch({query,location:currentUserLocation,radius:50000},(res,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK&&res?.length){
            const allowed = allowedByCategory[parentFilter] || new Set();
            const filtered = (p) => isCandidate(p, kw, reqType, allowed);
            currentResults=dedupe([...currentResults,...res.filter(p => filtered(p))]);
          } finalize();
        });
      };
      const finalize=()=>{
        currentResults=sortResults(currentResults);
        showResultsList(parentFilter,subLabel);
        toggleFilterButtons(false); backToMainFiltersButton.disabled=false;
      };
      nearby();
    }

    /* ====== Details, Directions, Compass ====== */
    function openDetailsById(placeId){ const s=currentResults.find(r=>r.place_id===placeId); if(s)getPlaceDetails(s); }
    function getPlaceDetails(summary){ 
        resultsListScreen.style.display = 'none';
        resultScreen.style.display='flex';
        funFactContainer.style.display='none';
        panorama.setPosition(summary.geometry.location);
        panoramaContainer.classList.add('shown');
        currentPlace = summary; 
        updateSaveButtonState();
        placeNameEl.textContent = 'Loading Details...';
        placePhotoEl.src=`https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(summary.name)}`;
        placeRatingEl.textContent=''; placeStarsEl.innerHTML=''; placePriceEl.textContent='';
        placeTypesContainer.innerHTML=''; websiteLink.classList.add('hidden');
        phoneLink.textContent=''; phoneLink.removeAttribute('href');
        placeAccessibility.textContent=''; placeAccessibility.style.display='none';
        
        routeSteps=[]; stepIndex=0; stepTarget=null; stopCompass();

        placesService.getDetails({
            placeId:summary.place_id,
            // *** COST-SAVING FIX ***: 'photos' field removed
            fields:['name','rating','user_ratings_total','price_level','website','vicinity','types','formatted_phone_number','geometry','wheelchair_accessible_entrance']
        },(place,status)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK&&place){
                currentPlace=place;
                placeNameEl.textContent=place.name;
                renderStars(placeStarsEl, place.rating??0);
                placeRatingEl.textContent=place.rating?place.rating.toFixed(1):'N/A';
                placePriceEl.textContent=place.price_level?'$'.repeat(place.price_level):'';
                // *** COST-SAVING FIX ***: Photo line commented out
                // if(place.photos?.length) placePhotoEl.src=place.photos[0].getUrl({maxWidth:600,maxHeight:400});
                if(place.website){websiteLink.href=place.website;websiteLink.classList.remove('hidden')}
                if(place.formatted_phone_number){phoneLink.href=`tel:${place.formatted_phone_number}`;phoneLink.textContent=place.formatted_phone_number}
                if(place.wheelchair_accessible_entrance){placeAccessibility.textContent='‚ôø';placeAccessibility.style.display='inline'}
                if(place.types?.length){
                    place.types.filter(t=>!['point_of_interest','establishment'].includes(t)).slice(0,3).forEach(t=>{
                        const s=document.createElement('span'); s.className='place-type-tag'; s.textContent=t.replace(/_/g, ' '); placeTypesContainer.appendChild(s);
                    });
                }
                const dest=`${place.name}, ${place.vicinity||''}`; directionsLink.href=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`;
                buildRouteTo(place.geometry.location);
                updateSaveButtonState();
            }
      });
     }
    
    // *** COMPASS FIX ***: All functions below are now fully implemented.
    function buildRouteTo(latLng){
      destLatLng = latLng;
      if(!currentUserLocation || !directionsService) return;
      directionsService.route({
        origin: currentUserLocation,
        destination: latLng,
        travelMode: 'WALKING'
      }, (response, status) => {
        if (status === 'OK' && response.routes?.[0]?.legs?.[0]?.steps) {
          routeSteps = response.routes[0].legs[0].steps;
          stepIndex = 0;
          setStep(0);
        } else {
          routeSteps = []; // No steps, just point-to-point
          stepTarget = null;
          destLatLng = latLng; // Keep final destination
        }
      });
    }
    function setStep(i){
      if(i >= routeSteps.length) {
        stepTarget = null; // Reached end of steps, fall back to final dest
        navMain.textContent = 'Arrived at destination';
        navSub.textContent = 'Compass pointing to final location.';
        return;
      }
      stepIndex = i;
      const step = routeSteps[i];
      stepTarget = step.end_location;
      navMain.textContent = stripHtml(step.instructions || 'Continue');
      navSub.textContent = `In ${step.distance?.text || '...'} (${step.duration?.text || '...'})`;
      if(guideSpeaking) speak(stripHtml(step.instructions));
    }
    const toRad=d=>d*Math.PI/180, norm=a=>((a%360)+360)%360;
    function bearingFromTo(a,b){
      const œÜ1=toRad(a.lat), Œª1=toRad(a.lng), œÜ2=toRad(b.lat), Œª2=toRad(b.lng);
      const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
      const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
      return norm(Math.atan2(y,x)*180/Math.PI);
    }
    function haversineMeters(a,b){
      const R=6371e3; const œÜ1=toRad(a.lat), œÜ2=toRad(b.lat), ŒîœÜ=toRad(b.lat-a.lat), ŒîŒª=toRad(b.lng-a.lng);
      const x=Math.sin(ŒîœÜ/2)*Math.sin(ŒîœÜ/2)+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)*Math.sin(ŒîŒª/2);
      return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
    }
    function turnHint(delta){
      if(delta<15||delta>345) return 'Straight ahead'; if(delta<45) return 'Slight right'; if(delta<135) return 'Turn right';
      if(delta<225) return 'Turn around'; if(delta<315) return 'Turn left'; return 'Slight left';
    }
    function updateCompassUI(){
      if(!compassActive || !currentUserLocation || !destLatLng) return;
      const target = stepTarget || destLatLng;
      const distM = haversineMeters(currentUserLocation, target.toJSON ? target.toJSON() : target);
      compassDist.textContent = metersToImperial(distM);

      if (stepTarget && distM < 20) { // Check if near step end
        setStep(stepIndex + 1);
        return;
      }

      const bearing = bearingFromTo(currentUserLocation, target.toJSON ? target.toJSON() : target);
      const delta = norm(bearing - headingDeg);
      compassArrow.style.transform = `rotate(${delta}deg)`;
      
      if(!stepTarget) { // Only update nav text if in point-to-point mode
        navMain.textContent = `Head ${turnHint(delta)}`;
        navSub.textContent = `Pointing to ${currentPlace?.name || 'destination'}`;
      }
    }
    function onOrientation(e){
      let heading = e.webkitCompassHeading; // iOS
      if (typeof heading === 'undefined') {
        heading = e.alpha; // Android
        if (typeof heading !== 'number' || isNaN(heading)) return;
        heading = norm(360 - heading); // 'alpha' is 0 at North, but rotates clockwise.
      }
      headingDeg = heading;
      updateCompassUI();
    }
    function openCompass(){
      if(!destLatLng) { alert('No destination set.'); return; }
      compassModal.style.display = 'flex';
      compassDialog.focus();
      startCompass();
    }
    function closeCompass(){
      compassModal.style.display = 'none';
      stopCompass();
    }
    function trapCompassTab(e){
      if (e.key !== 'Tab') return;
      const focusable = compassDialog.querySelectorAll('button');
      const first = focusable[0], last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        last.focus(); e.preventDefault();
      } else if (!e.shiftKey && document.activeElement === last) {
        first.focus(); e.preventDefault();
      }
    }
    function startCompass(){
      if(compassActive) return;
      compassActive = true;
      if ('ondeviceorientationabsolute' in window) {
        window.addEventListener('deviceorientationabsolute', onOrientation);
      } else if ('ondeviceorientation' in window) {
        window.addEventListener('deviceorientation', onOrientation);
      }
      if(navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(pos => {
          currentUserLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          updateCompassUI();
        }, null, {enableHighAccuracy: true});
      }
      compassDialog.addEventListener('keydown', trapCompassTab);
    }
    function stopCompass(){
      compassActive = false;
      window.removeEventListener('deviceorientationabsolute', onOrientation);
      window.removeEventListener('deviceorientation', onOrientation);
      if(watchId) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      guideSpeaking = false;
      guideButton.textContent = 'Guide Me ‚ñ∂Ô∏é';
      try { speechSynthesis.cancel(); } catch {}
      compassDialog.removeEventListener('keydown', trapCompassTab);
    }
    
    /* ====== Init / Geocode ====== */
    function initApp(){
      panorama=new google.maps.StreetViewPanorama(panoramaDiv,{addressControl:false,showRoadLabels:false,linksControl:false,panControl:false,enableCloseButton:false,fullscreenControl:false,zoomControl:false});
      placesService=new google.maps.places.PlacesService(document.createElement('div'));
      geocoder=new google.maps.Geocoder();
      directionsService=new google.maps.DirectionsService();
      toggleFilterButtons(true);
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const coords={lat:pos.coords.latitude,lng:pos.coords.longitude};
          reverseGeocodeSetLocation(coords);
        }, handleLocationError);
      } else handleLocationError();
    }
    window.initApp=initApp;

    function handleLocationError(){
      locationStatus.textContent="Couldn't get your location. Please enter one manually.";
      manualLocationEntry.classList.remove('hidden');
      getFunFact({lat:51.5074,lng:-0.1278});
      toggleFilterButtons(false);
    }
    function reverseGeocodeSetLocation(coords){
      geocoder.geocode({location:coords},(results,status)=>{
        let label="Your Current Location"; currentLocality='';
        if(status==='OK'&&results?.[0]){
          const c=results[0].address_components||[];
          const city=c.find(x=>x.types.includes('locality'))?.long_name||c.find(x=>x.types.includes('postal_town'))?.long_name||c.find(x=>x.types.includes('sublocality'))?.long_name;
          const state=c.find(x=>x.types.includes('administrative_area_level_1'))?.short_name;
          if(city&&state) currentLocality=`${city}, ${state}`;
          label=results[0].formatted_address.split(',').slice(0,2).join(',');
        }
        setLocationAndEnableApp(coords,label);
      });
    }
    function geocodeLocation(){
      const address=locationInput.value.trim(); if(!address) return;
      locationStatus.textContent=`Searching for "${address}"...`;
      geocoder.geocode({address},(results,status)=>{
        if(status==='OK'&&results?.[0]){
          const loc=results[0].geometry.location;
          reverseGeocodeSetLocation({lat:loc.lat(),lng:loc.lng()});
        } else locationStatus.textContent=`Could not find "${address}". Please try again.`;
      });
    }
    function setLocationAndEnableApp(coords,label){
      currentUserLocation=coords;
      locationStatus.textContent=`Exploring: ${label}`;
      manualLocationEntry.classList.add('hidden');
      toggleFilterButtons(false);
      getFunFact(coords);
      funFactContainer.style.display='block';
    }

    /* ====== UI & Events ====== */
    function showSubMenu(filter){
      filterContainer.classList.add('hidden'); randomButton.classList.add('hidden'); 
      // darkSideButton.style.display='none'; // Removed
      subMenuContainer.innerHTML=''; const sub=subFilterMap[filter]; const grid=document.createElement('div'); grid.className='grid grid-cols-2 gap-4 sub-menu';
      for(const name in sub){const b=document.createElement('button'); b.textContent=name; b.dataset.name=name; b.dataset.parent=filter; b.className='action-card rounded-lg font-bold py-3 text-base'; grid.appendChild(b);}
      subMenuContainer.appendChild(grid); subMenuContainer.classList.remove('hidden'); backToMainFiltersButton.classList.remove('hidden');
    }
    function hideSubMenu(){
        subMenuContainer.classList.add('hidden'); 
        backToMainFiltersButton.classList.add('hidden'); 
        filterContainer.classList.remove('hidden'); 
        randomButton.classList.remove('hidden'); 
        // darkSideButton.style.display='block'; // Removed
    }
    function findRandomAdventure() {
        const randomizableFilters = { ...subFilterMap };
        // 'dark' removed from this list
        ['utilities', 'pets'].forEach(f => delete randomizableFilters[f]);
        const allFilters = Object.values(randomizableFilters).flatMap(obj => Object.values(obj));
        hideSubMenu();
        findAdventure(allFilters[Math.floor(Math.random() * allFilters.length)], "random", "Surprise Me!");
    }
    function resetApp(hide=true){
      closeCompass();
      resultScreen.style.display='none'; resultsListScreen.style.display='none';
      mainScreen.classList.remove('hidden');
      funFactContainer.style.display='block';
      hideSubMenu(); toggleFilterButtons(false); backToMainFiltersButton.disabled=false;
      if(currentUserLocation) locationStatus.textContent='Location set! Where to next?';
      if(hide) panoramaContainer.classList.remove('shown');
    }

    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('button'); if(!btn||btn.disabled) return;
      if (e.target.closest('.map-link-icon')) return;

      if(btn.matches('#filter-container > button[data-filter]')){showSubMenu(btn.dataset.filter);return;}
      if(btn.closest('.sub-menu') && btn.dataset.name){
        const name=btn.dataset.name, parent=btn.dataset.parent;
        let params=subFilterMap[parent][name];
        if(parent==='eat' && name==='üçï Surprise Me'){const food=Object.values(subFilterMap.eat).filter(f=>f.type&&f.type.endsWith('_restaurant')); params=food[Math.floor(Math.random()*food.length)];}
        findAdventure(params,parent,name); return;
      }
      if(btn.classList.contains('result-item')){ openDetailsById(btn.dataset.id); return;}

      switch(btn.id){
        // case 'dark-side-button': showSubMenu('dark'); break; // Removed
        case 'back-to-main-filters': hideSubMenu(); break;
        case 'close-results-button': resultsListScreen.style.display='none'; funFactContainer.style.display='block'; break;
        case 'try-again-button': resetApp(); break;
        case 'search-button': geocodeLocation(); break;
        case 'random-button': findRandomAdventure(); break;
        case 'next-suggestion-button':
          if(currentResults.length){const idx=currentResults.findIndex(r=>r.place_id===(currentPlace?.place_id||'')); const next=currentResults[(idx+1)%currentResults.length]; if(next) getPlaceDetails(next);}
          break;
        case 'save-place-button': if(currentPlace) { if(savedPlaces[currentPlace.place_id]) delete savedPlaces[currentPlace.place_id]; else savedPlaces[currentPlace.place_id]={name:currentPlace.name,vicinity:directionsLink.href}; localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces)); updateSaveButtonState(); } break;
        case 'compass-button': openCompass(); break;
        case 'close-compass': closeCompass(); break;
        case 'guide-button':
          guideSpeaking = !guideSpeaking;
          guideButton.textContent = guideSpeaking ? 'Pause ‚è∏' : 'Guide Me ‚ñ∂Ô∏é';
          if(guideSpeaking){
            if(routeSteps.length && stepIndex < routeSteps.length){ const st=routeSteps[stepIndex]; const text=stripHtml(st.instructions||'Continue'); const dist=st.distance?.text||''; speak(`${text}${dist?'. '+dist:''}`); } 
            else if(currentPlace){ speak(`Head toward ${currentPlace.name}`); }
          } else { try{ speechSynthesis.cancel(); }catch{} }
          break;
        case 'share-button': if (navigator.share && currentPlace) { navigator.share({ title: currentPlace.name, text: `Check out this place I found: ${currentPlace.name}`, url: directionsLink.href, });} break;
      }
    });

    document.getElementById('location-input').addEventListener('keyup',e=>{if(e.key==='Enter') geocodeLocation();});
  </script>
</body>
</html>
