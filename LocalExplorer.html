<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Local Explorer" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />

  <title>Local Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {font-family:'Raleway',sans-serif;background:#f8f7f2;}
    h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
    #panorama{position:absolute;inset:0;z-index:1}
    .action-card{background:#111827;color:#f8f7f2;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .action-card:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .action-card:disabled{opacity:.6;cursor:not-allowed}
    #result-card{background:rgba(17,24,39,.92);color:#f8f7f2;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      transition:transform .4s ease,opacity .3s ease;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2)}
    .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);
      padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}
    #dark-side-button{position:fixed;bottom:1rem;left:1rem;font-size:1.5rem;opacity:.35;transition:.2s;cursor:pointer;z-index:20}
    #dark-side-button:hover{opacity:1}
  </style>
</head>
<body class="text-gray-900 flex flex-col items-center justify-center min-h-screen p-4">

  <div id="panorama-container" class="fixed inset-0">
    <div id="panorama"></div>
  </div>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center">
    <section id="main-screen">
      <h1 class="text-4xl font-header font-bold text-gray-900 mb-4">Local Explorer</h1>
      <p id="location-status" class="text-lg font-semibold text-gray-700 my-4">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" placeholder="Enter a city or place" class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none">
          <button id="search-button" class="action-card bg-orange-500 text-white p-3 rounded-r-lg">ğŸ”</button>
        </div>
      </div>

      <nav id="filter-container" class="grid grid-cols-2 gap-4">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ½ï¸ Foodie Finds</button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ›ï¸ Iconic Sights</button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸŒ™ Night Out</button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ’ Hidden Gems</button>
        <button data-filter="outdoor" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸï¸ Outdoors</button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ¾ Pet Friendly</button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ› ï¸ Utilities</button>
        <button id="donate-button" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">â¤ï¸ Donate</button>
      </nav>

      <button id="random-button" class="action-card w-full mt-4 rounded-lg font-bold py-3 text-base bg-orange-500 text-white">ğŸ¤· Surprise Me!</button>
      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden mt-4 text-gray-600 underline">Back to main filters</button>
    </section>
  </main>

  <button id="dark-side-button" data-filter="dark">ğŸ‘»</button>

  <!-- Results -->
  <section id="results-list-screen" class="hidden fixed inset-0 z-20 flex flex-col justify-end items-center p-4">
    <div id="results-list" class="bg-gray-900 p-4 rounded-lg shadow-lg w-full max-w-lg text-stone-100 space-y-2 overflow-y-auto"></div>
    <button id="close-results-button" class="mt-4 action-card bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
  </section>

  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./serviceworker.js').catch(err => console.log('SW failed:', err));
    });
  }

  const locationStatus=document.getElementById('location-status');
  const filterContainer=document.getElementById('filter-container');
  const subMenuContainer=document.getElementById('sub-menu-container');
  const backToMainFiltersButton=document.getElementById('back-to-main-filters');
  const resultsList=document.getElementById('results-list');
  const resultsListScreen=document.getElementById('results-list-screen');
  const randomButton=document.getElementById('random-button');

  let placesService,geocoder,currentUserLocation,currentLocality='';

  const subFilterMap={
    eat:{ "ğŸ• Surprise Me":{type:"restaurant"}, "Italian":{type:"italian_restaurant"}, "Mexican":{type:"mexican_restaurant"},
          "Japanese":{type:"japanese_restaurant"}, "Chinese":{type:"chinese_restaurant"}, "Indian":{type:"indian_restaurant"},
          "Pizza":{type:"pizza_restaurant"}, "Cafes":{type:"cafe"}, "Desserts":{type:"bakery"} },
    see:{ "Museums":{type:"museum"}, "Art Galleries":{type:"art_gallery"}, "Tourist Attractions":{type:"tourist_attraction"} },
    night:{ "Bars":{type:"bar"}, "Night Clubs":{type:"night_club"} },
    gems:{ "Quirky Shops":{keyword:"vintage store"}, "Indie Coffee":{type:"cafe"}, "Local Art":{type:"art_gallery"}, "Quiet Spots":{type:"park"} },
    outdoor:{ "Hikes":{type:"park",keyword:"trail hiking"}, "Beaches":{type:"tourist_attraction",keyword:"beach"},
              "Waterfalls":{type:"tourist_attraction",keyword:"waterfall"}, "Scenic Overlooks":{type:"tourist_attraction",keyword:"scenic overlook"},
              "Lakes":{type:"tourist_attraction",keyword:"lake"}, "Playgrounds":{type:"park",keyword:"playground"} },
    pets:{ "Dog Park":{type:"park",keyword:"dog"}, "Pet Store":{type:"pet_store"}, "Veterinarian":{type:"veterinary_care"} },
    utilities:{ "Hospital":{type:"hospital"}, "Pharmacy":{type:"pharmacy"}, "Police":{type:"police"},
                "Gas Station":{type:"gas_station"}, "Car Rental":{type:"car_rental"}, "ATM":{type:"atm"} },
    dark:{ "Cemeteries":{type:"cemetery"}, "Haunted Tours":{type:"tourist_attraction",keyword:"ghost tour haunted tour"},
           "Haunted Sites":{type:"tourist_attraction",keyword:"haunted site haunted house"},
           "Crime Museums":{type:"museum",keyword:"crime history museum"} }
  };

  const allowedByCategory={
    eat:new Set(["restaurant","cafe","bakery","meal_takeaway"]),
    see:new Set(["museum","art_gallery","tourist_attraction"]),
    night:new Set(["bar","night_club"]),
    gems:new Set(["art_gallery","park","cafe"]),
    outdoor:new Set(["park","tourist_attraction","natural_feature","campground"]),
    pets:new Set(["park","pet_store","veterinary_care"]),
    utilities:new Set(["hospital","pharmacy","police","gas_station","car_rental","atm"]),
    dark:new Set(["cemetery","museum","tourist_attraction"])
  };

  const bannedRetailish=new Set(["grocery_or_supermarket","department_store","shopping_mall","convenience_store","store","lodging","hotel"]);
  function darkNameOk(p){const n=(p.name||'').toLowerCase();const k=["haunted","ghost","cemeter","crypt","mausoleum","memorial","crime","noir","macabre","tour"];return k.some(x=>n.includes(x));}
  function filterByCategory(results,parent){const allow=allowedByCategory[parent];return(results||[]).filter(p=>{
    const t=new Set(p.types||[]);if(![...t].some(x=>allow.has(x)))return false;
    if(parent==='dark'){if(t.has('cemetery'))return true;return darkNameOk(p);}
    for(const x of t)if(bannedRetailish.has(x))return false;
    return true;
  });}

  function metersToMiles(m){return (m*0.000621371).toFixed(1)+' mi';}

  function initApp(){
    placesService=new google.maps.places.PlacesService(document.createElement('div'));
    geocoder=new google.maps.Geocoder();
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const coords={lat:pos.coords.latitude,lng:pos.coords.longitude};
        currentUserLocation=coords;locationStatus.textContent="Location set!";
      },()=>{locationStatus.textContent="Enter location manually";});
    }
  }
  window.initApp=initApp;

  function findAdventure(search,parent){
    if(!placesService||!currentUserLocation)return;
    const req={location:currentUserLocation,radius:15000,...search};
    placesService.nearbySearch(req,(res,status)=>{
      if(status!=='OK'||!res.length){alert("No results");return;}
      const filtered=filterByCategory(res,parent);
      showResults(filtered);
    });
  }

  function showResults(list){
    resultsList.innerHTML="";
    list.forEach(p=>{
      const photo=(p.photos&&p.photos[0])?p.photos[0].getUrl({maxWidth:200,maxHeight:200}):"https://placehold.co/200x200";
      const card=document.createElement('div');
      card.className="p-2 bg-gray-800 rounded-lg flex gap-3 items-center";
      card.innerHTML=`<img src="${photo}" class="w-20 h-20 object-cover rounded-md"/><div class="flex-1 text-left"><p class="font-semibold">${p.name}</p><p class="text-sm text-gray-400">${p.vicinity||""}</p><p class="text-xs text-yellow-400">${p.rating?"â˜… "+p.rating:""}</p></div>`;
      resultsList.appendChild(card);
    });
    resultsListScreen.classList.remove("hidden");
  }

  document.addEventListener('click',e=>{
    const btn=e.target.closest('button');if(!btn)return;
    if(btn.matches('#filter-container button[data-filter]')){showSubMenu(btn.dataset.filter);return;}
    if(btn.closest('.sub-menu')){const f=btn.dataset.parent;findAdventure(subFilterMap[f][btn.dataset.name],f);return;}
    if(btn.id==='close-results-button'){resultsListScreen.classList.add('hidden');}
  });

  function showSubMenu(f){filterContainer.classList.add('hidden');subMenuContainer.innerHTML='';
    const sub=subFilterMap[f];const grid=document.createElement('div');grid.className='grid grid-cols-2 gap-4 sub-menu';
    for(const name in sub){const b=document.createElement('button');b.textContent=name;b.dataset.name=name;b.dataset.parent=f;b.className='action-card rounded-lg font-bold py-3 text-base';grid.appendChild(b);}
    subMenuContainer.appendChild(grid);subMenuContainer.classList.remove('hidden');backToMainFiltersButton.classList.remove('hidden');
  }
  backToMainFiltersButton.onclick=()=>{subMenuContainer.classList.add('hidden');filterContainer.classList.remove('hidden');backToMainFiltersButton.classList.add('hidden');};

  </script>
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places&callback=initApp"></script>
</body>
</html>
