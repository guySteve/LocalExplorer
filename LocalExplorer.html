<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" id="theme-color-meta" content="#0A192F" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Local Explorer" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" /> <title>Local Explorer</title>

    <script src="./key.js"></script>
    <script>
      // Load API key securely and provide fallback
      const GKEY = window.MAPS_API_KEY || 'MISSING_API_KEY';
      if (GKEY === 'MISSING_API_KEY') {
        console.error("CRITICAL: Google Maps API Key is missing in key.js!");
        // Optionally display an error to the user here
      }
      document.write(`<script src="https://maps.googleapis.com/maps/api/js?key=${GKEY}&libraries=places,geocoding,directions&callback=initApp" async defer><\/script>`);
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        :root { /* Day Ops theme variables */
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #ffffff; --card-text: #111827; --card-bg-subtle: #e5e7eb;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #4f46e5;
          --modal-bg: rgba(255, 255, 255, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(255, 255, 255, 0.85); --list-card-bg: rgba(248, 247, 242, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="day-ops"] { /* Explicit Day Ops */
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #ffffff; --card-text: #111827; --card-bg-subtle: #e5e7eb;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #4f46e5;
          --modal-bg: rgba(255, 255, 255, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(255, 255, 255, 0.85); --list-card-bg: rgba(248, 247, 242, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="rugged-explorer"] { /* Default Theme */
          --bg: #0A192F; --text: #CCD6F6; --text-subtle: #8892B0;
          --card-bg: #112240; --card-text: #CCD6F6; --card-bg-subtle: #0A192F;
          --accent: #64FFDA; --accent-alt: #f59e0b; --accent-dark: #4DA89A;
          --modal-bg: rgba(10, 25, 47, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(17, 34, 64, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }
        [data-theme="night-ops"] {
          --bg: #111111; --text: #E0E0E0; --text-subtle: #9E9E9E;
          --card-bg: #1F1F1F; --card-text: #E0E0E0; --card-bg-subtle: #000000;
          --accent: #FF4136; --accent-alt: #F012BE; --accent-dark: #B10000;
          --modal-bg: rgba(20, 20, 20, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(31, 31, 31, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body{font-family:'Raleway',sans-serif; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s;}
        h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
        .pt-safe{padding-top: calc(1rem + env(safe-area-inset-top));}
        .pb-safe{padding-bottom: calc(1rem + env(safe-area-inset-bottom));}

        .action-card{ background: var(--card-bg); color: var(--card-text); transition: transform 0.2s, box-shadow 0.2s, background 0.3s, color 0.3s; box-shadow: 0 4px 12px var(--shadow-color); cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .action-card:hover:not(:disabled){transform:translateY(-2px); box-shadow:0 8px 20px var(--shadow-color)}
        .action-card:active:not(:disabled){transform:translateY(0) scale(.98)}
        .action-card:disabled{opacity:.4;cursor:not-allowed}

        .card-accent{ background: var(--accent); color: var(--card-bg) !important; /* Ensure text color overrides theme */}
        .card-accent:hover:not(:disabled){ background: var(--accent); opacity: 0.9; }
        .card-accent-alt{ background: var(--accent-alt); color: var(--card-bg) !important; }
        .card-accent-dark{ background: var(--accent-dark); color: var(--card-text) !important; }

        #result-card{ background: var(--modal-bg); color: var(--card-text); backdrop-filter: var(--modal-blur); -webkit-backdrop-filter: var(--modal-blur); transition:transform .4s ease,opacity .3s ease;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2) }
        .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}
        .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

        .list-screen{position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem; background: var(--list-bg); backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        .list-card{background: var(--list-card-bg); color: var(--card-text); border-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:auto}
        .result-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.75rem;display:flex;gap:.75rem; cursor: pointer;}
        .result-item:hover{background: rgba(255,255,255,0.1);}

        .modal-base{position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);}
        .modal-dialog{width: min(92vw, 440px); background: var(--list-card-bg); color: var(--card-text); border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); padding:16px; outline:none;}

        #nav-bubble{position:relative;margin: 8px 0 12px 0;padding:.6rem .75rem;font-size:13px;line-height:1.25; box-shadow:0 10px 24px rgba(0,0,0,.35);background:radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%); border:1px solid rgba(255,255,255,.12)}
        #nav-main{font-weight:700;letter-spacing:.2px} #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
        #compass-overlay{width:240px;height:240px;border-radius:22px;margin: 6px auto 10px auto; padding: 18px; position:relative; background: radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%), conic-gradient(from 0deg, var(--accent), rgba(245,158,11,.1) 30%, var(--accent-alt), rgba(16,185,129,.12) 75%, var(--accent)); border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06); display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden}
        #compass-arrow{width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:44px solid var(--accent); transform-origin:50% 90%;filter:drop-shadow(0 6px 8px var(--accent));margin-bottom:8px}
        #compass-dist{font-size:14px;font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}

        #settings-modal .modal-dialog { padding: 20px; }
        .theme-button { border: 2px solid var(--card-bg-subtle); padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .theme-button.active { border-color: var(--accent); box-shadow: 0 0 10px -2px var(--accent); }
        #voice-selector { background: var(--card-bg); color: var(--card-text); border: 1px solid var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; width: 100%; cursor: pointer; appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1em; padding-right: 2.5rem; }

        .review-item { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); border-radius: .9rem; padding: .75rem 1rem; }
        .review-sort-button { background: var(--card-bg-subtle); color: var(--card-text); padding: 8px 12px; border-radius: 8px; font-weight: 600; opacity: 0.7; cursor: pointer; }
        .review-sort-button.active { background: var(--accent); color: var(--card-bg) !important; opacity: 1; } /* Ensure text color override */
        #reviews-list-card .flex-container { display: flex; gap: 1rem; }
        #review-star-filter-container { display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-start; }
        .review-star-button { background: none; border: none; font-size: 0.9rem; padding: 2px 0; opacity: 0.6; cursor: pointer; color: var(--accent); text-align: left; line-height: 1.2; }
        .review-star-button .count { font-size: 0.7rem; color: var(--text-subtle); margin-left: 4px; }
        .review-star-button.active { opacity: 1; font-weight: bold; }
        #clear-star-filter { font-size: 0.75rem; font-weight: bold; opacity: 0.8; color: var(--text-subtle); margin-top: 4px; }
        #reviews-list { flex: 1; max-height: calc(60vh - 40px); overflow-y: auto; }

        #fun-fact-container { background: var(--card-bg); color: var(--text); border-radius: 1rem; padding: 1rem; box-shadow: 0 4px 12px var(--shadow-color); text-align: left; margin-bottom: 1.5rem; }
        #fun-fact-container h2 { color: var(--accent); font-family: 'Poppins', sans-serif; font-weight: 700; margin-bottom: 0.25rem; font-size: 0.875rem; letter-spacing: 0.05em; text-transform: uppercase; }
        #fun-fact-text { color: var(--text-subtle); border-top: 2px solid var(--card-bg-subtle); padding-top: 0.5rem; font-size: 0.875rem; }

        #searching-modal { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        #searching-dialog { background: var(--list-card-bg); color: var(--card-text); border-radius: 1.5rem; padding: 2.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
        #searching-dialog-icon { font-size: 3.5rem; animation: spin 2s linear infinite; }
        #searching-dialog-text { font-size: 1.25rem; font-family: 'Poppins', sans-serif; font-weight: 700; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pt-safe pb-safe">

  <button id="settings-button" class="action-card rounded-full fixed top-4 right-4 z-30 w-12 h-12 flex items-center justify-center text-2xl" aria-label="Settings">⚙️</button>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center" role="main" aria-live="polite">
    <section id="main-screen" aria-labelledby="app-title">
      <h1 id="app-title" class="text-4xl md:text-5xl font-header font-bold mb-4" style="color: var(--text);">Local Explorer</h1>
      <section id="fun-fact-container"> <h2>Local Fact</h2> <p id="fun-fact-text">Loading...</p> </section>
      <p id="location-status" class="text-lg font-semibold my-4" style="color: var(--text-subtle);">Please allow location access...</p>
      <div id="manual-location-entry" class="hidden mb-6"> <div class="flex items-center bg-white rounded-lg shadow-md"> <input type="text" id="location-input" inputmode="search" placeholder="Enter a city or place" class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" /> <button id="search-button" class="action-card card-accent text-white p-3 rounded-r-lg" aria-label="Search">🔍</button> </div> </div>
      <nav id="filter-container" class="grid grid-cols-3 gap-3"> <button data-filter="eat" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🍽️<span class="mt-1">Foodie Finds</span></button> <button data-filter="see" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🏛️<span class="mt-1">Iconic Sights</span></button> <button data-filter="night" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🌙<span class="mt-1">Night Out</span></button> <button data-filter="outdoors" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🏞️<span class="mt-1">Outdoors</span></button> <button data-filter="gems" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">💎<span class="mt-1">Hidden Gems</span></button> <button data-filter="pets" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🐾<span class="mt-1">Pet Friendly</span></button> <button data-filter="utilities" class="action-card rounded-lg font-bold py-4 text-sm col-span-3">🛠️ Utilities & Help</button> </nav>
      <button id="show-saved-button" class="action-card card-accent-alt w-full mt-4 rounded-lg font-bold py-3 text-base">⭐ My Saved Places</button> <button id="local-events-button" class="action-card card-accent-dark w-full mt-4 rounded-lg font-bold py-3 text-base">🎟️ Local Events</button> <button id="random-button" class="action-card card-accent w-full mt-4 rounded-lg font-bold py-3 text-base">🤷 Surprise Me!</button>
      <div id="sub-menu-container" class="hidden mt-4"></div> <button id="back-to-main-filters" class="hidden action-card w-full mt-4 rounded-lg font-bold py-3 text-base" style="background: var(--card-bg-subtle);">← Back to Main Menu</button>
    </section>
  </main>

   <section id="results-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;"> <div id="results-list-card" class="list-card"> <div class="flex items-center justify-between mb-3"> <h2 id="results-title" class="text-xl font-header font-bold">Results</h2> <button id="close-results-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button> </div> <div id="results-meta" class="text-sm opacity-80 mb-3"></div> <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div> </div> </section>
   <section id="saved-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;"> <div id="saved-list-card" class="list-card"> <div class="flex items-center justify-between mb-3"> <h2 id="saved-title" class="text-xl font-header font-bold">My Saved Places</h2> <button id="close-saved-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button> </div> <div id="saved-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div> </div> </section>
   <section id="events-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;"> <div id="events-list-card" class="list-card"> <div class="flex items-center justify-between mb-3"> <h2 id="events-title" class="text-xl font-header font-bold">Local Events</h2> <button id="close-events-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button> </div> <div class="text-xs opacity-60 text-center mb-2 -mt-2"> Events provided by <a href="https://ticketmaster.com" target="_blank" rel="noopener" class="underline">Ticketmaster</a> </div> <div id="events-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div> </div> </section>
   <section id="reviews-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
     <div id="reviews-list-card" class="list-card">
       <div class="flex items-center justify-between mb-3">
         <h2 id="reviews-title" class="text-xl font-header font-bold">Reviews</h2>
         <button id="close-reviews-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
       </div>
       <p id="review-date-filter-info" class="text-xs opacity-70 text-center mb-2 -mt-2"></p>
       <div id="review-filters-container" class="mb-3">
         <div id="review-sort-container" class="flex gap-2 mb-3">
           <button id="sort-reviews-best" class="review-sort-button flex-1">Best</button>
           <button id="sort-reviews-worst" class="review-sort-button flex-1">Worst</button>
           <button id="sort-reviews-recent" class="review-sort-button flex-1 active">Recent</button>
         </div>
         <div class="flex-container">
           <div id="review-star-filter-container" class="flex flex-col gap-1 items-start pr-3">
             </div>
           <div id="reviews-list" class="space-y-2 flex-1 overflow-y-auto"></div>
         </div>
       </div>
     </div>
   </section>

   <section id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;"> <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center"> <img id="place-photo" loading="lazy" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Place photo" class="w-full h-32 object-cover rounded-lg mb-4" style="background-color: var(--card-bg);" /> <div class="flex justify-between items-start"> <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2> <div class="flex items-center gap-2"> <span id="place-accessibility" class="text-2xl"></span> <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform" aria-pressed="false">☆</button> </div> </div> <div class="flex justify-center items-center gap-3 text-base my-2"> <div class="star-row" id="place-stars"></div> <p class="font-semibold" style="color: var(--accent);" id="place-rating">...</p> <p class="font-semibold" style="color: var(--accent-alt);" id="place-price">...</p> <a id="phone-link" href="#" class="hover:underline text-sm" style="color: var(--text-subtle);"></a> </div> <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div> <button id="show-reviews-button" class="action-card card-accent-dark w-full mt-3 mb-4 rounded-lg font-bold py-3 text-base" disabled> Show Reviews (0) </button> <div class="flex flex-wrap justify-center gap-3 my-4"> <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card card-accent font-bold py-3 px-4 rounded-lg">Map</a> <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card font-bold py-3 px-4 rounded-lg hidden" style="background: var(--card-bg-subtle);">Website</a> <button id="share-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Share</button> <button id="compass-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Compass</button> </div> <div id="result-buttons-container" class="w-full max-w-md flex gap-4"> <button id="try-again-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl" style="background: var(--card-bg-subtle);">Back</button> <button id="next-suggestion-button" class="flex-1 action-card card-accent-dark font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button> </div> </div> </section>

   <div id="compass-modal" class="modal-base"> <div id="compass-dialog" class="modal-dialog" tabindex="-1"> <header class="flex items-center justify-between mb-2"> <h2 id="modal-title" class="font-header text-lg">Live Compass</h2> <div class="flex gap-2"> <button id="guide-button" class="action-card card-accent-dark font-bold py-2 px-3 rounded-lg">Guide Me ▶︎</button> <button id="close-compass" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button> </div> </header> <div id="nav-bubble"> <div id="nav-main">Head toward destination</div> <div id="nav-sub">Follow the arrow</div> </div> <div id="compass-overlay"> <div id="compass-arrow"></div> <div id="compass-dist">--</div> </div> </div> </div>

   <div id="settings-modal" class="modal-base"> <div id="settings-dialog" class="modal-dialog" tabindex="-1"> <header class="flex items-center justify-between mb-4"> <h2 class="font-header text-xl">Settings</h2> <button id="close-settings-button" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button> </header> <div class="space-y-4"> <div> <h3 class="font-semibold mb-2">Theme</h3> <div class="grid grid-cols-3 gap-2"> <button class="theme-button flex-1" data-theme="day-ops">☀️ Day Ops</button> <button class="theme-button flex-1" data-theme="rugged-explorer">⚓ Rugged</button> <button class="theme-button flex-1" data-theme="night-ops">🌙 Night Ops</button> </div> </div> <div> <h3 class="font-semibold mb-2">Guide Voice</h3> <select id="voice-selector"> <option value="">Loading voices...</option> </select> </div> <a id="donate-button" href="https://venmo.com/u/Stephen-Mohamed-1" target="_blank" rel="noopener" class="action-card card-accent-alt font-bold py-3 px-4 rounded-lg w-full block text-center"> Buy me a coffee (Venmo) </a> <p id="app-version" class="text-center text-xs opacity-60 mt-4">App Version 14.0</p> </div> </div> </div>

  <div id="searching-modal"> <div id="searching-dialog"> <div id="searching-dialog-icon">🧭</div> <div id="searching-dialog-text">Acquiring Target...</div> </div> </div>

  <script>
    /* ====== IMMEDIATE SETTINGS LOAD ====== */
    function loadSettingsImmediate() { console.log('DEBUG: loadSettingsImmediate called.'); let theme, voiceURI, places; try { theme = localStorage.getItem('appTheme') || 'rugged-explorer'; console.log('DEBUG: Immediate theme read from localStorage:', theme); document.documentElement.dataset.theme = theme; console.log('DEBUG: Immediate theme applied to document:', theme); } catch (e) { console.error('DEBUG: Error reading appTheme immediately:', e); theme = 'rugged-explorer'; document.documentElement.dataset.theme = theme; } try { voiceURI = localStorage.getItem('appVoice') || null; currentVoiceURI = voiceURI; console.log('DEBUG: Immediate voice URI loaded:', currentVoiceURI); } catch (e) { console.error('DEBUG: Error reading appVoice immediately:', e); currentVoiceURI = null; } try { const placesJson = localStorage.getItem('savedPlaces') || '{}'; console.log('DEBUG: Immediate saved places JSON read:', placesJson.substring(0, 100) + '...'); places = JSON.parse(placesJson); savedPlaces = places; console.log('DEBUG: Immediate saved places loaded:', Object.keys(savedPlaces).length, 'items'); } catch (e) { console.error("DEBUG: Error loading/parsing saved places immediately:", e); savedPlaces = {}; try { localStorage.setItem('savedPlaces', '{}'); console.log('DEBUG: Cleared potentially corrupted savedPlaces in localStorage.'); } catch (e2) { console.error('DEBUG: Failed to clear corrupted savedPlaces:', e2); } } }
    let savedPlaces = {}; let currentVoiceURI = null; loadSettingsImmediate();

    /* ====== SW Registration ====== */
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker-v2.js') .then(reg => { console.log('Service worker v2 registered!', reg); reg.update(); console.log('Service worker update check triggered.'); }).catch(err => { console.error('Service worker v2 registration failed:', err); }); }); }

    /* ====== Refs ====== */
    const funFactContainer = document.getElementById('fun-fact-container'); const funFactText = document.getElementById('fun-fact-text'); const mainScreen = document.getElementById('main-screen'); const resultsListScreen = document.getElementById('results-list-screen'); const resultsTitle = document.getElementById('results-title'); const resultsMeta = document.getElementById('results-meta'); const resultsList = document.getElementById('results-list'); const resultScreen = document.getElementById('result-screen'); const filterContainer = document.getElementById('filter-container'); const locationStatus = document.getElementById('location-status'); const manualLocationEntry = document.getElementById('manual-location-entry'); const locationInput = document.getElementById('location-input'); const subMenuContainer = document.getElementById('sub-menu-container'); const backToMainFiltersButton = document.getElementById('back-to-main-filters'); const placeNameEl = document.getElementById('place-name'); const placeRatingEl = document.getElementById('place-rating'); const placeStarsEl = document.getElementById('place-stars'); const placePriceEl = document.getElementById('place-price'); const placePhotoEl = document.getElementById('place-photo'); const directionsLink = document.getElementById('directions-link'); const websiteLink = document.getElementById('website-link'); const placeTypesContainer = document.getElementById('place-types-container'); const phoneLink = document.getElementById('phone-link'); const placeAccessibility = document.getElementById('place-accessibility'); const savePlaceButton = document.getElementById('save-place-button'); const compassModal = document.getElementById('compass-modal'); const compassDialog = document.getElementById('compass-dialog'); const closeCompassBtn = document.getElementById('close-compass'); const guideButton = document.getElementById('guide-button'); const navMain = document.getElementById('nav-main'); const navSub = document.getElementById('nav-sub'); const compassArrow = document.getElementById('compass-arrow'); const compassDist = document.getElementById('compass-dist'); const shareButton = document.getElementById('share-button'); const randomButton = document.getElementById('random-button'); const savedListScreen = document.getElementById('saved-list-screen'); const savedList = document.getElementById('saved-list'); const eventsListScreen = document.getElementById('events-list-screen'); const eventsList = document.getElementById('events-list'); const settingsModal = document.getElementById('settings-modal'); const settingsDialog = document.getElementById('settings-dialog'); const themeColorMeta = document.getElementById('theme-color-meta'); const voiceSelector = document.getElementById('voice-selector'); const reviewsListScreen = document.getElementById('reviews-list-screen'); const reviewsList = document.getElementById('reviews-list'); const showReviewsButton = document.getElementById('show-reviews-button'); const searchingModal = document.getElementById('searching-modal'); const reviewSortContainer = document.getElementById('review-sort-container'); const reviewStarFilterContainer = document.getElementById('review-star-filter-container'); const reviewFiltersContainer = document.getElementById('review-filters-container'); const reviewDateFilterInfo = document.getElementById('review-date-filter-info');

    /* ====== State ====== */
    let placesService, geocoder, directionsService; let currentUserLocation; let currentLocality = ''; let currentGeocodeLabel = 'Your Location'; let currentPlace; let currentResults = []; let currentResultIndex = 0; /* savedPlaces loaded */ let localFacts = [], factInterval = null, currentFactIndex = 0; let compassActive = false, guideSpeaking = false, watchId = null, headingDeg = 0; let routeSteps = [], stepIndex = 0, stepTarget = null, destLatLng = null; let voices = []; /* currentVoiceURI loaded */ let currentReviews = []; let currentReviewSort = 'time'; let currentStarFilter = null;

    /* ====== Categories ====== */
    const subFilterMap = { eat: {"🍕 Surprise Me":{type:"restaurant"},"Italian":{type:"italian_restaurant",keyword:"italian"},"Mexican":{type:"mexican_restaurant",keyword:"mexican"},"Japanese":{type:"japanese_restaurant",keyword:"japanese"},"Chinese":{type:"chinese_restaurant",keyword:"chinese"},"Indian":{type:"indian_restaurant",keyword:"indian"},"Pizza":{type:"pizza_restaurant",keyword:"pizza"},"Cafes":{type:"cafe",keyword:"cafe"},"Desserts":{type:"bakery",keyword:"dessert bakery"}}, see:{"Museums":{type:"museum"},"Art Galleries":{type:"art_gallery"},"Tourist Attractions":{type:"tourist_attraction"}}, night:{"Bars":{type:"bar"},"Night Clubs":{type:"night_club"}}, outdoors:{"Parks":{type:"park"}, "Hiking":{keyword:"hiking area"}, "Campground":{type:"campground"}, "Scenic Lookout":{type:"tourist_attraction", keyword:"scenic lookout"}}, gems:{"Quirky Shops":{keyword:"vintage store"},"Indie Coffee":{type:"cafe"},"Local Art":{type:"art_gallery"},"Quiet Spots":{type:"park"}}, pets:{"Dog Park":{type:"park",keyword:"dog park"}, "Pet Store":{type:"pet_store", keyword:"pet supplies store"}, "Veterinarian":{type:"veterinary_care"}}, utilities:{"Hospital":{type:"hospital"},"Pharmacy":{type:"pharmacy"},"Police":{type:"police"},"Gas Station":{type:"gas_station"},"Car Rental":{type:"car_rental"},"ATM":{type:"atm"}} }; const allowedByCategory = { eat:new Set(['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant']), night:new Set(['bar','night_club']), see:new Set(['museum','art_gallery','tourist_attraction']), outdoors: new Set(['park', 'tourist_attraction', 'campground']), gems:new Set(['art_gallery','park','cafe']), pets:new Set(['park','pet_store','veterinary_care']), utilities:new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']), random: new Set([ ...['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant'], ...['bar','night_club'], ...['museum','art_gallery','tourist_attraction'], ...['park', 'campground'], ...['art_gallery','park','cafe'] ]) }; const bannedRetailish = new Set(['grocery_or_supermarket','supermarket','department_store','shopping_mall','convenience_store','store','lodging','hotel']);

    /* ====== Utils ====== */
    const metersToImperial = m => { const ft=m*3.28084; return ft<1000?`${Math.round(ft)} ft`:`${(m*0.000621371).toFixed(1)} mi`; };
    const toggleFilterButtons = d => document.querySelectorAll('#main-screen button, #settings-button').forEach(b=>b.disabled=d);
    const renderStarsHTML = r => { r=Math.round(r||0); let h=''; for(let i=1;i<=5;i++)h+=`<span class="star${i<=r?' filled':''}">★</span>${i<5?' ':''}`; return h; };
    const renderStars = (el,r) => el.innerHTML=renderStarsHTML(r);
    const stripHtml = h => { const t=document.createElement('div'); t.innerHTML=h||''; return t.textContent||t.innerText||''; };
    const dedupe = items => { const s=new Set(),o=[]; for(const it of items) if(it && it.place_id && !s.has(it.place_id)){s.add(it.place_id);o.push(it)} return o; };
    const sortResults = a => a.sort((x,y)=>(y.rating??0)-(x.rating??0)||(y.user_ratings_total??0)-(x.user_ratings_total??0)||(x.distanceMeters??Infinity)-(y.distanceMeters??Infinity)||x.name.localeCompare(y.name));
    function isCandidate(p, kw, reqType, allowedSet) { const types = new Set(p.types || []); const typeMatch = [...types].some(type => allowedSet.has(type)); for (const type of types) { if (bannedRetailish.has(type)) return false; } if (reqType && !types.has(reqType)) { if (!( (types.has('restaurant') || types.has('store') || types.has('point_of_interest')) && kw && new RegExp(kw, 'i').test(p.name || '') )) { return false; } } if (!typeMatch) { if (!(kw && new RegExp(kw, 'i').test(p.name || ''))) { return false; } } return true; }
    function updateSaveButtonState(){ const pressed = currentPlace && !!savedPlaces[currentPlace.place_id]; savePlaceButton.setAttribute('aria-pressed', String(pressed)); savePlaceButton.textContent = pressed ? '★' : '☆'; console.log('DEBUG: updateSaveButtonState ran. Place ID:', currentPlace ? currentPlace.place_id : 'null', 'Pressed:', pressed); }
    function speak(text){ try{ speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); if (currentVoiceURI) { const selectedVoice = voices.find(v => v.voiceURI === currentVoiceURI); if (selectedVoice) u.voice = selectedVoice; } speechSynthesis.speak(u); }catch(e){ console.error("Speak error:", e)} }

    /* ====== Local Facts ====== */
    async function getFunFact(coords){ try{ funFactText.textContent = "Finding local facts..."; const geoURL = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=10000&gslimit=10&gscoord=${coords.lat}|${coords.lng}&format=json&origin=*`; const geoRes = await fetch(geoURL); const geo = await geoRes.json(); const ids = (geo?.query?.geosearch||[]).map(p=>p.pageid).slice(0,10); if(!ids.length){ funFactText.textContent="No local facts found nearby."; return; } const exURL = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${ids.join('|')}&format=json&origin=*`; const exRes = await fetch(exURL); const ex = await exRes.json(); localFacts = Object.values(ex?.query?.pages||{}).map(p=>p.extract).filter(e => e && e.length > 60 && e.length < 280); if(localFacts.length) startFactCycling(); else funFactText.textContent="No detailed local facts found."; }catch(e){ funFactText.textContent="Local facts unavailable."; console.error("Fact fetch error:", e)} }
    function startFactCycling(){ if(factInterval) clearInterval(factInterval); currentFactIndex=0; funFactText.textContent = localFacts[currentFactIndex] || "No local facts found nearby."; if(localFacts.length>1){ factInterval=setInterval(()=>{ currentFactIndex=(currentFactIndex+1)%localFacts.length; funFactText.textContent = localFacts[currentFactIndex]; },7000); } }

    /* ====== Results/Saved/Events/Reviews Lists ====== */
    function showResultsList(parentFilter, subLabel){ console.log('DEBUG: showResultsList called'); mainScreen.style.display = 'none'; savedListScreen.style.display='none'; eventsListScreen.style.display='none'; reviewsListScreen.style.display = 'none'; resultsListScreen.style.display='flex'; resultsTitle.textContent=subLabel || 'Results'; resultsMeta.textContent=currentResults.length?`${currentResults.length} results`:'No results'; resultsList.innerHTML=''; if (currentResults.length === 0) { console.log('DEBUG: No results to display.'); resultsList.innerHTML = '<p class="opacity-70 text-center p-4">No results found matching your criteria.</p>'; return; } currentResults.forEach(p=>{ const rating=p.rating??null; const price=p.price_level?'$'.repeat(p.price_level):''; const vic=p.vicinity||p.formatted_address||''; const card=document.createElement('button'); card.className='result-item'; card.dataset.id = p.place_id; card.innerHTML=`<div class="flex-1 text-left"><div class="flex items-center justify-between"><h3 class="font-semibold text-base">${p.name || 'Unknown Name'}</h3><div class="text-xs opacity-70">${price}</div></div><div class="flex items-center gap-2 mt-1"><div class="star-row">${renderStarsHTML(rating)}</div><div class="text-sm" style="color:var(--accent);">${rating?rating.toFixed(1):'N/A'}</div><div class="text-xs opacity-60">(${p.user_ratings_total??0})</div></div><div class="text-xs opacity-80 mt-1">${vic || 'Unknown Location'}</div></div><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.name+', '+(vic||''))}" target="_blank" rel="noopener" class="p-2 rounded-full card-accent text-white self-center map-link-icon"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></a>`; try { resultsList.appendChild(card); } catch (e) { console.error('DEBUG: Error appending result item:', p.name, e); } }); console.log('DEBUG: resultsList innerHTML populated.'); }
    function showSavedList() { console.log('DEBUG: showSavedList called.'); mainScreen.style.display = 'none'; resultsListScreen.style.display='none'; eventsListScreen.style.display='none'; reviewsListScreen.style.display = 'none'; savedListScreen.style.display='flex'; savedList.innerHTML=''; console.log('DEBUG: savedPlaces object state:', savedPlaces); console.log('DEBUG: Type of savedPlaces:', typeof savedPlaces); console.log('DEBUG: Raw localStorage item:', localStorage.getItem('savedPlaces')); const places = Object.values(savedPlaces || {}); console.log('DEBUG: Number of places to display:', places.length); if (places.length === 0) { savedList.innerHTML = '<p class="opacity-70 text-center">You haven\'t saved any places yet.</p>'; console.log('DEBUG: Displaying "No saved places" message.'); return; } places.forEach((p, index)=>{ console.log(`DEBUG: Rendering saved item ${index}:`, p); if (!p || typeof p !== 'object' || !p.place_id) { console.warn(`DEBUG: Skipping invalid saved place item at index ${index}:`, p); return; } const card=document.createElement('div'); card.className='result-item'; card.innerHTML=`<button class="flex-1 text-left saved-item-details" data-id="${p.place_id}"><h3 class="font-semibold text-base">${p.name || 'Saved Place'}</h3><div class="text-xs opacity-80 mt-1">${p.vicinity||''}</div></button><button class="remove-saved-button action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);" data-id="${p.place_id}">X</button>`; try { savedList.appendChild(card); } catch (e) { console.error(`DEBUG: Error appending saved item ${index} (${p.name}):`, e); } }); console.log('DEBUG: Finished rendering saved places list.'); }
    function showEventsList(events) { mainScreen.style.display = 'none'; resultsListScreen.style.display='none'; savedListScreen.style.display='none'; reviewsListScreen.style.display = 'none'; eventsListScreen.style.display='flex'; eventsList.innerHTML=''; if (!events || events.length === 0) { eventsList.innerHTML = '<p class="opacity-70 text-center">No local events found on Ticketmaster.</p>'; return; } events.forEach(event => { const photo = event.images?.[0]?.url || 'https://placehold.co/200x200/111827/fff?text=Event'; const venue = event._embedded?.venues?.[0]?.name || ''; const eventDate = event.dates?.start?.localDate ? new Date(event.dates.start.localDate).toLocaleDateString(undefined, {month: 'short', day: 'numeric', timeZone: 'UTC'}) : 'Date TBD'; const card = document.createElement('a'); card.className = 'result-item'; card.href = event.url; card.target = '_blank'; card.rel = 'noopener'; card.innerHTML = `<img class="result-thumb" loading="lazy" src="${photo}" alt="${event.name}" /><div class="flex-1 text-left"><h3 class="font-semibold text-base">${event.name}</h3><div class="text-sm mt-1" style="color:var(--accent);">${eventDate}</div><div class="text-xs opacity-80 mt-1">${venue}</div></div>`; eventsList.appendChild(card); }); }
    function showReviews() { // ** REVIEWS DISPLAY LOGIC UPDATED **
        console.log("DEBUG: showReviews called. Sort:", currentReviewSort, "Star Filter:", currentStarFilter);
        mainScreen.style.display = 'none'; resultScreen.style.display = 'none'; reviewsListScreen.style.display = 'flex';

        // Use all available reviews (no date filter)
        const reviewsToDisplay = [...currentReviews];
        reviewDateFilterInfo.textContent = ""; // Clear date message
        console.log("DEBUG: Total reviews available (no date filter):", reviewsToDisplay.length);

        const showFilters = currentReviews.length >= 20;
        reviewFiltersContainer.style.display = showFilters ? 'block' : 'none';
        reviewSortContainer.style.display = showFilters ? 'flex' : 'none';

        const starCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
        reviewsToDisplay.forEach(r => { if (r && r.rating !== undefined && starCounts[r.rating] !== undefined) starCounts[r.rating]++; });

        reviewStarFilterContainer.innerHTML = '';
        [5, 4, 3, 2, 1].forEach(rating => {
            const count = starCounts[rating];
            if (count > 0 || !showFilters) {
                const btn = document.createElement('button'); btn.className = 'review-star-button'; btn.dataset.rating = rating; let stars = '★'.repeat(rating) + '☆'.repeat(5 - rating); btn.innerHTML = `${stars} <span class="count">(${count})</span>`; if (parseInt(btn.dataset.rating) === currentStarFilter) { btn.classList.add('active'); } reviewStarFilterContainer.appendChild(btn);
            }
        });
        if (showFilters) { const clearBtn = document.createElement('button'); clearBtn.id = 'clear-star-filter'; clearBtn.className = 'review-star-button text-xs font-bold'; clearBtn.style = 'opacity: 0.8; color: var(--text-subtle); margin-top: 4px;'; clearBtn.textContent = 'Clear'; reviewStarFilterContainer.appendChild(clearBtn); }

        const finalFilteredReviews = currentStarFilter === null ? [...reviewsToDisplay] : reviewsToDisplay.filter(r => r && r.rating === currentStarFilter);
        console.log("DEBUG: Reviews after star filter:", finalFilteredReviews.length);

        if (currentReviewSort === 'time') { finalFilteredReviews.sort((a, b) => (b?.time || 0) - (a?.time || 0)); }
        else if (currentReviewSort === 'rating-desc') { finalFilteredReviews.sort((a, b) => (b?.rating || 0) - (a?.rating || 0)); }
        else if (currentReviewSort === 'rating-asc') { finalFilteredReviews.sort((a, b) => (a?.rating || 0) - (b?.rating || 0)); }

        document.querySelectorAll('.review-sort-button').forEach(b => { b.classList.toggle('active', b.id.includes(currentReviewSort.split('-')[0])); });

        reviewsList.innerHTML = ''; // Clear previous reviews before rendering
        if (finalFilteredReviews.length === 0) {
            reviewsList.innerHTML = `<p class="opacity-70 text-center p-4">No reviews match ${currentStarFilter !== null ? currentStarFilter +'-star filter' : 'your criteria'}.</p>`; return;
        }

        console.log(`DEBUG: Rendering ${finalFilteredReviews.length} reviews...`); // Log count before loop
        finalFilteredReviews.forEach((review, index) => {
            if (!review || typeof review !== 'object') { console.warn(`DEBUG: Skipping invalid review item at index ${index}:`, review); return; }
            // console.log(`DEBUG: Rendering review ${index}:`, review.author_name); // Reduce log noise
            const card = document.createElement('div'); card.className = 'review-item';
            const reviewText = review.text ? stripHtml(review.text) : '<i>(No text provided)</i>';
            const authorName = review.author_name || 'Anonymous';
            const timeDescription = review.relative_time_description || '';
            const photoUrl = review.profile_photo_url || 'https://placehold.co/40x40/111827/fff?text=N/A';

            card.innerHTML = `<div class="flex items-center gap-3 mb-2"><img loading="lazy" src="${photoUrl}" alt="${authorName}" class="w-10 h-10 rounded-full" /><div class="flex-1"><h4 class="font-semibold text-sm">${authorName}</h4><p class="text-xs opacity-70">${timeDescription}</p></div><div class="star-row text-right">${renderStarsHTML(review.rating)}</div></div><p class="text-sm opacity-90">${reviewText}</p>`;
            try { reviewsList.appendChild(card); } catch(e) { console.error(`DEBUG: Error rendering review ${index}:`, e, review); }
        });
        console.log("DEBUG: Finished rendering reviews.");
    }


    /* ====== Search ====== */
    async function findLocalEvents() { if (!window.TICKETMASTER_API_KEY || window.TICKETMASTER_API_KEY === 'YOUR_KEY_HERE') { alert('Ticketmaster API key is missing from key.js.'); return; } if (!currentUserLocation) { alert('Please set your location first.'); return; } searchingModal.style.display = 'flex'; toggleFilterButtons(true); try { const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${window.TICKETMASTER_API_KEY}&latlong=${currentUserLocation.lat},${currentUserLocation.lng}&radius=25&unit=miles&sort=date,asc`; const res = await fetch(url); if (!res.ok) throw new Error(`Ticketmaster API error: ${res.status}`); const data = await res.json(); showEventsList(data._embedded?.events); } catch (e) { console.error(e); alert('Could not load local events. See console for details.'); } searchingModal.style.display = 'none'; toggleFilterButtons(false); }
    function findAdventure(searchParams,parentFilter,subLabel){ console.log('DEBUG: findAdventure started:', { searchParams, parentFilter, subLabel, currentUserLocation }); if(!placesService || !currentUserLocation){ console.error('DEBUG: placesService or currentUserLocation missing!'); alert("Error: Location not set or Maps service failed to load."); searchingModal.style.display = 'none'; toggleFilterButtons(false); return; } mainScreen.style.display = 'none'; searchingModal.style.display = 'flex'; toggleFilterButtons(true); backToMainFiltersButton.disabled=true; currentResults=[]; const reqType=searchParams.type||null; let kw = searchParams.keyword || ''; if (parentFilter === 'pets' && subLabel === 'Pet Store') { kw = 'pet supplies store'; } else if (parentFilter === 'eat') { kw = searchParams.keyword || (reqType ? reqType.replace('_restaurant', '') : ''); } console.log('DEBUG: Search criteria:', { reqType, kw }); const radii=[2000,5000,10000,20000,35000,50000]; let i=0; const nearby=()=>{ if(i>=radii.length) { console.log('DEBUG: Nearby search exhausted radii, trying text search.'); return text(); } const radius=radii[i++]; const req = { location: currentUserLocation, radius }; if (reqType) req.type = reqType; if (kw) req.keyword = kw; console.log(`DEBUG: Performing nearby search (radius ${radius}m):`, req); placesService.nearbySearch(req,(res,status)=>{ console.log(`DEBUG: Nearby results (radius ${radius}m):`, { status, res: res ? res.length : 0 }); if(status === google.maps.places.PlacesServiceStatus.OK && res?.length){ const allowed = allowedByCategory[parentFilter] || new Set(); const initialCount = currentResults.length; const newResults = res.filter(p => isCandidate(p, kw, reqType, allowed)); currentResults = dedupe([...currentResults,...newResults]); console.log(`DEBUG: Filtered nearby (radius ${radius}m). Added ${currentResults.length - initialCount} results.`); if(currentResults.length < 12 && i < radii.length){ console.log('DEBUG: Not enough results yet, searching wider...'); nearby(); } else { console.log('DEBUG: Found enough results or exhausted radii in nearby.'); finalize(); } } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS && i < radii.length) { console.log('DEBUG: Zero results nearby, searching wider...'); nearby(); } else if (i >= radii.length) { console.log('DEBUG: Nearby search failed or zero results after max radius, trying text search.'); text(); } else { console.log('DEBUG: Nearby search status not OK but not ZERO_RESULTS, searching wider anyway.'); nearby(); } }); }; const text=()=>{ const city=currentLocality||''; const query = kw ? `${kw} in ${city}` : `${subLabel||reqType||''} in ${city}`; console.log('DEBUG: Performing text search:', { query }); placesService.textSearch({query,location:currentUserLocation,radius:50000},(res,status)=>{ console.log('DEBUG: Text search results:', { status, res: res ? res.length : 0 }); if(status===google.maps.places.PlacesServiceStatus.OK && res?.length){ const allowed = allowedByCategory[parentFilter] || new Set(); const initialCount = currentResults.length; const newResults = res.filter(p => isCandidate(p, kw, reqType, allowed)); currentResults=dedupe([...currentResults,...newResults]); console.log(`DEBUG: Filtered text search. Added ${currentResults.length - initialCount} results.`); } else { console.log('DEBUG: Text search failed or returned zero results.'); } finalize(); }); }; const finalize=()=>{ console.log('DEBUG: Finalizing search. Total results before sort:', currentResults.length); currentResults=sortResults(currentResults); console.log('DEBUG: Results sorted. Calling showResultsList.'); showResultsList(parentFilter,subLabel); searchingModal.style.display = 'none'; toggleFilterButtons(false); backToMainFiltersButton.disabled=false; }; nearby(); }

    /* ====== Details, Directions, Compass ====== */
    function openDetailsById(placeId){ const resultIndex = currentResults.findIndex(r=>r.place_id===placeId); if(resultIndex !== -1) { currentResultIndex = resultIndex; getPlaceDetails(currentResults[currentResultIndex]); return; } const saved = savedPlaces[placeId]; if(saved) { const summary = { place_id: saved.place_id, name: saved.name, vicinity: saved.vicinity, geometry: { location: new google.maps.LatLng(saved.geometry.lat, saved.geometry.lng) } }; currentResults = [summary]; currentResultIndex = 0; getPlaceDetails(summary); return; } console.warn("DEBUG: openDetailsById - placeId not found in results or saved:", placeId); }
    function getPlaceDetails(summary){ if (!summary || !summary.place_id) { console.error("DEBUG: getPlaceDetails called with invalid summary:", summary); return; } mainScreen.style.display = 'none'; resultsListScreen.style.display = 'none'; savedListScreen.style.display = 'none'; eventsListScreen.style.display = 'none'; reviewsListScreen.style.display = 'none'; resultScreen.style.display='flex'; currentPlace = summary; currentReviews = []; currentStarFilter = null; currentReviewSort = 'time'; updateSaveButtonState(); placeNameEl.textContent = 'Loading Details...'; const placeholdURL = `https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(summary.name)}`; placePhotoEl.src = placeholdURL; placePhotoEl.onerror = null; placeRatingEl.textContent=''; placeStarsEl.innerHTML=''; placePriceEl.textContent=''; placeTypesContainer.innerHTML=''; websiteLink.classList.add('hidden'); phoneLink.textContent=''; phoneLink.removeAttribute('href'); placeAccessibility.textContent=''; placeAccessibility.style.display='none'; showReviewsButton.disabled = true; showReviewsButton.textContent = 'Loading Reviews...'; routeSteps=[]; stepIndex=0; stepTarget=null; stopCompass(); console.log("DEBUG: Fetching details for placeId:", summary.place_id); placesService.getDetails({ placeId:summary.place_id, fields:['name','rating','user_ratings_total','price_level','website','vicinity','types','formatted_phone_number','geometry','wheelchair_accessible_entrance', 'reviews', 'formatted_address'] },(place,status)=>{ console.log("DEBUG: Place Details status:", status, "Place:", place ? place.name : 'null'); if(status===google.maps.places.PlacesServiceStatus.OK&&place){ currentPlace=place; placeNameEl.textContent=place.name; renderStars(placeStarsEl, place.rating??0); placeRatingEl.textContent=place.rating?place.rating.toFixed(1):'N/A'; placePriceEl.textContent=place.price_level?'$'.repeat(place.price_level):''; if(place.website){ try { const domain = new URL(place.website).hostname; placePhotoEl.src = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`; placePhotoEl.onerror = () => { placePhotoEl.src = placeholdURL; }; } catch (e) { placePhotoEl.src = placeholdURL; } websiteLink.href=place.website; websiteLink.classList.remove('hidden'); } else { placePhotoEl.src = placeholdURL; } if(place.formatted_phone_number){phoneLink.href=`tel:${place.formatted_phone_number}`;phoneLink.textContent=place.formatted_phone_number} if(place.wheelchair_accessible_entrance){placeAccessibility.textContent='♿';placeAccessibility.style.display='inline'} if(place.types?.length){ place.types.filter(t=>!['point_of_interest','establishment'].includes(t)).slice(0,3).forEach(t=>{ const s=document.createElement('span'); s.className='place-type-tag'; s.textContent=t.replace(/_/g, ' '); placeTypesContainer.appendChild(s); }); } currentReviews = place.reviews || []; showReviewsButton.disabled = currentReviews.length === 0; showReviewsButton.textContent = `Show Reviews (${currentReviews.length})`; reviewFiltersContainer.style.display = currentReviews.length >= 20 ? 'block' : 'none'; const dest=`${place.name}, ${place.vicinity||place.formatted_address||''}`; directionsLink.href=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`; buildRouteTo(place.geometry.location); updateSaveButtonState(); } else { showReviewsButton.textContent = 'Reviews Unavailable'; console.error('Place Details fetch failed:', status); } }); }
    function buildRouteTo(latLng){ destLatLng = latLng; if(!currentUserLocation || !directionsService) return; directionsService.route({ origin: currentUserLocation, destination: latLng, travelMode: 'WALKING' }, (response, status) => { if (status === 'OK' && response.routes?.[0]?.legs?.[0]?.steps) { routeSteps = response.routes[0].legs[0].steps; stepIndex = 0; setStep(0); } else { routeSteps = []; stepTarget = null; destLatLng = latLng; } }); }
    function setStep(i){ if(i >= routeSteps.length) { stepTarget = null; navMain.textContent = 'Arrived at destination'; navSub.textContent = 'Compass pointing to final location.'; return; } stepIndex = i; const step = routeSteps[i]; stepTarget = step.end_location; navMain.textContent = stripHtml(step.instructions || 'Continue'); navSub.textContent = `In ${step.distance?.text || '...'} (${step.duration?.text || '...'})`; if(guideSpeaking) speak(stripHtml(step.instructions)); }
    const toRad=d=>d*Math.PI/180, norm=a=>((a%360)+360)%360; function bearingFromTo(a,b){ const φ1=toRad(a.lat), λ1=toRad(a.lng), φ2=toRad(b.lat), λ2=toRad(b.lng); const y=Math.sin(λ2-λ1)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1); return norm(Math.atan2(y,x)*180/Math.PI); } function haversineMeters(a,b){ const R=6371e3; const φ1=toRad(a.lat), φ2=toRad(b.lat), Δφ=toRad(b.lat-a.lat), Δλ=toRad(b.lng-a.lng); const x=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2); return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); } function turnHint(delta){ if(delta<15||delta>345) return 'Straight ahead'; if(delta<45) return 'Slight right'; if(delta<135) return 'Turn right'; if(delta<225) return 'Turn around'; if(delta<315) return 'Turn left'; return 'Slight left'; } function updateCompassUI(){ if(!compassActive || !currentUserLocation || !destLatLng) return; const target = stepTarget || destLatLng; const distM = haversineMeters(currentUserLocation, target.toJSON ? target.toJSON() : target); compassDist.textContent = metersToImperial(distM); if (stepTarget && distM < 20) { setStep(stepIndex + 1); return; } const bearing = bearingFromTo(currentUserLocation, target.toJSON ? target.toJSON() : target); const delta = norm(bearing - headingDeg); compassArrow.style.transform = `rotate(${delta}deg)`; if(!stepTarget) { navMain.textContent = `Head ${turnHint(delta)}`; navSub.textContent = `Pointing to ${currentPlace?.name || 'destination'}`; } } function onOrientation(e){ let heading = e.webkitCompassHeading; if (typeof heading === 'undefined') { heading = e.alpha; if (typeof heading !== 'number' || isNaN(heading)) return; heading = norm(360 - heading); } headingDeg = heading; updateCompassUI(); } function openCompass(){ if(!destLatLng) { alert('No destination set.'); return; } compassModal.style.display = 'flex'; compassDialog.focus(); startCompass(); } function closeCompass(){ compassModal.style.display = 'none'; stopCompass(); } function trapCompassTab(e){ if (e.key !== 'Tab') return; const focusable = compassDialog.querySelectorAll('button'); const first = focusable[0], last = focusable[focusable.length - 1]; if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); } else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); } } function startCompass(){ if(compassActive) return; compassActive = true; if ('ondeviceorientationabsolute' in window) { window.addEventListener('deviceorientationabsolute', onOrientation); } else if ('ondeviceorientation' in window) { window.addEventListener('deviceorientation', onOrientation); } if(navigator.geolocation) { watchId = navigator.geolocation.watchPosition(pos => { currentUserLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude}; updateCompassUI(); }, null, {enableHighAccuracy: true}); } compassDialog.addEventListener('keydown', trapCompassTab); } function stopCompass(){ compassActive = false; window.removeEventListener('deviceorientationabsolute', onOrientation); window.removeEventListener('deviceorientation', onOrientation); if(watchId) navigator.geolocation.clearWatch(watchId); watchId = null; guideSpeaking = false; guideButton.textContent = 'Guide Me ▶︎'; try { speechSynthesis.cancel(); } catch {} compassDialog.removeEventListener('keydown', trapCompassTab); }

    /* ====== Settings ====== */
    function applyTheme(theme) { console.log('DEBUG: Applying theme:', theme); document.documentElement.dataset.theme = theme; try { localStorage.setItem('appTheme', theme); console.log('DEBUG: Theme saved to localStorage.'); } catch (e) { console.error('DEBUG: Error saving theme to localStorage:', e); } document.querySelectorAll('.theme-button').forEach(b => { b.classList.toggle('active', b.dataset.theme === theme); }); const newThemeColor = theme === 'rugged-explorer' ? '#0A192F' : (theme === 'night-ops' ? '#111111' : '#f8f7f2'); themeColorMeta.content = newThemeColor; }
    function applyVoice(voiceURI) { console.log('DEBUG: Applying voice:', voiceURI); currentVoiceURI = voiceURI; try { localStorage.setItem('appVoice', voiceURI); console.log('DEBUG: Voice saved to localStorage.'); } catch (e) { console.error('DEBUG: Error saving voice to localStorage:', e); } }
    function loadVoices() { voices = speechSynthesis.getVoices(); voiceSelector.innerHTML = '<option value="">Device Default</option>'; voices.filter(v => v.lang.startsWith(navigator.language) || v.lang.startsWith('en-')).forEach(voice => { const option = document.createElement('option'); option.value = voice.voiceURI; option.textContent = `${voice.name} (${voice.lang})`; if (voice.voiceURI === currentVoiceURI) option.selected = true; voiceSelector.appendChild(option); }); }
    function loadSettings() { console.log('DEBUG: loadSettings (full - in initApp scope) called.'); const theme = localStorage.getItem('appTheme') || 'rugged-explorer'; applyTheme(theme); currentVoiceURI = localStorage.getItem('appVoice') || null; console.log('DEBUG: Full load - Voice URI from localStorage:', currentVoiceURI); loadVoices(); if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; } try { const placesJson = localStorage.getItem('savedPlaces') || '{}'; savedPlaces = JSON.parse(placesJson); console.log('DEBUG: Full load - Saved places loaded:', Object.keys(savedPlaces).length, 'items'); } catch (e) { console.error("DEBUG: Error loading saved places in full load:", e); savedPlaces = {}; localStorage.setItem('savedPlaces', '{}'); } }
    function openSettings() { settingsModal.style.display = 'flex'; settingsDialog.focus(); } function closeSettings() { settingsModal.style.display = 'none'; }

    /* ====== Init / Geocode ====== */
    function initApp(){ console.log("DEBUG: initApp called by Google Maps callback."); loadSettings(); placesService=new google.maps.places.PlacesService(document.createElement('div')); geocoder=new google.maps.Geocoder(); directionsService=new google.maps.DirectionsService(); toggleFilterButtons(true); locationStatus.textContent = 'Acquiring location...'; if(navigator.geolocation){ console.log("DEBUG: Geolocation supported."); navigator.geolocation.getCurrentPosition( pos => { console.log("DEBUG: Geolocation success."); const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude }; reverseGeocodeSetLocation(coords); }, handleLocationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); } else { console.log("DEBUG: Geolocation not supported."); handleLocationError({ code: -1, message: "Geolocation not supported by this browser." }); } } window.initApp=initApp;
    function handleLocationError(error) { console.warn("DEBUG: Geolocation error:", error.code, error.message); let message = "Couldn't get location."; switch(error.code) { case error.PERMISSION_DENIED: message = "Location permission denied. Check browser/site settings."; break; case error.POSITION_UNAVAILABLE: message = "Location info unavailable. Check device GPS."; break; case error.TIMEOUT: message = "Location request timed out."; break; case error.UNKNOWN_ERROR: message = "Unknown error getting location."; break; case -1: message = "Geolocation not supported."; break; } locationStatus.textContent = message; manualLocationEntry.classList.remove('hidden'); getFunFact({lat:40.7128,lng:-74.0060}); toggleFilterButtons(false); }
    function reverseGeocodeSetLocation(coords){ console.log("DEBUG: reverseGeocodeSetLocation called with coords:", coords); geocoder.geocode({location:coords},(results,status)=>{ console.log("DEBUG: Geocode status:", status); let label="Your Current Location"; currentLocality=''; if(status==='OK'&&results?.[0]){ console.log("DEBUG: Geocode success:", results[0].formatted_address); const c=results[0].address_components||[]; const city=c.find(x=>x.types.includes('locality'))?.long_name||c.find(x=>x.types.includes('postal_town'))?.long_name||c.find(x=>x.types.includes('sublocality'))?.long_name; const state=c.find(x=>x.types.includes('administrative_area_level_1'))?.short_name; if(city&&state) currentLocality=`${city}, ${state}`; label=results[0].formatted_address.split(',').slice(0,2).join(','); } else { console.warn("DEBUG: Geocode failed or no results."); } currentGeocodeLabel = label; setLocationAndEnableApp(coords,label); }); }
    function geocodeLocation(){ const address=locationInput.value.trim(); if(!address) return; console.log("DEBUG: geocodeLocation called for address:", address); searchingModal.style.display = 'flex'; geocoder.geocode({address},(results,status)=>{ searchingModal.style.display = 'none'; console.log("DEBUG: Address geocode status:", status); if(status==='OK'&&results?.[0]){ const loc=results[0].geometry.location; currentGeocodeLabel = results[0].formatted_address.split(',').slice(0,2).join(','); reverseGeocodeSetLocation({lat:loc.lat(),lng:loc.lng()}); } else locationStatus.textContent=`Could not find "${address}".`; }); }
    function setLocationAndEnableApp(coords,label){ console.log("DEBUG: setLocationAndEnableApp called:", {coords, label}); currentUserLocation=coords; locationStatus.textContent=`Exploring: ${label}`; manualLocationEntry.classList.add('hidden'); toggleFilterButtons(false); getFunFact(coords); funFactContainer.style.display='block'; }

    /* ====== UI & Events ====== */
    function showSubMenu(filter){ filterContainer.classList.add('hidden'); randomButton.classList.add('hidden'); document.getElementById('show-saved-button').classList.add('hidden'); document.getElementById('local-events-button').classList.add('hidden'); subMenuContainer.innerHTML=''; const sub=subFilterMap[filter]; const grid=document.createElement('div'); grid.className='grid grid-cols-2 gap-4 sub-menu'; for(const name in sub){const b=document.createElement('button'); b.textContent=name; b.dataset.name=name; b.dataset.parent=filter; b.className='action-card rounded-lg font-bold py-3 text-base'; grid.appendChild(b);} subMenuContainer.appendChild(grid); subMenuContainer.classList.remove('hidden'); backToMainFiltersButton.classList.remove('hidden'); }
    function hideSubMenu(){ subMenuContainer.classList.add('hidden'); backToMainFiltersButton.classList.add('hidden'); filterContainer.classList.remove('hidden'); randomButton.classList.remove('hidden'); document.getElementById('show-saved-button').classList.remove('hidden'); document.getElementById('local-events-button').classList.remove('hidden'); }
    function findRandomAdventure() { const randomizableFilters = { ...subFilterMap }; ['utilities', 'pets', 'outdoors'].forEach(f => delete randomizableFilters[f]); const allFilters = Object.values(randomizableFilters).flatMap(obj => Object.values(obj)); hideSubMenu(); findAdventure(allFilters[Math.floor(Math.random() * allFilters.length)], "random", "Surprise Me!"); }
    function resetApp(hide=true){ closeCompass(); resultScreen.style.display='none'; resultsListScreen.style.display='none'; savedListScreen.style.display='none'; eventsListScreen.style.display='none'; reviewsListScreen.style.display='none'; mainScreen.style.display='block'; funFactContainer.style.display='block'; hideSubMenu(); toggleFilterButtons(false); backToMainFiltersButton.disabled=false; if(currentUserLocation) locationStatus.textContent=`Exploring: ${currentGeocodeLabel}`; else locationStatus.textContent="Set your location."; }

    document.addEventListener('click', (e)=>{
      const target = e.target;
      let btn = target.closest('button');

      // Allow map links
      if (target.closest('.map-link-icon')) { console.log('DEBUG: Map link clicked.'); return; }

      // ** SAVE BUTTON FIX: Handle click specifically if target *is* the button OR its direct parent (the button itself) **
      if (target.id === 'save-place-button' || (target.parentElement && target.parentElement.id === 'save-place-button')) {
          console.log('DEBUG: Save Place Button click detected.');
          btn = document.getElementById('save-place-button'); // Ensure we have the button element
          if (btn && !btn.disabled) { // Check if not disabled
             if(currentPlace) {
               const placeId = currentPlace.place_id;
               if (!placeId) { console.error("DEBUG: Cannot save place - place_id is missing!", currentPlace); return; }
               if(savedPlaces[placeId]) { console.log('DEBUG: Unsaving place:', placeId); delete savedPlaces[placeId];
               } else {
                 const vicinityText = currentPlace.vicinity || currentPlace.formatted_address || 'Location details saved';
                 if (currentPlace.geometry && currentPlace.geometry.location) {
                    console.log('DEBUG: Saving place:', placeId, 'Name:', currentPlace.name, 'Vicinity:', vicinityText);
                    savedPlaces[placeId]={ name: currentPlace.name || 'Unnamed Place', place_id: placeId, vicinity: vicinityText, geometry: currentPlace.geometry.location.toJSON() };
                 } else { console.error("DEBUG: Cannot save place - geometry is missing!", currentPlace); alert("Could not save place - missing location data."); return; }
               }
               try { localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces)); console.log('DEBUG: savedPlaces saved to localStorage after toggle. Current count:', Object.keys(savedPlaces).length); } catch(err) { console.error('DEBUG: Error saving savedPlaces after toggle:', err); alert("Error saving place. Storage might be full."); }
               updateSaveButtonState();
             } else { console.warn("DEBUG: Save button clicked but currentPlace is null."); }
          } else { console.log('DEBUG: Save button click ignored (button not found or disabled).'); }
         return; // Explicitly return after handling
      }

      // If no button was found up the hierarchy, or if it's disabled, ignore
      if(!btn || btn.disabled) {
          // console.log('DEBUG: Click ignored (no button or disabled). Target:', target, 'Closest button:', btn); // Reduce noise
          return;
      }

      console.log('DEBUG: Click detected on button with ID:', btn.id || '(no id)', 'Classes:', btn.className);

      // --- Continue with other checks ---
      if(btn.matches('#filter-container > button[data-filter]')){showSubMenu(btn.dataset.filter);return;}
      if(btn.closest('.sub-menu') && btn.dataset.name){ const name=btn.dataset.name, parent=btn.dataset.parent; let params=subFilterMap[parent][name]; if(parent==='eat' && name==='🍕 Surprise Me'){const food=Object.values(subFilterMap.eat).filter(f=>f.type&&f.type.endsWith('_restaurant')); params=food[Math.floor(Math.random()*food.length)];} findAdventure(params,parent,name); return; }
      if(btn.closest('#results-list') && btn.classList.contains('result-item')){ openDetailsById(btn.dataset.id); return;}
      if(btn.classList.contains('saved-item-details')){ openDetailsById(btn.dataset.id); return;}
      if(btn.classList.contains('remove-saved-button')){ const placeId = btn.dataset.id; if(placeId && savedPlaces[placeId]){ console.log('DEBUG: Removing saved place:', placeId); delete savedPlaces[placeId]; try { localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces)); console.log('DEBUG: Updated savedPlaces saved to localStorage.'); } catch(err) { console.error('DEBUG: Error saving updated savedPlaces:', err); } showSavedList(); } return; }
      if(btn.classList.contains('theme-button')){ applyTheme(btn.dataset.theme); return; }
      if(btn.id === 'sort-reviews-best') { currentReviewSort = 'rating-desc'; showReviews(); return; }
      if(btn.id === 'sort-reviews-worst') { currentReviewSort = 'rating-asc'; showReviews(); return; }
      if(btn.id === 'sort-reviews-recent') { currentReviewSort = 'time'; showReviews(); return; }
      if(btn.classList.contains('review-star-button') && btn.dataset.rating) { currentStarFilter = parseInt(btn.dataset.rating); showReviews(); return; }
      if(btn.id === 'clear-star-filter') { currentStarFilter = null; showReviews(); return; }

      // Switch for remaining specific IDs
      switch(btn.id){
        case 'back-to-main-filters': hideSubMenu(); break;
        case 'close-results-button': resetApp(); break;
        case 'close-saved-button': resetApp(); break;
        case 'close-events-button': resetApp(); break;
        case 'close-reviews-button': resultScreen.style.display = 'flex'; reviewsListScreen.style.display = 'none'; break;
        case 'show-saved-button': showSavedList(); break;
        case 'local-events-button': findLocalEvents(); break;
        case 'show-reviews-button': showReviews(); break;
        case 'settings-button': openSettings(); break;
        case 'close-settings-button': closeSettings(); break;
        case 'try-again-button': resetApp(); break;
        case 'search-button': geocodeLocation(); break;
        case 'random-button': findRandomAdventure(); break;
        case 'next-suggestion-button': if(currentResults.length > 0){ currentResultIndex = (currentResultIndex + 1) % currentResults.length; getPlaceDetails(currentResults[currentResultIndex]); } break;
        // save-place-button handled above
        case 'compass-button': openCompass(); break;
        case 'close-compass': closeCompass(); break;
        case 'guide-button': guideSpeaking = !guideSpeaking; guideButton.textContent = guideSpeaking ? 'Pause ⏸' : 'Guide Me ▶︎'; if(guideSpeaking){ if(routeSteps.length && stepIndex < routeSteps.length){ const st=routeSteps[stepIndex]; const text=stripHtml(st.instructions||'Continue'); const dist=st.distance?.text||''; speak(`${text}${dist?'. '+dist:''}`); } else if(currentPlace){ speak(`Head toward ${currentPlace.name}`); } } else { try{ speechSynthesis.cancel(); }catch{} } break;
        case 'share-button': if (navigator.share && currentPlace) { navigator.share({ title: currentPlace.name, text: `Check out this place I found: ${currentPlace.name}`, url: directionsLink.href, });} break;
        default: console.log("DEBUG: Unhandled button click in switch:", btn.id); break;
      }
    });

    document.getElementById('location-input').addEventListener('keyup',e=>{if(e.key==='Enter') geocodeLocation();});
    document.getElementById('voice-selector').addEventListener('change', e => { applyVoice(e.target.value); });

  </script>
</body>
</html>
