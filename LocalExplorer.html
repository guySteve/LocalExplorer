<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" id="theme-color-meta" content="#0A192F" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Local Explorer" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <title>Local Explorer</title>

    <script src="./key.js"></script>
    <script>
      const GKEY = window.MAPS_API_KEY || 'MISSING_API_KEY';
      document.write(`<script src="https://maps.googleapis.com/maps/api/js?key=${GKEY}&libraries=places,geocoding,directions&callback=initApp" async defer><\/script>`);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        :root {
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #111827; --card-text: #f8f7f2; --card-bg-subtle: #374151;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #6366f1;
          --modal-bg: rgba(17, 24, 39, 0.92); --modal-blur: blur(12px);
          --list-bg: rgba(0, 0, 0, 0.75); --list-card-bg: rgba(17, 24, 39, 0.97);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="day-ops"] { /* Renamed 'light' */
          --bg: #f8f7f2; --text: #111827; --text-subtle: #4b5563;
          --card-bg: #ffffff; --card-text: #111827; --card-bg-subtle: #e5e7eb;
          --accent: #f59e0b; --accent-alt: #10b981; --accent-dark: #4f46e5;
          --modal-bg: rgba(255, 255, 255, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(255, 255, 255, 0.85); --list-card-bg: rgba(248, 247, 242, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.1);
        }
        [data-theme="rugged-explorer"] {
          --bg: #0A192F; --text: #CCD6F6; --text-subtle: #8892B0;
          --card-bg: #112240; --card-text: #CCD6F6; --card-bg-subtle: #0A192F;
          --accent: #64FFDA; --accent-alt: #f59e0b; --accent-dark: #57D3C1;
          --modal-bg: rgba(10, 25, 47, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(17, 34, 64, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }
        [data-theme="night-ops"] {
          --bg: #111111; --text: #E0E0E0; --text-subtle: #9E9E9E;
          --card-bg: #1F1F1F; --card-text: #E0E0E0; --card-bg-subtle: #000000;
          --accent: #FF4136; --accent-alt: #F012BE; --accent-dark: #B10000;
          --modal-bg: rgba(20, 20, 20, 0.9); --modal-blur: blur(10px);
          --list-bg: rgba(0, 0, 0, 0.85); --list-card-bg: rgba(31, 31, 31, 0.98);
          --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body{font-family:'Raleway',sans-serif; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s;}
        h1,h2,h3,.font-header{font-family:'Poppins',sans-serif;}
        .pt-safe{padding-top: calc(1rem + env(safe-area-inset-top));}
        .pb-safe{padding-bottom: calc(1rem + env(safe-area-inset-bottom));}

        .action-card{
          background: var(--card-bg); color: var(--card-text);
          transition: transform 0.2s, box-shadow 0.2s, background 0.3s, color 0.3s;
          box-shadow: 0 4px 12px var(--shadow-color); cursor: pointer;
          -webkit-tap-highlight-color: transparent; /* Touch optimization */
        }
        .action-card:hover:not(:disabled){transform:translateY(-2px); box-shadow:0 8px 20px var(--shadow-color)}
        .action-card:active:not(:disabled){transform:translateY(0) scale(.98)}
        .action-card:disabled{opacity:.4;cursor:not-allowed}

        .card-accent{ background: var(--accent); color: var(--card-bg); }
        .card-accent:hover:not(:disabled){ background: var(--accent); opacity: 0.9; }
        .card-accent-alt{ background: var(--accent-alt); color: var(--card-bg); }
        .card-accent-dark{ background: var(--accent-dark); color: var(--card-text); }

        #result-card{
          background: var(--modal-bg); color: var(--card-text); 
          backdrop-filter: var(--modal-blur); -webkit-backdrop-filter: var(--modal-blur);
          transition:transform .4s ease,opacity .3s ease;max-height:90vh;overflow-y:auto;border-top:1px solid rgba(248,247,242,.2)
        }
        .place-type-tag{background:rgba(248,247,242,.1);border:1px solid rgba(248,247,242,.2);padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600}
        .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

        .list-screen{position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem;
          background: var(--list-bg); backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        .list-card{background: var(--list-card-bg); color: var(--card-text); border-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:auto}
        
        .result-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.75rem;display:flex;gap:.75rem; cursor: pointer;}
        .result-item:hover{background: rgba(255,255,255,0.1);}
        .result-thumb{width:84px;height:84px;object-fit:cover;border-radius:.6rem;background: var(--card-bg); pointer-events: none;}

        .modal-base{position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);}
        .modal-dialog{width: min(92vw, 440px); background: var(--list-card-bg); color: var(--card-text);
          border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); padding:16px; outline:none;}

        #nav-bubble{position:relative;margin: 8px 0 12px 0;padding:.6rem .75rem;font-size:13px;line-height:1.25;
          box-shadow:0 10px 24px rgba(0,0,0,.35);background:radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%);
          border:1px solid rgba(255,255,255,.12)}
        #nav-main{font-weight:700;letter-spacing:.2px}
        #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
        #compass-overlay{width:240px;height:240px;border-radius:22px;margin: 6px auto 10px auto; padding: 18px; position:relative;
          background: radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
            conic-gradient(from 0deg, var(--accent), rgba(245,158,11,.1) 30%, var(--accent-alt), rgba(16,185,129,.12) 75%, var(--accent));
          border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06);
          display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden}
        #compass-arrow{width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:44px solid var(--accent);
          transform-origin:50% 90%;filter:drop-shadow(0 6px 8px var(--accent));margin-bottom:8px}
        #compass-dist{font-size:14px;font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}

        #settings-modal .modal-dialog { padding: 20px; }
        .theme-button { border: 2px solid var(--card-bg-subtle); padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .theme-button.active { border-color: var(--accent); box-shadow: 0 0 10px -2px var(--accent); }
        #voice-selector {
          background: var(--card-bg); color: var(--card-text); border: 1px solid var(--card-bg-subtle);
          padding: 8px 12px; border-radius: 8px; width: 100%; cursor: pointer;
        }
        
        .review-item {
          background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12);
          border-radius: .9rem; padding: .75rem 1rem;
        }
        .review-sort-button {
          background: var(--card-bg-subtle); color: var(--card-text);
          padding: 8px 12px; border-radius: 8px; font-weight: 600; opacity: 0.7; cursor: pointer;
        }
        .review-sort-button.active {
          background: var(--accent); color: var(--card-bg); opacity: 1;
        }
        /* NEW: Star Filter Buttons */
        .review-star-button {
           background: none; border: none; font-size: 1.25rem; padding: 4px; opacity: 0.5; cursor: pointer;
           color: var(--accent); /* Star color */
        }
        .review-star-button.active { opacity: 1; }

        #fun-fact-container {
          background: var(--card-bg); color: var(--text); border-radius: 1rem; padding: 1rem;
          box-shadow: 0 4px 12px var(--shadow-color); text-align: left; margin-bottom: 1.5rem;
        }
        #fun-fact-container h2 {
          color: var(--accent); font-family: 'Poppins', sans-serif; font-weight: 700;
          margin-bottom: 0.25rem; font-size: 0.875rem; letter-spacing: 0.05em; text-transform: uppercase;
        }
        #fun-fact-text {
          color: var(--text-subtle); border-top: 2px solid var(--card-bg-subtle);
          padding-top: 0.5rem; font-size: 0.875rem;
        }

        #searching-modal {
          position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center;
          background: rgba(0,0,0,.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        #searching-dialog {
          background: var(--list-card-bg); color: var(--card-text); border-radius: 1.5rem; padding: 2.5rem;
          display: flex; flex-direction: column; align-items: center; gap: 1rem;
          box-shadow: 0 20px 60px rgba(0,0,0,.5);
        }
        #searching-dialog-icon { font-size: 3.5rem; animation: spin 2s linear infinite; }
        #searching-dialog-text { font-size: 1.25rem; font-family: 'Poppins', sans-serif; font-weight: 700; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pt-safe pb-safe">

  <button id="settings-button" class="action-card rounded-full fixed top-4 right-4 z-30 w-12 h-12 flex items-center justify-center text-2xl" aria-label="Settings">⚙️</button>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center" role="main" aria-live="polite">
    <section id="main-screen" aria-labelledby="app-title">
      <h1 id="app-title" class="text-4xl md:text-5xl font-header font-bold mb-4" style="color: var(--text);">Local Explorer</h1>

      <section id="fun-fact-container">
        <h2>Local Fact</h2>
        <p id="fun-fact-text">Loading...</p>
      </section>

      <p id="location-status" class="text-lg font-semibold my-4" style="color: var(--text-subtle);">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" inputmode="search" placeholder="Enter a city or place"
                 class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card card-accent text-white p-3 rounded-r-lg" aria-label="Search">🔍</button>
        </div>
      </div>

      <nav id="filter-container" class="grid grid-cols-3 gap-3">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🍽️<span class="mt-1">Foodie Finds</span></button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🏛️<span class="mt-1">Iconic Sights</span></button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🌙<span class="mt-1">Night Out</span></button>
        <button data-filter="outdoors" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🏞️<span class="mt-1">Outdoors</span></button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">💎<span class="mt-1">Hidden Gems</span></button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-4 text-sm flex flex-col items-center justify-center">🐾<span class="mt-1">Pet Friendly</span></button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-4 text-sm col-span-3">🛠️ Utilities & Help</button>
      </nav>

      <button id="show-saved-button" class="action-card card-accent-alt w-full mt-4 rounded-lg font-bold py-3 text-base">⭐ My Saved Places</button>
      <button id="local-events-button" class="action-card card-accent-dark w-full mt-4 rounded-lg font-bold py-3 text-base">🎟️ Local Events</button>
      <button id="random-button" class="action-card card-accent w-full mt-4 rounded-lg font-bold py-3 text-base">🤷 Surprise Me!</button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden action-card w-full mt-4 rounded-lg font-bold py-3 text-base" style="background: var(--card-bg-subtle);">← Back to Main Menu</button>
    </section>
  </main>

  <section id="results-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="results-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="results-meta" class="text-sm opacity-80 mb-3"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  <section id="saved-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="saved-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="saved-title" class="text-xl font-header font-bold">My Saved Places</h2>
        <button id="close-saved-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="saved-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  <section id="events-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="events-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="events-title" class="text-xl font-header font-bold">Local Events</h2>
        <button id="close-events-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div class="text-xs opacity-60 text-center mb-2 -mt-2">
        Events provided by <a href="https://ticketmaster.com" target="_blank" rel="noopener" class="underline">Ticketmaster</a>
      </div>
      <div id="events-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>
  
  <section id="reviews-list-screen" class="list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="reviews-list-card" class="list-card">
      <div class="flex items-center justify-between mb-3">
        <h2 id="reviews-title" class="text-xl font-header font-bold">Reviews</h2>
        <button id="close-reviews-button" class="action-card" style="background: var(--card-bg-subtle); padding: 8px 12px; border-radius: 8px; font-weight: 600;">Back</button>
      </div>
      <div id="review-sort-container" class="flex gap-2 mb-3">
        <button id="sort-reviews-best" class="review-sort-button flex-1">Best</button>
        <button id="sort-reviews-worst" class="review-sort-button flex-1">Worst</button>
        <button id="sort-reviews-recent" class="review-sort-button flex-1 active">Recent</button>
      </div>
      <div id="review-star-filter-container" class="flex justify-center gap-1 mb-3">
        <button class="review-star-button" data-rating="5">★★★★★</button>
        <button class="review-star-button" data-rating="4">★★★★☆</button>
        <button class="review-star-button" data-rating="3">★★★☆☆</button>
        <button class="review-star-button" data-rating="2">★★☆☆☆</button>
        <button class="review-star-button" data-rating="1">★☆☆☆☆</button>
        <button id="clear-star-filter" class="review-star-button text-xs font-bold" style="opacity: 0.8; color: var(--text-subtle);">Clear</button>
      </div>
      <div id="reviews-list" class="space-y-2 max-h-[55vh] overflow-y-auto"></div>
    </div>
  </section>

  <section id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" loading="lazy" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Place photo" class="w-full h-32 object-cover rounded-lg mb-4" style="background-color: var(--card-bg);" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform" aria-pressed="false">☆</button>
        </div>
      </div>
      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold" style="color: var(--accent);" id="place-rating">...</p>
        <p class="font-semibold" style="color: var(--accent-alt);" id="place-price">...</p>
        <a id="phone-link" href="#" class="hover:underline text-sm" style="color: var(--text-subtle);"></a>
      </div>
      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>
      <button id="show-reviews-button" class="action-card card-accent-dark w-full mt-3 mb-4 rounded-lg font-bold py-3 text-base" disabled>
        Show Reviews (0)
      </button>
      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card card-accent font-bold py-3 px-4 rounded-lg">Map</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card font-bold py-3 px-4 rounded-lg hidden" style="background: var(--card-bg-subtle);">Website</a>
        <button id="share-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card card-accent-alt font-bold py-3 px-4 rounded-lg">Compass</button>
      </div>
      <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
        <button id="try-again-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl" style="background: var(--card-bg-subtle);">Back</button>
        <button id="next-suggestion-button" class="flex-1 action-card card-accent-dark font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
      </div>
    </div>
  </section>

  <div id="compass-modal" class="modal-base">
    <div id="compass-dialog" class="modal-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-2">
        <h2 id="modal-title" class="font-header text-lg">Live Compass</h2>
        <div class="flex gap-2">
          <button id="guide-button" class="action-card card-accent-dark font-bold py-2 px-3 rounded-lg">Guide Me ▶︎</button>
          <button id="close-compass" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button>
        </div>
      </header>
      <div id="nav-bubble">
        <div id="nav-main">Head toward destination</div>
        <div id="nav-sub">Follow the arrow</div>
      </div>
      <div id="compass-overlay">
        <div id="compass-arrow"></div>
        <div id="compass-dist">--</div>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal-base">
    <div id="settings-dialog" class="modal-dialog" tabindex="-1">
      <header class="flex items-center justify-between mb-4">
        <h2 class="font-header text-xl">Settings</h2>
        <button id="close-settings-button" class="action-card font-bold py-2 px-3 rounded-lg" style="background: var(--card-bg-subtle);">Close</button>
      </header>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Theme</h3>
          <div class="grid grid-cols-3 gap-2">
            <button class="theme-button flex-1" data-theme="day-ops">☀️ Day Ops</button>
            <button class="theme-button flex-1" data-theme="rugged-explorer">⚓ Rugged</button>
            <button class="theme-button flex-1" data-theme="night-ops">🌙 Night Ops</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Guide Voice</h3>
          <select id="voice-selector"> <option value="">Loading voices...</option> </select>
        </div>
        <a id="donate-button" href="https://venmo.com/u/Stephen-Mohamed-1" target="_blank" rel="noopener" 
           class="action-card card-accent-alt font-bold py-3 px-4 rounded-lg w-full block text-center">
          Buy me a coffee (Venmo)
        </a>
        <p id="app-version" class="text-center text-xs opacity-60 mt-4">App Version 9.0</p>
      </div>
    </div>
  </div>
  
  <div id="searching-modal">
    <div id="searching-dialog">
      <div id="searching-dialog-icon">🧭</div>
      <div id="searching-dialog-text">Acquiring Target...</div>
    </div>
  </div>

<script>
    /* ====== IMMEDIATE SETTINGS LOAD ====== */
    // ... (loadSettingsImmediate function remains outside) ...
    let savedPlaces = {}; let currentVoiceURI = null; loadSettingsImmediate();

    /* ====== SW Registration ====== */
    // ... (SW registration remains outside) ...

    // *** NEW: Wrap main script logic in DOMContentLoaded ***
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DEBUG: DOMContentLoaded event fired. Initializing main script logic.");

        /* ====== Refs ====== */
        // Now it's safe to get element references here
        const funFactContainer = document.getElementById('fun-fact-container');
        // ... (ALL your const element = getElementById lines) ...
        const reviewDateFilterInfo = document.getElementById('review-date-filter-info');
        const reviewFiltersContainer = document.getElementById('review-filters-container');
        const compassButton = document.getElementById('compass-button'); // Add ref for compass button

        /* ====== State ====== */
        // ... (your let variables) ...

        /* ====== Categories ====== */
        // ... (your const category objects) ...

        /* ====== Utils ====== */
        // ... (your utility functions) ...

        /* ====== Local Facts ====== */
        // ... (your fact functions) ...

        /* ====== Results/Saved/Events/Reviews Lists ====== */
        // ... (your show...List functions) ...

        function showReviews() {
             console.log("DEBUG: showReviews called. Sort:", currentReviewSort, "Star Filter:", currentStarFilter);
             mainScreen.style.display = 'none'; resultScreen.style.display = 'none'; reviewsListScreen.style.display = 'flex';

             // No longer need null check for reviewDateFilterInfo IF DOMContentLoaded is used correctly
             reviewDateFilterInfo.textContent = ""; // Clear date message

             const reviewsToDisplay = [...currentReviews];
             console.log("DEBUG: Total reviews available (no date filter):", reviewsToDisplay.length);

             const showFilters = currentReviews.length >= 20;

             // No longer need null check for reviewFiltersContainer IF DOMContentLoaded is used correctly
             reviewFiltersContainer.style.display = showFilters ? 'block' : 'none';
             reviewSortContainer.style.display = showFilters ? 'flex' : 'none';

             // ... (rest of showReviews function) ...
        }


        /* ====== Search ====== */
        // ... (your find... functions) ...

        /* ====== Details, Directions, Compass ====== */
        function openDetailsById(placeId){ /* ... */ }

        function getPlaceDetails(summary){
            // ... (initial setup) ...

            // Disable Save and Compass buttons initially
            savePlaceButton.disabled = true;
            compassButton.disabled = true; // Disable compass
            updateSaveButtonState();

            // ... (rest of setup) ...

            console.log("DEBUG: Fetching details for placeId:", summary.place_id);
            placesService.getDetails({ /* ... */ }, (place, status) => {
                 console.log("DEBUG: Place Details status:", status, "Place:", place ? place.name : 'null');
                 if(status===google.maps.places.PlacesServiceStatus.OK && place){
                    // ... (update currentPlace, name, stars etc.) ...

                    // Enable Save button only if place_id exists
                    if (place.place_id) {
                        savePlaceButton.disabled = false;
                        updateSaveButtonState();
                    } else {
                        console.error("DEBUG: Place details loaded BUT place_id is missing!", place);
                        savePlaceButton.disabled = true;
                    }

                    // Set destination and enable Compass button
                    buildRouteTo(place.geometry.location); // This sets destLatLng
                    if (destLatLng) { // Check if destLatLng was set successfully
                       compassButton.disabled = false; // Enable compass
                    } else {
                       compassButton.disabled = true; // Keep disabled if route build failed
                       console.warn("DEBUG: buildRouteTo might have failed, destLatLng not set.");
                    }

                 } else {
                    // ... (error handling) ...
                    savePlaceButton.disabled = true; // Keep disabled on error
                    compassButton.disabled = true; // Keep compass disabled on error
                 }
            });
        }

        function buildRouteTo(latLng){
            destLatLng = null; // Reset destLatLng before trying to set it
            if(!currentUserLocation || !directionsService) {
                console.warn("DEBUG: buildRouteTo - missing user location or directions service.");
                return; // Exit if prerequisites missing
            }
            // Add safety check for latLng
            if (!latLng || typeof latLng.lat !== 'function' || typeof latLng.lng !== 'function') {
                 console.error("DEBUG: buildRouteTo - invalid latLng received:", latLng);
                 return;
            }
            destLatLng = latLng; // Set it ONLY if valid
            console.log("DEBUG: buildRouteTo setting destLatLng:", destLatLng.toJSON()); // Log the value being set
            directionsService.route({ /* ... */ }, (response, status) => {
                 if (status === 'OK' && response.routes?.[0]?.legs?.[0]?.steps) {
                     // ... (process steps) ...
                 } else {
                     routeSteps = []; stepTarget = null;
                     // Keep destLatLng set even if routing fails, compass can still point directly
                     console.warn("DEBUG: Directions service failed:", status);
                 }
             });
        }

        // ... (rest of Details, Compass functions) ...

        /* ====== Settings ====== */
        // ... (your settings functions) ...

        /* ====== Init / Geocode ====== */
        // NOTE: initApp IS CALLED BY GOOGLE MAPS, leave it outside DOMContentLoaded
        // But the code *inside* initApp that relies on the DOM might need adjustment
        // Let's assume Google Maps callback ensures DOM is ready by then, usually safe.

        // ... (your geocode functions) ...

        /* ====== UI & Events ====== */
        // ... (your show/hide menu, resetApp functions) ...

        // Your main document.addEventListener('click', ...) stays inside DOMContentLoaded
        document.addEventListener('click', (e)=>{
             // ... (all your click handling logic) ...
        });

        // Your input listeners stay inside DOMContentLoaded
        document.getElementById('location-input').addEventListener('keyup',e=>{if(e.key==='Enter') geocodeLocation();});
        document.getElementById('voice-selector').addEventListener('change', e => { applyVoice(e.target.value); });

        console.log("DEBUG: Main script logic initialized.");
    }); // *** End of DOMContentLoaded wrapper ***

    /* ====== Init / Geocode ====== */
    // initApp needs to be globally accessible for the Google Maps callback
    function initApp(){
        console.log("DEBUG: initApp called by Google Maps callback.");
        // Ensure DOM is ready before proceeding inside initApp, though DOMContentLoaded should cover this
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMapServices);
        } else {
            initializeMapServices();
        }
    }
    window.initApp=initApp; // Make it global

    function initializeMapServices() { // Renamed original initApp content
        console.log("DEBUG: initializeMapServices running.");
        loadSettings(); // Okay here
        placesService=new google.maps.places.PlacesService(document.createElement('div'));
        geocoder=new google.maps.Geocoder();
        directionsService=new google.maps.DirectionsService();
        // Now it's safe to access locationStatus etc. because DOM is ready
        toggleFilterButtons(true);
        locationStatus.textContent = 'Acquiring location...';
        if(navigator.geolocation){
            console.log("DEBUG: Geolocation supported.");
            navigator.geolocation.getCurrentPosition( pos => { /* ... */ }, handleLocationError, { /* ... */ } );
        } else { /* ... */ }
    }

    // ... (handleLocationError, reverseGeocodeSetLocation, geocodeLocation, setLocationAndEnableApp functions remain global or are called safely from within DOMContentLoaded scope) ...
     function handleLocationError(error) { /* ... */ }
     function reverseGeocodeSetLocation(coords){ /* ... */ }
     function geocodeLocation(){ /* ... */ }
     function setLocationAndEnableApp(coords,label){ /* ... */ }

</script>
</body>
</html>
