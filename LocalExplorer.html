<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Explorer</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#f8f7f2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="key.js"></script>
  <style>
    :root {
      /* Polished Salty Sailor theme variables */
      --background: #f8f7f2;
      --card: #1a2b44;      /* Matte navy */
      --primary: #c87941;   /* Brass/Copper */
      --secondary: #334e68; /* Muted teal/blue */
      --text-dark: #1a2b44;
      --text-light: #ffffff;
      --accent: #8a5a44;     /* Teak brown */
      --radius: 12px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Raleway', sans-serif;
      background-color: var(--background);
      color: var(--text-dark);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: contain; /* Prevent scroll bounce on mobile */
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    h1, h2, h3 {
      font-family: 'Poppins', sans-serif;
      margin: 0;
    }
    h1 {
      font-size: 1.8rem;
      color: var(--card);
      letter-spacing: 0.05rem;
      text-transform: uppercase;
      font-weight: 700;
      margin: 0;
    }
    #appHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 90%;
      margin: 0 auto;
      padding: 1rem 0.5rem 0.75rem;
      border-bottom: 3px solid var(--accent);
      gap: 0.75rem;
      position: sticky;
      top: 0;
      background: var(--background);
      z-index: 6;
    }
    #appHeader h1 {
      margin: 0;
    }
    #settingsBtn {
      background-color: var(--card);
      color: var(--text-light);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #settingsBtn:hover {
      transform: rotate(12deg) scale(1.05);
      box-shadow: 0 4px 14px rgba(0,0,0,0.3);
    }
    #settingsBtn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    #locationDisplay {
      text-align: center;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      color: var(--card);
      font-weight: 500;
      letter-spacing: 0.02rem;
    }
    #manualInputContainer {
      display: none;
      margin: 0.5rem auto;
      max-width: 90%;
    }
    #manualInputContainer input {
      width: 100%;
      padding: 0.6rem;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      font-size: 1rem;
      background-color: var(--background);
      color: var(--card);
      outline: none;
    }
    #weatherWidget {
      background: linear-gradient(145deg, var(--secondary), rgba(8, 54, 80, 0.8));
      color: var(--text-light);
      margin: 0.5rem auto;
      padding: 0.95rem 1.1rem;
      border-radius: var(--radius);
      max-width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      transition: gap 0.3s ease, padding-bottom 0.3s ease; /* Added padding transition */
    }
     /* Make header content align center */
    #weatherHeader {
      display: flex;
      justify-content: space-between;
      align-items: center; /* FIX: Changed from flex-start */
      gap: 0.75rem;
      min-height: 40px; /* Ensure space for buttons */
    }
    #weatherLabels {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      flex-grow: 1; /* Allow labels to take space */
    }
    #weatherTitle {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      letter-spacing: 0.04rem;
    }
    #weatherUpdated {
      font-size: 0.7rem;
      opacity: 0.75;
    }
    #refreshWeatherBtn {
      background: rgba(255,255,255,0.15);
      color: var(--text-light);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
      flex-shrink: 0;
    }
    #refreshWeatherBtn:hover {
      background: rgba(255,255,255,0.25);
      transform: rotate(-18deg);
    }
    #refreshWeatherBtn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    /* FIX: Adjusted anchor button positioning */
    .weather-toggle-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.5rem; /* Adjust size as needed */
      cursor: pointer;
      opacity: 0.7;
      transition: transform 0.3s ease, opacity 0.2s ease;
      padding: 0; /* Remove default padding */
      line-height: 1; /* Ensure tight vertical fit */
      margin-left: 0.5rem; /* Space from refresh button */
      flex-shrink: 0;
      /* Removed absolute positioning */
    }
    .weather-toggle-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    #weatherWidget.weather-minimized .weather-toggle-btn {
      transform: rotate(180deg); /* Keep rotation for visual cue */
    }
    /* Hide content when minimized */
    #weatherWidget.weather-minimized #weatherContent {
      display: none;
    }
    #weatherWidget.weather-minimized {
      gap: 0;
      padding-bottom: 0.5rem; /* Reduce padding when closed */
    }

    #weatherContent {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    #weatherPrimary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 2.4rem;
      font-weight: 600;
    }
    #weatherIcon {
      font-size: 2.2rem;
    }
    #weatherTemp {
      font-size: 2.6rem;
      font-weight: 700;
    }
    #weatherDetails {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.95rem;
      flex: 1;
      min-width: 160px;
    }
    #weatherDescription {
      font-size: 1rem;
      font-weight: 500;
    }
    #weatherMeta {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.85rem;
      opacity: 0.85;
    }
    #weatherRange {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      max-width: 90%;
      margin: 1rem auto;
    }
    .filter-btn {
      background-color: var(--card);
      color: var(--text-light);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: transform 0.1s ease, background-color 0.2s ease;
      touch-action: manipulation;
    }
    .filter-btn .emoji {
      font-size: 1.1rem;
    }
    .filter-btn:active {
      transform: scale(0.96);
      background-color: var(--secondary);
    }
    .filter-btn.support-btn {
      background: linear-gradient(145deg, #48586b, #7b8b9e);
      color: var(--text-light);
      border: 1px solid #a4b0bc;
      box-shadow: inset 1px 1px 2px rgba(255,255,255,0.3), inset -2px -2px 3px rgba(0,0,0,0.4);
    }
    .filter-btn.support-btn:hover {
      filter: brightness(1.05);
    }

    #settingsPanel .modal-content {
      max-width: 420px;
      padding: 1.25rem 1.5rem 1.5rem;
    }
    .setting-group {
      margin-bottom: 1rem;
    }
    .setting-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
      color: var(--card);
    }
    .setting-hint {
      display: block;
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
      color: var(--card);
    }
    #settingsPanel select {
      width: 100%;
      padding: 0.55rem;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      font-size: 0.95rem;
      background: var(--background);
      color: var(--card);
    }
    .setting-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      color: var(--card);
    }
    .settings-secondary {
      width: 100%;
      border: none;
      border-radius: var(--radius);
      background-color: var(--secondary);
      color: var(--text-light);
      padding: 0.65rem;
      font-size: 0.95rem;
      cursor: pointer;
      transition: filter 0.2s ease;
    }
    .settings-secondary:hover {
      filter: brightness(1.1);
    }
    #primaryActions {
      max-width: 90%;
      margin: 1rem auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    #myListBtn, #surpriseBtn, #myPlanBtn {
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      padding: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    #myListBtn {
      background-color: var(--secondary);
      color: var(--text-light);
      border: 1px solid var(--accent);
    }
    #surpriseBtn {
      background-color: var(--primary);
      color: var(--text-light);
      font-weight: 600;
      border: 1px solid var(--primary);
    }
    #myPlanBtn {
      background-color: var(--secondary);
      color: var(--text-light);
      border: 1px solid var(--accent);
    }
    #primaryActions button {
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      touch-action: manipulation;
    }
    #primaryActions button:active {
      transform: scale(0.97);
      box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    }
    #donateBtn { /* Legacy rule, kept in case used elsewhere */
      background: linear-gradient(145deg, #48586b, #7b8b9e);
      color: var(--text-light);
      border: 1px solid #a4b0bc;
      box-shadow: inset 1px 1px 2px rgba(255,255,255,0.3), inset -2px -2px 3px rgba(0,0,0,0.4);
    }

    /* Modal overlay */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal.active {
      display: flex;
      backdrop-filter: blur(2px);
    }
    body.modal-open {
      overflow: hidden;
    }
    .modal-content {
      --swipe-offset: 0px;
      background-color: var(--background);
      border-radius: var(--radius);
      max-height: 80vh;
      overflow-y: auto;
      width: 92%;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      padding: 1rem;
      position: relative;
      border: 2px solid var(--accent);
      transform: translateY(calc(20px + var(--swipe-offset, 0px))) scale(0.95);
      transition: transform 0.3s ease;
    }
    .modal.active .modal-content {
      transform: translateY(var(--swipe-offset, 0px)) scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--card);
      padding: 0.2rem;
    }
    .subMenuList button,
    .results-list button {
      width: 100%;
      background: var(--card);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .list-remove {
      margin-left: auto;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }
    .list-remove:hover,
    .list-remove:focus-visible {
      opacity: 1;
    }
    .special-btn {
      background: var(--primary);
      color: var(--text-light);
      font-weight: 600;
    }
    .subMenuList button:hover,
    .results-list button:hover {
      background: var(--secondary); /* Use secondary color for hover */
    }
    .load-more-btn {
      width: 100%;
      margin: 0.75rem 0 0;
      border: 1px dashed rgba(26,43,68,0.3);
      background: transparent;
      color: var(--card);
      border-radius: var(--radius);
      padding: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      display: none;
    }
    .load-more-btn:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    .results-item {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      width: 100%;
    }
    .results-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      text-align: left;
    }
    .results-info h4 {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: var(--text-light);
      letter-spacing: 0.03rem;
    }
    .results-info .rating {
      font-size: 0.8rem;
      color: #fbbf24; /* Keep rating color consistent */
    }
    /* Details sheet */
    #detailsSheet {
      --swipe-offset: 0px;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 70vh;
      background-color: var(--card);
      color: var(--text-light);
      border-radius: 20px 20px 0 0;
      transform: translateY(calc(100% + var(--swipe-offset, 0px)));
      transition: transform 0.35s ease;
      z-index: 25;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sheet-close {
      position: absolute;
      top: 0.3rem;
      right: 0.5rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-light);
      cursor: pointer;
      z-index: 5;
    }
    #detailsSheet.active {
      transform: translateY(var(--swipe-offset, 0px));
    }
    #detailsMap {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 40%;
      background: linear-gradient(135deg, rgba(26,43,68,0.9), rgba(51,78,104,0.85));
      pointer-events: none; /* Only interactive after opt-in */
    }
    #detailsSheet.streetview-active #detailsMap {
      pointer-events: auto;
    }
    #activateStreetViewBtn {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(200,121,65,0.9);
      border: 1px solid rgba(255,255,255,0.4);
      color: #fff;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
      pointer-events: auto;
    }
    #detailsSheet.streetview-active #activateStreetViewBtn {
      display: none;
    }
    #detailsContent {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60%;
      overflow-y: auto;
      padding: 1rem;
      background: rgba(26, 43, 68, 0.9); /* Use card color with alpha */
      backdrop-filter: blur(4px);
    }
    .sheet-handle {
      width: 54px;
      height: 5px;
      border-radius: 999px;
      background: rgba(255,255,255,0.35);
      margin: 0 auto 0.7rem;
    }
    #detailsContent h3 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    #detailsContent .stars, #detailsContent .price {
      color: var(--accent); /* Use accent color for stars/price */
      font-size: 1.1rem;
    }
    #detailsContent .stars { margin-right: 0.5rem; }
    #detailsActions {
      margin-top: 0.75rem;
    }
    .action-grid {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }
    .action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .action-pill {
      flex: 1;
      min-width: 130px;
      border-radius: calc(var(--radius) * 1.1);
      padding: 0.55rem 0.75rem;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: var(--text-light);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.15s ease, background-color 0.2s ease;
    }
    .action-pill:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.16);
    }
    .action-pill.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--text-light);
    }
    .action-pill.outline {
      background: transparent;
      border-color: rgba(255,255,255,0.45);
    }
    .action-pill.ghost {
      background: rgba(255,255,255,0.05);
    }
    .action-pill.in-plan {
      background: rgba(72,187,120,0.35);
      border-color: rgba(72,187,120,0.9);
      color: #e8ffef;
    }
    /* Accordion */
    .accordion {
      background: var(--secondary);
      color: var(--text-light);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 0.75rem;
      width: 100%;
      text-align: left;
      outline: none;
      cursor: pointer;
      margin-top: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
     .accordion:hover {
       background: var(--card);
     }
    .accordion-content {
      background: var(--secondary);
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 0 0.5rem;
      border: 1px solid var(--accent);
      border-top: none;
    }
    .accordion.active + .accordion-content {
      max-height: 300px;
      padding: 0.5rem;
    }
    /* My List modal */
    #myListModal .results-list button {
      background: var(--secondary); /* Match plan modal */
    }
    #myListModal .empty-state {
      text-align: center;
      color: var(--card);
      font-size: 0.9rem;
      margin: 1rem 0;
    }
    #myListModal .results-list button:hover,
    #planModal .results-list button:hover {
      background-color: var(--card); /* Darken on hover */
    }
    /* Compass & navigation overlay */
    /* --- Compass Futuristic HUD --- */
    #compassOverlay {
      position: fixed;
      bottom: 0.5rem;
      right: 0.5rem;
      transform: translateY(100%);
      width: 300px;
      max-width: 90%;
      background: linear-gradient(165deg, rgba(20,32,48,0.92), rgba(8,18,30,0.98));
      color: var(--text-light);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: 0 18px 36px rgba(0,0,0,0.55), inset 0 0 18px rgba(138,90,68,0.18);
      z-index: 40;
      transition: transform 0.4s ease;
      overflow: hidden;
      border: 1px solid rgba(138,90,68,0.55);
      backdrop-filter: blur(8px);
    }
    #compassOverlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 0%, rgba(255,204,153,0.18), transparent 55%), radial-gradient(circle at 80% 20%, rgba(120,180,255,0.12), transparent 60%);
      pointer-events: none;
    }
    #compassOverlay.active {
      transform: translateY(0);
    }
    #compassTop {
      position: relative;
      padding: 1.6rem;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background: radial-gradient(circle at center, rgba(50,80,118,0.45) 0%, rgba(8,18,30,0.92) 70%);
    }
    .compass-holo {
      position: relative;
      width: 180px;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 0 24px rgba(200,120,65,0.45));
    }
    .holo-ring {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(200,120,65,0.35);
      box-shadow: 0 0 25px rgba(200,120,65,0.25);
      animation: pulseRing 7s ease-in-out infinite;
    }
    .holo-ring.outer {
      width: 170px;
      height: 170px;
      animation-delay: 0s;
    }
    .holo-ring.inner {
      width: 140px;
      height: 140px;
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 0 18px rgba(120,200,255,0.18);
      animation-duration: 9s;
      animation-direction: alternate;
    }
    .holo-core {
      position: relative;
      width: 122px;
      height: 122px;
      border-radius: 50%;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: radial-gradient(circle, rgba(255,255,255,0.12) 0%, rgba(22,36,58,0.92) 70%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .holo-core::after {
      content: '';
      position: absolute;
      inset: -20%;
      background: conic-gradient(from 0deg, rgba(120,200,255,0.35), transparent 60%);
      animation: radarSweep 4.5s linear infinite;
      mix-blend-mode: screen;
      opacity: 0.65;
    }
    .holo-grid {
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 2px, transparent 2px, transparent 6px),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 2px, transparent 2px, transparent 6px);
      animation: gridDrift 14s linear infinite;
      opacity: 0.7;
    }
    .holo-glow {
      position: absolute;
      width: 120%;
      height: 120%;
      border-radius: 50%;
      pointer-events: none;
      background: radial-gradient(circle, rgba(200,120,65,0.35) 0%, transparent 65%);
      filter: blur(14px);
      animation: glowPulse 5.5s ease-in-out infinite alternate;
    }
    #compassNeedle {
      position: absolute;
      top: 18px;
      left: 50%;
      width: 10px;
      height: 86px;
      transform: translateX(-50%) rotate(0deg);
      transform-origin: center 74px;
      border-radius: 999px 999px 18px 18px;
      background: linear-gradient(180deg, rgba(255,186,140,0.96) 0%, rgba(200,120,65,0.85) 60%, rgba(255,255,255,0.7) 100%);
      box-shadow: 0 0 22px rgba(200,120,65,0.5), 0 0 6px rgba(255,255,255,0.45);
      transition: transform 0.45s ease-out;
    }
    #compassNeedle::after {
      content: '';
      position: absolute;
      bottom: -20px;
      left: 50%;
      width: 3px;
      height: 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(200,120,65,0.55));
      border-radius: 4px;
      transform: translateX(-50%);
      opacity: 0.7;
      box-shadow: 0 0 10px rgba(255,255,255,0.35);
    }
    .cardinal {
      position: absolute;
      font-size: 0.75rem;
      letter-spacing: 0.28rem;
      font-weight: 600;
      color: rgba(255,255,255,0.75);
      text-shadow: 0 0 8px rgba(200,120,65,0.6);
    }
    .cardinal.north { top: 6px; left: 50%; transform: translateX(-50%); }
    .cardinal.south { bottom: 6px; left: 50%; transform: translateX(-50%); }
    .cardinal.east { right: 10px; top: 50%; transform: translateY(-50%); letter-spacing: 0.2rem; }
    .cardinal.west { left: 10px; top: 50%; transform: translateY(-50%); letter-spacing: 0.2rem; }
    #compassControls {
      position: relative;
      background: linear-gradient(180deg, rgba(18,30,46,0.92), rgba(12,20,30,0.96));
      padding: 0.75rem 1.1rem 1.1rem;
      border-top: 1px solid rgba(138,90,68,0.4);
    }
    #compassControls::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(200,120,65,0.08), transparent 50%);
      pointer-events: none;
    }
    #radarMap {
      width: 100%;
      height: 140px;
      border-radius: calc(var(--radius) / 1.2);
      border: 1px solid rgba(120,180,255,0.18);
      overflow: hidden;
      margin-bottom: 0.75rem;
      background: rgba(0,0,0,0.2);
    }
    .compass-note {
      background: rgba(200,120,65,0.18);
      color: rgba(255,255,255,0.82);
      padding: 0.35rem 0.7rem;
      border-radius: calc(var(--radius) / 1.4);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14rem;
    }
    #advancedCompassControls {
      border: 1px solid rgba(120,180,255,0.18);
      box-shadow: inset 0 0 16px rgba(120,180,255,0.08);
    }
    #advancedCompassControls label {
      color: rgba(255,255,255,0.8);
    }
    #travelModeToggle label {
      color: rgba(255,255,255,0.85);
      font-size: 0.92rem;
      letter-spacing: 0.05rem;
    }
    #navigationButtons {
      display: flex;
      gap: 0.55rem;
      margin-bottom: 0.6rem;
    }
    #navigationButtons button {
      flex: 1;
      padding: 0.45rem 0.4rem;
      border-radius: var(--radius);
      border: 1px solid rgba(120,180,255,0.25);
      background: linear-gradient(160deg, rgba(30,48,70,0.65), rgba(18,30,46,0.95));
      color: rgba(255,255,255,0.9);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.03rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35), inset 0 0 8px rgba(120,180,255,0.15);
      transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }
    #navigationButtons button:hover {
      transform: translateY(-1px);
      background: linear-gradient(160deg, rgba(44,70,110,0.8), rgba(22,38,60,0.95));
      box-shadow: 0 10px 20px rgba(0,0,0,0.35), inset 0 0 10px rgba(200,120,65,0.22);
    }
    #navigationButtons button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: inset 0 0 6px rgba(120,180,255,0.12);
      background: rgba(25,40,62,0.7);
    }
    #navigationButtons button:focus-visible {
      outline: 2px solid rgba(120,180,255,0.55);
      outline-offset: 2px;
    }
    #directionsList {
      max-height: 160px;
      overflow-y: auto;
      font-size: 0.86rem;
      line-height: 1.45;
      margin-top: 0.6rem;
      padding: 0.45rem;
      border-radius: calc(var(--radius) / 1.2);
      background: rgba(14,24,36,0.68);
      border: 1px solid rgba(120,180,255,0.12);
      box-shadow: inset 0 0 14px rgba(0,0,0,0.35);
    }
    #directionsList div {
      padding: 0.25rem 0.45rem;
      margin-bottom: 0.2rem;
      border-radius: 6px;
      transition: background-color 0.25s ease, color 0.25s ease;
      background: rgba(255,255,255,0.04);
    }
    #directionsList .current-step {
      background: rgba(200,120,65,0.2);
      color: rgba(255,255,255,0.95);
      font-weight: 700;
      box-shadow: 0 0 10px rgba(200,120,65,0.25);
    }
    .direction-icon {
      display: inline-block;
      width: 1.2em;
      margin-right: 0.35em;
      font-weight: 700;
      color: rgba(255,198,148,0.9);
    }
    #nextStepCard {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: calc(var(--radius) / 1.2);
      background: rgba(14,24,36,0.7);
      border: 1px solid rgba(120,180,255,0.18);
      box-shadow: inset 0 0 14px rgba(0,0,0,0.35);
    }
    .next-step-label {
      font-size: 0.75rem;
      letter-spacing: 0.1rem;
      text-transform: uppercase;
      color: rgba(255,255,255,0.65);
    }
    #nextStepText {
      font-size: 0.95rem;
      margin: 0.4rem 0 0.6rem;
      font-weight: 600;
      color: var(--text-light);
    }
    .next-step-actions {
      display: flex;
      gap: 0.4rem;
    }
    .next-step-actions button {
      flex: 1;
      border-radius: calc(var(--radius) / 1.5);
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.05);
      color: var(--text-light);
      padding: 0.35rem 0.4rem;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .next-step-actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #directionsList.collapsed {
      max-height: 0;
      padding: 0;
      border: none;
      opacity: 0;
      pointer-events: none;
    }
    #directionsList .future-step {
      opacity: 0.35;
      filter: blur(0.2px);
    }
    @keyframes pulseRing {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.04); opacity: 0.6; }
    }
    @keyframes gridDrift {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(6deg) scale(1.02); }
      100% { transform: rotate(12deg) scale(1); }
    }
    @keyframes glowPulse {
      0% { opacity: 0.35; transform: scale(0.96); }
      100% { opacity: 0.65; transform: scale(1.05); }
    }
    @keyframes radarSweep {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #hiddenMap { /* Hide map container used for Places Service */
      position: absolute;
      top: -10px; left: -10px; width: 1px; height: 1px; overflow: hidden;
    }
    /* Responsive adjustments */
    @media (max-width: 520px) {
      #appHeader {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
      }
      #settingsBtn { width: 40px; height: 40px; }
      #weatherContent { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      #weatherPrimary { font-size: 2.2rem; }
    }
    @media (min-width: 640px) {
      #primaryActions {
        flex-direction: row;
        gap: 0.75rem;
      }
      #primaryActions button {
        flex: 1;
      }
    }
    @media (min-width: 768px) {
      h1 { font-size: 2rem; }
      #detailsSheet { height: 60vh; }
      #detailsMap { height: 45%; }
      #detailsContent { height: 55%; }
    }
  </style>
</head>
<body>
  <header id="appHeader">
    <h1 id="appTitle">Local Explorer</h1>
    <button id="settingsBtn" type="button" aria-label="Open settings">⚙️</button>
  </header>
  <div id="locationDisplay">Determining your location…</div>
  <div id="manualInputContainer">
    <input type="text" id="manualInput" placeholder="Enter a location">
  </div>
  <div id="weatherWidget" aria-live="polite">
    <div id="weatherHeader">
      <div id="weatherLabels">
        <span id="weatherTitle">Local Weather</span>
        <span id="weatherUpdated">Waiting for location...</span>
      </div>
      <button id="refreshWeatherBtn" type="button" aria-label="Refresh weather">↻</button>
      <button id="toggleWeatherBtn" type="button" aria-label="Toggle weather details" class="weather-toggle-btn">⚓</button>
    </div>
    <div id="weatherContent">
      <div id="weatherPrimary">
        <span id="weatherIcon">--</span>
        <span id="weatherTemp">--°</span>
      </div>
      <div id="weatherDetails">
        <div id="weatherDescription">We will pull the forecast once we know where you are.</div>
        <div id="weatherMeta">
          <span id="weatherFeels">Feels like --°</span>
          <span id="weatherWind">Wind -- mph</span>
        </div>
        <div id="weatherRange">High --° / Low --°</div>
      </div>
    </div>
  </div>
  <div class="filters" id="filterGrid"></div>
  <div id="primaryActions">
    <button id="myListBtn">📋 My List</button>
    <button id="myPlanBtn">🗺️ My Plan</button>
    <button id="surpriseBtn">🎲 Surprise Events</button>
  </div>
  <div id="settingsPanel" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Settings</h3>
        <button class="close-btn" id="closeSettingsBtn">x</button>
      </div>
      <div class="setting-group">
        <label for="themeSelect">Theme</label>
        <select id="themeSelect">
          <option value="naval">Polished Sailor</option>
          <option value="sunset">Sunset Cruise</option>
          <option value="neon">Neon Harbor</option>
          <option value="arctic">Arctic Dawn</option>
          <option value="highseas">High Seas Neon</option>
          <option value="mojave">Mojave Drift</option>
          <option value="aurora">Aurora Mist</option>
        </select>
        <span class="setting-hint">Pick a style and we will remember it for next time.</span>
      </div>
      <div class="setting-group">
        <label for="voiceSelect">Voice</label>
        <select id="voiceSelect"></select>
        <span class="setting-hint">Used for spoken navigation prompts.</span>
      </div>
      <div class="setting-group">
        <label class="setting-toggle">
          <input type="checkbox" id="ambientModeToggle">
          <span>Ambient harbor sound cues</span>
        </label>
        <span class="setting-hint">Adds soft ambience while navigating (experimental).</span>
      </div>
      <div class="setting-group">
        <button id="resetSettingsBtn" class="settings-secondary" type="button">Reset to defaults</button>
      </div>
    </div>
  </div>
  <div id="hiddenMap"></div> <div id="subMenuModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="subMenuTitle">Categories</h3><button class="close-btn" id="closeSubMenu">×</button></div><div class="subMenuList" id="subMenuList"></div></div></div>
  <div id="resultsModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="resultsTitle">Results</h3><button class="close-btn" id="closeResults">×</button></div><div class="results-list" id="resultsList"></div><button id="loadMoreResultsBtn" class="load-more-btn" type="button">Keep scanning</button></div></div>
  <div id="myListModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>My List</h3><button class="close-btn" id="closeMyList">×</button></div><div class="results-list" id="myListContent"></div><div class="empty-state" id="myListEmpty" style="display:none;">Your saved places will appear here.</div></div></div>
  <div id="planModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>My Plan</h3><button class="close-btn" id="closePlan">×</button></div><div id="planSummary" style="margin-bottom:0.5rem; font-size:0.85rem; color:var(--card);"></div><div class="results-list" id="planContent"></div><div class="empty-state" id="planEmpty" style="display:none;">Your plan is empty.</div><div style="margin-top:0.5rem; display:flex; gap:0.5rem;"><button id="sharePlanBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--primary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Share Plan</button></div></div></div>
  <div id="donateModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Support Local Explorer</h3><button class="close-btn" id="closeDonate">×</button></div><p style="color: var(--card); font-size: 0.9rem; margin-bottom: 1rem;">If you enjoy using Local Explorer, consider supporting development. Donations help keep this sailor’s app afloat!</p><p style="color: var(--card); font-size: 0.9rem; margin-bottom: 1rem; text-align:center;">Venmo: <strong>@Stephen-Mohamed-1</strong></p><div style="display:flex; gap:0.5rem;"><button id="openVenmoBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--primary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Open Venmo</button><button id="copyVenmoBtn" style="flex:1; border:none; border-radius:var(--radius); background-color:var(--secondary); color:var(--text-light); padding:0.5rem; font-size:0.9rem;">Copy Handle</button></div></div></div>

  <div id="detailsSheet">
    <div id="detailsMap">
      <button id="activateStreetViewBtn" type="button" aria-label="Enable Street View Peek">👁️ Street View</button>
    </div>
    <div id="detailsContent">
      <div class="sheet-handle" aria-hidden="true"></div>
      <button id="closeDetailsBtn" class="sheet-close">×</button>
      <h3 id="detailsName"></h3>
      <div id="detailsRating"></div>
      <div id="detailsPhone"></div>
      <div id="detailsAddress"></div>
      <div id="detailsPrice"></div>
      <div id="detailsActions" class="action-grid">
        <div class="action-row primary">
          <button id="guideBtn" class="action-pill primary">🧭 Radar Route</button>
          <button id="mapsBtn" class="action-pill outline">📍 Open in Maps</button>
        </div>
        <div class="action-row secondary">
          <button id="saveBtn" class="action-pill ghost">☆ Save</button>
          <button id="planBtn" class="action-pill ghost">🗺️ Add to Plan</button>
          <button id="shareBtn" class="action-pill ghost">📤 Share</button>
          <button id="websiteBtn" class="action-pill ghost">🔗 Website</button>
        </div>
      </div>
      <button class="accordion" id="reviewsAccordion">Reviews</button>
      <div class="accordion-content" id="reviewsContent"></div>
      <button class="accordion" id="hoursAccordion">Weekly Hours</button>
      <div class="accordion-content" id="hoursContent"></div>
    </div>
  </div>

  <div id="compassOverlay">
    <div id="compassTop">
      <div class="compass-holo">
        <div class="holo-ring outer"></div>
        <div class="holo-ring inner"></div>
        <div class="holo-core">
          <div class="holo-grid"></div>
          <div id="compassNeedle"></div>
          <div class="cardinal north">N</div>
          <div class="cardinal east">E</div>
          <div class="cardinal south">S</div>
          <div class="cardinal west">W</div>
        </div>
        <div class="holo-glow"></div>
      </div>
    </div>
    <div id="compassControls">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <div class="compass-note">Set voice in main ⚙️</div>
        <button id="compassSettingsBtn" type="button" aria-label="Compass Settings" style="background:none; border:none; color: var(--text-light); font-size: 1.2rem; cursor: pointer;">⚙️</button>
      </div>
      <div id="advancedCompassControls" style="display: none; margin-bottom: 0.5rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: var(--radius);">
        <div id="travelModeToggle" style="margin-bottom: 0.5rem;">
          <label style="margin-right: 0.5rem;"><input type="radio" name="travelMode" value="DRIVING" checked> Driving</label>
          <label><input type="radio" name="travelMode" value="WALKING"> Walking</label>
        </div>
        <div id="radarControls"> <label style="display:block; font-size:0.8rem;">Map Zoom<input type="range" id="radarZoom" min="12" max="20" value="15" style="width:100%;"></label>
          <label style="display:block; margin-top:0.5rem; font-size:0.8rem;">Needle Brightness<input type="range" id="radarBrightness" min="30" max="100" value="70" style="width:100%;"></label>
        </div>
      </div>
      <div id="radarMap" aria-label="Route preview map"></div>
      <div id="navigationButtons">
        <button id="readDirectionsBtn">🗣️ Read Directions</button>
        <button id="silenceBtn" disabled>🔇 Silence</button>
        <button id="closeCompassBtn">Close</button>
      </div>
      <div id="nextStepCard">
        <div class="next-step-label">Next move</div>
        <div id="nextStepText">Waiting for route...</div>
        <div class="next-step-actions">
          <button id="nextStepBtn" type="button" disabled>Next step</button>
          <button id="showAllStepsBtn" type="button">Show full route</button>
        </div>
      </div>
      <div id="directionsList" class="collapsed"></div>
    </div>
  </div>

  <script>
    // Create the script tag for Google Maps after reading the API key from keys.js
    (function() {
      const fallbackKey = 'AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY'; // Replace if needed
      const mapsKey = window.MAPS_API_KEY || fallbackKey;
      const mapsScript = document.createElement('script');
      mapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${mapsKey}&libraries=places,geometry&callback=initMap`;
      mapsScript.async = true;
      mapsScript.defer = true;
      document.head.appendChild(mapsScript);
    })();
    function $(id) { return document.getElementById(id); } // Utility
    function sampleFromArray(list, count = 5) {
      const copy = [...list];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, count);
    }
    function stripHtml(text) { return (text || '').replace(/<[^>]+>/g, '').trim(); }
    function toPlainLatLng(latLng) {
      if (!latLng) return null;
      if (typeof latLng.lat === 'function' && typeof latLng.lng === 'function') {
        return { lat: latLng.lat(), lng: latLng.lng() };
      }
      if (typeof latLng.lat === 'number' && typeof latLng.lng === 'number') return latLng;
      return null;
    }

    let lastDeviceHeading = null, lastGeolocationHeading = null, pendingStreetViewLatLng = null;

    function normalizeHeading(value) {
      if (typeof value !== 'number' || Number.isNaN(value)) return null;
      return (value % 360 + 360) % 360;
    }

    function deriveHeadingFromEvent(ev) {
      if (!ev) return null;
      if (typeof ev.webkitCompassHeading === 'number') return normalizeHeading(ev.webkitCompassHeading);
      if (typeof ev.alpha === 'number') {
        const orientation = (screen?.orientation?.angle ?? window.orientation ?? 0);
        return normalizeHeading(360 - (ev.alpha + orientation));
      }
      return null;
    }

    function closeOverlayElement(el) {
      if (!el) return;
      el.classList.remove('active');
      const otherModalsOpen = document.querySelector('.modal.active');
      const detailsOpen = $("detailsSheet")?.classList.contains('active');
      const compassOpen = $("compassOverlay")?.classList.contains('active');
      if (!otherModalsOpen && !detailsOpen && !compassOpen) {
        document.body.classList.remove('modal-open');
      }
    }

    function enableSwipeDismiss({ container, dragTarget, scrollElement, onDismiss, threshold = 90, maxOffset = 220 }) {
      if (!container || !dragTarget || typeof onDismiss !== 'function') return;
      const scrollRef = scrollElement || dragTarget;
      let startY = 0;
      let currentOffset = 0;
      let dragging = false;

      const setOffset = (value) => dragTarget.style.setProperty('--swipe-offset', `${Math.max(0, value)}px`);
      const clearOffset = () => {
        dragTarget.style.transition = 'transform 0.18s ease';
        setOffset(0);
        requestAnimationFrame(() => {
          dragTarget.style.transition = '';
          dragTarget.style.removeProperty('--swipe-offset');
        });
      };

      const handleStart = (evt) => {
        if (!container.classList.contains('active')) return;
        if (evt.touches.length !== 1) return;
        if (scrollRef && scrollRef.scrollTop > 2) {
          dragging = false;
          return;
        }
        dragging = true;
        startY = evt.touches[0].clientY;
        currentOffset = 0;
        dragTarget.style.transition = '';
      };

      const handleMove = (evt) => {
        if (!dragging) return;
        const deltaY = evt.touches[0].clientY - startY;
        if (deltaY <= 0) {
          setOffset(0);
          return;
        }
        evt.preventDefault();
        currentOffset = Math.min(deltaY, maxOffset);
        setOffset(currentOffset);
      };

      const handleEnd = () => {
        if (!dragging) return;
        dragging = false;
        if (currentOffset > threshold) {
          setOffset(0);
          dragTarget.style.removeProperty('--swipe-offset');
          onDismiss();
        } else {
          clearOffset();
        }
        currentOffset = 0;
      };

      dragTarget.addEventListener('touchstart', handleStart, { passive: true });
      dragTarget.addEventListener('touchmove', handleMove, { passive: false });
      dragTarget.addEventListener('touchend', handleEnd, { passive: true });
      dragTarget.addEventListener('touchcancel', () => { dragging = false; clearOffset(); }, { passive: true });
    }

    function attachModalSwipe(modalEl, closeHandler) {
      if (!modalEl || typeof closeHandler !== 'function') return;
      const content = modalEl.querySelector('.modal-content');
      if (!content) return;
      enableSwipeDismiss({ container: modalEl, dragTarget: content, scrollElement: content, onDismiss: closeHandler });
    }

    function prepareStreetViewPreview(latLng) {
      pendingStreetViewLatLng = latLng || null;
      const sheet = $("detailsSheet");
      if (sheet) sheet.classList.remove('streetview-active');
      const btn = $("activateStreetViewBtn");
      if (btn) {
        btn.disabled = !latLng;
        btn.textContent = '👁️ Street View';
        btn.style.opacity = latLng ? '1' : '0.6';
      }
      if (streetViewPanorama) streetViewPanorama.setVisible(false);
    }

    function activateStreetViewPeek() {
      if (!pendingStreetViewLatLng || typeof google === 'undefined' || !google.maps) return;
      const btn = $("activateStreetViewBtn");
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Loading...';
      }
      const sheet = $("detailsSheet");
      const latLngLiteral = toPlainLatLng(pendingStreetViewLatLng);
      if (!latLngLiteral) {
        if (btn) {
          btn.disabled = false;
          btn.textContent = '👁️ Street View';
        }
        return;
      }
      const targetLatLng = new google.maps.LatLng(latLngLiteral.lat, latLngLiteral.lng);
      const streetService = new google.maps.StreetViewService();
      streetService.getPanorama({ location: targetLatLng, radius: 50 }, (data, status) => {
        if (btn) {
          btn.disabled = false;
          btn.textContent = '👁️ Street View';
        }
        if (status !== google.maps.StreetViewStatus.OK) {
          alert('Street View is not available for this location.');
          return;
        }
        const panoOpts = data?.location
          ? { pano: data.location.pano, pov: { heading: 270, pitch: 0 }, zoom: 1 }
          : { position: targetLatLng, pov: { heading: 0, pitch: 0 }, zoom: 0 };
        if (!streetViewPanorama) {
          streetViewPanorama = new google.maps.StreetViewPanorama($("detailsMap"), panoOpts);
        } else {
          if (panoOpts.pano) streetViewPanorama.setPano(panoOpts.pano);
          streetViewPanorama.setPosition(panoOpts.position || targetLatLng);
          streetViewPanorama.setPov(panoOpts.pov);
          streetViewPanorama.setZoom(panoOpts.zoom);
        }
        streetViewPanorama.setVisible(true);
        sheet?.classList.add('streetview-active');
      });
    }

    const DEFAULT_THEME = 'naval'; // Polished Sailor is the new 'naval'
    const THEMES = {
      naval: { '--background': '#f8f7f2', '--card': '#1a2b44', '--primary': '#c87941', '--secondary': '#334e68', '--text-dark': '#1a2b44', '--text-light': '#ffffff', '--accent': '#8a5a44' },
      sunset: { '--background': '#1b1c3d', '--card': '#ef476f', '--primary': '#ffd166', '--secondary': '#073b4c', '--text-dark': '#f7f5ff', '--text-light': '#fff8f0', '--accent': '#06d6a0' },
      neon: { '--background': '#080b1a', '--card': '#1f2a44', '--primary': '#ef2d56', '--secondary': '#2fbf71', '--text-dark': '#f2f7ff', '--text-light': '#f2f7ff', '--accent': '#08f7fe' },
      arctic: { '--background': '#e4f0f6', '--card': '#1b3b5f', '--primary': '#3d9be9', '--secondary': '#1f5673', '--text-dark': '#1b3b5f', '--text-light': '#ffffff', '--accent': '#8bc6ec' },
      highseas: { '--background': '#050a1c', '--card': '#0f2447', '--primary': '#1dd3b0', '--secondary': '#16355f', '--text-dark': '#d7f3ff', '--text-light': '#f0fbff', '--accent': '#58a4ff' },
      mojave: { '--background': '#fff3e1', '--card': '#4a2c22', '--primary': '#f4a259', '--secondary': '#bc5f34', '--text-dark': '#3f2a1b', '--text-light': '#fffaf5', '--accent': '#f7c59f' },
      aurora: { '--background': '#060b1b', '--card': '#102a43', '--primary': '#7f5af0', '--secondary': '#2cb67d', '--text-dark': '#e6f0ff', '--text-light': '#f7f2ff', '--accent': '#64dfdf' }
    };
    let currentThemeKey = DEFAULT_THEME;

    function applyThemeVariables(themeKey) { /* Applies CSS variables from THEMES */
      const theme = THEMES[themeKey] || THEMES[DEFAULT_THEME];
      if (!theme) return;
      const root = document.documentElement;
      Object.entries(theme).forEach(([token, value]) => root.style.setProperty(token, value));
      const themeColorMeta = document.querySelector('meta[name="theme-color"]');
      if (themeColorMeta) themeColorMeta.content = theme['--background'] || '#f8f7f2';
      currentThemeKey = themeKey;
    }
    function setTheme(themeKey, persist = true) { /* Sets theme and saves preference */
      applyThemeVariables(themeKey);
      if (persist) localStorage.setItem('selectedTheme', themeKey);
    }
    setTheme(localStorage.getItem('selectedTheme') || DEFAULT_THEME, false); // Apply saved theme on load

    // Global state variables
    let currentPosition = null, currentAddress = '', map, placesService, geocoder, streetViewPanorama;
    let currentResults = [], currentPlaceDetails, compassWatchId, latestLocationLabel = '', currentPaginationHandle = null, appendNextResults = false, lastResultsTitle = 'Results';
    let lastWeatherFetch = 0, lastWeatherCoords = null, cachedWeather = null;
    const WEATHER_CACHE_MS = 10 * 60 * 1000; // 10 minutes
    let selectedVoiceUri = localStorage.getItem('selectedVoiceUri') || '';

    // DOM element references
    const weatherElements = { widget: $("weatherWidget"), title: $("weatherTitle"), updated: $("weatherUpdated"), icon: $("weatherIcon"), temp: $("weatherTemp"), description: $("weatherDescription"), feels: $("weatherFeels"), wind: $("weatherWind"), range: $("weatherRange") };
    const voiceSelect = $("voiceSelect");

    function populateVoices() { /* Populates voice dropdown in settings */
      const voices = window.speechSynthesis.getVoices();
      if (!voiceSelect || !voices || voices.length === 0) return;
      voiceSelect.innerHTML = ''; // Clear existing options
      voices.forEach(voice => {
        const opt = document.createElement('option');
        opt.value = voice.voiceURI;
        opt.textContent = `${voice.name}${voice.lang ? ' (' + voice.lang + ')' : ''}`;
        voiceSelect.appendChild(opt);
      });
      const match = voices.find(v => v.voiceURI === selectedVoiceUri);
      if (match) voiceSelect.value = selectedVoiceUri;
      else if (voices[0]) { // Default to first available voice
        selectedVoiceUri = voices[0].voiceURI;
        voiceSelect.value = selectedVoiceUri;
        localStorage.setItem('selectedVoiceUri', selectedVoiceUri);
      }
    }
    if (voiceSelect) voiceSelect.addEventListener('change', (e) => { selectedVoiceUri = e.target.value; localStorage.setItem('selectedVoiceUri', selectedVoiceUri); });
    populateVoices(); // Initial population
    if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoices; // Repopulate if list changes

    const categories = { /* Define search categories */
      "Foodie Finds": [{ name: "Italian", keyword: "italian restaurant", type: "restaurant" }, { name: "Pizza", keyword: "pizza", type: "restaurant" }, { name: "Cafes", keyword: "cafe", type: "cafe" }, { name: "Bakeries", keyword: "bakery", type: "bakery" }, { name: "Sushi", keyword: "sushi", type: "restaurant" }],
      "Iconic Sights": [{ name: "Tourist Attractions", type: "tourist_attraction" }, { name: "Museums", type: "museum" }, { name: "Art Galleries", type: "art_gallery" }, { name: "Parks", type: "park" }, { name: "Landmarks", keyword: "landmark", type: "point_of_interest" }],
      "Night Out": [{ name: "Bars", type: "bar" }, { name: "Night Clubs", type: "night_club" }, { name: "Movie Theaters", type: "movie_theater" }, { name: "Bowling Alleys", type: "bowling_alley" }, { name: "Concert Venues", keyword: "concert", type: "point_of_interest" }],
      "Hidden Gems": [{ name: "Libraries", type: "library" }, { name: "Book Stores", type: "book_store" }, { name: "Gardens", keyword: "garden", type: "park" }, { name: "Historical Sites", keyword: "historical site", type: "point_of_interest" }, { name: "Local Favorites", keyword: "local favorite", type: "point_of_interest" }, { name: "Historical Markers", keyword: "historical marker", type: "point_of_interest" }],
      "Pet Friendly": [{ name: "Dog Parks", keyword: "dog park", type: "park" }, { name: "Pet Stores", type: "pet_store" }, { name: "Veterinary Care", type: "veterinary_care" }, { name: "Pet Friendly Cafes", keyword: "pet friendly cafe", type: "cafe" }, { name: "Pet Friendly Hotels", keyword: "pet friendly hotel", type: "lodging" }],
      "Utilities & Help": [{ name: "Hospitals", type: "hospital", ignoreRating: true }, { name: "Pharmacies", type: "pharmacy", ignoreRating: true }, { name: "Police", type: "police", ignoreRating: true }, { name: "Gas Stations", type: "gas_station", ignoreRating: true }, { name: "ATMs", type: "atm", ignoreRating: true }],
      "Outdoor": [{ name: "Parks", type: "park" }, { name: "Trails", keyword: "hiking trail", type: "park" }, { name: "Nature Reserves", keyword: "nature reserve", type: "park" }, { name: "Beaches", keyword: "beach", type: "park" }, { name: "Campgrounds", keyword: "campground", type: "campground" }],
      "Local Events": [{ name: "All Events", value: "all" }, { name: "Music", value: "music" }, { name: "Sports", value: "sports" }, { name: "Comedy", value: "comedy" }, { name: "Festivals", value: "festival" }]
    };
    function initApp() { /* Main app initialization after Maps loads */
      map = new google.maps.Map($("hiddenMap"), { center: { lat: 0, lng: 0 }, zoom: 15 });
      placesService = new google.maps.places.PlacesService(map);
      geocoder = new google.maps.Geocoder();
      if (navigator.geolocation) navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError);
      else showManualInput(); // Fallback if no geolocation
      populateFilterButtons(); // Create category buttons
      initWeatherControls(); // Setup weather refresh/toggle
      initSettingsPanel(); // Setup settings modal
      setupAccordions(); // Enable accordions in details
      checkSharedPlan(); // Check URL for shared plan
    }
    function onLocationSuccess(position) { /* Geolocation success */
      currentPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
      reverseGeocode(currentPosition); // Get address from coordinates
    }
    function onLocationError(err) { /* Geolocation failed */
      console.warn('Geolocation failed', err);
      $("locationDisplay").textContent = "Enter a location to begin";
      showManualInput(); // Show manual input field
      setWeatherPlaceholder('Enter a location to see the latest weather.');
    }
    function showManualInput() { /* Show manual location input */
      $("manualInputContainer").style.display = 'block';
      const input = $("manualInput");
      if (input.dataset.listenerAttached === 'true') return; // Prevent multiple listeners
      input.dataset.listenerAttached = 'true';
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const addr = input.value.trim();
          if (addr) { setWeatherPlaceholder('Looking up weather...'); geocodeAddress(addr); }
        }
      });
    }
    function geocodeAddress(address) { /* Get coords from address */
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          currentPosition = { lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() };
          currentAddress = results[0].formatted_address;
          displayLocation(results[0], currentPosition);
          updateWeather(currentPosition, { force: true });
        } else alert('Location not found. Please try again.');
      });
    }
    function reverseGeocode(pos) { /* Get address from coords */
      geocoder.geocode({ location: pos }, (results, status) => {
        if (status === 'OK' && results[0]) {
          currentAddress = results[0].formatted_address;
          displayLocation(results[0], pos);
          updateWeather(pos);
        } else { // Fallback display
          $("locationDisplay").innerHTML = `<span style="font-size:0.85rem;">${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}</span>`;
          latestLocationLabel = ''; updateWeatherTitle(); updateWeather(pos);
        }
      });
    }
    function displayLocation(result, pos) { /* Update UI with location */
        let city = '', state = '';
        if (result.address_components) {
            result.address_components.forEach(comp => {
            if (comp.types.includes('locality')) city = comp.long_name;
            if (comp.types.includes('administrative_area_level_1')) state = comp.short_name || comp.long_name;
            });
        }
        let locStr = city && state ? `${city}, ${state}` : city || state || currentAddress;
        latestLocationLabel = locStr.replace(/[<>]/g, ''); // Sanitize
        $("locationDisplay").innerHTML = `${locStr}<br><span style="font-size:0.75rem; opacity:0.8;">${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}</span>`;
        updateWeatherTitle();
    }
    function populateFilterButtons() { /* Create main category buttons */
      const grid = $("filterGrid"); grid.innerHTML = '';
      Object.keys(categories).forEach(cat => {
        const btn = document.createElement('button'); btn.className = 'filter-btn';
        btn.innerHTML = `<span class="emoji">${getIconForCategory(cat)}</span>${cat}`;
        btn.onclick = () => openSubMenu(cat); grid.appendChild(btn);
      });
      const supportBtn = document.createElement('button'); supportBtn.className = 'filter-btn support-btn';
      supportBtn.innerHTML = '⚓ Donate'; supportBtn.onclick = () => { $("donateModal").classList.add('active'); document.body.classList.add('modal-open'); };
      grid.appendChild(supportBtn);
    }
    function getIconForCategory(cat) { /* Get emoji for category */
      switch (cat) {
        case 'Foodie Finds': return '🍽️'; case 'Iconic Sights': return '🏛️'; case 'Night Out': return '🌙';
        case 'Hidden Gems': return '💎'; case 'Pet Friendly': return '🐾'; case 'Utilities & Help': return '🛠️';
        case 'Outdoor': return '🌲'; case 'Local Events': return '🎟️'; default: return '';
      }
    }
    function openSubMenu(categoryName) { /* Open sub-category modal */
      $("subMenuTitle").textContent = categoryName; const list = $("subMenuList"); list.innerHTML = '';
      categories[categoryName].forEach(item => {
        const btn = document.createElement('button'); btn.textContent = item.name;
        btn.onclick = () => { closeSubMenu(); performSearch(categoryName, item); }; list.appendChild(btn);
      });
      if (categoryName === 'Foodie Finds') { // Special button for Foodie Finds
        const surpriseBtn = document.createElement('button'); surpriseBtn.className = 'special-btn'; surpriseBtn.textContent = '🤤 Surprise Me!';
        surpriseBtn.onclick = () => { const r = categories['Foodie Finds'][Math.floor(Math.random() * categories['Foodie Finds'].length)]; closeSubMenu(); performSearch('Foodie Finds', r); }; list.appendChild(surpriseBtn);
      }
      $("subMenuModal").classList.add('active'); document.body.classList.add('modal-open');
    }
    function closeSubMenu() { closeOverlayElement($("subMenuModal")); }
    $("closeSubMenu").onclick = closeSubMenu;
    attachModalSwipe($("subMenuModal"), closeSubMenu);

    function performSearch(category, item) { /* Perform Google Places search */
      if (!currentPosition) return alert('Please provide a location first.');
      if (category === 'Local Events') return searchLocalEvents(item); // Handle events separately
      const request = { location: new google.maps.LatLng(currentPosition.lat, currentPosition.lng), radius: item.radius || 7000, type: item.type || undefined, keyword: item.keyword || undefined, rankBy: item.rankBy || google.maps.places.RankBy.PROMINENCE };
      lastResultsTitle = item.name || category;
      appendNextResults = false;
      setLoadMoreState(null);
      placesService.nearbySearch(request, (results, status, pagination) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
          const minRating = item.minRating ?? 4.2;
          const minReviews = item.minReviews ?? 20;
          let filtered = item.ignoreRating ? results : results.filter(p => (p.rating || 0) >= minRating && (p.user_ratings_total || 0) >= minReviews);
          if (!filtered.length) filtered = results.slice(0, 8);
          filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0) || (b.user_ratings_total || 0) - (a.user_ratings_total || 0));
          if (appendNextResults) {
            currentResults = currentResults.concat(filtered); displayResults(lastResultsTitle, filtered, { append: true });
          } else {
            currentResults = filtered; displayResults(lastResultsTitle, filtered);
          }
          appendNextResults = false;
          setLoadMoreState(pagination);
        } else {
          if (!appendNextResults) alert('No results found.');
          appendNextResults = false;
          setLoadMoreState(null);
        }
      });
    }
    async function searchLocalEvents(item) { /* Fetch events from Ticketmaster */
      if (!currentPosition) return alert('Please provide a location first.');
      const apiKey = window.TICKETMASTER_API_KEY || 'XmzfrRHZilGDGfD63SmdamF288GZ3FxH'; // Use key or fallback
      if (!apiKey) return alert('Ticketmaster API key missing.');
      const classification = (item.value && item.value !== 'all') ? `&classificationName=${item.value}` : '';
      const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${apiKey}&latlong=${currentPosition.lat},${currentPosition.lng}&radius=50${classification}`;
      try {
        const resp = await fetch(url); const data = await resp.json();
        const events = (data._embedded && data._embedded.events) || [];
        displayEventResults(events, item.name); // Display events in results modal
      } catch (err) { console.error(err); alert('Unable to fetch events.'); }
    }
    function displayEventResults(events, subCategory) { /* Display Ticketmaster results */
        const list = $("resultsList"); list.innerHTML = '';
        $("resultsTitle").textContent = `${subCategory} Events`;
        setLoadMoreState(null);
        if (events.length === 0) { list.innerHTML = '<p style="text-align:center; color: var(--card);">No events found nearby.</p>'; }
        events.forEach(event => {
            const btn = document.createElement('button'); btn.onclick = () => { if (event.url) window.open(event.url, '_blank'); };
            const wrap = document.createElement('div'); wrap.className = 'results-item';
            // Image (still show event images)
            const img = document.createElement('img');
            img.src = (event.images && event.images.length > 0) ? event.images[0].url : 'data:image/png;base64,...'; // Placeholder needed
            img.style.width = '60px'; img.style.height = '60px'; img.style.objectFit = 'cover'; img.style.borderRadius = 'var(--radius)'; img.style.flexShrink = '0';
            wrap.appendChild(img);
            // Info
            const info = document.createElement('div'); info.className = 'results-info';
            const title = document.createElement('h4'); title.textContent = event.name; info.appendChild(title);
            // Add Date/Time
            if (event.dates && event.dates.start) { const d = event.dates.start.localDate || '', t = event.dates.start.localTime || ''; const span = document.createElement('span'); span.className = 'rating'; span.textContent = d + (t ? ` ${t}` : ''); info.appendChild(span); }
            // Add Venue
            if (event._embedded?.venues?.[0]) { const v = event._embedded.venues[0]; const city = v.city?.name || ''; const state = v.state?.name || v.state?.stateCode || ''; const loc = city && state ? `${city}, ${state}` : city || state; const span = document.createElement('span'); span.className = 'rating'; span.textContent = v.name + (loc ? ` — ${loc}` : ''); info.appendChild(span); }
            wrap.appendChild(info); btn.appendChild(wrap); list.appendChild(btn);
        });
        $("resultsModal").classList.add('active'); document.body.classList.add('modal-open');
    }
    async function showSurpriseEvents() {
      if (!currentPosition) return alert('Please provide location first.');
      const apiKey = window.TICKETMASTER_API_KEY || 'XmzfrRHZilGDGfD63SmdamF288GZ3FxH';
      if (!apiKey) return alert('Ticketmaster API key missing.');
      const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${apiKey}&latlong=${currentPosition.lat},${currentPosition.lng}&radius=80&size=40`;
      try {
        const resp = await fetch(url); const data = await resp.json();
        const events = (data._embedded && data._embedded.events) || [];
        const picks = sampleFromArray(events, Math.min(6, events.length));
        if (!picks.length) return alert('No events found for Surprise Me.');
        displayEventResults(picks, 'Surprise Mix');
      } catch (err) {
        console.error(err);
        alert('Unable to fetch surprise events.');
      }
    }

    function displayResults(title, results, opts = {}) { /* Display Google Places results (text-only) */
      const { append = false } = opts;
      const list = $("resultsList");
      if (!append) {
        $("resultsTitle").textContent = `${title} Results`;
        list.innerHTML = '';
      }
      const planIds = getPlan().map(p => p.place_id), visitedIds = getVisitedPlan();
      if (!append && results.length === 0) {
        list.innerHTML = '<p style="text-align:center; color: var(--card);">No results found.</p>';
        setLoadMoreState(null);
      }
      results.forEach(place => {
        const btn = document.createElement('button'); btn.onclick = () => showDetails(place.place_id);
        const wrap = document.createElement('div'); wrap.className = 'results-item';
        const info = document.createElement('div'); info.className = 'results-info';
        const titleEl = document.createElement('h4'); titleEl.textContent = place.name; info.appendChild(titleEl);
        const rating = document.createElement('span'); rating.className = 'rating';
        rating.textContent = place.rating ? `⭐${place.rating.toFixed(1)} (${place.user_ratings_total || 0})` : 'No rating'; info.appendChild(rating);
        if (planIds.includes(place.place_id)) {
          const visit = document.createElement('span'); visit.className = 'rating'; visit.style.marginLeft = '0.3rem';
          visit.textContent = visitedIds.includes(place.place_id) ? '✅' : '🧭'; info.appendChild(visit);
        }
        wrap.appendChild(info); btn.appendChild(wrap); list.appendChild(btn);
      });
      $("resultsModal").classList.add('active'); document.body.classList.add('modal-open');
    }
    const loadMoreBtn = $("loadMoreResultsBtn");
    if (loadMoreBtn) {
      loadMoreBtn.onclick = () => {
        if (!currentPaginationHandle) return;
        appendNextResults = true;
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Scanning...';
        currentPaginationHandle.nextPage();
      };
    }
    function setLoadMoreState(pagination) {
      currentPaginationHandle = (pagination && pagination.hasNextPage) ? pagination : null;
      const btn = $("loadMoreResultsBtn");
      if (!btn) return;
      if (currentPaginationHandle) {
        btn.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Keep scanning';
      } else {
        btn.style.display = 'none';
      }
    }
    function closeResultsModal() { closeOverlayElement($("resultsModal")); }
    $("closeResults").onclick = closeResultsModal;
    $("resultsModal").onclick = (e) => { if (e.target.id === 'resultsModal') closeResultsModal(); }; // Close on overlay click
    attachModalSwipe($("resultsModal"), closeResultsModal);

    $("surpriseBtn").onclick = showSurpriseEvents;



    function showDetails(placeId) { /* Show place details sheet */
      // Reduced fields: removed 'photos'
      placesService.getDetails({ placeId: placeId, fields: ['name','formatted_address','formatted_phone_number','rating','reviews','price_level','geometry','website','url','opening_hours','place_id'] }, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place) {
          currentPlaceDetails = place; const loc = place.geometry.location;
          prepareStreetViewPreview(loc);
          // Populate text fields
          $("detailsName").textContent = place.name || 'No Name';
          let stars = ''; if (place.rating) { const full = Math.floor(place.rating), half = (place.rating - full) >= 0.5; stars = '★'.repeat(full) + (half ? '½' : '') + ` (${place.rating.toFixed(1)})`; }
          $("detailsRating").innerHTML = `<span class="stars">${stars}</span>`;
          $("detailsPrice").textContent = place.price_level ? '$'.repeat(place.price_level) : '';
          $("detailsPhone").textContent = place.formatted_phone_number || '';
          $("detailsAddress").textContent = place.formatted_address || '';
          // Set button states/actions
          updateSaveButtonState(place.place_id); updatePlanButtonState(place.place_id);
          $("mapsBtn").onclick = () => window.open(place.url || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}`, '_blank');
          $("websiteBtn").style.display = place.website ? 'inline-flex' : 'none';
          $("websiteBtn").onclick = () => { if (place.website) window.open(place.website, '_blank'); };
          $("shareBtn").onclick = () => { if (navigator.share) navigator.share({ title: place.name, text: place.formatted_address, url: place.url || window.location.href }).catch(console.error); else alert('Sharing not supported.'); };
          $("guideBtn").onclick = () => openCompass(loc);
          // Populate accordions
          populateReviews(place.reviews || []); populateHours(place.opening_hours);
          $("detailsSheet").classList.add('active'); document.body.classList.add('modal-open'); // Show sheet
        } else console.error("Place details request failed:", status);
      });
    }
    function closeDetails() {
      prepareStreetViewPreview(null);
      closeOverlayElement($("detailsSheet"));
    }
    $("detailsSheet").onclick = (e) => { if (e.target.id === 'detailsSheet') closeDetails(); }; // Close on overlay click
    $("closeDetailsBtn").onclick = closeDetails;
    if ($("activateStreetViewBtn")) $("activateStreetViewBtn").onclick = activateStreetViewPeek;
    const detailsSheetEl = $("detailsSheet");
    if (detailsSheetEl) {
      enableSwipeDismiss({
        container: detailsSheetEl,
        dragTarget: detailsSheetEl,
        scrollElement: $("detailsContent"),
        onDismiss: closeDetails,
        threshold: 110,
        maxOffset: 320
      });
    }

    function populateReviews(reviews) { /* Fill reviews accordion */
      const content = $("reviewsContent"); content.innerHTML = '';
      if (!reviews || reviews.length === 0) content.innerHTML = '<p>No reviews available.</p>';
      else reviews.slice(0, 5).forEach(r => { const p = document.createElement('p'); p.style.marginBottom = '0.5rem'; p.textContent = `"${r.text}" — ${r.author_name}`; content.appendChild(p); });
    }
    function populateHours(hours) { /* Fill hours accordion */
      const content = $("hoursContent"); content.innerHTML = '';
      if (!hours?.weekday_text) content.innerHTML = '<p>No hours available.</p>';
      else hours.weekday_text.forEach(l => { const p = document.createElement('p'); p.textContent = l; content.appendChild(p); });
    }
    function setupAccordions() { /* Add click listeners to accordions */
      document.querySelectorAll('.accordion').forEach(btn => {
        btn.onclick = () => {
          btn.classList.toggle('active'); const content = btn.nextElementSibling;
          content.style.maxHeight = btn.classList.contains('active') ? content.scrollHeight + 'px' : null;
        };
      });
    }

    // LocalStorage helpers for Favorites (My List) & Plan
    function getSavedList() { return JSON.parse(localStorage.getItem('myPlaces') || '[]'); }
    function savePlace(place) { let l = getSavedList(); if (!l.find(p => p.place_id === place.place_id)) { if (l.length >= 50) l.shift(); l.push({ place_id: place.place_id, name: place.name, address: place.formatted_address, rating: place.rating, url: place.url }); localStorage.setItem('myPlaces', JSON.stringify(l)); } }
    function removePlace(id) { let l = getSavedList().filter(p => p.place_id !== id); localStorage.setItem('myPlaces', JSON.stringify(l)); }
    function updateSaveButtonState(id) { const saved = getSavedList().some(p => p.place_id === id); $("saveBtn").textContent = saved ? '★ Saved' : '☆ Save'; $("saveBtn").onclick = () => { saved ? removePlace(id) : savePlace(currentPlaceDetails); updateSaveButtonState(id); loadMyList(); }; }

    function getPlan() { return JSON.parse(localStorage.getItem('myPlan') || '[]'); }
    function savePlan(list) { localStorage.setItem('myPlan', JSON.stringify(list)); }
    function getVisitedPlan() { return JSON.parse(localStorage.getItem('visitedPlan') || '[]'); }
    function saveVisitedPlan(list) { localStorage.setItem('visitedPlan', JSON.stringify(list)); }
    function addToPlan(place) { let l = getPlan(); if (!l.some(p => p.place_id === place.place_id)) { l.push({ place_id: place.place_id, name: place.name, lat: place.geometry.location.lat(), lng: place.geometry.location.lng(), address: place.formatted_address || '' }); savePlan(l); } }
    function removeFromPlan(id) { let l = getPlan().filter(p => p.place_id !== id); savePlan(l); }
    function toggleVisited(id) { let v = getVisitedPlan(); v.includes(id) ? v = v.filter(i => i !== id) : v.push(id); saveVisitedPlan(v); }
    function updatePlanButtonState(id) { const inPlan = getPlan().some(p => p.place_id === id); const btn = $("planBtn"); btn.textContent = inPlan ? '🗺️ In Plan' : '🗺️ Add to Plan'; btn.classList.toggle('in-plan', inPlan); btn.onclick = () => { if (!currentPlaceDetails) return; inPlan ? removeFromPlan(id) : addToPlan(currentPlaceDetails); loadPlan(); updatePlanButtonState(id); }; }

    function loadPlan() { /* Load and display plan items */
        const list = getPlan(), content = $("planContent"), empty = $("planEmpty"), summary = $("planSummary");
        content.innerHTML = ''; const visited = getVisitedPlan();
        if (!list.length) { empty.style.display = 'block'; summary.textContent = ''; return; }
        empty.style.display = 'none';
        const vCount = list.filter(i => visited.includes(i.place_id)).length, total = list.length;
        const ratio = vCount / total; let badge = ratio === 1 ? '🎖️' : ratio >= 0.8 ? '🥇' : ratio >= 0.5 ? '🥈' : ratio >= 0.3 ? '🥉' : '🔰';
        summary.textContent = `Visited ${vCount} of ${total} places ${badge}`;
        list.forEach(item => { /* Create button for each item */
            const btn = document.createElement('button'); btn.style.display = 'flex'; /* ... styling ... */ btn.style.alignItems = 'center'; btn.style.width = '100%';
            const wrap = document.createElement('div'); wrap.className = 'results-item';
            const info = document.createElement('div'); info.className = 'results-info';
            const title = document.createElement('h4'); title.textContent = item.name; info.appendChild(title);
            const vSpan = document.createElement('span'); vSpan.className = 'rating'; vSpan.textContent = visited.includes(item.place_id) ? 'Visited' : 'Not visited'; info.appendChild(vSpan);
            wrap.appendChild(info); btn.appendChild(wrap);
            // Visible 'Visited' button
            const vBtn = document.createElement('button'); vBtn.textContent = visited.includes(item.place_id) ? '✔️ Visited' : '◻️ Visit';
            vBtn.style.cssText = 'flex-shrink: 0; margin-left: 0.5rem; background: var(--card); color: var(--text-light); border: 1px solid var(--accent); border-radius: 8px; padding: 0.3rem 0.5rem; font-size: 0.8rem; cursor: pointer;';
            vBtn.onclick = (e) => { e.stopPropagation(); toggleVisited(item.place_id); loadPlan(); }; btn.appendChild(vBtn);
            btn.onclick = () => { showDetails(item.place_id); closePlan(); }; content.appendChild(btn);
        });
    }
    function closePlan() { closeOverlayElement($("planModal")); }
    $("myPlanBtn").onclick = () => { loadPlan(); $("planModal").classList.add('active'); document.body.classList.add('modal-open'); };
    $("closePlan").onclick = closePlan;
    $("planModal").onclick = (e) => { if (e.target.id === 'planModal') closePlan(); };
    attachModalSwipe($("planModal"), closePlan);
    $("sharePlanBtn").onclick = () => { /* Share plan via URL */
      const plan = getPlan(); if (!plan || plan.length === 0) return alert('Plan is empty.');
      try { const data = { items: plan }; const encoded = btoa(encodeURIComponent(JSON.stringify(data))); const url = `${window.location.origin}${window.location.pathname}?plan=${encoded}`;
        if (navigator.share) navigator.share({ title: 'My Local Explorer Plan', text: 'Check out my travel plan!', url: url }).catch(console.error);
        else window.prompt('Copy and share this link:', url);
      } catch (err) { console.error(err); alert('Unable to share plan.'); }
    };

    function loadMyList() { /* Load and display favorites */
        const list = getSavedList(), content = $("myListContent"), empty = $("myListEmpty");
        content.innerHTML = '';
        if (!list.length) { empty.style.display = 'block'; return; }
        empty.style.display = 'none';
        list.forEach(item => {
            const btn = document.createElement('button'); btn.onclick = () => { showDetails(item.place_id); closeMyList(); };
            const wrap = document.createElement('div'); wrap.className = 'results-item';
            const info = document.createElement('div'); info.className = 'results-info';
            const title = document.createElement('h4'); title.textContent = item.name; info.appendChild(title);
            const rating = document.createElement('span'); rating.className = 'rating'; rating.textContent = item.rating ? `★${item.rating.toFixed(1)}` : ''; info.appendChild(rating);
            wrap.appendChild(info); btn.appendChild(wrap);
            const del = document.createElement('span');
            del.className = 'list-remove';
            del.setAttribute('aria-label', `Remove ${item.name} from My List`);
            del.title = 'Remove from My List';
            del.textContent = '✕';
            del.onclick = (e) => { e.stopPropagation(); removePlace(item.place_id); loadMyList(); };
            btn.appendChild(del);
            content.appendChild(btn);
        });
    }
    function closeMyList() { closeOverlayElement($("myListModal")); }
    $("myListBtn").onclick = () => { loadMyList(); $("myListModal").classList.add('active'); document.body.classList.add('modal-open'); };
    $("closeMyList").onclick = closeMyList;
    $("myListModal").onclick = (e) => { if (e.target.id === 'myListModal') closeMyList(); };
    attachModalSwipe($("myListModal"), closeMyList);

    // Donate Modal Listeners (Restored Venmo)
    function closeDonateModal() { closeOverlayElement($("donateModal")); }
    $("closeDonate").onclick = closeDonateModal;
    $("donateModal").onclick = (e) => { if (e.target.id === 'donateModal') closeDonateModal(); };
    attachModalSwipe($("donateModal"), closeDonateModal);
    if ($("openVenmoBtn")) {
      $("openVenmoBtn").addEventListener('click', () => {
        const venmoUrl = 'https://venmo.com/Stephen-Mohamed-1';
        window.open(venmoUrl, '_blank');
      });
    }
    if ($("copyVenmoBtn")) {
      $("copyVenmoBtn").addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText('@Stephen-Mohamed-1');
          alert('Venmo handle copied to clipboard!');
        } catch (err) {
          alert('Unable to copy. Please copy manually.');
        }
      });
    }

    function getIconForInstruction(instruction) {
      const lowerInstruction = instruction.toLowerCase();
      if (lowerInstruction.includes('turn left')) return '↖️';
      if (lowerInstruction.includes('turn right')) return '↗️';
      if (lowerInstruction.includes('keep left')) return '↰';
      if (lowerInstruction.includes('keep right')) return '↱';
      if (lowerInstruction.includes('straight')) return '⬆️';
      if (lowerInstruction.includes('merge')) return '⤸';
      if (lowerInstruction.includes('roundabout') || lowerInstruction.includes('traffic circle')) return '🔄';
      if (lowerInstruction.includes('exit')) return '↘️';
      if (lowerInstruction.includes('destination')) return '🏁';
      return '➡️'; // Default
    }

    let navigationStopped = false;
    let currentRouteSteps = [];
    let currentNavigationIndex = 0;
    let currentSpeechUtterance = null;
    let currentTravelMode = 'DRIVING';
    let orientationListener = null; // Keep track of the listener
    let radarMap, radarDirectionsRenderer, radarCurrentMarker, radarDestinationMarker, radarDestLatLng = null;

    function openCompass(destLatLng) { // `destLatLng` can be LatLngLiteral or google.maps.LatLng
        const overlay = $("compassOverlay"); overlay.classList.add('active'); document.body.classList.add('modal-open');
        populateVoices(); navigationStopped=true; speechSynthesis.cancel(); currentRouteSteps=[]; currentNavigationIndex=0;
        $("readDirectionsBtn").disabled=true; $("silenceBtn").disabled=true;
        const dl = $("directionsList");
        if (dl) { dl.innerHTML='Calibrating…'; dl.classList.add('collapsed'); }
        const nextStepTextEl = $("nextStepText");
        if (nextStepTextEl) nextStepTextEl.textContent = 'Calibrating route...';
        const needle = $("compassNeedle"); if(needle) needle.style.transform='translateX(-50%) rotate(0deg)';
        const destPlain = toPlainLatLng(destLatLng);
        if (!destPlain) { alert('Unable to load destination.'); return; }
        radarDestLatLng = new google.maps.LatLng(destPlain.lat, destPlain.lng);
        currentTravelMode=document.querySelector('input[name="travelMode"]:checked')?.value||'DRIVING';
        if(orientationListener) window.removeEventListener('deviceorientation', orientationListener, true);
        orientationListener = null;

        const ensureRadarMap = () => {
            const mapHost = $("radarMap");
            if (!mapHost || typeof google === 'undefined') return;
            if (!radarMap) {
                radarMap = new google.maps.Map(mapHost, {
                    center: radarDestLatLng,
                    zoom: 14,
                    disableDefaultUI: true,
                    gestureHandling: 'none',
                    backgroundColor: '#0f1624',
                    styles: [{ featureType: 'poi', stylers: [{ visibility: 'off' }] }, { featureType: 'transit', stylers: [{ visibility: 'off' }] }]
                });
            }
            if (!radarDirectionsRenderer) {
                radarDirectionsRenderer = new google.maps.DirectionsRenderer({
                    map: radarMap,
                    suppressMarkers: true,
                    preserveViewport: true,
                    polylineOptions: { strokeColor: '#c87941', strokeWeight: 4 }
                });
            } else {
                radarDirectionsRenderer.setMap(radarMap);
            }
            if (!radarDestinationMarker) {
                radarDestinationMarker = new google.maps.Marker({
                    map: radarMap,
                    position: radarDestLatLng,
                    zIndex: 1,
                    icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 5, strokeColor: '#c87941', fillColor: '#c87941', fillOpacity: 1 }
                });
            } else radarDestinationMarker.setPosition(radarDestLatLng);
            const zoomSlider = $("radarZoom");
            if (zoomSlider && radarMap) zoomSlider.value = radarMap.getZoom();
        };
        const refreshRadarOrigin = () => {
            if (!radarMap || !currentPosition) return;
            const origin = new google.maps.LatLng(currentPosition.lat, currentPosition.lng);
            if (!radarCurrentMarker) {
                radarCurrentMarker = new google.maps.Marker({
                    map: radarMap,
                    zIndex: 2,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 5, strokeWeight: 2, strokeColor: '#8fd8ff', fillColor: '#8fd8ff', fillOpacity: 1 }
                });
            }
            radarCurrentMarker.setPosition(origin);
        };
        ensureRadarMap();
        refreshRadarOrigin();
        updateCompassArrow();

        const updateCompassArrow = (ev, override = {}) => {
            if (!currentPosition || !radarDestLatLng || !needle) return;
            try {
                const curLatLng = new google.maps.LatLng(currentPosition.lat, currentPosition.lng);
                const bearing = google.maps.geometry.spherical.computeHeading(curLatLng, radarDestLatLng);
                let deviceHeading = null;
                if (ev) {
                    const derived = deriveHeadingFromEvent(ev);
                    if (derived !== null) {
                        lastDeviceHeading = derived;
                        deviceHeading = derived;
                    }
                }
                if (typeof override.heading === 'number') {
                    deviceHeading = normalizeHeading(override.heading);
                }
                if (deviceHeading === null && lastDeviceHeading !== null) deviceHeading = lastDeviceHeading;
                if (deviceHeading === null && lastGeolocationHeading !== null) deviceHeading = lastGeolocationHeading;
                const rotation = normalizeHeading(bearing - (deviceHeading ?? 0)) ?? 0;
                needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
            } catch(e){ console.error("Heading error:",e); }
        };

        const startOrientationListener = () => {
            if (orientationListener) return; // Prevent duplicates if somehow called again
            const handler = (event) => updateCompassArrow(event);
            if (window.DeviceOrientationEvent?.requestPermission) {
                window.DeviceOrientationEvent.requestPermission().then(r => {
                    if (r === 'granted') {
                        orientationListener = handler;
                        window.addEventListener('deviceorientation', orientationListener, true);
                    } else { console.warn("Orientation permission denied."); }
                }).catch(e => { console.error("Orientation permission error:", e); });
            }
            else if ('ondeviceorientation' in window) { orientationListener = handler; window.addEventListener('deviceorientation', orientationListener, true); }
            else { console.warn("Orientation not supported."); }
        };
        startOrientationListener();

        if(navigator.geolocation){
            if(compassWatchId)navigator.geolocation.clearWatch(compassWatchId);
            compassWatchId=navigator.geolocation.watchPosition(p=>{
                currentPosition={lat:p.coords.latitude,lng:p.coords.longitude};
                if (typeof p.coords.heading === 'number' && !Number.isNaN(p.coords.heading)) {
                    lastGeolocationHeading = normalizeHeading(p.coords.heading);
                }
                updateCompassArrow();
                refreshRadarOrigin();
            },e=>console.error("Watch err:",e),{enableHighAccuracy:true});
        }

        const ds=new google.maps.DirectionsService();
        const nextStepBtn = $("nextStepBtn");
        const showAllBtn = $("showAllStepsBtn");
        let nextStepPointer = 0;
        let stepsExpanded = false;

        const collapseStepList = () => { if (dl) dl.classList.add('collapsed'); stepsExpanded = false; if (showAllBtn) showAllBtn.textContent = 'Show full route'; };
        const expandStepList = () => { if (dl) dl.classList.remove('collapsed'); stepsExpanded = true; if (showAllBtn) showAllBtn.textContent = 'Hide steps'; };
        const updateStepPreview = () => {
            if (!nextStepTextEl || !nextStepBtn) return;
            if (!currentRouteSteps.length) {
                nextStepTextEl.textContent = 'Waiting for route...';
                nextStepBtn.disabled = true;
                nextStepBtn.textContent = 'Next step';
                return;
            }
            if (nextStepPointer >= currentRouteSteps.length) {
                nextStepTextEl.textContent = 'All clear. Enjoy the stop!';
                nextStepBtn.disabled = true;
                nextStepBtn.textContent = 'Arrived';
                return;
            }
            const upcoming = stripHtml(currentRouteSteps[nextStepPointer].instructions) || 'Continue on course';
            nextStepTextEl.textContent = upcoming;
            nextStepBtn.disabled = false;
            nextStepBtn.textContent = nextStepPointer === 0 ? 'Start route' : 'Next step';
        };
        const setNextStepPointer = (value) => {
            nextStepPointer = Math.min(value, currentRouteSteps.length);
            updateStepPreview();
        };
        const revealStep = (idx) => { if (!dl) return; const node = dl.children[idx]; if (node) node.classList.remove('future-step'); };
        const resetStepUi = (message = 'Waiting for route...') => {
            if (dl) dl.innerHTML = '';
            if (nextStepTextEl) nextStepTextEl.textContent = message;
            if (nextStepBtn) { nextStepBtn.disabled = true; nextStepBtn.textContent = 'Next step'; }
            setNextStepPointer(0);
            collapseStepList();
        };
        resetStepUi('Calibrating route...');

        if (nextStepBtn) nextStepBtn.onclick = () => {
            if (!currentRouteSteps || !currentRouteSteps.length) return;
            const idx = Math.min(nextStepPointer, currentRouteSteps.length - 1);
            highlightStep(idx);
            revealStep(idx);
            setNextStepPointer(idx + 1);
        };
        if (showAllBtn) showAllBtn.onclick = () => {
            if (!dl) return;
            if (stepsExpanded) collapseStepList();
            else {
                expandStepList();
                Array.from(dl.children).forEach(el => el.classList.remove('future-step'));
            }
        };

        function fetchAndDisplayRoute(mode){
            if (!dl) return;
            if (!currentPosition) {
                dl.textContent = 'Waiting for your location…';
                $("readDirectionsBtn").disabled = true;
                return;
            }
            resetStepUi('Plotting route...');
            dl.innerHTML='Calibrating…';
            $("readDirectionsBtn").disabled=true;
            ds.route({origin:currentPosition,destination:radarDestLatLng,travelMode:google.maps.TravelMode[mode]},(r,s)=>{dl.innerHTML='';if(s===google.maps.DirectionsStatus.OK&&r){currentRouteSteps=r.routes[0].legs[0].steps;currentNavigationIndex=0;currentRouteSteps.forEach((st,i)=>{const d=document.createElement('div');d.dataset.index=i;const ic=getIconForInstruction(st.instructions);d.innerHTML=`<span class="direction-icon">${ic}</span> ${st.instructions}`;d.classList.add('future-step');dl.appendChild(d);});$("readDirectionsBtn").disabled=false;if (nextStepBtn) { nextStepBtn.disabled=false; nextStepBtn.textContent='Start route'; }setNextStepPointer(0);refreshRadarOrigin();if(radarDirectionsRenderer){radarDirectionsRenderer.setDirections(r);radarDirectionsRenderer.setRouteIndex(0);}if(radarMap&&currentPosition){const bounds=new google.maps.LatLngBounds();bounds.extend(new google.maps.LatLng(currentPosition.lat,currentPosition.lng));bounds.extend(radarDestLatLng);radarMap.fitBounds(bounds);}}else{dl.textContent=`Route error: ${s}`;currentRouteSteps=[];setNextStepPointer(0);}}); }
        fetchAndDisplayRoute(currentTravelMode);

        const rb=$("readDirectionsBtn"),sb=$("silenceBtn"),cb=$("closeCompassBtn"),stb=$("compassSettingsBtn"),ac=$("advancedCompassControls"),tmr=document.querySelectorAll('input[name="travelMode"]');
        function readDirections(){if(!currentRouteSteps||currentRouteSteps.length===0)return;navigationStopped=false;rb.disabled=true;rb.textContent="Reading...";sb.disabled=false;setNextStepPointer(currentNavigationIndex);speakNextStep();}
        function silenceDirections(){navigationStopped=true;speechSynthesis.cancel();if(currentSpeechUtterance)currentSpeechUtterance.onend=null;rb.disabled=(currentRouteSteps.length===0);rb.textContent="🔊 Read Directions";sb.disabled=true;}
        function highlightStep(idx){if(!dl)return;Array.from(dl.children).forEach((el,i)=>{const isMatch=i===idx;el.classList.toggle('current-step',isMatch);if(isMatch){el.classList.remove('future-step');el.scrollIntoView({behavior:'smooth',block:'nearest'});}});}
        function speakNextStep(){if(navigationStopped||currentNavigationIndex>=currentRouteSteps.length){silenceDirections();return;}highlightStep(currentNavigationIndex);setNextStepPointer(currentNavigationIndex+1);const step=currentRouteSteps[currentNavigationIndex];const clean=stripHtml(step.instructions);const txt=`Step ${currentNavigationIndex+1}: ${clean}.`;currentSpeechUtterance=new SpeechSynthesisUtterance(txt);const voices=speechSynthesis.getVoices();const pref=selectedVoiceUri||voiceSelect?.value||'';const voice=voices.find(v=>v.voiceURI===pref)||voices[0];if(voice)currentSpeechUtterance.voice=voice;currentSpeechUtterance.pitch=1;currentSpeechUtterance.rate=1;currentSpeechUtterance.volume=1;currentSpeechUtterance.onend=()=>{if(!navigationStopped){currentNavigationIndex++;setTimeout(speakNextStep,1500);}if(rb.textContent==="Reading..."){rb.textContent="🔊 Read Directions";if(!navigationStopped)rb.disabled=true;}};currentSpeechUtterance.onerror=(e)=>{console.error('Speech err:',e);silenceDirections();};speechSynthesis.speak(currentSpeechUtterance);if(currentNavigationIndex===0&&rb.textContent==="Reading..."){setTimeout(()=>{if(rb.textContent==="Reading...")rb.textContent="🔊 Read Directions";},500);}}
        rb.onclick=readDirections;sb.onclick=silenceDirections;
        stb.onclick=()=>{ac.style.display=ac.style.display==='none'?'block':'none';};
        tmr.forEach(r=>{r.onchange=(e)=>{const newM=e.target.value;if(newM!==currentTravelMode){currentTravelMode=newM;silenceDirections();fetchAndDisplayRoute(currentTravelMode);}};});
        const brightnessSlider = $("radarBrightness"); if(brightnessSlider) brightnessSlider.oninput=()=>{const n=$("compassNeedle");if(n)n.style.filter=`brightness(${brightnessSlider.value/100})`;};
        const zoomSlider = $("radarZoom"); if (zoomSlider) {
            if (radarMap) zoomSlider.value = radarMap.getZoom();
            zoomSlider.oninput = () => { if (radarMap) radarMap.setZoom(parseInt(zoomSlider.value, 10) || radarMap.getZoom()); };
        }

        cb.onclick=()=>{
            closeOverlayElement(overlay);
            if(compassWatchId) navigator.geolocation.clearWatch(compassWatchId); compassWatchId=null;
            if(orientationListener) window.removeEventListener('deviceorientation', orientationListener, true); orientationListener=null;
            silenceDirections(); ac.style.display='none';
        };
    } // End openCompass
    // Weather Fetching & Rendering Logic (Unchanged)
    function updateWeatherTitle() { /* Sets title based on location */ weatherElements.title.textContent = latestLocationLabel ? `Weather · ${latestLocationLabel}` : 'Local Weather'; }
    function setWeatherPlaceholder(msg) { /* Shows placeholder text */ Object.assign(weatherElements, { icon: '⛅', temp: '--°', description: msg, feels: 'Feels like --°', wind: 'Wind -- mph', range: 'High --° / Low --°', updated: 'Updated --' }); updateWeatherTitle(); }
    function showWeatherLoading(msg) { weatherElements.description.textContent = msg; weatherElements.updated.textContent = 'Updating...'; }
    function weatherCodeToSummary(code) { /* Translates weather code to icon/text */ const map = { 0: { icon: '☀️', text: 'Clear' }, 1: { icon: '🌤️', text: 'Mostly clear' }, 2: { icon: '⛅', text: 'Partly cloudy' }, 3: { icon: '☁️', text: 'Overcast' }, 45: { icon: '🌫️', text: 'Fog' }, 48: { icon: '🌫️', text: 'Icy fog' }, 51: { icon: '🌦️', text: 'Light drizzle' }, 53: { icon: '🌦️', text: 'Drizzle' }, 55: { icon: '🌧️', text: 'Heavy drizzle' }, 61: { icon: '🌦️', text: 'Light rain' }, 63: { icon: '🌧️', text: 'Rain' }, 65: { icon: '🌧️', text: 'Heavy rain' }, 71: { icon: '🌨️', text: 'Light snow' }, 73: { icon: '🌨️', text: 'Snow' }, 75: { icon: '❄️', text: 'Heavy snow' }, 80: { icon: '🌦️', text: 'Showers' }, 82: { icon: '⛈️', text: 'Heavy showers' }, 95: { icon: '⛈️', text: 'Thunderstorm' } }; return map[code] || { icon: '🌤️', text: 'Mixed' }; }
    async function fetchWeatherData(pos) { /* Fetch from Open-Meteo */ const p = new URLSearchParams({ latitude: pos.lat.toFixed(4), longitude: pos.lng.toFixed(4), current_weather: 'true', hourly: 'apparent_temperature', daily: 'temperature_2m_max,temperature_2m_min', timezone: 'auto' }); const r = await fetch(`https://api.open-meteo.com/v1/forecast?${p}`); if (!r.ok) throw new Error('Weather fetch failed'); return r.json(); }
    function renderWeather(data) { /* Update UI with weather data */ if (!data?.current_weather) return setWeatherPlaceholder('Weather unavailable.'); const c = data.current_weather, sum = weatherCodeToSummary(c.weathercode), tempF = Math.round(c.temperature * 9/5 + 32); let feelsF = tempF; if (data.hourly?.time?.indexOf(c.time) > -1) feelsF = Math.round(data.hourly.apparent_temperature[data.hourly.time.indexOf(c.time)] * 9/5 + 32); const maxF = Math.round((data.daily?.temperature_2m_max?.[0] ?? c.temperature) * 9/5 + 32), minF = Math.round((data.daily?.temperature_2m_min?.[0] ?? c.temperature) * 9/5 + 32), windMph = Math.round((c.windspeed || 0) / 1.609); weatherElements.icon.textContent = sum.icon; weatherElements.temp.textContent = `${tempF}°`; weatherElements.description.textContent = sum.text; weatherElements.feels.textContent = `Feels like ${feelsF}°`; weatherElements.wind.textContent = `Wind ${windMph} mph`; weatherElements.range.textContent = `High ${maxF}° / Low ${minF}°`; weatherElements.updated.textContent = `Updated ${new Date().toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}`; updateWeatherTitle(); }
    async function updateWeather(pos, opts = {}) { /* Update weather, uses cache */ if (!pos) return setWeatherPlaceholder('Provide location for forecast.'); const key = `${pos.lat.toFixed(3)}|${pos.lng.toFixed(3)}`, now = Date.now(); if (!opts.force && cachedWeather && lastWeatherCoords === key && (now - lastWeatherFetch) < WEATHER_CACHE_MS) return renderWeather(cachedWeather); showWeatherLoading('Updating forecast...'); try { const data = await fetchWeatherData(pos); cachedWeather = data; lastWeatherCoords = key; lastWeatherFetch = now; renderWeather(data); } catch (err) { console.error('Weather update failed', err); setWeatherPlaceholder('Unable to retrieve weather.'); } }
    function initWeatherControls() { /* Attach listeners for weather */ const refBtn = $("refreshWeatherBtn"); if (refBtn) refBtn.onclick = () => updateWeather(currentPosition, { force: true }); updateWeatherTitle(); const tglBtn = $("toggleWeatherBtn"), wWidget = $("weatherWidget"); if (tglBtn && wWidget) { const isMin = localStorage.getItem('weatherMinimized') === 'true'; wWidget.classList.toggle('weather-minimized', isMin); tglBtn.onclick = () => { const nowMin = wWidget.classList.toggle('weather-minimized'); localStorage.setItem('weatherMinimized', nowMin ? 'true' : 'false'); }; } }

    function initSettingsPanel() { /* Setup settings modal listeners */ const panel = $("settingsPanel"), openBtn = $("settingsBtn"), closeBtn = $("closeSettingsBtn"), themeSel = $("themeSelect"), ambToggle = $("ambientModeToggle"), resetBtn = $("resetSettingsBtn"); const open = () => { panel?.classList.add('active'); document.body.classList.add('modal-open'); }; const close = () => { closeOverlayElement(panel); }; if (openBtn) openBtn.onclick = open; if (closeBtn) closeBtn.onclick = close; if (panel) { panel.onclick = (e) => { if (e.target === panel) close(); }; attachModalSwipe(panel, close); } document.onkeydown = (e) => { if (e.key === 'Escape' && panel?.classList.contains('active')) close(); }; if (themeSel) { themeSel.value = currentThemeKey; themeSel.onchange = (e) => setTheme(e.target.value || DEFAULT_THEME); } const storedAmb = localStorage.getItem('ambientModeEnabled') === 'true'; if (ambToggle) { ambToggle.checked = storedAmb; ambToggle.onchange = () => localStorage.setItem('ambientModeEnabled', ambToggle.checked ? 'true' : 'false'); } if (resetBtn) resetBtn.onclick = () => { setTheme(DEFAULT_THEME); if (themeSel) themeSel.value = DEFAULT_THEME; selectedVoiceUri = ''; localStorage.removeItem('selectedVoiceUri'); populateVoices(); if (voiceSelect) voiceSelect.dispatchEvent(new Event('change')); if (ambToggle) { ambToggle.checked = false; localStorage.setItem('ambientModeEnabled', 'false'); } if ($("weatherWidget")) { $("weatherWidget").classList.remove('weather-minimized'); localStorage.removeItem('weatherMinimized'); } updateWeatherTitle(); }; }

    function checkSharedPlan() { /* Check URL for ?plan=... */ try { const params = new URLSearchParams(window.location.search); if (params.has('plan')) { const data = JSON.parse(decodeURIComponent(atob(params.get('plan')))); if (data?.items) { localStorage.setItem('myPlan', JSON.stringify(data.items)); localStorage.removeItem('visitedPlan'); setTimeout(() => { loadPlan(); $("planModal").classList.add('active'); document.body.classList.add('modal-open'); }, 500); } } } catch (e) { console.warn('Failed to decode shared plan', e); } }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker-v2.js');
    }

    // Final Setup
    window.initMap = initApp; // Google Maps callback

    // Clean up modal state if user navigates back/forward
    window.addEventListener('popstate', () => {
        document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
        if ($("detailsSheet").classList.contains('active')) closeDetails();
        if ($("compassOverlay").classList.contains('active')) $("closeCompassBtn").click(); // Trigger cleanup
        document.body.classList.remove('modal-open');
    });
  </script>
</body>
</html>
