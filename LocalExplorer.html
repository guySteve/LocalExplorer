<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Local Explorer</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --navy: #111827;
      --ivory:#f8f7f2;
      --accent:#f59e0b; /* amber */
      --mint:#10b981;
    }
    body { font-family:'Raleway',sans-serif; background:#f8f7f2; }
    h1,h2,h3,.font-header { font-family:'Poppins',sans-serif; }
    #panorama { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
    .action-card { background:#111827; color:#f8f7f2; transition:.2s all; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .action-card:hover:not(:disabled){ transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
    .action-card:active:not(:disabled){ transform:translateY(-1px) scale(.98); }
    .action-card:disabled{ opacity:.6; cursor:not-allowed; }
    #dark-side-button{ position:fixed; bottom:1rem; left:1rem; font-size:1.5rem; opacity:.3; transition:opacity .2s; cursor:pointer; z-index:20; }
    #dark-side-button:hover{ opacity:1; }

    /* Detail card */
    #result-card{ background:rgba(17,24,39,.92); color:#f8f7f2; backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      transition:transform .5s cubic-bezier(.19,1,.22,1), opacity .5s ease-out; max-height:90vh; overflow-y:auto;
      border-top:1px solid rgba(248,247,242,.2); }
    .place-type-tag{ background:rgba(248,247,242,.1); border:1px solid rgba(248,247,242,.2); padding:2px 10px; border-radius:9999px; font-size:.75rem; text-transform:capitalize; font-weight:600; }

    #panorama-container { pointer-events:none; opacity:0; visibility:hidden; }
    #panorama-container.shown { pointer-events:auto; opacity:1; visibility:visible; transition:opacity 1s; }

    /* Results overlay darker so background doesn‚Äôt distract */
    #results-list-screen { position:fixed; inset:0; z-index:20; display:none; flex-direction:column; padding:1rem;
      background:rgba(0,0,0,.7); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
    #results-list-card { background:rgba(17,24,39,.96); color:#f8f7f2; border-top-left-radius:1rem; border-top-right-radius:1rem; padding:1rem; max-width:42rem; width:100%; margin:0 auto; }
    .result-item { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:0.75rem; padding:0.75rem; display:flex; gap:0.75rem; }
    .result-thumb { width:84px; height:84px; object-fit:cover; border-radius:0.5rem; background:#111827; }
    .star-row { font-size:12px; letter-spacing:1px; }
    .star-row .star { opacity:.35 }
    .star-row .star.filled { opacity:1 }

    /* =========================
       Wavy Compass + Pop-out
       ========================= */
    /* Container HUD */
    #compass-hud {
      position: fixed; right: 1rem; bottom: 7.5rem; z-index: 40;
      display: none; align-items: center; gap: 0.6rem;
    }

    /* Morphing speech bubble (pop-out) */
    #nav-bubble {
      position: relative;
      max-width: 62vw;
      color: var(--ivory);
      padding: .65rem .8rem .7rem .85rem;
      font-size: 13px; line-height: 1.25;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      background: radial-gradient(120% 140% at 10% 0%, rgba(16,185,129,.16) 0%, rgba(245,158,11,.18) 35%, rgba(17,24,39,.96) 68%);
      border: 1px solid rgba(255,255,255,.12);
      animation: blobMorph 9s ease-in-out infinite;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #nav-bubble::after{ /* tail pointer to compass */
      content:'';
      position:absolute; right:-10px; bottom:14px;
      width: 0; height: 0;
      border-left: 12px solid rgba(17,24,39,.96);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.35));
    }
    #nav-main { font-weight: 700; letter-spacing:.2px; }
    #nav-sub  { font-size: 11.5px; opacity:.85; margin-top:2px; }

    @keyframes blobMorph {
      0%   { border-radius: 24px 18px 22px 28px / 26px 18px 26px 22px; }
      25%  { border-radius: 18px 26px 20px 24px / 18px 28px 18px 26px; }
      50%  { border-radius: 26px 24px 28px 18px / 22px 24px 18px 28px; }
      75%  { border-radius: 20px 28px 24px 20px / 24px 18px 28px 18px; }
      100% { border-radius: 24px 18px 22px 28px / 26px 18px 26px 22px; }
    }

    /* Compass disk with sweep & pulse */
    #compass-overlay {
      width: 100px; height: 100px; border-radius: 9999px;
      position: relative;
      background:
        radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
        conic-gradient(from 0deg, rgba(245,158,11,.5), rgba(245,158,11,.1) 30%, rgba(16,185,129,.5) 60%, rgba(16,185,129,.12) 75%, rgba(245,158,11,.35));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:
        0 10px 30px rgba(0,0,0,.45),
        inset 0 0 0 2px rgba(255,255,255,.06);
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      overflow: hidden;
    }
    /* rotating sweep */
    #compass-overlay::before{
      content:'';
      position:absolute; inset:-30%;
      background: conic-gradient(from 0deg, rgba(255,255,255,.0) 0%, rgba(255,255,255,.22) 6%, rgba(255,255,255,0) 12%);
      animation: sweep 4s linear infinite;
      mix-blend-mode: overlay;
    }
    @keyframes sweep { to { transform: rotate(360deg); } }

    /* pulsing ring */
    #compass-overlay::after{
      content:'';
      position:absolute; width: 84%; height: 84%; border-radius: 9999px;
      box-shadow: 0 0 0 0 rgba(245,158,11,.35);
      animation: pulse 2.6s ease-out infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(245,158,11,.28); }
      70%{ box-shadow: 0 0 0 14px rgba(245,158,11,0); }
      100%{ box-shadow: 0 0 0 0 rgba(245,158,11,0); }
    }

    /* arrow + glow */
    #compass-arrow {
      width: 0; height: 0;
      border-left: 12px solid transparent; border-right: 12px solid transparent;
      border-bottom: 30px solid var(--accent);
      transform-origin: 50% 90%;
      filter: drop-shadow(0 6px 8px rgba(245,158,11,.45));
      margin-bottom: 6px;
    }
    #compass-dist {
      font-size: 12px; color: #e5e7eb; font-weight: 600; letter-spacing:.3px;
      text-shadow: 0 1px 2px rgba(0,0,0,.5);
    }

    /* Results list cleans background already via overlay */

  </style>
</head>
<body class="text-gray-900 flex flex-col items-center justify-center min-h-screen p-4">

  <!-- Street View backdrop -->
  <div id="panorama-container" class="fixed inset-0">
    <div id="panorama"></div>
  </div>

  <div id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center">
    <!-- Main -->
    <div id="main-screen">
      <h1 class="text-4xl md:text-5xl font-header font-bold text-gray-900 mb-4">Local Explorer</h1>

      <div id="fun-fact-container" class="text-left mb-4 px-2">
        <h3 class="font-header font-bold mb-1 text-orange-500 text-sm tracking-wider uppercase">Local Fact</h3>
        <p id="fun-fact-text" class="text-sm text-gray-600 border-t-2 border-gray-200 pt-2">Loading...</p>
      </div>

      <p id="location-status" class="text-lg font-semibold text-gray-700 my-4 transition-all">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center bg-white rounded-lg shadow-md">
          <input type="text" id="location-input" placeholder="Enter a city or place" class="w-full bg-transparent text-gray-800 p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-r-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </button>
        </div>
      </div>

      <div class="flex items-center gap-4 mb-4">
        <button id="my-list-button" class="action-card rounded-lg font-bold py-3 text-base flex-1 flex items-center justify-center gap-2">
          <span class="text-xl">üìã</span> My List
        </button>
      </div>

      <div id="filter-container" class="grid grid-cols-2 gap-4">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üçΩÔ∏è</span> Foodie Finds</button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üèõÔ∏è</span> Iconic Sights</button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üåô</span> Night Out</button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üíé</span> Hidden Gems</button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üêæ</span> Pet Friendly</button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center"><span class="text-2xl mb-1">üõ†Ô∏è</span> Utilities & Help</button>
      </div>

      <button id="random-button" class="action-card w-full mt-4 rounded-lg font-bold py-3 text-base flex items-center justify-center gap-2 bg-orange-500 text-white">
        <span class="text-xl">ü§∑</span> Surprise Me!
      </button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden mt-4 text-gray-600 underline">Back to main filters</button>
    </div>
  </div>

  <button id="dark-side-button" data-filter="dark">üëª</button>

  <!-- Results LIST -->
  <div id="results-list-screen" style="display:none;">
    <div id="results-list-card" class="w-full">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card bg-gray-700 text-white font-bold py-2 px-3 rounded-lg">Back</button>
      </div>
      <div id="results-meta" class="text-sm text-gray-300 mb-3"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </div>

  <!-- Detail RESULT -->
  <div id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Photo of the location" class="w-full h-48 object-cover rounded-lg mb-4" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-70 hover:opacity-100 transition-transform">‚òÜ</button>
        </div>
      </div>

      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold text-orange-400" id="place-rating">...</p>
        <p class="font-semibold text-green-400" id="place-price">...</p>
        <a id="phone-link" href="#" class="text-blue-300 hover:underline text-sm"></a>
      </div>

      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>

      <!-- Reviews -->
      <div id="reviews-block" class="text-left mt-3 hidden">
        <h3 class="font-bold mb-2">Recent Reviews</h3>
        <div id="place-reviews" class="space-y-2"></div>
      </div>

      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Map View</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hidden">Website</a>
        <button id="share-button" class="flex-1 action-card bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg">Compass</button>
        <button id="speak-toggle" class="action-card bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Voice: Off</button>
      </div>

      <!-- Wavy compass HUD -->
      <div id="compass-hud">
        <div id="nav-bubble" style="display:none;">
          <div id="nav-main">Head toward destination</div>
          <div id="nav-sub">Follow the arrow</div>
        </div>
        <div id="compass-overlay">
          <div id="compass-arrow"></div>
          <div id="compass-dist">--</div>
        </div>
      </div>
    </div>

    <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
      <button id="try-again-button" class="flex-1 action-card bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Back</button>
      <button id="next-suggestion-button" class="flex-1 action-card bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
    </div>
  </div>

  <script>
    /* ================== Core Setup & Helpers ================== */

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./serviceworker.js').catch(err => console.log('SW registration failed:', err));
      });
    }

    const mainScreen = document.getElementById('main-screen');
    const resultsListScreen = document.getElementById('results-list-screen');
    const resultsTitle = document.getElementById('results-title');
    const resultsMeta = document.getElementById('results-meta');
    const resultsList = document.getElementById('results-list');

    const resultScreen = document.getElementById('result-screen');
    const filterContainer = document.getElementById('filter-container');
    const locationStatus = document.getElementById('location-status');
    const panoramaContainer = document.getElementById('panorama-container');
    const panoramaDiv = document.getElementById('panorama');
    const manualLocationEntry = document.getElementById('manual-location-entry');
    const locationInput = document.getElementById('location-input');
    const subMenuContainer = document.getElementById('sub-menu-container');
    const backToMainFiltersButton = document.getElementById('back-to-main-filters');
    const randomButton = document.getElementById('random-button');
    const funFactContainer = document.getElementById('fun-fact-container');
    const funFactText = document.getElementById('fun-fact-text');
    const darkSideButton = document.getElementById('dark-side-button');

    const placeNameEl = document.getElementById('place-name');
    const placeRatingEl = document.getElementById('place-rating');
    const placeStarsEl = document.getElementById('place-stars');
    const placePriceEl = document.getElementById('place-price');
    const placePhotoEl = document.getElementById('place-photo');
    const directionsLink = document.getElementById('directions-link');
    const websiteLink = document.getElementById('website-link');
    const placeTypesContainer = document.getElementById('place-types-container');
    const phoneLink = document.getElementById('phone-link');
    const placeAccessibility = document.getElementById('place-accessibility');
    const savePlaceButton = document.getElementById('save-place-button');
    const nextSuggestionButton = document.getElementById('next-suggestion-button');

    // Compass HUD
    const compassHud = document.getElementById('compass-hud');
    const compassOverlay = document.getElementById('compass-overlay');
    const compassArrow = document.getElementById('compass-arrow');
    const compassDist = document.getElementById('compass-dist');
    const navBubble = document.getElementById('nav-bubble');
    const navMain = document.getElementById('nav-main');
    const navSub = document.getElementById('nav-sub');
    const speakToggle = document.getElementById('speak-toggle');

    const reviewsBlock = document.getElementById('reviews-block');
    const placeReviews = document.getElementById('place-reviews');

    let placesService, panorama, geocoder, directionsService;
    let currentUserLocation;
    let currentLocality = '';
    let currentPlace;
    let currentResults = [];
    let savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');

    // Compass / voice
    let compassActive = false;
    let destinationLatLng = null;
    let watchId = null;
    let headingDeg = 0;
    let voiceOn = false;

    const subFilterMap = {
      eat: {
        "üçï Surprise Me": { type: "restaurant" },
        "Italian": { type: "italian_restaurant", keyword: "italian" },
        "Mexican": { type: "mexican_restaurant", keyword: "mexican" },
        "Japanese": { type: "japanese_restaurant", keyword: "japanese" },
        "Chinese": { type: "chinese_restaurant", keyword: "chinese" },
        "Indian": { type: "indian_restaurant", keyword: "indian" },
        "Pizza": { type: "pizza_restaurant", keyword: "pizza" },
        "Cafes": { type: "cafe", keyword: "cafe" },
        "Desserts": { type: "bakery", keyword: "dessert bakery" }
      },
      see: { "Museums": { type: "museum" }, "Art Galleries": { type: "art_gallery" }, "Tourist Attractions": { type: "tourist_attraction" } },
      night:{ "Bars": { type: "bar" }, "Night Clubs": { type: "night_club" } },
      gems: { "Quirky Shops": { keyword: "vintage store" }, "Indie Coffee": { type: "cafe" }, "Local Art": { type: "art_gallery" }, "Quiet Spots": { type: "park" } },
      pets: { "Dog Park": { type: "park", keyword: "dog" }, "Pet Store": { type: "pet_store" }, "Veterinarian": { type: "veterinary_care" } },
      utilities: { "Hospital": { type: "hospital" }, "Pharmacy": { type: "pharmacy" }, "Police": { type: "police" }, "Gas Station": { type: "gas_station" }, "Car Rental": { type: "car_rental" }, "ATM": { type: "atm" } },
      dark: { "Cemeteries": { type: "cemetery" }, "Historic Crimes": { keyword: "haunted tour" }, "Notable Tombs": { type: "cemetery", keyword: "famous grave" } }
    };

    const allowedByCategory = {
      eat: new Set(['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant']),
      night: new Set(['bar','night_club']),
      see: new Set(['museum','art_gallery','tourist_attraction']),
      pets: new Set(['park','pet_store','veterinary_care']),
      utilities: new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']),
      gems: new Set(['art_gallery','park','cafe']),
      dark: new Set(['cemetery'])
    };
    const bannedRetailish = new Set(['grocery_or_supermarket','supermarket','department_store','shopping_mall','convenience_store','store']);

    /* ========== Utilities ========== */
    function metersToImperial(m) {
      const feet = m * 3.28084;
      if (feet < 1000) return `${Math.round(feet)} ft`;
      const miles = m * 0.000621371;
      return `${miles.toFixed(miles < 10 ? 1 : 0)} mi`;
    }
    function toggleFilterButtons(disabled){
      document.querySelectorAll('#main-screen button').forEach(b => b.disabled = disabled);
    }
    function renderStars(container, rating){
      const r = Math.round(rating || 0);
      container.innerHTML = '';
      for (let i=1; i<=5; i++){
        const span = document.createElement('span');
        span.textContent = '‚òÖ';
        span.className = 'star' + (i <= r ? ' filled' : '');
        container.appendChild(span);
        if (i<5) container.appendChild(document.createTextNode(' '));
      }
    }
    function renderStarsHTML(rating){
      const r = Math.round(rating || 0);
      let html = '';
      for (let i=1;i<=5;i++) html += `<span class="star${i<=r?' filled':''}">‚òÖ</span>${i<5?' ':''}`;
      return html;
    }
    function updateSaveButtonState(){
      if (!currentPlace) return;
      savePlaceButton.textContent = savedPlaces[currentPlace.place_id] ? '‚òÖ' : '‚òÜ';
      savePlaceButton.classList.toggle('text-orange-400', !!savedPlaces[currentPlace.place_id]);
    }
    function isRestaurantCandidate(place, cuisineKeyword, requestedType){
      const types = new Set(place.types || []);
      const isRestaurantish = types.has('restaurant') || [...types].some(t => t.endsWith('_restaurant')) || types.has('cafe') || types.has('bakery') || types.has('meal_takeaway');
      if (!isRestaurantish) return false;
      for (const t of types) if (bannedRetailish.has(t)) return false;
      if (requestedType && !types.has(requestedType)) {
        if (!(types.has('restaurant') && cuisineKeyword && new RegExp(cuisineKeyword,'i').test(place.name || ''))) return false;
      }
      return true;
    }
    function filterResultsByCategory(results, parentFilter, requestedType, cuisineKeyword){
      const allowed = allowedByCategory[parentFilter];
      if (!allowed) return results || [];
      return (results || []).filter(p => {
        const types = new Set(p.types || []);
        const categoryMatch = [...types].some(t => allowed.has(t));
        if (!categoryMatch) return false;
        if (parentFilter === 'eat') return isRestaurantCandidate(p, cuisineKeyword, requestedType);
        return true;
      });
    }
    function dedupeById(items){
      const seen = new Set(); const out = [];
      for (const it of items){ if (!seen.has(it.place_id)){ seen.add(it.place_id); out.push(it); } }
      return out;
    }
    function sortResults(base){
      return base.sort((a,b) =>
        (b.rating??0)-(a.rating??0) ||
        (b.user_ratings_total??0)-(a.user_ratings_total??0) ||
        (a.distanceMeters??Infinity)-(b.distanceMeters??Infinity) ||
        a.name.localeCompare(b.name)
      );
    }

    /* ========== Results List ========== */
    function showResultsList(parentFilter, subLabel){
      funFactContainer.classList.add('hidden');
      resultsListScreen.style.display = 'flex';
      resultsTitle.textContent = subLabel;
      resultsMeta.textContent = currentResults.length ? `${currentResults.length} results` : 'No results';
      resultsList.innerHTML = '';

      currentResults.forEach(p => {
        const card = document.createElement('div');
        card.className = 'result-item';
        const photoUrl = (p.photos && p.photos[0]) ? p.photos[0].getUrl({maxWidth: 200, maxHeight: 200}) : 'https://placehold.co/200x200/111827/fff?text=No+Photo';
        const rating = p.rating ?? null;
        const price = p.price_level ? '$'.repeat(p.price_level) : '';
        const vicinity = p.vicinity || p.formatted_address || '';

        card.innerHTML = `
          <img class="result-thumb" src="${photoUrl}" alt="">
          <div class="flex-1 text-left">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-base">${p.name}</h3>
              <div class="text-xs text-gray-300">${price}</div>
            </div>
            <div class="flex items-center gap-2 mt-1">
              <div class="star-row">${renderStarsHTML(rating)}</div>
              <div class="text-sm text-orange-300">${rating ? rating.toFixed(1) : 'N/A'}</div>
              <div class="text-xs text-gray-400">(${p.user_ratings_total ?? 0})</div>
            </div>
            <div class="text-xs text-gray-300 mt-1">${vicinity}</div>
            <div class="mt-2 flex gap-2">
              <button class="action-card px-2 py-1 rounded-md text-xs open-details" data-id="${p.place_id}">Details</button>
              <a class="action-card px-2 py-1 rounded-md text-xs" target="_blank" rel="noopener" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.name + ', ' + (vicinity||''))}">Map</a>
            </div>
          </div>`;
        resultsList.appendChild(card);
      });
    }

    /* ========== Search Cascade ========== */
    function findAdventure(searchParams, parentFilter, subLabel){
      if (!placesService || !currentUserLocation) return;

      toggleFilterButtons(true);
      backToMainFiltersButton.disabled = true;
      locationStatus.textContent = "Searching nearby...";
      currentResults = [];

      const requestedType = searchParams.type || null;
      const cuisineKeyword = (parentFilter === 'eat') ? (searchParams.keyword || (requestedType ? requestedType.replace('_restaurant','') : '')) : '';

      const radii = [2000, 5000, 10000, 20000]; // up to ~12.4 mi
      let idx = 0;

      const nearbyStep = () => {
        if (idx >= radii.length) { return textSearchStep(); }
        const radius = radii[idx++];
        const req = { location: currentUserLocation, radius, ...(searchParams.type && { type: searchParams.type }), ...(searchParams.keyword && { keyword: searchParams.keyword }) };

        placesService.nearbySearch(req, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results?.length) {
            const filtered = filterResultsByCategory(results, parentFilter, requestedType, cuisineKeyword).map(r => ({...r}));
            currentResults = dedupeById([...currentResults, ...filtered]);
            if (currentResults.length < 12) {
              locationStatus.textContent = `Searching wider (${metersToImperial(radius)} radius)...`;
              nearbyStep();
            } else {
              finalizeList();
            }
          } else {
            nearbyStep();
          }
        });
      };

      const textSearchStep = () => {
        const queryCity = currentLocality || '';
        const query = cuisineKeyword ? `${cuisineKeyword} restaurant ${queryCity ? 'in ' + queryCity : ''}`.trim() : subLabel + (queryCity ? ' in ' + queryCity : '');
        const req = { query, location: currentUserLocation, radius: 30000 };
        placesService.textSearch(req, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results?.length){
            const filtered = filterResultsByCategory(results, parentFilter, requestedType, cuisineKeyword);
            currentResults = dedupeById([...currentResults, ...filtered]);
          }
          finalizeList();
        });
      };

      const finalizeList = () => {
        currentResults = sortResults(currentResults);
        showResultsList(parentFilter, subLabel);
        toggleFilterButtons(false);
        backToMainFiltersButton.disabled = false;
      };

      nearbyStep();
    }

    /* ========== Details + Reviews ========== */
    function openDetailsById(placeId){
      const summary = currentResults.find(r => r.place_id === placeId);
      if (!summary) return;
      getPlaceDetails(summary);
    }
    function stripHtml(html) { const t = document.createElement('div'); t.innerHTML = html||''; return t.textContent || t.innerText || ''; }

    function getPlaceDetails(placeSummary){
      funFactContainer.classList.add('hidden');
      resultsListScreen.style.display = 'none';

      resultScreen.style.display = 'flex';
      panorama.setPosition(placeSummary.geometry.location);
      panoramaContainer.classList.add('shown');

      currentPlace = placeSummary;
      updateSaveButtonState();

      placeNameEl.textContent = 'Loading Details...';
      placePhotoEl.src = `https://placehold.co/600x400/111827/f8f7f2?text=${encodeURIComponent(placeSummary.name)}`;
      placeRatingEl.textContent = '';
      placeStarsEl.innerHTML = '';
      placePriceEl.textContent = '';
      placeTypesContainer.innerHTML = '';
      websiteLink.classList.add('hidden');
      phoneLink.textContent=''; phoneLink.removeAttribute('href');
      placeAccessibility.textContent = ''; placeAccessibility.style.display = 'none';
      reviewsBlock.classList.add('hidden'); placeReviews.innerHTML = '';

      const request = {
        placeId: placeSummary.place_id,
        fields: ['name','rating','user_ratings_total','price_level','photos','website','vicinity','types','formatted_phone_number','geometry','wheelchair_accessible_entrance','reviews']
      };
      placesService.getDetails(request, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place){
          currentPlace = place;
          placeNameEl.textContent = place.name;
          renderStars(placeStarsEl, place.rating ?? 0);
          placeRatingEl.textContent = place.rating ? place.rating.toFixed(1) : 'N/A';
          placePriceEl.textContent = place.price_level ? '$'.repeat(place.price_level) : '';
          if (place.photos?.length) placePhotoEl.src = place.photos[0].getUrl({ maxWidth: 600, maxHeight: 400 });
          if (place.website){ websiteLink.href = place.website; websiteLink.classList.remove('hidden'); }
          if (place.formatted_phone_number){ phoneLink.href = `tel:${place.formatted_phone_number}`; phoneLink.textContent = place.formatted_phone_number; }
          if (place.wheelchair_accessible_entrance){ placeAccessibility.textContent = '‚ôø'; placeAccessibility.style.display = 'inline'; }

          if (place.types?.length){
            place.types.filter(t => !['point_of_interest','establishment'].includes(t)).slice(0,3).forEach(type => {
              const span = document.createElement('span');
              span.className = 'place-type-tag';
              span.textContent = type.replace(/_/g,' ');
              placeTypesContainer.appendChild(span);
            });
          }

          // Reviews
          if (place.reviews?.length) {
            const top = place.reviews.slice(0,3);
            placeReviews.innerHTML = top.map(rv => {
              const stars = renderStarsHTML(Math.round(rv.rating || 0));
              return `<div class="bg-white/5 border border-white/10 rounded-lg p-2">
                <div class="flex items-center justify-between">
                  <div class="star-row">${stars}</div>
                  <div class="text-xs text-gray-300">${new Date(rv.time*1000).toLocaleDateString()}</div>
                </div>
                <div class="text-sm mt-1 italic">"${(rv.text||'').slice(0,200)}${rv.text && rv.text.length>200 ? '‚Ä¶' : ''}"</div>
                <div class="text-xs mt-1 text-right opacity-80">‚Äî ${rv.author_name||'Google user'}</div>
              </div>`;
            }).join('');
            reviewsBlock.classList.remove('hidden');
          }

          const destination = encodeURIComponent(`${place.name}, ${place.vicinity || ''}`);
          directionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;

          destinationLatLng = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
          buildRouteInstructionBubble();
          compassHud.style.display = 'flex';
          updateSaveButtonState();
        }
      });
    }

    /* ========== Directions + Compass + Voice ========== */
    function speak(text){
      if (!voiceOn) return;
      try{ const u = new SpeechSynthesisUtterance(text); u.rate=1.0; u.pitch=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{}
    }
    function buildRouteInstructionBubble(){
      if (!directionsService || !currentUserLocation || !destinationLatLng) return;
      const req = { origin: currentUserLocation, destination: destinationLatLng, travelMode: 'WALKING' };
      directionsService.route(req, (res, status) => {
        if (status === 'OK' && res.routes?.[0]?.legs?.[0]?.steps?.length){
          const step = res.routes[0].legs[0].steps[0];
          const text = stripHtml(step.instructions || 'Head toward destination');
          const dist = step.distance?.text || '';
          const full = `${text}${dist ? ' ‚Ä¢ ' + dist : ''}`;
          navMain.textContent = text;
          navSub.textContent  = dist ? `Next ‚Ä¢ ${dist}` : 'Live compass active';
          navBubble.style.display = 'block';
          speak(full);
        } else {
          navMain.textContent = 'Head toward destination';
          navSub.textContent  = 'Follow the arrow';
          navBubble.style.display = 'block';
        }
      });
    }

    // Bearing helpers
    const toRad = d => d * Math.PI / 180;
    const norm = a => (a % 360 + 360) % 360;
    function bearingFromTo(a, b) {
      const œÜ1 = toRad(a.lat), œÜ2 = toRad(b.lat);
      const ŒîŒª = toRad(b.lng - a.lng);
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      return norm((Math.atan2(y, x) * 180) / Math.PI);
    }
    function haversineMeters(a, b) {
      const R = 6371000;
      const dœÜ = toRad(b.lat - a.lat);
      const dŒª = toRad(b.lng - a.lng);
      const œÜ1 = toRad(a.lat), œÜ2 = toRad(b.lat);
      const s = Math.sin(dœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }
    function turnHint(delta){
      // delta = degrees to turn right to face target (0 = straight)
      if (delta < 12 || delta > 348) return 'Straight';
      if (delta < 30) return 'Slight right';
      if (delta < 60) return 'Right';
      if (delta < 120) return 'Turn right';
      if (delta < 180) return 'Sharp right';
      const left = 360 - delta; // mirror for left side
      if (left < 30) return 'Slight left';
      if (left < 60) return 'Left';
      if (left < 120) return 'Turn left';
      return 'Sharp left';
    }

    function updateCompassUI() {
      if (!compassActive || !destinationLatLng || !currentUserLocation) return;
      const brg = bearingFromTo(currentUserLocation, destinationLatLng);
      const delta = norm(brg - headingDeg);
      compassArrow.style.transform = `rotate(${delta}deg)`;
      const meters = haversineMeters(currentUserLocation, destinationLatLng);
      compassDist.textContent = metersToImperial(meters);

      // Live small hint
      const hint = turnHint(delta);
      navSub.textContent = `${hint} ‚Ä¢ ${metersToImperial(meters)}`;
    }
    function onOrientation(e) {
      if (typeof e.webkitCompassHeading === 'number') {
        headingDeg = e.webkitCompassHeading;
      } else if (typeof e.alpha === 'number') {
        headingDeg = norm(360 - e.alpha);
      }
      updateCompassUI();
    }
    function startCompass() {
      if (!destinationLatLng) return;
      compassActive = true;
      compassHud.style.display = 'flex';
      navBubble.style.display = 'block';

      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(state => {
          if (state === 'granted') window.addEventListener('deviceorientation', onOrientation, true);
          else { alert('Compass permission denied.'); stopCompass(); }
        }).catch(() => { alert('Compass not available.'); stopCompass(); });
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', onOrientation, true);
      } else { alert('Compass not supported.'); stopCompass(); return; }

      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
          pos => { currentUserLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude }; updateCompassUI(); buildRouteInstructionBubble(); },
          () => {}, { enableHighAccuracy: true, maximumAge: 3000, timeout: 10000 }
        );
      }
    }
    function stopCompass() {
      compassActive = false;
      compassHud.style.display = 'none';
      window.removeEventListener('deviceorientation', onOrientation, true);
      if (watchId != null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    }

    /* ========== Init & Geocode ========== */
    function initApp(){
      panorama = new google.maps.StreetViewPanorama(panoramaDiv, { addressControl:false, showRoadLabels:false, linksControl:false, panControl:false, enableCloseButton:false, fullscreenControl:false, zoomControl:false });
      placesService = new google.maps.places.PlacesService(document.createElement('div'));
      geocoder = new google.maps.Geocoder();
      directionsService = new google.maps.DirectionsService();
      toggleFilterButtons(true);

      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          reverseGeocodeSetLocation(coords);
        }, handleLocationError);
      } else {
        handleLocationError();
      }
    }
    window.initApp = initApp;

    function handleLocationError(){
      locationStatus.textContent = "Couldn't get your location. Please enter one manually.";
      manualLocationEntry.classList.remove('hidden');
      toggleFilterButtons(false);
    }

    function reverseGeocodeSetLocation(coords){
      geocoder.geocode({ location: coords }, (results, status) => {
        let label = "Your Current Location";
        currentLocality = '';
        if (status === 'OK' && results?.[0]){
          const comps = results[0].address_components || [];
          const city = comps.find(c => c.types.includes('locality'))?.long_name
                   || comps.find(c => c.types.includes('postal_town'))?.long_name
                   || comps.find(c => c.types.includes('sublocality'))?.long_name;
          const state = comps.find(c => c.types.includes('administrative_area_level_1'))?.short_name;
          if (city && state) currentLocality = `${city}, ${state}`;
          label = results[0].formatted_address.split(',').slice(0,2).join(',');
        }
        setLocationAndEnableApp(coords, label);
      });
    }

    function geocodeLocation(){
      const address = locationInput.value.trim();
      if (!address) return;
      locationStatus.textContent = `Searching for "${address}"...`;
      geocoder.geocode({ address }, (results, status) => {
        if (status === 'OK' && results?.[0]){
          const loc = results[0].geometry.location;
          reverseGeocodeSetLocation({ lat: loc.lat(), lng: loc.lng() });
        } else {
          locationStatus.textContent = `Could not find "${address}". Please try again.`;
        }
      });
    }

    function setLocationAndEnableApp(coords, locationName){
      currentUserLocation = coords;
      locationStatus.textContent = `Exploring: ${locationName}`;
      manualLocationEntry.classList.add('hidden');
      toggleFilterButtons(false);
    }

    /* ========== UI: submenus, events ========== */
    function showSubMenu(filter){
      filterContainer.classList.add('hidden');
      randomButton.classList.add('hidden');
      darkSideButton.style.display = 'none';
      subMenuContainer.innerHTML = '';
      const subFilters = subFilterMap[filter];
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 gap-4 sub-menu';
      for (const name in subFilters){
        const b = document.createElement('button');
        b.textContent = name; b.dataset.name = name; b.dataset.parent = filter;
        b.className = 'action-card rounded-lg font-bold py-3 text-base';
        grid.appendChild(b);
      }
      subMenuContainer.appendChild(grid);
      subMenuContainer.classList.remove('hidden');
      backToMainFiltersButton.classList.remove('hidden');
    }
    function hideSubMenu(){
      subMenuContainer.classList.add('hidden');
      backToMainFiltersButton.classList.add('hidden');
      filterContainer.classList.remove('hidden');
      randomButton.classList.remove('hidden');
      darkSideButton.style.display = 'block';
    }
    function resetApp(hidePanorama = true){
      stopCompass();
      resultScreen.style.display = 'none';
      resultsListScreen.style.display = 'none';
      mainScreen.classList.remove('hidden');
      funFactContainer.classList.remove('hidden');
      hideSubMenu();
      toggleFilterButtons(false);
      backToMainFiltersButton.disabled = false;
      if (currentUserLocation) locationStatus.textContent = "Location set! Where to next?";
      if (hidePanorama) panoramaContainer.classList.remove('shown');
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn || btn.disabled) return;

      if (btn.matches('#filter-container > button[data-filter]')) { showSubMenu(btn.dataset.filter); return; }

      if (btn.closest('.sub-menu') && btn.dataset.name) {
        const filterName = btn.dataset.name;
        const parent = btn.dataset.parent;
        let params = subFilterMap[parent][filterName];
        if (parent === 'eat' && filterName === 'üçï Surprise Me') {
          const food = Object.values(subFilterMap.eat).filter(f => f.type && f.type.endsWith('_restaurant'));
          params = food[Math.floor(Math.random() * food.length)];
        }
        findAdventure(params, parent, filterName);
        return;
      }

      if (e.target.classList.contains('open-details') || (e.target.closest('.open-details'))) {
        const t = e.target.closest('.open-details');
        openDetailsById(t.dataset.id);
        return;
      }

      switch (btn.id){
        case 'dark-side-button': showSubMenu('dark'); break;
        case 'back-to-main-filters': hideSubMenu(); break;
        case 'close-results-button':
          resultsListScreen.style.display = 'none';
          funFactContainer.classList.remove('hidden');
          break;
        case 'try-again-button': resetApp(); break;
        case 'search-button': geocodeLocation(); break;
        case 'next-suggestion-button':
          if (currentResults.length) {
            const idx = currentResults.findIndex(r => r.place_id === (currentPlace?.place_id || ''));
            const next = currentResults[(idx + 1) % currentResults.length];
            if (next) getPlaceDetails(next);
          }
          break;
        case 'save-place-button':
          if (!currentPlace) break;
          if (savedPlaces[currentPlace.place_id]) delete savedPlaces[currentPlace.place_id];
          else savedPlaces[currentPlace.place_id] = { name: currentPlace.name, vicinity: directionsLink.href };
          localStorage.setItem('savedPlaces', JSON.stringify(savedPlaces));
          updateSaveButtonState();
          break;
        case 'compass-button':
          if (compassActive) { stopCompass(); }
          else { startCompass(); speak('Compass started. Follow the arrow.'); }
          break;
        case 'speak-toggle':
          voiceOn = !voiceOn;
          speakToggle.textContent = `Voice: ${voiceOn ? 'On' : 'Off'}`;
          if (voiceOn) speak('Voice guidance enabled.'); else try{ speechSynthesis.cancel(); }catch{}
          break;
      }
    });

    document.getElementById('location-input').addEventListener('keyup', e => { if (e.key === 'Enter') geocodeLocation(); });

  </script>

  <!-- Google Maps (keep your restricted key) -->
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places&callback=initApp"></script>
</body>
</html>
