<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Local Explorer" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <title>Local Explorer</title>

  <!-- Replace YOUR_KEY with your referrer-restricted key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9PMHJVDip9WvIQVywmRjcdhqiQPrtXiY&libraries=places&callback=initApp" async defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    /* ===== Theme (Modern Navy) ===== */
    :root{
      --navy-900:#0b1220; /* deep hull navy */
      --navy-800:#0f1a2e;
      --navy-700:#12203b;
      --navy-600:#1a2b4f;
      --navy-500:#233a6b;
      --ivory:#f8f7f2;
      --gold:#f2c14e;   /* subtle naval brass */
      --teal:#2dd4bf;   /* accent for focus */
      --ink:#e5e7eb;    /* soft gray text */
      --muted:rgba(255,255,255,.12);
    }

    html,body{height:100%}
    body{
      font-family:'Raleway',sans-serif;
      color:var(--ivory);
      background:
        radial-gradient(140% 140% at 20% -10%, rgba(45,212,191,.06) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--navy-900) 0%, var(--navy-800) 60%, var(--navy-900) 100%);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    h1,h2,h3,.font-header{font-family:'Poppins',sans-serif}

    /* Safe areas */
    .pt-safe{padding-top: calc(1rem + env(safe-area-inset-top));}
    .pb-safe{padding-bottom: calc(1rem + env(safe-area-inset-bottom));}

    /* Cards + Buttons */
    .action-card{
      background:linear-gradient(180deg, var(--navy-700), var(--navy-800));
      color:var(--ivory); transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
      border:1px solid var(--muted); min-height:44px; /* tap target */
    }
    .action-card:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      background:linear-gradient(180deg, var(--navy-600), var(--navy-700));
    }
    .action-card:active:not(:disabled){transform:translateY(0) scale(.98)}
    .action-card:disabled{opacity:.55;cursor:not-allowed}

    /* Global focus visibility */
    :where(button,a,input,select,textarea):focus-visible{
      outline:3px solid var(--teal);
      outline-offset:2px;
      border-radius:12px;
    }

    /* Street View layer */
    #panorama{position:absolute;inset:0;z-index:1}
    #panorama-container{pointer-events:none;opacity:0;visibility:hidden}
    #panorama-container.shown{pointer-events:none;opacity:1;visibility:visible;transition:opacity .7s}

    /* Result drawer */
    #result-card{
      background:rgba(15,22,36,.92);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      transition:transform .4s ease,opacity .3s ease;
      max-height:90vh; overflow-y:auto; border-top:1px solid var(--muted)
    }
    .place-type-tag{
      background:rgba(255,255,255,.06);
      border:1px solid var(--muted);
      padding:2px 10px;border-radius:9999px;font-size:.75rem;text-transform:capitalize;font-weight:600
    }
    .star-row{font-size:12px;letter-spacing:1px}.star-row .star{opacity:.35}.star-row .star.filled{opacity:1}

    /* Results List overlay */
    #results-list-screen{
      position:fixed;inset:0;z-index:20;display:none;flex-direction:column;padding:1rem;
      background:rgba(3,8,18,.78);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)
    }
    #results-list-card{background:rgba(15,22,36,.97);color:var(--ivory);border-radius:1rem;padding:1rem;max-width:42rem;width:100%;margin:auto;border:1px solid var(--muted)}
    .result-item{
      background:rgba(255,255,255,.05);border:1px solid var(--muted);border-radius:.9rem;padding:.75rem;display:flex;gap:.75rem; cursor: pointer;
    }
    .result-item:hover{background: rgba(255,255,255,0.08);}
    .result-thumb{width:84px;height:84px;object-fit:cover;border-radius:.6rem;background:var(--navy-900); pointer-events: none;}

    /* Dark-side button */
    #dark-side-button{position:fixed;bottom:1rem;left:1rem;font-size:1.5rem;opacity:.45;transition:opacity .2s;cursor:pointer;z-index:20}
    #dark-side-button:hover{opacity:1}

    /* Compass modal */
    #compass-modal{position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center;
      background: rgba(3,8,18,.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);}
    #compass-dialog{
      width: min(92vw, 480px); background: rgba(15,22,36,.97); color: var(--ivory);
      border:1px solid var(--muted); border-radius:18px; box-shadow:0 24px 70px rgba(0,0,0,.55); padding:16px; outline:none;
    }
    #nav-bubble{
      position:relative;margin: 8px 0 12px 0;color:var(--ivory);padding:.6rem .75rem;font-size:13px;line-height:1.25;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      background:
        radial-gradient(120% 140% at 10% 0%, rgba(45,212,191,.10) 0%, rgba(242,193,78,.12) 35%, rgba(15,22,36,.96) 68%);
      border:1px solid var(--muted)
    }
    #nav-main{font-weight:700;letter-spacing:.2px}
    #nav-sub{font-size:11.5px;opacity:.85;margin-top:2px}
    #compass-overlay{
      width:260px;height:260px;border-radius:22px;margin: 6px auto 10px auto; padding: 18px; position:relative;
      background:
        radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 100%),
        conic-gradient(from 0deg, rgba(242,193,78,.4), rgba(242,193,78,.08) 30%, rgba(45,212,191,.5) 60%, rgba(45,212,191,.12) 75%, rgba(242,193,78,.35));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);overflow:hidden
    }
    #compass-arrow{
      width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:44px solid var(--gold);
      transform-origin:50% 90%;filter:drop-shadow(0 6px 8px rgba(242,193,78,.45));margin-bottom:8px
    }
    #compass-dist{font-size:14px;color:var(--ink);font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.5)}

    /* Reviews modal */
    #reviews-modal{position:fixed; inset:0; z-index:60; display:none; align-items:center; justify-content:center;
      background:rgba(3,8,18,.65); backdrop-filter:blur(8px)}
    #reviews-card{
      width:min(92vw,760px); max-height:85vh; overflow:auto;
      background:rgba(15,22,36,.98); color:var(--ivory);
      border:1px solid var(--muted); border-radius:18px; padding:16px; box-shadow:0 24px 70px rgba(0,0,0,.55)
    }
    .review{background:rgba(255,255,255,.06); border:1px solid var(--muted); border-radius:12px; padding:12px}
    .review + .review{margin-top:10px}
    .reviewer{font-weight:700}
    .review-meta{font-size:12px; opacity:.8}
    /* allow full text; modal scrolls */
    .whitespace-pre-wrap{white-space:pre-wrap}

    /* Form/input: iOS zoom prevention (>=16px) */
    input,select,textarea,button{font-size:16px}

    /* Motion safety */
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important}
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pt-safe pb-safe">

  <!-- Street View backdrop (non-interactive) -->
  <div id="panorama-container" class="fixed inset-0">
    <div id="panorama" aria-hidden="true"></div>
  </div>

  <main id="app-container" class="relative z-10 w-full max-w-lg mx-auto text-center" role="main" aria-live="polite">
    <section id="main-screen" aria-labelledby="app-title">
      <h1 id="app-title" class="text-4xl md:text-5xl font-header font-bold mb-4" style="color:var(--ivory)">Local Explorer</h1>

      <!-- Local facts -->
      <section id="fun-fact-container" class="text-left mb-4 px-2">
        <h2 class="font-header font-bold mb-1 text-sm tracking-wider uppercase" style="color:var(--gold)">Local Fact</h2>
        <p id="fun-fact-text" class="text-sm border-t-2 pt-2" style="color:var(--ink); border-color:rgba(255,255,255,.12)">Loading...</p>
      </section>

      <p id="location-status" class="text-lg font-semibold my-4" style="color:var(--ink)">Please allow location access...</p>

      <div id="manual-location-entry" class="hidden mb-6">
        <div class="flex items-center rounded-lg" style="background:rgba(255,255,255,.06); border:1px solid var(--muted)">
          <input type="text" id="location-input" inputmode="search" placeholder="Enter a city or place"
                 class="w-full bg-transparent text-white p-3 rounded-l-lg focus:outline-none" />
          <button id="search-button" class="action-card bg-gradient-to-b from-[var(--gold)] to-[var(--gold)] text-black font-semibold p-3 rounded-r-lg" aria-label="Search">ğŸ”</button>
        </div>
      </div>

      <!-- Categories -->
      <nav id="filter-container" class="grid grid-cols-2 gap-4">
        <button data-filter="eat" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ½ï¸ Foodie Finds</button>
        <button data-filter="see" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ›ï¸ Iconic Sights</button>
        <button data-filter="night" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸŒ™ Night Out</button>
        <button data-filter="gems" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ’ Hidden Gems</button>
        <button data-filter="pets" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ¾ Pet Friendly</button>
        <button data-filter="utilities" class="action-card rounded-lg font-bold py-3 text-base flex flex-col items-center justify-center">ğŸ› ï¸ Utilities & Help</button>
      </nav>

      <button id="random-button" class="action-card w-full mt-4 rounded-lg font-bold py-3 text-base"
        style="background:linear-gradient(180deg,#24406f,#1c2f54); border-color:rgba(255,255,255,.18)">ğŸ¤· Surprise Me!</button>

      <div id="sub-menu-container" class="hidden mt-4"></div>
      <button id="back-to-main-filters" class="hidden mt-4 underline" style="color:var(--ink)">Back to main filters</button>
    </section>
  </main>

  <button id="dark-side-button" data-filter="dark" aria-label="Dark category">ğŸ‘»</button>

  <!-- Results LIST -->
  <section id="results-list-screen" role="dialog" aria-modal="true" style="display:none;">
    <div id="results-list-card" class="w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h2 id="results-title" class="text-xl font-header font-bold">Results</h2>
        <button id="close-results-button" class="action-card font-bold py-2 px-3 rounded-lg">Back</button>
      </div>
      <div id="results-meta" class="text-sm mb-3" style="color:var(--ink)"></div>
      <div id="results-list" class="space-y-2 max-h-[68vh] overflow-y-auto"></div>
    </div>
  </section>

  <!-- Place Detail -->
  <section id="result-screen" class="fixed inset-0 z-20 flex flex-col justify-end items-center p-4" style="display:none;">
    <div id="result-card" class="p-4 rounded-t-2xl shadow-2xl w-full max-w-md text-center">
      <img id="place-photo" loading="lazy" src="https://placehold.co/600x400/333/FFF?text=Loading..." alt="Place photo" class="w-full h-48 object-cover rounded-lg mb-4" />
      <div class="flex justify-between items-start">
        <h2 class="text-2xl md:text-3xl font-header font-bold text-left" id="place-name">...</h2>
        <div class="flex items-center gap-2">
          <span id="place-accessibility" class="text-2xl"></span>
          <button id="save-place-button" class="text-3xl opacity-80 hover:opacity-100 transition-transform" aria-pressed="false" title="Save">â˜†</button>
        </div>
      </div>

      <div class="flex justify-center items-center gap-3 text-base my-2">
        <div class="star-row" id="place-stars"></div>
        <p class="font-semibold" id="place-rating" style="color:var(--gold)">...</p>
        <p class="font-semibold" id="place-price" style="color:#a7f3d0">...</p>
        <a id="phone-link" href="#" class="hover:underline text-sm" style="color:#93c5fd"></a>
      </div>

      <div id="place-types-container" class="flex flex-wrap justify-center gap-2 my-3"></div>

      <div class="flex flex-wrap justify-center gap-3 my-4">
        <a id="directions-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card font-bold py-3 px-4 rounded-lg"
           style="background:linear-gradient(180deg,#24406f,#1c2f54)">Map</a>
        <a id="website-link" href="#" target="_blank" rel="noopener" class="flex-1 action-card font-bold py-3 px-4 rounded-lg hidden">Website</a>
        <button id="reviews-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg">Reviews</button>
        <button id="share-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg">Share</button>
        <button id="compass-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg">Compass (Walking)</button>
      </div>

      <div id="result-buttons-container" class="w-full max-w-md flex gap-4">
        <button id="try-again-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Back</button>
        <button id="next-suggestion-button" class="flex-1 action-card font-bold py-3 px-4 rounded-lg text-lg rounded-b-2xl">Next</button>
      </div>
    </div>
  </section>

  <!-- Compass Modal -->
  <div id="compass-modal" aria-hidden="true">
    <div id="compass-dialog" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <header class="flex items-center justify-between mb-2">
        <h2 id="modal-title" class="font-header text-lg flex items-center gap-2">
          ğŸš¶ Live Compass â€” Walking
          <span class="text-xs font-semibold px-2 py-0.5 rounded" style="background:rgba(16,185,129,.25); border:1px solid var(--muted)">Walking mode</span>
        </h2>
        <div class="flex gap-2">
          <button id="guide-button" class="action-card font-bold py-2 px-3 rounded-lg">Guide Me â–¶ï¸</button>
          <button id="close-compass" class="action-card font-bold py-2 px-3 rounded-lg">Close</button>
        </div>
      </header>
      <div id="nav-bubble">
        <div id="nav-main">Head toward destination</div>
        <div id="nav-sub">Walking directions Â· Follow the arrow</div>
      </div>
      <div id="compass-overlay">
        <div id="compass-arrow"></div>
        <div id="compass-dist">--</div>
      </div>
    </div>
  </div>

  <!-- Reviews Modal -->
  <div id="reviews-modal">
    <div id="reviews-card" role="dialog" aria-modal="true" aria-labelledby="reviews-title">
      <div class="flex items-center justify-between gap-2 mb-2 flex-wrap">
        <h3 id="reviews-title" class="font-header text-lg">Recent Reviews</h3>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-sm opacity-90 select-none">
            <input id="reviews-worst-toggle" type="checkbox" class="accent-[var(--gold)]">
            <span>Worst (â‰¤3â˜…)</span>
          </label>
          <a id="reviews-open-in-maps" class="action-card font-bold py-2 px-3 rounded-lg hidden" target="_blank" rel="noopener"
             style="background:linear-gradient(180deg,#24406f,#1c2f54)">Open in Google Maps</a>
          <button id="close-reviews" class="action-card font-bold py-2 px-3 rounded-lg">Close</button>
        </div>
      </div>
      <div id="reviews-list"></div>
    </div>
  </div>

  <script>
    /* ====== SW (non-blocking) ====== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./serviceworker.js').catch(()=>{});
      });
    }

    /* ====== Refs ====== */
    const funFactContainer = document.getElementById('fun-fact-container');
    const funFactText = document.getElementById('fun-fact-text');
    const resultsListScreen = document.getElementById('results-list-screen');
    const resultsTitle = document.getElementById('results-title');
    const resultsMeta = document.getElementById('results-meta');
    const resultsList = document.getElementById('results-list');
    const resultScreen = document.getElementById('result-screen');
    const filterContainer = document.getElementById('filter-container');
    const locationStatus = document.getElementById('location-status');
    const panoramaContainer = document.getElementById('panorama-container');
    const panoramaDiv = document.getElementById('panorama');
    const manualLocationEntry = document.getElementById('manual-location-entry');
    const locationInput = document.getElementById('location-input');
    const subMenuContainer = document.getElementById('sub-menu-container');
    const backToMainFiltersButton = document.getElementById('back-to-main-filters');
    const placeNameEl = document.getElementById('place-name');
    const placeRatingEl = document.getElementById('place-rating');
    const placeStarsEl = document.getElementById('place-stars');
    const placePriceEl = document.getElementById('place-price');
    const placePhotoEl = document.getElementById('place-photo');
    const directionsLink = document.getElementById('directions-link');
    const websiteLink = document.getElementById('website-link');
    const placeTypesContainer = document.getElementById('place-types-container');
    const phoneLink = document.getElementById('phone-link');
    const placeAccessibility = document.getElementById('place-accessibility');
    const savePlaceButton = document.getElementById('save-place-button');
    const compassModal = document.getElementById('compass-modal');
    const compassDialog = document.getElementById('compass-dialog');
    const guideButton = document.getElementById('guide-button');
    const navMain = document.getElementById('nav-main');
    const navSub = document.getElementById('nav-sub');
    const compassArrow = document.getElementById('compass-arrow');
    const compassDist = document.getElementById('compass-dist');
    const randomButton = document.getElementById('random-button');
    const darkSideButton = document.getElementById('dark-side-button');

    // Reviews refs
    const reviewsModal = document.getElementById('reviews-modal');
    const reviewsList = document.getElementById('reviews-list');
    const reviewsOpenInMaps = document.getElementById('reviews-open-in-maps');
    const reviewsWorstToggle = document.getElementById('reviews-worst-toggle');

    /* ====== State ====== */
    let placesService, panorama, geocoder, directionsService;
    let currentUserLocation;
    let currentLocality = '';
    let currentPlace;
    let currentResults = [];
    let savedPlaces = JSON.parse(localStorage.getItem('savedPlaces') || '{}');
    let localFacts = [], factInterval = null, currentFactIndex = 0;
    let compassActive = false, guideSpeaking = false, watchId = null, headingDeg = 0;
    let routeSteps = [], stepIndex = 0, stepTarget = null, destLatLng = null;
    let currentReviews = [];

    /* ====== Categories ====== */
    const subFilterMap = {
      eat: {"ğŸ• Surprise Me":{type:"restaurant"},"Italian":{type:"italian_restaurant",keyword:"italian"},"Mexican":{type:"mexican_restaurant",keyword:"mexican"},"Japanese":{type:"japanese_restaurant",keyword:"japanese"},"Chinese":{type:"chinese_restaurant",keyword:"chinese"},"Indian":{type:"indian_restaurant",keyword:"indian"},"Pizza":{type:"pizza_restaurant",keyword:"pizza"},"Cafes":{type:"cafe",keyword:"cafe"},"Desserts":{type:"bakery",keyword:"dessert bakery"}},
      see:{"Museums":{type:"museum"},"Art Galleries":{type:"art_gallery"},"Tourist Attractions":{type:"tourist_attraction"}},
      night:{"Bars":{type:"bar"},"Night Clubs":{type:"night_club"}},
      gems:{"Quirky Shops":{keyword:"vintage store"},"Indie Coffee":{type:"cafe"},"Local Art":{type:"art_gallery"},"Quiet Spots":{type:"park"}},
      pets:{"Dog Park":{type:"park",keyword:"dog"},"Pet Store":{type:"pet_store"},"Veterinarian":{type:"veterinary_care"}},
      utilities:{"Hospital":{type:"hospital"},"Pharmacy":{type:"pharmacy"},"Police":{type:"police"},"Gas Station":{type:"gas_station"},"Car Rental":{type:"car_rental"},"ATM":{type:"atm"}},
      dark:{"Cemeteries":{type:"cemetery"},"Haunted Tours":{type:"tourist_attraction",keyword:"ghost tour haunted tour"},"Haunted Sites":{type:"tourist_attraction",keyword:"haunted site haunted house"},"Crime Museums":{type:"museum",keyword:"crime history museum"}}
    };
    const allowedByCategory = {
      eat:new Set(['restaurant','cafe','bakery','meal_takeaway','pizza_restaurant','italian_restaurant','mexican_restaurant','japanese_restaurant','chinese_restaurant','indian_restaurant']),
      night:new Set(['bar','night_club']),
      see:new Set(['museum','art_gallery','tourist_attraction']),
      gems:new Set(['art_gallery','park','cafe']),
      pets:new Set(['park','pet_store','veterinary_care']),
      utilities:new Set(['hospital','pharmacy','police','gas_station','car_rental','atm']),
      dark:new Set(['cemetery','museum','tourist_attraction'])
    };
    const bannedRetailish = new Set(['grocery_or_supermarket','supermarket','department_store','shopping_mall','convenience_store','store','lodging','hotel']);

    /* ====== Utils ====== */
    const METERS_10_MILES = 16093; // ~10 miles
    const metersToImperial = m => { const ft=m*3.28084; return ft<1000?`${Math.round(ft)} ft`:`${(m*0.000621371).toFixed(1)} mi`; };
    const toggleFilterButtons = d => document.querySelectorAll('#main-screen button').forEach(b=>b.disabled=d);
    const renderStarsHTML = r => { r=Math.round(r||0); let h=''; for(let i=1;i<=5;i++)h+=`<span class="star${i<=r?' filled':''}">â˜…</span>${i<5?' ':''}`; return h; };
    const renderStars = (el,r) => el.innerHTML=renderStarsHTML(r);
    const stripHtml = h => { const t=document.createElement('div'); t.innerHTML=h||''; return t.textContent||t.innerText||''; };
    const dedupe = items => { const s=new Set(),o=[]; for(const it of items) if(!s.has(it.place_id)){s.add(it.place_id);o.push(it)} return o; };
    const sortResults = a => a.sort((x,y)=>(y.rating??0)-(x.rating??0)||(y.user_ratings_total??0)-(x.user_ratings_total??0)||(x.distanceMeters??Infinity)-(y.distanceMeters??Infinity)||x.name.localeCompare(y.name));
    const toRad = d => d*Math.PI/180, toDeg = r => r*180/Math.PI, norm = a => ((a%360)+360)%360;

    function isCandidate(p, kw, reqType, allowedSet) {
      const t=new Set(p.types||[]);
      if (![...t].some(x => allowedSet.has(x))) return false;
      for (const x of t) if(bannedRetailish.has(x)) return false;
      if (reqType && !t.has(reqType)) {
        if(!(t.has('restaurant') && kw && new RegExp(kw,'i').test(p.name||''))) return false;
      }
      return true;
    }

    function updateSaveButtonState(){
      const pressed = currentPlace && !!savedPlaces[currentPlace.place_id];
      savePlaceButton.setAttribute('aria-pressed', String(pressed));
      savePlaceButton.textContent = pressed ? 'â˜…' : 'â˜†';
    }

    function speak(text){
      try{ speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }catch{}
    }

    /* ====== Local Facts ====== */
    async function getFunFact(coords){
      try{
        funFactText.textContent = "Finding local facts...";
        const geoURL = `https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=10000&gslimit=10&gscoord=${coords.lat}|${coords.lng}&format=json&origin=*`;
        const geoRes = await fetch(geoURL); const geo = await geoRes.json();
        const ids = (geo?.query?.geosearch||[]).map(p=>p.pageid).slice(0,10);
        if(!ids.length){ funFactText.textContent="No local facts found nearby."; return; }
        const exURL = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${ids.join('|')}&format=json&origin=*`;
        const exRes = await fetch(exURL); const ex = await exRes.json();
        localFacts = Object.values(ex?.query?.pages||{}).map(p=>p.extract).filter(e => e && e.length > 60 && e.length < 280);
        funFactText.textContent = localFacts[0] || "No local facts found nearby.";
        if(localFacts.length>1){
          if(factInterval) clearInterval(factInterval);
          let i=0; factInterval=setInterval(()=>{ i=(i+1)%localFacts.length; funFactText.textContent = localFacts[i]; },7000);
        }
      }catch{ funFactText.textContent="Local facts are currently unavailable."; }
    }

    /* ====== Distance helpers ====== */
    function haversineMeters(a,b){
      const R=6371000;
      const Ï†1=toRad(a.lat), Ï†2=toRad(b.lat);
      const dÏ†=toRad(b.lat-a.lat), dÎ»=toRad(b.lng-a.lng);
      const h=Math.sin(dÏ†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dÎ»/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function computeDistanceMetersFromCurrent(loc){
      if(!currentUserLocation || !loc) return Infinity;
      const b = { lat: typeof loc.lat === 'function' ? loc.lat() : loc.lat,
                  lng: typeof loc.lng === 'function' ? loc.lng() : loc.lng };
      return haversineMeters(currentUserLocation, b);
    }

    /* ====== Results List ====== */
    function showResultsList(parentFilter, subLabel){
      resultsListScreen.style.display='flex'; funFactContainer.style.display='none';
      resultsTitle.textContent=subLabel || 'Results';
      resultsMeta.textContent=currentResults.length?`${currentResults.length
